<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jazz Chord Progression Editor & Player</title>

    <!-- Load FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Alpine.js for interactions -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js"></script>
    <!-- Load Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- Load DaisyUI for enhanced components -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/daisyui/4.4.19/full.min.css" rel="stylesheet" type="text/css" />
    <!-- Load Tone.js for audio synthesis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Load SortableJS for drag-and-drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Load FileSaver.js for exporting files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Load Tonal.js for music theory utilities -->
    <script src="https://cdn.jsdelivr.net/npm/@tonaljs/tonal/browser/tonal.min.js"></script>
    <!-- Load Tippy.js for tooltips -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css" />

    <style>
        .chord-card.active {
            background-color: rgba(139, 92, 246, 0.2);
            border-color: #8b5cf6;
        }

        .chord-card.playing {
            animation: pulse 2s infinite;
            border-color: #8b5cf6;
            background-color: rgba(139, 92, 246, 0.3);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(139, 92, 246, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0);
            }
        }

        .chord-palette-item:hover {
            background-color: rgba(139, 92, 246, 0.1);
            cursor: pointer;
        }

        .sortable-ghost {
            opacity: 0.5;
            background: #f0f0f0;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2a303c;
        }

        ::-webkit-scrollbar-thumb {
            background: #3d4451;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #8b5cf6;
        }

        .timeline-scrubber {
            position: relative;
            height: 6px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 10px 0;
        }

        .timeline-progress {
            position: absolute;
            height: 100%;
            background: #8b5cf6;
            border-radius: 3px;
        }

        .timeline-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            top: 50%;
            margin-top: -6px;
            margin-left: -6px;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.4);
        }

        /* Virtual piano keyboard */
        .piano-key {
            height: 60px;
            border: 1px solid #ccc;
            display: inline-block;
            cursor: pointer;
            position: relative;
        }

        .white-key {
            background-color: white;
            width: 30px;
            z-index: 0;
        }

        .black-key {
            background-color: #333;
            width: 20px;
            height: 40px;
            z-index: 1;
            position: absolute;
            margin-left: -10px;
        }

        .piano-note-label {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #666;
        }

        .black-key .piano-note-label {
            color: white;
            bottom: 2px;
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen" x-data="chordEditor()" x-init="init()"
    @keydown.escape="closeAllModals()">

    <!-- Main layout -->
    <div class="flex flex-col h-screen">
        <!-- Top Navigation Bar -->
        <nav class="bg-gray-800 shadow-lg p-4 flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-music text-violet-400 text-2xl mr-2"></i>
                <h1 class="text-xl font-bold">Jazz Chord Progression Editor</h1>
            </div>

            <div class="flex space-x-2">
                <button @click="newProgression()" class="btn btn-sm btn-ghost">
                    <i class="fas fa-file mr-1"></i> New
                </button>
                <button @click="openPresetsModal()" class="btn btn-sm btn-ghost btn-primary text-white">
                    <i class="fas fa-star mr-1"></i> Presets
                </button>
                <button @click="saveProgressionToFile()" class="btn btn-sm btn-ghost">
                    <i class="fas fa-download mr-1"></i> Export
                </button>
                <button @click="openImportModal()" class="btn btn-sm btn-ghost">
                    <i class="fas fa-upload mr-1"></i> Import
                </button>
                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-sm btn-ghost">
                        <i class="fas fa-ellipsis-v"></i>
                    </label>
                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                        <li><a @click="openSettingsModal()"><i class="fas fa-cog mr-2"></i> Settings</a></li>
                        <li><a @click="openHelpModal()"><i class="fas fa-question-circle mr-2"></i> Help</a></li>
                        <li><a @click="copyCurrentProgressionAsText()"><i class="fas fa-copy mr-2"></i> Copy as Text</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
            <!-- Left Sidebar - Chord Palette -->
            <div class="w-full md:w-72 bg-gray-800 p-4 overflow-y-auto" x-show="showChordPalette">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-violet-400">Chord Palette</h2>
                    <button @click="toggleChordPalette()" class="btn btn-sm btn-ghost md:hidden">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <div class="form-control">
                        <div class="input-group">
                            <input type="text" placeholder="Search chords..."
                                class="input input-sm input-bordered w-full" x-model="chordSearchQuery"
                                @input="filterChordPalette()">
                            <button class="btn btn-sm btn-square">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="tabs tabs-boxed mb-4">
                    <a class="tab" :class="{'tab-active': activeChordCategory === 'basic'}"
                        @click="setChordCategory('basic')">Basic</a>
                    <a class="tab" :class="{'tab-active': activeChordCategory === 'jazz'}"
                        @click="setChordCategory('jazz')">Jazz</a>
                    <a class="tab" :class="{'tab-active': activeChordCategory === 'extended'}"
                        @click="setChordCategory('extended')">Extended</a>
                </div>

                <div class="collapse collapse-plus bg-base-200 mb-2" x-data="{open: true}">
                    <input type="checkbox" x-model="open" />
                    <div class="collapse-title text-sm font-medium">
                        Root Note
                    </div>
                    <div class="collapse-content" x-show="open">
                        <div class="grid grid-cols-4 gap-1">
                            <template x-for="note in rootNotes" :key="note">
                                <div class="btn btn-xs"
                                    :class="{'btn-primary': selectedRoot === note, 'btn-outline': selectedRoot !== note}"
                                    @click="selectedRoot = note" x-text="note"></div>
                            </template>
                        </div>
                    </div>
                </div>

                <div class="space-y-1 mt-4">
                    <template x-for="(category, categoryName) in filteredChordTypes" :key="categoryName">
                        <div class="mb-4">
                            <h3 class="text-sm font-semibold text-gray-400 mb-2" x-text="categoryName"></h3>
                            <div class="space-y-1">
                                <template x-for="chord in category" :key="chord.name">
                                    <div class="chord-palette-item px-3 py-2 rounded-md text-sm flex justify-between items-center"
                                        @click="addChordToProgression(chord)">
                                        <span x-text="selectedRoot + chord.suffix"></span>
                                        <button class="btn btn-xs btn-ghost btn-circle"
                                            @click.stop="previewChord(chord)">
                                            <i class="fas fa-play text-xs"></i>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="divider my-4">Custom Chord</div>

                <div class="bg-base-200 p-3 rounded-lg">
                    <div class="form-control mb-2">
                        <label class="label pt-0">
                            <span class="label-text text-xs">Root</span>
                        </label>
                        <select class="select select-sm select-bordered w-full" x-model="customChord.root">
                            <template x-for="note in rootNotes" :key="note">
                                <option :value="note" x-text="note"></option>
                            </template>
                        </select>
                    </div>

                    <div class="form-control mb-2">
                        <label class="label pt-0">
                            <span class="label-text text-xs">Chord Type</span>
                        </label>
                        <select class="select select-sm select-bordered w-full" x-model="customChord.type">
                            <option value="major">Major</option>
                            <option value="minor">Minor</option>
                            <option value="7">Dominant 7th</option>
                            <option value="maj7">Major 7th</option>
                            <option value="m7">Minor 7th</option>
                            <option value="dim">Diminished</option>
                            <option value="aug">Augmented</option>
                            <option value="sus4">Sus4</option>
                            <option value="6">6th</option>
                            <option value="m6">Minor 6th</option>
                            <option value="9">9th</option>
                            <option value="maj9">Major 9th</option>
                            <option value="m9">Minor 9th</option>
                            <option value="11">11th</option>
                            <option value="13">13th</option>
                            <option value="alt">Altered</option>
                        </select>
                    </div>

                    <div class="form-control mb-2">
                        <label class="label pt-0">
                            <span class="label-text text-xs">Extensions (optional)</span>
                        </label>
                        <div class="grid grid-cols-2 gap-1">
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="customChord.b5">
                                <span class="label-text text-xs">b5</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="customChord.s5">
                                <span class="label-text text-xs">#5</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="customChord.b9">
                                <span class="label-text text-xs">b9</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="customChord.s9">
                                <span class="label-text text-xs">#9</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="customChord.s11">
                                <span class="label-text text-xs">#11</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="customChord.b13">
                                <span class="label-text text-xs">b13</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-control mb-2">
                        <label class="label pt-0">
                            <span class="label-text text-xs">Bass Note (optional)</span>
                        </label>
                        <select class="select select-sm select-bordered w-full" x-model="customChord.bass">
                            <option value="">Same as root</option>
                            <template x-for="note in rootNotes" :key="note">
                                <option :value="note" x-text="note"></option>
                            </template>
                        </select>
                    </div>

                    <button class="btn btn-sm btn-primary w-full mt-2" @click="addCustomChord()">
                        Add Custom Chord
                    </button>
                </div>
            </div>

            <!-- Main Editor Area -->
            <div class="flex-1 p-6 overflow-y-auto relative">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">
                            <span x-text="currentProgression.name || 'Untitled Progression'"></span>
                            <button @click="editProgressionName()" class="btn btn-xs btn-ghost ml-2">
                                <i class="fas fa-edit"></i>
                            </button>
                        </h2>
                        <p class="text-gray-400" x-show="currentProgression.description">
                            <span x-text="currentProgression.description"></span>
                        </p>
                    </div>

                    <div class="flex gap-2">
                        <button @click="toggleChordPalette()" class="btn btn-sm btn-outline md:hidden">
                            <i class="fas fa-book"></i> Palette
                        </button>
                        <button @click="createNewSection()" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus"></i> Add Section
                        </button>
                    </div>
                </div>

                <div class="space-y-8 mb-10">
                    <template x-for="(section, sectionIndex) in currentProgression.sections" :key="sectionIndex">
                        <div class="bg-gray-800 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center">
                                    <button class="btn btn-xs btn-circle mr-2"
                                        @click="toggleSectionCollapse(sectionIndex)">
                                        <i class="fas"
                                            :class="section.collapsed ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
                                    </button>

                                    <div x-show="!section.isEditingName" class="flex items-center">
                                        <h3 class="text-xl font-bold" x-text="section.name"></h3>
                                        <button @click="startEditSectionName(sectionIndex)"
                                            class="btn btn-xs btn-ghost ml-2">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>

                                    <div x-show="section.isEditingName" class="flex">
                                        <input type="text" class="input input-sm input-bordered mr-2"
                                            x-model="section.editNameValue"
                                            @keyup.enter="saveSectionName(sectionIndex)">
                                        <button @click="saveSectionName(sectionIndex)" class="btn btn-xs btn-primary">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="flex gap-1">
                                    <button class="btn btn-xs btn-outline" @click="playSection(sectionIndex)">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="btn btn-xs btn-outline" @click="addChordToSection(sectionIndex)">
                                        <i class="fas fa-plus"></i> Add Chord
                                    </button>
                                    <div class="dropdown dropdown-end">
                                        <label tabindex="0" class="btn btn-xs btn-ghost">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </label>
                                        <ul tabindex="0"
                                            class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-48">
                                            <li><a @click="duplicateSection(sectionIndex)">
                                                    <i class="fas fa-copy mr-2"></i> Duplicate Section
                                                </a></li>
                                            <li><a @click="addAnnotationToSection(sectionIndex)">
                                                    <i class="fas fa-comment mr-2"></i> Add Section Annotation
                                                </a></li>
                                            <li><a @click="moveSectionUp(sectionIndex)" x-show="sectionIndex > 0">
                                                    <i class="fas fa-arrow-up mr-2"></i> Move Up
                                                </a></li>
                                            <li><a @click="moveSectionDown(sectionIndex)"
                                                    x-show="sectionIndex < currentProgression.sections.length - 1">
                                                    <i class="fas fa-arrow-down mr-2"></i> Move Down
                                                </a></li>
                                            <li><a @click="deleteSection(sectionIndex)" class="text-error">
                                                    <i class="fas fa-trash mr-2"></i> Delete Section
                                                </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div x-show="section.annotation" class="bg-base-300 rounded-md p-3 mb-4 text-sm">
                                <div class="flex justify-between">
                                    <p x-text="section.annotation"></p>
                                    <button @click="editSectionAnnotation(sectionIndex)" class="btn btn-xs btn-ghost">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>

                            <div x-show="!section.collapsed">
                                <div :id="'chords-container-' + sectionIndex"
                                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                    <template x-for="(chord, chordIndex) in section.chords" :key="chordIndex">
                                        <div class="chord-card border border-gray-700 rounded-md p-3 transition-all"
                                            :class="{'playing': isChordPlaying(sectionIndex, chordIndex), 'active': selectedChordIndices.section === sectionIndex && selectedChordIndices.chord === chordIndex}">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <div class="text-lg font-bold" x-text="getChordDisplayName(chord)">
                                                    </div>
                                                    <div class="text-xs text-gray-400 mt-1">
                                                        <span x-text="formatChordNotes(chord.notes)"></span>
                                                    </div>
                                                </div>
                                                <div class="flex gap-1">
                                                    <button @click="playChord(chord)"
                                                        class="btn btn-xs btn-circle btn-ghost">
                                                        <i class="fas fa-play text-xs"></i>
                                                    </button>
                                                    <div class="dropdown dropdown-end">
                                                        <label tabindex="0"
                                                            class="btn btn-xs btn-circle btn-ghost cursor-pointer">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </label>
                                                        <ul tabindex="0"
                                                            class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-48">
                                                            <li><a @click="editChord(sectionIndex, chordIndex)">
                                                                    <i class="fas fa-edit mr-2"></i> Edit Chord
                                                                </a></li>
                                                            <li><a
                                                                    @click="addChordAnnotation(sectionIndex, chordIndex)">
                                                                    <i class="fas fa-comment mr-2"></i> Add Annotation
                                                                </a></li>
                                                            <li><a @click="duplicateChord(sectionIndex, chordIndex)">
                                                                    <i class="fas fa-copy mr-2"></i> Duplicate
                                                                </a></li>
                                                            <li><a @click="moveChordLeft(sectionIndex, chordIndex)"
                                                                    x-show="chordIndex > 0">
                                                                    <i class="fas fa-arrow-left mr-2"></i> Move Left
                                                                </a></li>
                                                            <li><a @click="moveChordRight(sectionIndex, chordIndex)"
                                                                    x-show="chordIndex < section.chords.length - 1">
                                                                    <i class="fas fa-arrow-right mr-2"></i> Move Right
                                                                </a></li>
                                                            <li><a @click="deleteChord(sectionIndex, chordIndex)"
                                                                    class="text-error">
                                                                    <i class="fas fa-trash mr-2"></i> Delete
                                                                </a></li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>

                                            <div x-show="chord.annotation"
                                                class="mt-3 text-xs bg-base-300 p-2 rounded text-gray-300">
                                                <div class="flex justify-between">
                                                    <p x-text="chord.annotation"></p>
                                                    <button @click="editChordAnnotation(sectionIndex, chordIndex)"
                                                        class="btn btn-xs btn-ghost btn-circle">
                                                        <i class="fas fa-edit text-xs"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Player Controls (Fixed at Bottom) -->
        <div class="bg-gray-800 border-t border-gray-700 p-4 shadow-lg">
            <div class="container mx-auto">
                <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-4 w-full lg:w-auto">
                        <div class="flex gap-2">
                            <button @click="restartPlayback()" class="btn btn-circle btn-sm btn-outline">
                                <i class="fas fa-step-backward"></i>
                            </button>

                            <button @click="togglePlay()" class="btn btn-circle btn-sm">
                                <i :class="isPlaying ? 'fas fa-pause' : 'fas fa-play'"></i>
                            </button>

                            <button @click="stopPlayback()" class="btn btn-circle btn-sm btn-outline">
                                <i class="fas fa-stop"></i>
                            </button>
                        </div>

                        <div class="text-sm">
                            <div class="font-semibold" x-text="currentChordName || 'Not Playing'"></div>
                            <div class="text-xs text-gray-400" x-text="currentSectionName || ''"></div>
                        </div>
                    </div>

                    <div class="w-full lg:w-1/2">
                        <div class="timeline-scrubber" @click="seekToPosition($event)">
                            <div class="timeline-progress" :style="'width: ' + progressPercentage + '%'"></div>
                            <div class="timeline-handle" :style="'left: ' + progressPercentage + '%'"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-400">
                            <span x-text="formatTime(elapsedTime)"></span>
                            <span x-text="formatTime(totalTime)"></span>
                        </div>
                    </div>

                    <div class="flex items-center gap-4 w-full lg:w-auto">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-music text-sm"></i>
                            <select x-model="instrument" @change="changeInstrument()"
                                class="select select-sm select-bordered">
                                <option value="piano">Piano</option>
                                <option value="rhodes">Electric Piano</option>
                                <option value="synth">Moog Synth</option>
                                <option value="warm-pad">Warm Pad</option>
                                <option value="analog-saw">Analog Saw</option>
                                <option value="marimba">Marimba</option>
                                <option value="vibraphone">Vibraphone</option>
                            </select>
                        </div>

                        <div class="flex items-center gap-2">
                            <i class="fas fa-volume-up text-sm"></i>
                            <input type="range" min="0" max="1" step="0.1" x-model="volume" @change="updateVolume()"
                                class="range range-xs range-primary w-20">
                        </div>

                        <div class="flex items-center gap-2">
                            <i class="fas fa-tachometer-alt text-sm"></i>
                            <select x-model="tempo" @change="updateTempo()" class="select select-sm select-bordered">
                                <option value="40">40 BPM</option>
                                <option value="60">60 BPM</option>
                                <option value="80">80 BPM</option>
                                <option value="100">100 BPM</option>
                                <option value="120">120 BPM</option>
                                <option value="140">140 BPM</option>
                                <option value="160">160 BPM</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <!-- Presets Modal -->
        <div class="modal" :class="{'modal-open': showPresetsModal}">
            <div class="modal-box max-w-4xl">
                <h3 class="font-bold text-lg mb-4">Jazz Progression Presets</h3>
                <p class="text-sm text-gray-400 mb-6">Select a professionally crafted jazz chord progression to use as a
                    starting point</p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Preset 1 - Gemma 3 -->
                    <div class="card bg-base-200 hover:bg-base-300 transition-colors cursor-pointer">
                        <div class="card-body">
                            <h2 class="card-title">
                                <span class="badge badge-primary">Gemma 3</span>
                            </h2>
                            <p class="text-sm">16-bar progression with polychords, altered dominants, and non-functional
                                harmony</p>
                            <div class="card-actions justify-end mt-2">
                                <button class="btn btn-sm btn-outline" @click.stop="previewPreset('gemma3')">
                                    <i class="fas fa-play mr-1"></i> Preview
                                </button>
                                <button class="btn btn-sm btn-primary" @click.stop="loadPreset('gemma3')">
                                    <i class="fas fa-check mr-1"></i> Select
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Preset 2 - ChatGPT 4.5 -->
                    <div class="card bg-base-200 hover:bg-base-300 transition-colors cursor-pointer">
                        <div class="card-body">
                            <h2 class="card-title">
                                <span class="badge badge-secondary">ChatGPT 4.5</span>
                            </h2>
                            <p class="text-sm">16-bar sequence with modal interchange, bitonal chords, and altered
                                dominants</p>
                            <div class="card-actions justify-end mt-2">
                                <button class="btn btn-sm btn-outline" @click.stop="previewPreset('chatgpt45')">
                                    <i class="fas fa-play mr-1"></i> Preview
                                </button>
                                <button class="btn btn-sm btn-primary" @click.stop="loadPreset('chatgpt45')">
                                    <i class="fas fa-check mr-1"></i> Select
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Preset 3 - Claude 3.7 Sonnet -->
                    <div class="card bg-base-200 hover:bg-base-300 transition-colors cursor-pointer">
                        <div class="card-body">
                            <h2 class="card-title">
                                <span class="badge badge-accent">Claude 3.7</span>
                            </h2>
                            <p class="text-sm">Sophisticated 4-section progression with polytonal concepts and upper
                                structure triads</p>
                            <div class="card-actions justify-end mt-2">
                                <button class="btn btn-sm btn-outline" @click.stop="previewPreset('claude37')">
                                    <i class="fas fa-play mr-1"></i> Preview
                                </button>
                                <button class="btn btn-sm btn-primary" @click.stop="loadPreset('claude37')">
                                    <i class="fas fa-check mr-1"></i> Select
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="divider my-4">Featured Progression</div>

                <div class="bg-base-200 p-4 rounded-lg">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="font-bold text-lg" x-text="featuredPreset.name"></h3>
                            <p class="text-sm text-gray-400" x-text="featuredPreset.description"></p>
                        </div>
                        <button class="btn btn-primary" @click="loadPreset(featuredPreset.id)">
                            Use This Progression
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th>Bar</th>
                                    <th>Chord</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(chord, index) in featuredPreset.preview" :key="index">
                                    <tr>
                                        <td x-text="chord.bar"></td>
                                        <td x-text="chord.name"></td>
                                        <td x-text="chord.notes"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="modal-action">
                    <button @click="closePresetsModal()" class="btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Edit Chord Modal -->
        <div class="modal" :class="{'modal-open': showEditChordModal}">
            <div class="modal-box max-w-2xl">
                <h3 class="font-bold text-lg mb-4">Edit Chord</h3>

                <div class="tabs tabs-boxed mb-4">
                    <a class="tab" :class="{'tab-active': editChordTab === 'basic'}"
                        @click="editChordTab = 'basic'">Basic</a>
                    <a class="tab" :class="{'tab-active': editChordTab === 'advanced'}"
                        @click="editChordTab = 'advanced'">Advanced</a>
                    <a class="tab" :class="{'tab-active': editChordTab === 'notes'}"
                        @click="editChordTab = 'notes'">Notes</a>
                </div>

                <div x-show="editChordTab === 'basic'">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Root Note</span>
                            </label>
                            <select class="select select-bordered w-full" x-model="editingChord.root">
                                <template x-for="note in rootNotes" :key="note">
                                    <option :value="note" x-text="note"></option>
                                </template>
                            </select>
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Chord Type</span>
                            </label>
                            <select class="select select-bordered w-full" x-model="editingChord.type"
                                @change="updateEditingChordFromType()">
                                <option value="major">Major</option>
                                <option value="minor">Minor</option>
                                <option value="7">Dominant 7th</option>
                                <option value="maj7">Major 7th</option>
                                <option value="m7">Minor 7th</option>
                                <option value="dim">Diminished</option>
                                <option value="aug">Augmented</option>
                                <option value="sus4">Sus4</option>
                                <option value="6">6th</option>
                                <option value="m6">Minor 6th</option>
                                <option value="9">9th</option>
                                <option value="maj9">Major 9th</option>
                                <option value="m9">Minor 9th</option>
                                <option value="11">11th</option>
                                <option value="13">13th</option>
                                <option value="alt">Altered</option>
                            </select>
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Bass Note (for slash chords)</span>
                            </label>
                            <select class="select select-bordered w-full" x-model="editingChord.bass">
                                <option value="">Same as root</option>
                                <template x-for="note in rootNotes" :key="note">
                                    <option :value="note" x-text="note"></option>
                                </template>
                            </select>
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Annotation (optional)</span>
                            </label>
                            <input type="text" class="input input-bordered w-full" x-model="editingChord.annotation"
                                placeholder="Add a note about this chord...">
                        </div>
                    </div>

                    <div class="form-control mt-4">
                        <label class="label">
                            <span class="label-text">Extensions & Alterations</span>
                        </label>
                        <div class="grid grid-cols-3 md:grid-cols-6 gap-2">
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.b5">
                                <span class="label-text">b5</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.s5">
                                <span class="label-text">#5</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.b9">
                                <span class="label-text">b9</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.s9">
                                <span class="label-text">#9</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.s11">
                                <span class="label-text">#11</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.b13">
                                <span class="label-text">b13</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-control mt-4">
                        <label class="label">
                            <span class="label-text">Preview</span>
                        </label>
                        <div class="bg-base-300 p-4 rounded-md flex justify-between items-center">
                            <div>
                                <div class="text-lg font-bold" x-text="getChordDisplayName(editingChord)"></div>
                                <div class="text-sm text-gray-400" x-text="formatChordNotes(editingChord.notes)"></div>
                            </div>
                            <button @click="previewEditingChord()" class="btn btn-sm btn-primary">
                                <i class="fas fa-play mr-1"></i> Play
                            </button>
                        </div>
                    </div>
                </div>

                <div x-show="editChordTab === 'advanced'">
                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text">Voicing Style</span>
                        </label>
                        <select class="select select-bordered w-full" x-model="editingChord.voicingStyle"
                            @change="regenerateChordNotes()">
                            <option value="close">Close Voicing</option>
                            <option value="open">Open Voicing</option>
                            <option value="drop2">Drop 2 Voicing</option>
                            <option value="spread">Spread Voicing</option>
                            <option value="quartal">Quartal (4ths)</option>
                            <option value="cluster">Cluster</option>
                        </select>
                    </div>

                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text">Octave Range</span>
                        </label>
                        <div class="flex gap-4">
                            <div class="w-1/2">
                                <label class="label pt-0">
                                    <span class="label-text text-xs">Bass Octave</span>
                                </label>
                                <select class="select select-bordered w-full" x-model="editingChord.baseOctave"
                                    @change="regenerateChordNotes()">
                                    <option value="1">Very Low (1)</option>
                                    <option value="2">Low (2)</option>
                                    <option value="3">Middle (3)</option>
                                    <option value="4">High (4)</option>
                                </select>
                            </div>
                            <div class="w-1/2">
                                <label class="label pt-0">
                                    <span class="label-text text-xs">Span (octaves)</span>
                                </label>
                                <select class="select select-bordered w-full" x-model="editingChord.octaveSpan"
                                    @change="regenerateChordNotes()">
                                    <option value="1">Tight (1)</option>
                                    <option value="2">Normal (2)</option>
                                    <option value="3">Wide (3)</option>
                                    <option value="4">Very Wide (4)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text">Tension Notes (add to chord)</span>
                        </label>
                        <div class="grid grid-cols-4 gap-2">
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.tensions" value="add9" @change="regenerateChordNotes()">
                                <span class="label-text">add9</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.tensions" value="add11" @change="regenerateChordNotes()">
                                <span class="label-text">add11</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.tensions" value="add13" @change="regenerateChordNotes()">
                                <span class="label-text">add13</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.tensions" value="addb9" @change="regenerateChordNotes()">
                                <span class="label-text">addb9</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-control mb-4">
                        <label class="label flex justify-between">
                            <span class="label-text">Chord Density</span>
                            <span class="label-text-alt" x-text="editingChord.density + ' notes'"></span>
                        </label>
                        <input type="range" min="3" max="7" class="range range-primary" x-model="editingChord.density"
                            @change="regenerateChordNotes()">
                        <div class="w-full flex justify-between text-xs px-2 mt-1">
                            <span>Triad</span>
                            <span>Tetrad</span>
                            <span>Complex</span>
                        </div>
                    </div>
                </div>

                <div x-show="editChordTab === 'notes'">
                    <p class="text-sm mb-4">Manually adjust individual notes in the chord. Click on the piano keyboard
                        to hear each note.</p>

                    <div class="flex justify-center mb-6 overflow-x-auto">
                        <!-- Mini piano keyboard for note selection -->
                        <div class="relative h-[60px] whitespace-nowrap">
                            <!-- White keys -->
                            <template x-for="(note, i) in pianoNotes.filter(n => !n.includes('#'))" :key="i">
                                <div :data-note="note" class="piano-key white-key inline-block align-top"
                                    :class="{'bg-violet-200': isNoteInChord(note)}" @click="toggleNoteInChord(note)">
                                    <div class="piano-note-label" x-text="note.slice(0, -1)"></div>
                                </div>
                            </template>

                            <!-- Black keys -->
                            <template x-for="(note, i) in pianoNotes.filter(n => n.includes('#'))" :key="i">
                                <div :data-note="note" class="piano-key black-key inline-block align-top"
                                    :class="{'bg-violet-800': isNoteInChord(note)}"
                                    :style="`left: ${getBlackKeyPosition(note)}px`" @click="toggleNoteInChord(note)">
                                    <div class="piano-note-label" x-text="note.slice(0, -1)"></div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="bg-base-300 p-4 rounded-md mb-4">
                        <h4 class="font-semibold mb-2">Current Notes</h4>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="(note, index) in editingChord.notes" :key="index">
                                <div class="badge badge-lg badge-primary gap-1">
                                    <span x-text="note"></span>
                                    <button @click="removeNoteFromChord(index)" class="btn btn-xs btn-circle btn-ghost">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Add New Note</span>
                        </label>
                        <div class="flex gap-2">
                            <select class="select select-bordered w-full" x-model="newNoteToAdd">
                                <template x-for="note in noteLetters" :key="note">
                                    <option :value="note" x-text="note"></option>
                                </template>
                            </select>
                            <select class="select select-bordered w-full" x-model="newNoteOctave">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                            <button @click="addNoteToChord()" class="btn btn-primary">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <button @click="sortChordNotes()" class="btn btn-sm btn-outline mt-4">
                        <i class="fas fa-sort mr-1"></i> Sort Notes
                    </button>
                </div>

                <div class="modal-action">
                    <button @click="cancelEditChord()" class="btn">Cancel</button>
                    <button @click="saveEditedChord()" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Import Modal -->
        <div class="modal" :class="{'modal-open': showImportModal}">
            <div class="modal-box">
                <h3 class="font-bold text-lg mb-4">Import Progression</h3>

                <div class="tabs tabs-boxed mb-4">
                    <a class="tab" :class="{'tab-active': importTab === 'file'}" @click="importTab = 'file'">From
                        File</a>
                    <a class="tab" :class="{'tab-active': importTab === 'text'}" @click="importTab = 'text'">From
                        Text</a>
                </div>

                <div x-show="importTab === 'file'">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">Upload JSON file</span>
                        </label>
                        <input type="file" class="file-input file-input-bordered w-full" accept=".json"
                            @change="handleFileUpload($event)">
                    </div>

                    <div class="alert alert-info mt-4" x-show="importMessage">
                        <i class="fas fa-info-circle"></i>
                        <span x-text="importMessage"></span>
                    </div>
                </div>

                <div x-show="importTab === 'text'">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">Paste progression JSON</span>
                        </label>
                        <textarea class="textarea textarea-bordered h-40"
                            placeholder="Paste your chord progression JSON here..." x-model="importJsonText"></textarea>
                    </div>
                </div>

                <div class="modal-action">
                    <button @click="closeImportModal()" class="btn">Cancel</button>
                    <button @click="importFromText()" x-show="importTab === 'text'"
                        class="btn btn-primary">Import</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal" :class="{'modal-open': showSettingsModal}">
            <div class="modal-box">
                <h3 class="font-bold text-lg mb-4">Settings</h3>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Default Chord Duration (seconds)</span>
                    </label>
                    <input type="range" min="0.5" max="4" step="0.5" class="range range-primary"
                        x-model="chordDuration">
                    <div class="flex justify-between text-xs px-2 mt-1">
                        <span>0.5s</span>
                        <span>1s</span>
                        <span>2s</span>
                        <span>3s</span>
                        <span>4s</span>
                    </div>
                </div>

                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Default Reverb Amount</span>
                    </label>
                    <input type="range" min="0" max="1" step="0.1" class="range range-primary" x-model="reverb"
                        @change="updateEffects()">
                    <div class="flex justify-between text-xs px-2 mt-1">
                        <span>None</span>
                        <span>Low</span>
                        <span>Medium</span>
                        <span>High</span>
                        <span>Max</span>
                    </div>
                </div>

                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Interface Theme</span>
                    </label>
                    <select class="select select-bordered w-full" x-model="theme" @change="applyTheme()">
                        <option value="dark">Dark</option>
                        <option value="synthwave">Synthwave</option>
                        <option value="luxury">Luxury</option>
                        <option value="dracula">Dracula</option>
                        <option value="business">Business</option>
                        <option value="night">Night</option>
                    </select>
                </div>

                <div class="modal-action">
                    <button @click="closeSettingsModal()" class="btn btn-primary">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div class="modal" :class="{'modal-open': showHelpModal}">
            <div class="modal-box max-w-2xl">
                <h3 class="font-bold text-lg mb-4">Jazz Chord Progression Editor Help</h3>

                <div class="tabs tabs-boxed mb-4">
                    <a class="tab" :class="{'tab-active': helpTab === 'basics'}" @click="helpTab = 'basics'">Basics</a>
                    <a class="tab" :class="{'tab-active': helpTab === 'chords'}" @click="helpTab = 'chords'">Chord
                        Types</a>
                    <a class="tab" :class="{'tab-active': helpTab === 'keyboard'}"
                        @click="helpTab = 'keyboard'">Keyboard Shortcuts</a>
                </div>

                <div class="overflow-y-auto pr-2" style="max-height: 60vh;">
                    <div x-show="helpTab === 'basics'">
                        <h4 class="font-bold mb-2">Getting Started</h4>
                        <ul class="list-disc ml-6 space-y-2 mb-4">
                            <li>Use the <b>Chord Palette</b> on the left to browse and add chords to your progression.
                            </li>
                            <li>Create <b>Sections</b> to organize your progression (verse, chorus, bridge, etc.).</li>
                            <li>Add <b>Annotations</b> to sections or individual chords to include notes about
                                performance or theory.</li>
                            <li>Use the playback controls at the bottom to listen to your progression.</li>
                        </ul>

                        <h4 class="font-bold mb-2">Managing Your Work</h4>
                        <ul class="list-disc ml-6 space-y-2 mb-4">
                            <li>Use <b>Export</b> to save your progression as a JSON file that you can share or reuse
                                later.</li>
                            <li>Use <b>Import</b> to load a previously saved progression.</li>
                            <li>The <b>New</b> button creates a fresh progression.</li>
                        </ul>

                        <h4 class="font-bold mb-2">Editing Chords</h4>
                        <ul class="list-disc ml-6 space-y-2">
                            <li>Click the <b>three dots</b> menu on any chord to edit, delete, or duplicate it.</li>
                            <li>In the chord editor, use the <b>Basic</b> tab for quick changes or the <b>Advanced</b>
                                tab for detailed voicing options.</li>
                            <li>The <b>Notes</b> tab allows you to manually edit the specific notes in each chord.</li>
                        </ul>
                    </div>

                    <div x-show="helpTab === 'chords'" class="space-y-4">
                        <h4 class="font-bold mb-2">Common Jazz Chord Types</h4>

                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Symbol</th>
                                        <th>Example</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Major 7th</td>
                                        <td>maj7</td>
                                        <td>Cmaj7</td>
                                        <td>C E G B</td>
                                    </tr>
                                    <tr>
                                        <td>Dominant 7th</td>
                                        <td>7</td>
                                        <td>C7</td>
                                        <td>C E G Bb</td>
                                    </tr>
                                    <tr>
                                        <td>Minor 7th</td>
                                        <td>m7</td>
                                        <td>Cm7</td>
                                        <td>C Eb G Bb</td>
                                    </tr>
                                    <tr>
                                        <td>Half-diminished</td>
                                        <td>m7b5</td>
                                        <td>Cm7b5</td>
                                        <td>C Eb Gb Bb</td>
                                    </tr>
                                    <tr>
                                        <td>Diminished 7th</td>
                                        <td>dim7</td>
                                        <td>Cdim7</td>
                                        <td>C Eb Gb A</td>
                                    </tr>
                                    <tr>
                                        <td>Augmented</td>
                                        <td>aug</td>
                                        <td>Caug</td>
                                        <td>C E G#</td>
                                    </tr>
                                    <tr>
                                        <td>Major 9th</td>
                                        <td>maj9</td>
                                        <td>Cmaj9</td>
                                        <td>C E G B D</td>
                                    </tr>
                                    <tr>
                                        <td>Dominant 9th</td>
                                        <td>9</td>
                                        <td>C9</td>
                                        <td>C E G Bb D</td>
                                    </tr>
                                    <tr>
                                        <td>Minor 9th</td>
                                        <td>m9</td>
                                        <td>Cm9</td>
                                        <td>C Eb G Bb D</td>
                                    </tr>
                                    <tr>
                                        <td>Dominant 13th</td>
                                        <td>13</td>
                                        <td>C13</td>
                                        <td>C E G Bb D F A</td>
                                    </tr>
                                    <tr>
                                        <td>Altered Dominant</td>
                                        <td>7alt</td>
                                        <td>C7alt</td>
                                        <td>C E G Bb Db Eb Ab</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h4 class="font-bold mb-2">Common Extensions & Alterations</h4>
                        <ul class="list-disc ml-6 space-y-1">
                            <li><b>b5</b> - Flattened 5th (Gb in C chord)</li>
                            <li><b>#5</b> - Sharpened 5th (G# in C chord)</li>
                            <li><b>b9</b> - Flattened 9th (Db in C chord)</li>
                            <li><b>#9</b> - Sharpened 9th (D# in C chord)</li>
                            <li><b>#11</b> - Sharpened 11th (F# in C chord)</li>
                            <li><b>b13</b> - Flattened 13th (Ab in C chord)</li>
                        </ul>
                    </div>

                    <div x-show="helpTab === 'keyboard'">
                        <h4 class="font-bold mb-2">Keyboard Shortcuts</h4>
                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full">
                                <thead>
                                    <tr>
                                        <th>Shortcut</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><kbd class="kbd">Space</kbd></td>
                                        <td>Play/Pause progression</td>
                                    </tr>
                                    <tr>
                                        <td><kbd class="kbd">Esc</kbd></td>
                                        <td>Close any open modal</td>
                                    </tr>
                                    <tr>
                                        <td><kbd class="kbd">Ctrl</kbd> + <kbd class="kbd">S</kbd></td>
                                        <td>Export progression</td>
                                    </tr>
                                    <tr>
                                        <td><kbd class="kbd">Ctrl</kbd> + <kbd class="kbd">N</kbd></td>
                                        <td>New progression</td>
                                    </tr>
                                    <tr>
                                        <td><kbd class="kbd">Ctrl</kbd> + <kbd class="kbd">O</kbd></td>
                                        <td>Open import modal</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="modal-action">
                    <button @click="closeHelpModal()" class="btn">Close</button>
                </div>
            </div>
        </div>

        <!-- Name Edit Modal -->
        <div class="modal" :class="{'modal-open': showNameEditModal}">
            <div class="modal-box">
                <h3 class="font-bold text-lg mb-4">Edit Progression Details</h3>

                <div class="form-control mb-4">
                    <label class="label">
                        <span class="label-text">Progression Name</span>
                    </label>
                    <input type="text" class="input input-bordered w-full" x-model="editingProgressionName"
                        placeholder="Enter a name...">
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Description (optional)</span>
                    </label>
                    <textarea class="textarea textarea-bordered h-20" x-model="editingProgressionDescription"
                        placeholder="Enter a description..."></textarea>
                </div>

                <div class="modal-action">
                    <button @click="cancelNameEdit()" class="btn">Cancel</button>
                    <button @click="saveProgressionName()" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>

        <!-- Annotation Modal -->
        <div class="modal" :class="{'modal-open': showAnnotationModal}">
            <div class="modal-box">
                <h3 class="font-bold text-lg mb-4" x-text="annotationModalTitle"></h3>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Annotation Text</span>
                    </label>
                    <textarea class="textarea textarea-bordered h-32" x-model="editingAnnotation"
                        placeholder="Enter annotation text..."></textarea>
                </div>

                <div class="modal-action">
                    <button @click="cancelAnnotation()" class="btn">Cancel</button>
                    <button @click="saveAnnotation()" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Libraries -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('chordEditor', () => ({
                // UI State
                audioInitialized: false,
                showChordPalette: true,
                showEditChordModal: false,
                showImportModal: false,
                showSettingsModal: false,
                showHelpModal: false,
                showNameEditModal: false,
                showAnnotationModal: false,
                showPresetsModal: false,
                activeChordCategory: 'basic',
                editChordTab: 'basic',
                importTab: 'file',
                helpTab: 'basics',
                chordSearchQuery: '',
                theme: 'dark',
                featuredPreset: {
                    id: 'gemma3',
                    name: 'Sophisticated Jazz Progression (Gemma 3)',
                    description: 'A 16-bar progression with polychords, altered dominants, and non-functional harmony',
                    preview: []
                },

                // Player State
                isPlaying: false,
                tempo: 60,
                chordDuration: 2,
                currentChordIndex: 0,
                currentSectionIndex: 0,
                currentChordName: "",
                currentSectionName: "",
                progressPercentage: 0,
                elapsedTime: 0,
                totalTime: 0,
                instrument: "piano",
                reverb: 0.5,
                volume: 0.7,

                // Editing State
                editingSectionIndex: null,
                editingChordIndex: null,
                editingChord: {
                    name: "",
                    root: "C",
                    type: "maj7",
                    bass: "",
                    notes: [],
                    b5: false,
                    s5: false,
                    b9: false,
                    s9: false,
                    s11: false,
                    b13: false,
                    annotation: "",
                    voicingStyle: "close",
                    baseOctave: 3,
                    octaveSpan: 2,
                    density: 4,
                    tensions: []
                },
                editingProgressionName: "",
                editingProgressionDescription: "",
                editingAnnotation: "",
                annotationModalTitle: "",
                annotationTarget: { type: null, sectionIndex: null, chordIndex: null },
                selectedChordIndices: { section: null, chord: null },
                importJsonText: "",
                importMessage: "",

                // Custom Chord Builder
                customChord: {
                    root: "C",
                    type: "major",
                    b5: false,
                    s5: false,
                    b9: false,
                    s9: false,
                    s11: false,
                    b13: false,
                    bass: ""
                },

                // Piano keyboard
                pianoNotes: ['C3', 'C#3', 'D3', 'D#3', 'E3', 'F3', 'F#3', 'G3', 'G#3', 'A3', 'A#3', 'B3', 'C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4', 'A#4', 'B4'],
                noteLetters: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],
                newNoteToAdd: 'C',
                newNoteOctave: '3',

                // Audio
                synth: null,
                chordSequence: null,
                reverb_effect: null,

                // Chord data
                rootNotes: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],
                selectedRoot: 'C',

                // Voice leading state
                voiceLeadingState: {
                    previousNotes: null,
                    currentVoicing: null
                },

                // Current progression data
                currentProgression: {
                    name: "My Jazz Progression",
                    description: "",
                    sections: [
                        {
                            name: "Section A",
                            chords: [
                                {
                                    name: "Cmaj7(#11)",
                                    root: "C",
                                    type: "maj7",
                                    bass: "",
                                    notes: ['C3', 'E3', 'G3', 'B3', 'F#4'],
                                    s11: true,
                                    annotation: "",
                                    voicingStyle: "close",
                                    baseOctave: 3,
                                    octaveSpan: 2,
                                    density: 5,
                                    tensions: ["#11"]
                                },
                                {
                                    name: "D7(b9)",
                                    root: "D",
                                    type: "7",
                                    bass: "",
                                    notes: ['D3', 'F#3', 'A3', 'C4', 'Eb4'],
                                    b9: true,
                                    annotation: "",
                                    voicingStyle: "close",
                                    baseOctave: 3,
                                    octaveSpan: 2,
                                    density: 5
                                },
                                {
                                    name: "Gmaj9",
                                    root: "G",
                                    type: "maj9",
                                    bass: "",
                                    notes: ['G2', 'B2', 'D3', 'F#3', 'A3'],
                                    annotation: "",
                                    voicingStyle: "close",
                                    baseOctave: 2,
                                    octaveSpan: 2,
                                    density: 5
                                },
                                {
                                    name: "E7alt",
                                    root: "E",
                                    type: "alt",
                                    bass: "",
                                    notes: ['E2', 'G#2', 'D3', 'F3', 'Bb3'],
                                    b9: true,
                                    s9: true,
                                    b5: true,
                                    s5: true,
                                    annotation: "",
                                    voicingStyle: "close",
                                    baseOctave: 2,
                                    octaveSpan: 2,
                                    density: 5
                                }
                            ],
                            collapsed: false,
                            annotation: "Ethereal opening section with advanced harmonic techniques"
                        }
                    ]
                },

                // Chord type definitions
                chordTypes: {
                    'Basic': [
                        { name: 'Major', suffix: '', notes: ['1', '3', '5'] },
                        { name: 'Minor', suffix: 'm', notes: ['1', 'b3', '5'] },
                        { name: 'Diminished', suffix: 'dim', notes: ['1', 'b3', 'b5'] },
                        { name: 'Augmented', suffix: 'aug', notes: ['1', '3', '#5'] },
                        { name: 'Sus4', suffix: 'sus4', notes: ['1', '4', '5'] },
                        { name: 'Sus2', suffix: 'sus2', notes: ['1', '2', '5'] },
                        { name: '6th', suffix: '6', notes: ['1', '3', '5', '6'] },
                        { name: 'Minor 6th', suffix: 'm6', notes: ['1', 'b3', '5', '6'] }
                    ],
                    'Seventh Chords': [
                        { name: 'Major 7th', suffix: 'maj7', notes: ['1', '3', '5', '7'] },
                        { name: 'Dominant 7th', suffix: '7', notes: ['1', '3', '5', 'b7'] },
                        { name: 'Minor 7th', suffix: 'm7', notes: ['1', 'b3', '5', 'b7'] },
                        { name: 'Minor Major 7th', suffix: 'mMaj7', notes: ['1', 'b3', '5', '7'] },
                        { name: 'Half-Diminished', suffix: 'm7b5', notes: ['1', 'b3', 'b5', 'b7'] },
                        { name: 'Diminished 7th', suffix: 'dim7', notes: ['1', 'b3', 'b5', 'bb7'] },
                        { name: 'Augmented 7th', suffix: 'aug7', notes: ['1', '3', '#5', 'b7'] },
                        { name: 'Augmented Major 7th', suffix: 'augMaj7', notes: ['1', '3', '#5', '7'] }
                    ],
                    'Extended Chords': [
                        { name: 'Major 9th', suffix: 'maj9', notes: ['1', '3', '5', '7', '9'] },
                        { name: 'Dominant 9th', suffix: '9', notes: ['1', '3', '5', 'b7', '9'] },
                        { name: 'Minor 9th', suffix: 'm9', notes: ['1', 'b3', '5', 'b7', '9'] },
                        { name: 'Dominant 11th', suffix: '11', notes: ['1', '3', '5', 'b7', '9', '11'] },
                        { name: 'Minor 11th', suffix: 'm11', notes: ['1', 'b3', '5', 'b7', '9', '11'] },
                        { name: 'Dominant 13th', suffix: '13', notes: ['1', '3', '5', 'b7', '9', '11', '13'] },
                        { name: 'Major 13th', suffix: 'maj13', notes: ['1', '3', '5', '7', '9', '11', '13'] },
                        { name: 'Minor 13th', suffix: 'm13', notes: ['1', 'b3', '5', 'b7', '9', '11', '13'] }
                    ],
                    'Altered Chords': [
                        { name: 'Dominant 7 b9', suffix: '7b9', notes: ['1', '3', '5', 'b7', 'b9'] },
                        { name: 'Dominant 7 #9', suffix: '7#9', notes: ['1', '3', '5', 'b7', '#9'] },
                        { name: 'Dominant 7 #11', suffix: '7#11', notes: ['1', '3', '5', 'b7', '#11'] },
                        { name: 'Dominant 7 b13', suffix: '7b13', notes: ['1', '3', '5', 'b7', 'b13'] },
                        { name: 'Dominant 7 b5', suffix: '7b5', notes: ['1', '3', 'b5', 'b7'] },
                        { name: 'Dominant 7 #5', suffix: '7#5', notes: ['1', '3', '#5', 'b7'] },
                        { name: 'Altered Dominant', suffix: '7alt', notes: ['1', '3', 'b5/#5', 'b7', 'b9/#9'] },
                        { name: 'Lydian Dominant', suffix: '7#11', notes: ['1', '3', '5', 'b7', '9', '#11'] }
                    ],
                    'Jazz Voicings': [
                        { name: 'Major 7 #11', suffix: 'maj7#11', notes: ['1', '3', '5', '7', '#11'] },
                        { name: 'Minor 9 b5', suffix: 'm9b5', notes: ['1', 'b3', 'b5', 'b7', '9'] },
                        { name: 'Dominant 9 sus4', suffix: '9sus4', notes: ['1', '4', '5', 'b7', '9'] },
                        { name: 'Dominant 13 sus4', suffix: '13sus4', notes: ['1', '4', '5', 'b7', '9', '13'] },
                        { name: 'Dominant 7 b9 sus4', suffix: '7b9sus4', notes: ['1', '4', '5', 'b7', 'b9'] },
                        { name: 'Minor 6/9', suffix: 'm6/9', notes: ['1', 'b3', '5', '6', '9'] },
                        { name: 'Major 6/9', suffix: '6/9', notes: ['1', '3', '5', '6', '9'] },
                        { name: 'Dominant 9 b5', suffix: '9b5', notes: ['1', '3', 'b5', 'b7', '9'] }
                    ]
                },
                filteredChordTypes: {},

                init() {
                    if (this.isInitialized) {
                        console.log("Already initialized, skipping...");
                        return;
                    }
                    try {
                        console.log("Initializing Jazz Chord Editor...");

                        this.filterChordPalette();
                        this.applyTheme();
                        this.updateTotalTime();
                        this.updateFeaturedPresetPreview('gemma3');

                        // Store the keydown handler as a property so we can remove it later
                        this.keydownHandler = (e) => {
                            try {
                                if (e.key === ' ' && !this.isModalOpen()) {
                                    e.preventDefault();
                                    this.togglePlay();
                                }
                                if (e.ctrlKey && e.key === 's') {
                                    e.preventDefault();
                                    this.saveProgressionToFile();
                                }
                                if (e.ctrlKey && e.key === 'n') {
                                    e.preventDefault();
                                    this.newProgression();
                                }
                                if (e.ctrlKey && e.key === 'o') {
                                    e.preventDefault();
                                    this.openImportModal();
                                }
                            } catch (e) {
                                console.error("Error in keyboard event handler:", e);
                            }
                        };

                        // Add the event listener
                        window.addEventListener('keydown', this.keydownHandler);

                        if (!this.audioInitialized) {
                            this.createAudioEnableOverlay();
                        } else {
                            console.log('Audio is already initialized, skipping overlay');
                        }

                        console.log("Basic initialization complete. Audio will be initialized after user interaction.");
                        this.isInitialized = true; // Mark as initialized

                        // Set up unload handler for cleanup
                        window.addEventListener('beforeunload', () => this.cleanup());

                        // Validate progression notes
                        this.validateProgressionNotes();


                    } catch (e) {
                        console.error("Error initializing app:", e);
                    }
                },

                cleanup() {
                    try {
                        console.log("Cleaning up Jazz Chord Editor resources...");
                        if (this.keydownHandler) {
                            window.removeEventListener('keydown', this.keydownHandler);
                            this.keydownHandler = null;
                        }
                        if (this.isPlaying) this.stopPlayback();
                        if (Tone.Transport) {
                            Tone.Transport.stop();
                            Tone.Transport.cancel(0);
                        }
                        if (this.chordSequence) {
                            this.chordSequence.dispose();
                            this.chordSequence = null;
                        }
                        if (this.synth) {
                            this.synth.dispose();
                            this.synth = null;
                        }
                        if (this.reverb_effect) {
                            this.reverb_effect.dispose();
                            this.reverb_effect = null;
                        }
                        if (this.masterEQ) {
                            this.masterEQ.dispose();
                            this.masterEQ = null;
                        }
                        if (this.limiter) {
                            this.limiter.dispose();
                            this.limiter = null;
                        }
                        if (this.instrumentEffects) {
                            this.instrumentEffects.forEach(effect => effect.dispose());
                            this.instrumentEffects = [];
                        }
                        console.log("Cleanup complete");
                    } catch (e) {
                        console.error("Error during cleanup:", e);
                    }
                },

                // New method to create an overlay that requires user interaction
                createAudioEnableOverlay() {
                    // If we've already initialized, don't show again
                    if (this.audioInitialized) {
                        console.log("Audio already initialized, skipping overlay");
                        return;
                    }

                    const overlay = document.createElement('div');
                    overlay.id = 'audio-enable-overlay';
                    overlay.style.position = 'fixed';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.width = '100%';
                    overlay.style.height = '100%';
                    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                    overlay.style.display = 'flex';
                    overlay.style.justifyContent = 'center';
                    overlay.style.alignItems = 'center';
                    overlay.style.zIndex = '9999';

                    const content = document.createElement('div');
                    content.style.backgroundColor = '#2a303c';
                    content.style.padding = '2rem';
                    content.style.borderRadius = '0.5rem';
                    content.style.maxWidth = '500px';
                    content.style.textAlign = 'center';

                    const title = document.createElement('h2');
                    title.innerText = 'Enable Audio';
                    title.style.color = '#fff';
                    title.style.marginBottom = '1rem';

                    const message = document.createElement('p');
                    message.innerText = 'This application uses Web Audio to play jazz chord progressions. Browser security requires a user interaction before audio can be enabled.';
                    message.style.color = '#ccc';
                    message.style.marginBottom = '1.5rem';

                    const button = document.createElement('button');
                    button.innerText = 'Click to Enable Audio';
                    button.className = 'btn btn-primary btn-lg';
                    button.style.padding = '0.75rem 1.5rem';

                    // Store reference to overlay for retries
                    this.audioOverlay = overlay;

                    // Add error message container (hidden by default)
                    const errorContainer = document.createElement('div');
                    errorContainer.style.color = '#ff6b6b';
                    errorContainer.style.marginTop = '1rem';
                    errorContainer.style.display = 'none';
                    this.audioErrorContainer = errorContainer;

                    content.appendChild(title);
                    content.appendChild(message);
                    content.appendChild(button);
                    content.appendChild(errorContainer);
                    overlay.appendChild(content);

                    // Add event listener for the simplest possible audio initialization
                    button.addEventListener('click', () => {
                        try {
                            // Mark that we've started initialization
                            this.audioInitialized = true;

                            // Show loading state
                            button.disabled = true;
                            button.innerText = 'Initializing Audio...';
                            errorContainer.style.display = 'none';

                            // Use the most basic audio initialization possible
                            this.basicAudioInitialization(button, errorContainer, overlay);
                        } catch (e) {
                            console.error("Error in click handler:", e);
                            this.showAudioError("Unexpected error. Please try again.", button, errorContainer);
                            // Reset if there was an error
                            this.audioInitialized = false;
                        }
                    });

                    document.body.appendChild(overlay);
                },

                /**
                 * Initializes the audio subsystem with proper error handling.
                 * @param {HTMLElement} button - The button element to update.
                 * @param {HTMLElement} errorContainer - Container for error messages.
                 * @param {HTMLElement} overlay - The overlay to remove on success.
                 */
                basicAudioInitialization(button, errorContainer, overlay) {
                    try {
                        // First try with a simple approach
                        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

                        // Check if audio context started
                        if (audioCtx.state !== 'running') {
                            audioCtx.resume().then(() => {
                                console.log("AudioContext resumed successfully.");

                                // IMPORTANT: Call Tone.start() right here in the same user gesture,
                                // so Chrome sees it as a direct click action and unsuspends audio.
                                Tone.start().then(() => {
                                    console.log("Tone.js successfully started. Now initializing the main synth...");

                                    // Now initialize Tone.js with our custom routine
                                    this.initSimpleTone(audioCtx, button, errorContainer, overlay);

                                    // Remove overlay after successful init
                                    if (overlay && overlay.parentNode) {
                                        document.body.removeChild(overlay);
                                    }
                                }).catch(err => {
                                    console.error("Failed to start Tone.js:", err);
                                    this.showAudioError("Could not start Tone.js. Please try again.", button, errorContainer);
                                    // Reset audio initialization flag
                                    this.audioInitialized = false;
                                });
                            }).catch(err => {
                                console.error("Failed to resume AudioContext:", err);
                                this.showAudioError("Could not start audio system. Please try again.", button, errorContainer);
                                // Reset audio initialization flag
                                this.audioInitialized = false;
                            });
                        } else {
                            // If it's already running, just init
                            this.initSimpleTone(audioCtx, button, errorContainer, overlay);

                            // Remove overlay
                            if (overlay && overlay.parentNode) {
                                document.body.removeChild(overlay);
                            }
                        }
                    } catch (e) {
                        console.error("Error in audio initialization:", e);
                        this.showAudioError("Unexpected audio initialization error. Please try again.", button, errorContainer);
                        // Reset audio initialization flag
                        this.audioInitialized = false;
                    }
                },

                /**
                 * Initializes the audio system with a master EQ and smoother envelope for improved sound quality.
                 * @param {AudioContext} audioCtx - The Web Audio API context.
                 * @param {HTMLElement} button - The button element to update.
                 * @param {HTMLElement} errorContainer - Container for error messages.
                 * @param {HTMLElement} overlay - The overlay to remove on success.
                 */
                initSimpleTone(audioCtx, button, errorContainer, overlay) {
                    try {
                        // Clean up any existing Tone Transport or events
                        if (Tone.Transport) {
                            Tone.Transport.stop();
                            Tone.Transport.cancel(0);
                        }

                        // Dispose of previous instances to prevent memory leaks
                        if (this.synth) {
                            this.synth.dispose();
                            this.synth = null;
                        }
                        if (this.reverb_effect) {
                            this.reverb_effect.dispose();
                            this.reverb_effect = null;
                        }
                        if (this.masterEQ) {
                            this.masterEQ.dispose();
                            this.masterEQ = null;
                        }
                        if (this.limiter) {
                            this.limiter.dispose();
                            this.limiter = null;
                        }

                        // Ensure Tone is using the provided AudioContext
                        Tone.setContext(audioCtx);

                        // Create a limiter to prevent clipping
                        this.limiter = new Tone.Limiter(-3).toDestination();

                        // Create a reverb effect with warmer settings
                        this.reverb_effect = new Tone.Reverb({
                            decay: 1.5,
                            wet: this.reverb || 0.3, // Use existing reverb setting or default
                            preDelay: 0.01
                        }).connect(this.limiter);

                        // Create a master EQ for better frequency balance
                        this.masterEQ = new Tone.EQ3({
                            low: -3,      // Reduce muddy low frequencies slightly
                            mid: 0,       // Keep mids neutral
                            high: 3,      // Brighten highs for clarity
                            lowFrequency: 200,
                            highFrequency: 2000
                        }).connect(this.reverb_effect);

                        // IMPROVED: Use higher maxPolyphony to never drop notes
                        this.synth = new Tone.PolySynth(Tone.Synth, {
                            maxPolyphony: 256, // Boosted from original 128
                            oscillator: {
                                type: "triangle" // Triangle wave is smoother for jazz chords
                            },
                            envelope: {
                                attack: 0.1,   // Slightly longer attack for smoother onset
                                decay: 0.3,    // Moderately fast initial decay
                                sustain: 0.6,  // Medium sustain level for good balance
                                release: 2.0   // Longer release for nice decay
                            }
                        });

                        // Chain through EQ, reverb, limiter
                        this.synth.chain(this.masterEQ, this.reverb_effect, this.limiter);

                        // Overall volume level with headroom
                        this.synth.volume.value = -8;

                        // Mark as successfully initialized
                        this.audioInitialized = true;

                        console.log("Full audio system initialized successfully!");
                    } catch (e) {
                        console.error("Error in Tone.js initialization:", e);
                        this.showAudioError("Could not initialize audio system. Please try again.", button, errorContainer);
                        // Reset audio initialization flag
                        this.audioInitialized = false;
                    }
                },

                /**
                 * Optimizes chord notes for playback to prevent polyphony issues and ensure key chord tones.
                 * @param {string[]} notes - Array of note strings (e.g., ['C3', 'E3', 'G3']).
                 * @returns {string[]} Optimized array of note strings.
                 */
                optimizeChordNotes(notes) {
                    if (!notes || !Array.isArray(notes)) return [];

                    // Parse notes into objects with pitch values
                    const noteObjects = notes.map(note => {
                        const name = note.slice(0, -1);
                        const octave = parseInt(note.slice(-1));
                        const pitch = this.getNoteIndex(name) + octave * 12;
                        return { note, pitch, name, octave };
                    });

                    // Remove duplicates by pitch
                    const uniqueNotes = [];
                    const seenPitches = new Set();
                    noteObjects.forEach(n => {
                        if (!seenPitches.has(n.pitch)) {
                            seenPitches.add(n.pitch);
                            uniqueNotes.push(n);
                        }
                    });

                    // Sort by pitch (low to high)
                    uniqueNotes.sort((a, b) => a.pitch - b.pitch);

                    // Limit to max polyphony and optimize for jazz sound
                    const MAX_NOTES = 8; // Reasonable for rich jazz chords
                    if (uniqueNotes.length > MAX_NOTES) {
                        // Prioritize root (lowest), 3rd, 7th, then highest tensions
                        const optimized = [];
                        const root = uniqueNotes[0]; // Assume lowest is root
                        optimized.push(root);

                        // Find 3rd and 7th based on typical jazz intervals (approx)
                        const rootPitch = root.pitch;
                        const candidates = uniqueNotes.slice(1);
                        const third = candidates.find(n => [3, 4].includes((n.pitch - rootPitch) % 12)) || candidates[0];
                        const seventh = candidates.find(n => [10, 11].includes((n.pitch - rootPitch) % 12)) || candidates[1];
                        if (third && !optimized.some(n => n.pitch === third.pitch)) optimized.push(third);
                        if (seventh && !optimized.some(n => n.pitch === seventh.pitch)) optimized.push(seventh);

                        // Fill remaining slots with highest tensions
                        const remaining = candidates.filter(n => !optimized.some(o => o.pitch === n.pitch));
                        remaining.sort((a, b) => b.pitch - a.pitch); // Highest first
                        while (optimized.length < MAX_NOTES && remaining.length > 0) {
                            optimized.push(remaining.shift());
                        }

                        return optimized.map(n => n.note);
                    }

                    return uniqueNotes.map(n => n.note);
                },

                getNoteIndex(noteName) {
                    // Expanded noteMap to include flats so we don't get undefined for "Eb","Ab","Bb", etc.
                    const noteMap = {
                        'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4,
                        'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9,
                        'A#': 10, 'Bb': 10, 'B': 11
                    };
                    return (noteMap[noteName] !== undefined) ? noteMap[noteName] : 0;
                },

                /**
            * Generates a pool of possible notes for a chord across multiple octaves for voice-leading.
            * Now with robust error handling.
            * @param {Object} chord - The chord object with root, type, extensions, etc.
            * @returns {string[]} Array of note strings (e.g., ['C2', 'E2', 'G2', ...]).
            */
                getChordNotePool(chord) {
                    // Validate input
                    if (!chord || typeof chord !== 'object' || !chord.root) {
                        console.warn("Invalid chord in getChordNotePool:", chord);
                        return ['C3', 'E3', 'G3', 'C4', 'E4', 'G4']; // Return C major across octaves as fallback
                    }

                    const noteMap = {
                        'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'F': 5,
                        'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11
                    };

                    // Check if root note is valid
                    if (!noteMap.hasOwnProperty(chord.root)) {
                        console.warn("Invalid root note in getChordNotePool:", chord.root);
                        return ['C3', 'E3', 'G3', 'C4', 'E4', 'G4']; // Return C major as fallback
                    }

                    const intervalMap = {
                        '1': { semitones: 0, octaveOffset: 0 },
                        'b2': { semitones: 1, octaveOffset: 0 },
                        '2': { semitones: 2, octaveOffset: 0 },
                        '#2': { semitones: 3, octaveOffset: 0 },
                        'b3': { semitones: 3, octaveOffset: 0 },
                        '3': { semitones: 4, octaveOffset: 0 },
                        '4': { semitones: 5, octaveOffset: 0 },
                        '#4': { semitones: 6, octaveOffset: 0 },
                        'b5': { semitones: 6, octaveOffset: 0 },
                        '5': { semitones: 7, octaveOffset: 0 },
                        '#5': { semitones: 8, octaveOffset: 0 },
                        'b6': { semitones: 8, octaveOffset: 0 },
                        '6': { semitones: 9, octaveOffset: 0 },
                        'b7': { semitones: 10, octaveOffset: 0 },
                        '7': { semitones: 11, octaveOffset: 0 },
                        'bb7': { semitones: 9, octaveOffset: 0 },
                        '9': { semitones: 2, octaveOffset: 1 },
                        'b9': { semitones: 1, octaveOffset: 1 },
                        '#9': { semitones: 3, octaveOffset: 1 },
                        '11': { semitones: 5, octaveOffset: 1 },
                        '#11': { semitones: 6, octaveOffset: 1 },
                        'b13': { semitones: 8, octaveOffset: 1 },
                        '13': { semitones: 9, octaveOffset: 1 }
                    };

                    // Get intervals safely
                    let intervals = [];
                    try {
                        intervals = this.getIntervalsForChordType(chord.type || 'major');
                    } catch (e) {
                        console.warn("Error getting intervals for chord type:", chord.type, e);
                        intervals = ['1', '3', '5']; // Default to major triad
                    }

                    // Add extensions based on chord properties
                    if (chord.b5) intervals.push('b5');
                    if (chord.s5) intervals.push('#5');
                    if (chord.b9) intervals.push('b9');
                    if (chord.s9) intervals.push('#9');
                    if (chord.s11) intervals.push('#11');
                    if (chord.b13) intervals.push('b13');

                    const notePool = [];

                    // Safely generate note pool
                    try {
                        intervals.forEach(interval => {
                            if (!(interval in intervalMap)) return;

                            const { semitones, octaveOffset } = intervalMap[interval];
                            const totalSemitones = noteMap[chord.root] + semitones;
                            const noteIndex = ((totalSemitones % 12) + 12) % 12;

                            // Find note name from index (prefer natural, then sharp)
                            const possibleNames = Object.keys(noteMap).filter(key => noteMap[key] === noteIndex);
                            const noteName = possibleNames.find(n => n.length === 1) || // Natural notes first (C, D, E...)
                                possibleNames.find(n => n.includes('#')) || // Then prefer sharps
                                possibleNames[0];                          // Fallback to first

                            if (!noteName) return; // Skip if no name found

                            // Generate notes across octaves 2 to 6
                            for (let oct = 2; oct <= 6; oct++) {
                                let noteOctave = oct + octaveOffset;
                                if (noteOctave >= 2 && noteOctave <= 6) {
                                    notePool.push(noteName + noteOctave);
                                }
                            }
                        });
                    } catch (e) {
                        console.error("Error generating note pool:", e);
                        // Add fallback notes
                        for (let oct = 2; oct <= 6; oct++) {
                            notePool.push('C' + oct, 'E' + oct, 'G' + oct);
                        }
                    }

                    return notePool.length > 0 ? notePool : ['C3', 'E3', 'G3', 'C4', 'E4', 'G4']; // Ensure pool is never empty
                },

                parseNote(note) {
                    const match = note.match(/^([A-G][#b]?)(\d+)$/);
                    if (!match) {
                        console.warn("Invalid note format:", note);
                        return { noteName: "C", octave: 4 }; // Safe default
                    }
                    return { noteName: match[1], octave: parseInt(match[2]) };
                },


                /**
                 * Converts a note string to its MIDI number with robust error handling.
                 * @param {string} note - Note string (e.g., 'C4', 'Eb3').
                 * @returns {number} MIDI number (e.g., 60 for 'C4').
                 */
                getMIDI(note) {
                    // Add defensive check for undefined or invalid input.
                    if (!note || typeof note !== 'string') {
                        console.warn('Invalid note passed to getMIDI:', note);
                        return 60; // Default to middle C (60) instead of crashing.
                    }
                    const { noteName, octave } = this.parseNote(note);
                    const noteMap = {
                        'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4,
                        'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9,
                        'A#': 10, 'Bb': 10, 'B': 11
                    };
                    const semitone = (noteMap[noteName] !== undefined) ? noteMap[noteName] : 0;
                    return 12 * (octave + 1) + semitone;
                },


                /**
                 * Finds the closest note in a pool to a previous note based on MIDI distance.
                 * Now with robust error handling.
                 * @param {string} prevNote - Previous note (e.g., 'C4').
                 * @param {string[]} pool - Array of note strings to choose from.
                 * @returns {string} Closest note from the pool.
                 */
                findClosestNote(prevNote, pool) {
                    // Defensive checks
                    if (!prevNote || typeof prevNote !== 'string') {
                        console.warn('Invalid previous note in findClosestNote:', prevNote);
                        return pool && pool.length > 0 ? pool[0] : 'C4';
                    }

                    if (!pool || !Array.isArray(pool) || pool.length === 0) {
                        console.warn('Invalid or empty pool in findClosestNote');
                        return 'C4'; // Return middle C as fallback
                    }

                    try {
                        const prevMIDI = this.getMIDI(prevNote);
                        let closestNote = pool[0];
                        let minDiff = Math.abs(this.getMIDI(pool[0]) - prevMIDI);

                        for (let i = 1; i < pool.length; i++) {
                            if (typeof pool[i] !== 'string') continue; // Skip invalid notes

                            const diff = Math.abs(this.getMIDI(pool[i]) - prevMIDI);
                            if (diff < minDiff) {
                                minDiff = diff;
                                closestNote = pool[i];
                            }
                        }

                        return closestNote;
                    } catch (e) {
                        console.error("Error in findClosestNote:", e);
                        return pool[0]; // Return first note in pool as fallback
                    }
                },
                /**
                 * Adjusts the octave of a note to minimize movement from a previous note.
                 * @param {string} note - The note to adjust (e.g., 'C3').
                 * @param {string} prevNote - The previous note (e.g., 'C4').
                 * @returns {string} The adjusted note with the optimal octave.
                 */
                adjustOctaveForSmoothness(note, prevNote) {
                    // Parse both notes using the helper.
                    const { noteName: base, octave: currentOct } = this.parseNote(note);
                    const { octave: prevOct } = this.parseNote(prevNote);
                    const prevPitch = this.getNoteIndex(this.parseNote(prevNote).noteName) + prevOct * 12;
                    let bestOct = currentOct;
                    let bestDiff = Math.abs((this.getNoteIndex(base) + currentOct * 12) - prevPitch);
                    for (let delta = -2; delta <= 2; delta++) {
                        const trialOct = currentOct + delta;
                        const trialPitch = this.getNoteIndex(base) + trialOct * 12;
                        const diff = Math.abs(trialPitch - prevPitch);
                        if (diff < bestDiff) {
                            bestDiff = diff;
                            bestOct = trialOct;
                        }
                    }
                    bestOct = Math.max(0, Math.min(8, bestOct)); // Clamp octave between 0 and 8.
                    return base + bestOct;
                },

                /**
                 * Applies voice-leading by selecting the closest notes and adjusting octaves for smoothness.
                 * @param {string[]} newNotes - Array of note strings for the new chord.
                 * @returns {string[]} Adjusted notes for voice-leading.
                 */
                applyVoiceLeading(newNotes) {
                    if (!this.previousVoicing || this.previousVoicing.length === 0) {
                        this.previousVoicing = newNotes.slice();
                        return newNotes;
                    }

                    // Select closest notes based on previous voicing
                    const pool = this.getChordNotePool(this.editingChord);
                    const adjustedNotes = this.previousVoicing.map(prevNote => this.findClosestNote(prevNote, pool));

                    // Adjust octaves for smoothness
                    const finalNotes = adjustedNotes.map((note, i) => this.adjustOctaveForSmoothness(note, this.previousVoicing[i]));

                    this.previousVoicing = finalNotes.slice();
                    return finalNotes;
                },

                showAudioError(message, button, errorContainer) {
                    // Display error and reset button
                    errorContainer.innerText = message;
                    errorContainer.style.display = 'block';
                    button.disabled = false;
                    button.innerText = 'Try Again';
                },

                initTone() {
                    // Start the audio context (Tone.js convenience method)
                    Tone.start();

                    // Create a polyphonic synth with higher polyphony
                    this.synth = new Tone.PolySynth(Tone.Synth, {
                        maxPolyphony: 128, // ensure we can play large chords
                        oscillator: {
                            type: "triangle"
                        },
                        envelope: {
                            attack: 0.02,
                            decay: 0.1,
                            sustain: 0.8,
                            release: 1.5
                        }
                    }).toDestination();

                    // Set the synth volume based on the user's volume setting
                    this.synth.volume.value = Tone.gainToDb(this.volume);

                    // Create and connect a reverb effect
                    this.reverb_effect = new Tone.Reverb(2.5).toDestination();
                    this.synth.connect(this.reverb_effect);
                    this.reverb_effect.wet.value = this.reverb;
                },

                // Initialize all the sections' sortable functionality
                initSortable() {
                    try {
                        // For each section, initialize sortable for chord cards
                        this.currentProgression.sections.forEach((section, index) => {
                            this.initSectionSortable(index);
                        });
                    } catch (error) {
                        console.error("Error initializing sortable:", error);
                    }
                },

                // Initialize sortable for a specific section
                initSectionSortable(sectionIndex) {
                    // Initialize sortable with a slight delay to ensure DOM is ready
                    setTimeout(() => {
                        try {
                            const el = document.getElementById('chords-container-' + sectionIndex);
                            if (el) {
                                new Sortable(el, {
                                    animation: 150,
                                    ghostClass: 'sortable-ghost',
                                    onEnd: (evt) => {
                                        try {
                                            // Update the chord order in the data model
                                            const chords = [...this.currentProgression.sections[sectionIndex].chords];
                                            const movedChord = chords.splice(evt.oldIndex, 1)[0];
                                            chords.splice(evt.newIndex, 0, movedChord);
                                            this.currentProgression.sections[sectionIndex].chords = chords;
                                        } catch (e) {
                                            console.error("Error in sortable onEnd handler:", e);
                                        }
                                    }
                                });
                            }
                        } catch (e) {
                            console.error("Error setting up sortable for section", sectionIndex, ":", e);
                        }
                    }, 100);
                },

                initTooltips() {
                    // Initialize tooltips with Tippy.js
                    tippy('[data-tippy-content]', {
                        animation: 'scale',
                        theme: 'light'
                    });
                },

                // UI Utilities
                isModalOpen() {
                    return this.showEditChordModal ||
                        this.showImportModal ||
                        this.showSettingsModal ||
                        this.showHelpModal ||
                        this.showNameEditModal ||
                        this.showAnnotationModal;
                },

                closeAllModals() {
                    this.showEditChordModal = false;
                    this.showImportModal = false;
                    this.showSettingsModal = false;
                    this.showHelpModal = false;
                    this.showNameEditModal = false;
                    this.showAnnotationModal = false;
                },

                toggleChordPalette() {
                    this.showChordPalette = !this.showChordPalette;
                },

                applyTheme() {
                    document.documentElement.setAttribute('data-theme', this.theme);
                },

                // Chord Palette Functions
                setChordCategory(category) {
                    this.activeChordCategory = category;
                    this.filterChordPalette();
                },

                filterChordPalette() {
                    // Filter chord types based on category and search query
                    this.filteredChordTypes = {};

                    Object.entries(this.chordTypes).forEach(([category, chords]) => {
                        // Filter by category
                        let shouldIncludeCategory = false;

                        if (this.activeChordCategory === 'basic') {
                            shouldIncludeCategory = ['Basic', 'Seventh Chords'].includes(category);
                        } else if (this.activeChordCategory === 'jazz') {
                            shouldIncludeCategory = ['Seventh Chords', 'Extended Chords', 'Jazz Voicings'].includes(category);
                        } else if (this.activeChordCategory === 'extended') {
                            shouldIncludeCategory = ['Extended Chords', 'Altered Chords', 'Jazz Voicings'].includes(category);
                        }

                        if (shouldIncludeCategory) {
                            // Filter by search query
                            const searchQuery = this.chordSearchQuery.toLowerCase();
                            const filteredChords = searchQuery ?
                                chords.filter(chord =>
                                    chord.name.toLowerCase().includes(searchQuery) ||
                                    chord.suffix.toLowerCase().includes(searchQuery)) :
                                chords;

                            if (filteredChords.length > 0) {
                                this.filteredChordTypes[category] = filteredChords;
                            }
                        }
                    });
                },

                // Chord Handling
                addChordToProgression(chord) {
                    const chordTypeInfo = this.getChordTypeFromSuffix(chord.suffix);
                    const intervals = this.getIntervalsForChordType(chordTypeInfo.type);
                    if (chordTypeInfo.b5) intervals.push('b5');
                    if (chordTypeInfo.s5) intervals.push('#5');
                    if (chordTypeInfo.b9) intervals.push('b9');
                    if (chordTypeInfo.s9) intervals.push('#9');
                    if (chordTypeInfo.s11) intervals.push('#11');
                    if (chordTypeInfo.b13) intervals.push('b13');
                    const notes = this.generateChordNotes(this.selectedRoot, intervals);
                    const newChord = {
                        name: this.selectedRoot + chord.suffix,
                        root: this.selectedRoot,
                        type: chordTypeInfo.type,
                        bass: "",
                        notes: notes,
                        annotation: "",
                        voicingStyle: "close",
                        baseOctave: 3,
                        octaveSpan: 2,
                        density: notes.length,
                        ...chordTypeInfo
                    };

                    if (this.currentProgression.sections.length > 0) {
                        const lastSectionIndex = this.currentProgression.sections.length - 1;
                        this.currentProgression.sections[lastSectionIndex].chords.push(newChord);
                        this.playChord(newChord);
                    } else {
                        this.createNewSection();
                        this.currentProgression.sections[0].chords.push(newChord);
                        this.playChord(newChord);
                    }
                },

                getChordTypeFromSuffix(suffix) {
                    // Map suffixes to chord types
                    const suffixMap = {
                        '': 'major',
                        'm': 'minor',
                        'dim': 'dim',
                        'aug': 'aug',
                        'sus4': 'sus4',
                        'sus2': 'sus2',
                        '6': '6',
                        'm6': 'm6',
                        'maj7': 'maj7',
                        '7': '7',
                        'm7': 'm7',
                        'mMaj7': 'mMaj7',
                        'm7b5': 'm7b5',
                        'dim7': 'dim7',
                        'aug7': 'aug7',
                        'augMaj7': 'augMaj7',
                        'maj9': 'maj9',
                        '9': '9',
                        'm9': 'm9',
                        '11': '11',
                        'm11': 'm11',
                        '13': '13',
                        'maj13': 'maj13',
                        'm13': 'm13',
                        '7b9': '7',
                        '7#9': '7',
                        '7#11': '7',
                        '7b13': '7',
                        '7b5': '7',
                        '7#5': '7',
                        '7alt': 'alt',
                        'maj7#11': 'maj7',
                        'm9b5': 'm9',
                        '9sus4': '9sus4',
                        '13sus4': '13sus4',
                        '7b9sus4': '7sus4',
                        'm6/9': 'm6',
                        '6/9': '6'
                    };
                    const baseType = suffixMap[suffix] || 'major';
                    const alterations = {};
                    if (suffix.includes('b5')) alterations.b5 = true;
                    if (suffix.includes('#5')) alterations.s5 = true;
                    if (suffix.includes('b9')) alterations.b9 = true;
                    if (suffix.includes('#9')) alterations.s9 = true;
                    if (suffix.includes('#11')) alterations.s11 = true;
                    if (suffix.includes('b13')) alterations.b13 = true;
                    return { type: baseType, ...alterations };
                },

                /**
                 * Generates chord notes from root and intervals.
                 * @param {string} root - Root note (e.g., 'C', 'F#').
                 * @param {string[]} intervals - Array of interval names (e.g., ['1', '3', '5']).
                 * @param {number} [baseOct=3] - Base octave for generated notes.
                 * @returns {string[]} Array of note strings (e.g., ['C3', 'E3', 'G3']).
                 */
                generateChordNotes(root, intervals, baseOct = 3) {
                    // Convert scale degree intervals to actual notes
                    const noteMap = {
                        'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4,
                        'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9,
                        'A#': 10, 'Bb': 10, 'B': 11
                    };

                    if (!(root in noteMap))
                        throw new Error("Invalid root note: " + root);
                    if (!Array.isArray(intervals))
                        throw new Error("Intervals must be an array");

                    // Use the provided baseOct parameter or default to 3
                    const baseOctave = baseOct;

                    // Interval mapping: Each key maps to its semitone offset and octave offset.
                    // Base chord tones (octaveOffset: 0)
                    const intervalMap = {
                        '1': { semitones: 0, octaveOffset: 0 },
                        'b2': { semitones: 1, octaveOffset: 0 },
                        '2': { semitones: 2, octaveOffset: 0 },
                        'sus2': { semitones: 2, octaveOffset: 0 },
                        '#2': { semitones: 3, octaveOffset: 0 }, // enharmonic with b3
                        'b3': { semitones: 3, octaveOffset: 0 },
                        '3': { semitones: 4, octaveOffset: 0 },
                        'maj3': { semitones: 4, octaveOffset: 0 },
                        'min3': { semitones: 3, octaveOffset: 0 }, // synonym for b3
                        '4': { semitones: 5, octaveOffset: 0 },
                        'sus4': { semitones: 5, octaveOffset: 0 },
                        '#4': { semitones: 6, octaveOffset: 0 }, // same as b5
                        'b5': { semitones: 6, octaveOffset: 0 },
                        '5': { semitones: 7, octaveOffset: 0 },
                        'aug5': { semitones: 8, octaveOffset: 0 },
                        '#5': { semitones: 8, octaveOffset: 0 },
                        'b6': { semitones: 8, octaveOffset: 0 }, // minor sixth, same pitch as #5
                        '6': { semitones: 9, octaveOffset: 0 },
                        'maj6': { semitones: 9, octaveOffset: 0 },
                        'b7': { semitones: 10, octaveOffset: 0 },
                        'min7': { semitones: 10, octaveOffset: 0 },
                        '7': { semitones: 11, octaveOffset: 0 },
                        'maj7': { semitones: 11, octaveOffset: 0 },
                        'bb7': { semitones: 9, octaveOffset: 0 }, // double-flat 7

                        // Extended chord tones (typically played one octave higher: octaveOffset: 1)
                        '9': { semitones: 2, octaveOffset: 1 },
                        'maj9': { semitones: 2, octaveOffset: 1 },
                        'b9': { semitones: 1, octaveOffset: 1 },
                        'min9': { semitones: 1, octaveOffset: 1 },
                        '#9': { semitones: 3, octaveOffset: 1 },
                        '11': { semitones: 5, octaveOffset: 1 },
                        'maj11': { semitones: 5, octaveOffset: 1 },
                        '#11': { semitones: 6, octaveOffset: 1 },
                        'b13': { semitones: 8, octaveOffset: 1 },
                        '13': { semitones: 9, octaveOffset: 1 },
                        'maj13': { semitones: 9, octaveOffset: 1 },
                        'min13': { semitones: 8, octaveOffset: 1 }
                    };

                    // Map each interval to its corresponding note string
                    return intervals.map(interval => {
                        if (!(interval in intervalMap))
                            throw new Error("Unrecognized interval: " + interval);

                        const { semitones, octaveOffset } = intervalMap[interval];

                        // Calculate total semitones from root and derive note index and octave
                        const totalSemitones = noteMap[root] + semitones;
                        let noteOctave = baseOctave + Math.floor(totalSemitones / 12) + octaveOffset;
                        noteOctave = Math.min(Math.max(noteOctave, 0), 8); // Clamp octave range
                        noteOctave = Math.max(0, Math.min(8, noteOctave))

                        const noteIndex = ((totalSemitones % 12) + 12) % 12;

                        // Reverse lookup for note name using the noteMap
                        // Find the appropriate note name (prefer sharps by default)
                        const noteNames = Object.keys(noteMap).filter(key => noteMap[key] === noteIndex);
                        const noteName = noteNames.find(name => name.length === 1) || // Prefer naturals (C, D, E, etc.)
                            noteNames.find(name => name.includes('#')) || // Then prefer sharps (C#, D#, etc.)
                            noteNames[0]; // Fallback to first available

                        return noteName ? noteName + noteOctave : null;
                    }).filter(n => n !== null);
                },

                addCustomChord() {
                    // Determine the chord type and alterations
                    let type = this.customChord.type;
                    let alterations = [];

                    if (this.customChord.b5) alterations.push('b5');
                    if (this.customChord.s5) alterations.push('#5');
                    if (this.customChord.b9) alterations.push('b9');
                    if (this.customChord.s9) alterations.push('#9');
                    if (this.customChord.s11) alterations.push('#11');
                    if (this.customChord.b13) alterations.push('b13');

                    // Generate chord name
                    let name = this.customChord.root;

                    // Add type suffix
                    switch (type) {
                        case 'major': break; // No suffix for major
                        case 'minor': name += 'm'; break;
                        case 'dim': name += 'dim'; break;
                        case 'aug': name += 'aug'; break;
                        case 'sus4': name += 'sus4'; break;
                        default: name += type; break;
                    }

                    // Add alterations in parentheses if any
                    if (alterations.length > 0) {
                        name += '(' + alterations.join(',') + ')';
                    }

                    // Add bass note for slash chords
                    if (this.customChord.bass && this.customChord.bass !== this.customChord.root) {
                        name += '/' + this.customChord.bass;
                    }

                    // Generate notes for the chord
                    const intervals = this.getIntervalsForChordType(type);
                    let notes = this.generateChordNotes(this.customChord.root, intervals);

                    // Add bass note as the lowest note if specified
                    if (this.customChord.bass && this.customChord.bass !== this.customChord.root) {
                        notes.unshift(this.customChord.bass + '2');
                    }

                    // Create the chord object
                    const newChord = {
                        name: name,
                        root: this.customChord.root,
                        type: type,
                        bass: this.customChord.bass,
                        notes: notes,
                        annotation: "",
                        voicingStyle: "close",
                        baseOctave: 3,
                        octaveSpan: 2,
                        density: intervals.length,
                        ...Object.fromEntries(
                            ['b5', 's5', 'b9', 's9', 's11', 'b13'].map(
                                key => [key, this.customChord[key]]
                            )
                        )
                    };

                    // Add to the last section
                    if (this.currentProgression.sections.length > 0) {
                        const lastSectionIndex = this.currentProgression.sections.length - 1;
                        this.currentProgression.sections[lastSectionIndex].chords.push(newChord);

                        // Play the chord
                        this.playChord(newChord);
                    } else {
                        this.createNewSection();
                        this.currentProgression.sections[0].chords.push(newChord);
                        this.playChord(newChord);
                    }

                    // Reset the custom chord form
                    this.resetCustomChordForm();
                },

                resetCustomChordForm() {
                    this.customChord = {
                        root: this.customChord.root,
                        type: "major",
                        b5: false,
                        s5: false,
                        b9: false,
                        s9: false,
                        s11: false,
                        b13: false,
                        bass: ""
                    };
                },

                getIntervalsForChordType(type) {
                    // Map chord types to interval structures
                    const intervalMap = {
                        'major': ['1', '3', '5'],
                        'minor': ['1', 'b3', '5'],
                        'dim': ['1', 'b3', 'b5'],
                        'aug': ['1', '3', '#5'],
                        'sus4': ['1', '4', '5'],
                        'sus2': ['1', '2', '5'],
                        '6': ['1', '3', '5', '6'],
                        'm6': ['1', 'b3', '5', '6'],
                        '7': ['1', '3', '5', 'b7'],
                        'maj7': ['1', '3', '5', '7'],
                        'm7': ['1', 'b3', '5', 'b7'],
                        'dim7': ['1', 'b3', 'b5', 'bb7'],
                        'aug7': ['1', '3', '#5', 'b7'],
                        'm7b5': ['1', 'b3', 'b5', 'b7'],
                        '9': ['1', '3', '5', 'b7', '9'],
                        'maj9': ['1', '3', '5', '7', '9'],
                        'm9': ['1', 'b3', '5', 'b7', '9'],
                        '11': ['1', '3', '5', 'b7', '9', '11'],
                        '13': ['1', '3', '5', 'b7', '9', '11', '13'],
                        'alt': ['1', '3', 'b5', 'b7', 'b9', '#9']
                    };

                    return intervalMap[type] || ['1', '3', '5']; // Default to major triad
                },

                // Helper method to ensure the audio context is running
                ensureAudioContextRunning() {
                    if (!Tone.context || Tone.context.state !== 'running') {
                        return Tone.start().then(() => {
                            console.log("Audio context started");
                        }).catch(e => {
                            console.error("Failed to start audio context:", e);
                            throw e;
                        });
                    }
                    return Promise.resolve();
                },

                /**
      * Simple and reliable playChord function
      */
                playChord(chord) {
                    if (!this.synth || !Tone.context) {
                        console.warn("Cannot play chord - audio not initialized yet");
                        return;
                    }

                    if (!chord || !chord.notes || !Array.isArray(chord.notes) || chord.notes.length === 0) {
                        console.warn("Invalid chord for playback:", chord);
                        return;
                    }

                    try {
                        // Filter and validate notes
                        const validNotes = chord.notes.filter(note =>
                            typeof note === 'string' && /^[A-G][#b]?[0-9]$/.test(note)
                        );

                        if (validNotes.length === 0) {
                            console.warn("No valid notes to play in chord:", chord.notes);
                            return;
                        }

                        // IMPORTANT: Special handling for the notorious Gmaj9 chord
                        if (validNotes.includes('G2') && validNotes.includes('B2') && validNotes.includes('D3')) {
                            console.log("Detected problematic Gmaj9 chord - applying special handling");

                            // Just a very minimal intervention - slightly longer duration
                            this.synth.triggerAttackRelease(validNotes, 0.6);
                        } else {
                            // Play normally
                            this.synth.triggerAttackRelease(validNotes, 0.5);
                        }
                    } catch (err) {
                        console.error("Error playing chord:", err);
                    }
                },


                previewChord(event, chord) {
                    // If you already use Alpines @click.stop, you can omit the next line.
                    // event.stopPropagation();
                    // Create a temporary chord with the selected root.
                    const tempChord = {
                        notes: this.generateChordNotes(this.selectedRoot, chord.notes)
                    };
                    // Play the chord.
                    this.playChord(tempChord);
                },

                previewEditingChord() {
                    this.playChord(this.editingChord);
                },

                // Section Management
                createNewSection() {
                    const newSection = {
                        name: "Section " + String.fromCharCode(65 + this.currentProgression.sections.length), // A, B, C, etc.
                        chords: [],
                        collapsed: false,
                        annotation: ""
                    };

                    this.currentProgression.sections.push(newSection);

                    // Initialize sortable for the new section
                    setTimeout(() => {
                        this.initSectionSortable(this.currentProgression.sections.length - 1);
                    }, 100);
                },

                toggleSectionCollapse(sectionIndex) {
                    this.currentProgression.sections[sectionIndex].collapsed =
                        !this.currentProgression.sections[sectionIndex].collapsed;
                },

                startEditSectionName(sectionIndex) {
                    // Set editing state
                    this.currentProgression.sections[sectionIndex].isEditingName = true;
                    this.currentProgression.sections[sectionIndex].editNameValue =
                        this.currentProgression.sections[sectionIndex].name;
                },

                saveSectionName(sectionIndex) {
                    // Save the edited name
                    this.currentProgression.sections[sectionIndex].name =
                        this.currentProgression.sections[sectionIndex].editNameValue;

                    // Exit editing state
                    this.currentProgression.sections[sectionIndex].isEditingName = false;
                },

                duplicateSection(sectionIndex) {
                    // Create a deep copy of the section
                    const sectionCopy = JSON.parse(JSON.stringify(this.currentProgression.sections[sectionIndex]));
                    sectionCopy.name += " (Copy)";

                    // Insert after the original
                    this.currentProgression.sections.splice(sectionIndex + 1, 0, sectionCopy);

                    // Initialize sortable for the new section
                    setTimeout(() => {
                        this.initSectionSortable(sectionIndex + 1);
                    }, 100);
                },

                moveSectionUp(sectionIndex) {
                    if (sectionIndex > 0) {
                        const sections = [...this.currentProgression.sections];
                        const temp = sections[sectionIndex];
                        sections[sectionIndex] = sections[sectionIndex - 1];
                        sections[sectionIndex - 1] = temp;
                        this.currentProgression.sections = sections;
                    }
                },

                moveSectionDown(sectionIndex) {
                    if (sectionIndex < this.currentProgression.sections.length - 1) {
                        const sections = [...this.currentProgression.sections];
                        const temp = sections[sectionIndex];
                        sections[sectionIndex] = sections[sectionIndex + 1];
                        sections[sectionIndex + 1] = temp;
                        this.currentProgression.sections = sections;
                    }
                },

                deleteSection(sectionIndex) {
                    if (confirm("Are you sure you want to delete this section?")) {
                        this.currentProgression.sections.splice(sectionIndex, 1);
                    }
                },

                addChordToSection(sectionIndex) {
                    // Open chord palette on mobile if it's not already open
                    if (!this.showChordPalette && window.innerWidth < 768) {
                        this.showChordPalette = true;
                    }

                    // Add a basic C major chord as a placeholder
                    const newChord = {
                        name: "Cmaj7",
                        root: "C",
                        type: "maj7",
                        bass: "",
                        notes: ['C3', 'E3', 'G3', 'B3'],
                        annotation: "",
                        voicingStyle: "close",
                        baseOctave: 3,
                        octaveSpan: 2,
                        density: 4
                    };

                    this.currentProgression.sections[sectionIndex].chords.push(newChord);

                    // Edit the chord right away
                    setTimeout(() => {
                        this.editChord(sectionIndex, this.currentProgression.sections[sectionIndex].chords.length - 1);
                    }, 100);
                },

                // Chord Editing
                editChord(sectionIndex, chordIndex) {
                    // Store the indices
                    this.editingSectionIndex = sectionIndex;
                    this.editingChordIndex = chordIndex;

                    // Make a deep copy of the chord to edit
                    this.editingChord = JSON.parse(
                        JSON.stringify(this.currentProgression.sections[sectionIndex].chords[chordIndex])
                    );

                    // Set defaults for properties that might not exist in older chord objects
                    if (!this.editingChord.voicingStyle) this.editingChord.voicingStyle = "close";
                    if (!this.editingChord.baseOctave) this.editingChord.baseOctave = 3;
                    if (!this.editingChord.octaveSpan) this.editingChord.octaveSpan = 2;
                    if (!this.editingChord.density) this.editingChord.density = this.editingChord.notes.length;
                    if (!this.editingChord.tensions) this.editingChord.tensions = [];

                    // Switch to edit tab
                    this.editChordTab = 'basic';

                    // Open the modal
                    this.showEditChordModal = true;
                },

                cancelEditChord() {
                    this.showEditChordModal = false;
                },

                saveEditedChord() {
                    // Update the chord name based on parameters
                    this.editingChord.name = this.getChordDisplayName(this.editingChord);

                    // Save the edited chord back to the progression
                    this.currentProgression.sections[this.editingSectionIndex].chords[this.editingChordIndex] =
                        JSON.parse(JSON.stringify(this.editingChord));

                    // Close the modal
                    this.showEditChordModal = false;

                    // Play the updated chord
                    this.playChord(this.editingChord);
                },

                updateEditingChordFromType() {
                    // Update chord intervals based on selected type
                    const intervals = this.getIntervalsForChordType(this.editingChord.type);

                    // Regenerate notes
                    this.regenerateChordNotes();
                },

                /**
                 * Regenerates the notes for the editing chord based on its properties, incorporating voice-leading and tension handling.
                 */
                regenerateChordNotes() {
                    // Get base intervals for the chord type (assumes getIntervalsForChordType exists)
                    const baseIntervals = this.getIntervalsForChordType(this.editingChord.type);

                    // Add extensions based on density and tensions
                    let intervals = [...baseIntervals];

                    // Limit the number of notes based on density setting
                    intervals = intervals.slice(0, this.editingChord.density);

                    // Add tensions if specified
                    if (this.editingChord.tensions) {
                        this.editingChord.tensions.forEach(tension => {
                            if (tension === 'add9' && !intervals.includes('9')) intervals.push('9');
                            if (tension === 'add11' && !intervals.includes('11')) intervals.push('11');
                            if (tension === 'add13' && !intervals.includes('13')) intervals.push('13');
                            if (tension === 'addb9' && !intervals.includes('b9')) intervals.push('b9');
                        });
                    }

                    // For altered chords, drop redundant tensions if both conflicting flags are true
                    if (this.editingChord.type === 'alt') {
                        if (this.editingChord.b5 && this.editingChord.s5) {
                            // Prefer '#5' over 'b5'
                            this.editingChord.b5 = false;
                        }
                        if (this.editingChord.b9 && this.editingChord.s9) {
                            // Prefer 'b9' over '#9'
                            this.editingChord.s9 = false;
                        }
                    }

                    // Apply alterations
                    if (this.editingChord.b5) {
                        const idx = intervals.indexOf('5');
                        if (idx !== -1) intervals[idx] = 'b5';
                    }
                    if (this.editingChord.s5) {
                        const idx = intervals.indexOf('5');
                        if (idx !== -1) intervals[idx] = '#5';
                    }

                    // Generate the actual notes (assumes generateChordNotes exists)
                    let notes = this.generateChordNotes(this.editingChord.root, intervals);

                    // Apply voicing style (assumes applyVoicingStyle exists)
                    notes = this.applyVoicingStyle(notes, this.editingChord.voicingStyle);

                    // Apply octave range with limitation for smaller chords
                    notes = this.applyOctaveRange(notes, parseInt(this.editingChord.baseOctave), parseInt(this.editingChord.octaveSpan));

                    // Apply voice-leading for smoother transitions
                    notes = this.applyVoiceLeading(notes);

                    // Add bass note for slash chords
                    if (this.editingChord.bass && this.editingChord.bass !== this.editingChord.root) {
                        notes = notes.filter(note => !note.startsWith(this.editingChord.bass));
                        notes.unshift(this.editingChord.bass + (parseInt(this.editingChord.baseOctave) - 1));
                    }

                    // Update the notes in the editing chord
                    this.editingChord.notes = notes;
                },

                applyVoicingStyle(notes, style) {
                    // Apply different voicing styles to the chord
                    const noteObjects = notes.map(note => {
                        const noteName = note.slice(0, -1);
                        const octave = parseInt(note.slice(-1));
                        return { name: noteName, octave: octave };
                    });

                    // Sort by pitch
                    noteObjects.sort((a, b) => {
                        const aIndex = this.getNoteIndex(a.name);
                        const bIndex = this.getNoteIndex(b.name);
                        return (a.octave * 12 + aIndex) - (b.octave * 12 + bIndex);
                    });

                    // Apply the selected voicing style
                    let revoiced = [...noteObjects];

                    if (style === 'drop2' && noteObjects.length >= 4) {
                        // Drop 2 voicing: move the second highest note down an octave
                        revoiced[revoiced.length - 2].octave -= 1;
                    } else if (style === 'open') {
                        // Open voicing: spread out the notes by alternating octaves
                        for (let i = 1; i < revoiced.length; i += 2) {
                            revoiced[i].octave += 1;
                        }
                    } else if (style === 'spread') {
                        // Spread voicing: gradually increase octaves
                        for (let i = 1; i < revoiced.length; i++) {
                            revoiced[i].octave += Math.floor(i / 2);
                        }
                    } else if (style === 'quartal') {
                        // Quartal voicing: rearrange notes to be in fourths where possible
                        // This is a simplification - proper quartal voicing would require more complex reharmonization
                        revoiced.sort((a, b) => {
                            const aIndex = this.getNoteIndex(a.name);
                            const bIndex = this.getNoteIndex(b.name);
                            // Try to arrange notes in 4ths (5 semitones)
                            const diff = (bIndex - aIndex + 12) % 12;
                            return Math.abs(diff - 5);
                        });
                    } else if (style === 'cluster') {
                        // Cluster voicing: put everything close together
                        for (let i = 0; i < revoiced.length; i++) {
                            revoiced[i].octave = Math.floor(i / 3) + 3;
                        }
                    }

                    // Convert back to note strings
                    return revoiced.map(note => note.name + note.octave);
                },

                /**
                 * Adjusts the octave range of the notes, limiting the span for smaller chords.
                 * @param {string[]} notes - Array of note strings (e.g., ['C4', 'E4', 'G4']).
                 * @param {number} baseOctave - The base octave (e.g., 3).
                 * @param {number} span - The desired octave span (e.g., 2).
                 * @returns {string[]} Adjusted notes with controlled octave range.
                 */
                applyOctaveRange(notes, baseOctave, span) {
                    const noteObjects = notes.map(note => {
                        const noteName = note.slice(0, -1);
                        const octave = parseInt(note.slice(-1));
                        return { name: noteName, octave };
                    });

                    // Limit voicing range for chords with 4 or fewer notes
                    let effectiveSpan = span;
                    if (noteObjects.length <= 4) {
                        effectiveSpan = Math.min(span, 2); // Cap at 2 octaves for smaller chords
                    }

                    // Distribute notes across the effective span
                    for (let i = 0; i < noteObjects.length; i++) {
                        let newOctave = baseOctave + Math.floor((i * effectiveSpan) / noteObjects.length);
                        newOctave = Math.max(0, Math.min(8, newOctave)); // Clamp between 0 and 8
                        noteObjects[i].octave = newOctave;
                    }

                    return noteObjects.map(note => note.name + note.octave);
                },

                /**
                 * Gets the semitone index of a note name (without octave).
                 * @param {string} noteName - Note name (e.g., 'C', 'Eb').
                 * @returns {number} Semitone index (0-11).
                 */
                getNoteIndex(noteName) {
                    // Expanded noteMap to handle all flats and sharps
                    const noteMap = {
                        'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4,
                        'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9,
                        'A#': 10, 'Bb': 10, 'B': 11
                    };

                    return (noteMap[noteName] !== undefined) ? noteMap[noteName] : 0;
                },

                // Piano keyboard note management
                getBlackKeyPosition(note) {
                    // Calculate position for black keys on the piano keyboard
                    const noteName = note.slice(0, -1);
                    const whiteKeyWidth = 30;
                    const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

                    // Map black keys to their position relative to white keys
                    const blackKeyPositions = {
                        'C#': 0.7,
                        'D#': 1.7,
                        'F#': 3.7,
                        'G#': 4.7,
                        'A#': 5.7
                    };

                    return blackKeyPositions[noteName] * whiteKeyWidth;
                },

                isNoteInChord(note) {
                    // Check if a note is in the editing chord
                    const noteName = note.slice(0, -1);
                    const noteOctave = note.slice(-1);

                    return this.editingChord.notes.some(chordNote => {
                        const chordNoteName = chordNote.slice(0, -1);
                        const chordNoteOctave = chordNote.slice(-1);
                        return chordNoteName === noteName && chordNoteOctave === noteOctave;
                    });
                },

                toggleNoteInChord(note) {
                    if (this.isNoteInChord(note)) {
                        this.removeNoteFromChord(
                            this.editingChord.notes.findIndex(n => n === note)
                        );
                    } else {
                        this.editingChord.notes.push(note);

                        // Play the note
                        this.synth.triggerAttackRelease([note], "8n");
                    }
                },

                removeNoteFromChord(index) {
                    this.editingChord.notes.splice(index, 1);
                },

                addNoteToChord() {
                    const newNote = this.newNoteToAdd + this.newNoteOctave;

                    if (!this.editingChord.notes.includes(newNote)) {
                        this.editingChord.notes.push(newNote);

                        // Play the note
                        this.synth.triggerAttackRelease([newNote], "8n");
                    }
                },

                sortChordNotes() {
                    // Sort notes by pitch
                    this.editingChord.notes.sort((a, b) => {
                        const aNoteName = a.slice(0, -1);
                        const aOctave = parseInt(a.slice(-1));
                        const bNoteName = b.slice(0, -1);
                        const bOctave = parseInt(b.slice(-1));

                        const aIndex = this.getNoteIndex(aNoteName);
                        const bIndex = this.getNoteIndex(bNoteName);

                        return (aOctave * 12 + aIndex) - (bOctave * 12 + bIndex);
                    });
                },

                // Chord Display Functions
                getChordDisplayName(chord) {
                    if (!chord || typeof chord !== 'object') {
                        return "";
                    }

                    try {
                        // Handle case where chord might be a proxy object
                        let root = chord.root;
                        let type = chord.type;
                        let bass = chord.bass;
                        let b5 = chord.b5;
                        let s5 = chord.s5;
                        let b9 = chord.b9;
                        let s9 = chord.s9;
                        let s11 = chord.s11;
                        let b13 = chord.b13;

                        if (!root) {
                            return chord.name || "";
                        }

                        let name = root;

                        // Add chord type
                        switch (type) {
                            case 'major': break; // Major has no suffix
                            case 'minor': name += 'm'; break;
                            case 'dim': name += 'dim'; break;
                            case 'aug': name += 'aug'; break;
                            case 'sus4': name += 'sus4'; break;
                            default:
                                if (type) name += type;
                                break;
                        }

                        // Add alterations if any
                        let alterations = [];
                        if (b5) alterations.push('b5');
                        if (s5) alterations.push('#5');
                        if (b9) alterations.push('b9');
                        if (s9) alterations.push('#9');
                        if (s11) alterations.push('#11');
                        if (b13) alterations.push('b13');

                        if (alterations.length > 0) {
                            name += '(' + alterations.join(',') + ')';
                        }

                        // Add bass note for slash chords
                        if (bass && bass !== root) {
                            name += '/' + bass;
                        }

                        return name;
                    } catch (e) {
                        console.error("Error generating chord display name:", e);
                        return chord.name || "";
                    }
                },

                formatChordNotes(notes) {
                    if (!notes || !Array.isArray(notes)) return '';

                    // Format notes for display, removing octave numbers
                    try {
                        return notes.map(note => note.slice(0, -1)).join(', ');
                    } catch (e) {
                        console.error("Error formatting chord notes:", e, notes);
                        return '';
                    }
                },

                /**
                 * Toggles between play and pause states.
                 */
                togglePlay() {
                    if (this.isPlaying) {
                        this.stopPlayback();
                    } else {
                        this.startPlayback();
                    }
                },


                /**
                 * Modified startPlayback function with voice leading
                 */
                async startPlayback() {
                    // First, stop any current playback
                    this.stopPlayback();

                    if (!this.synth) {
                        console.warn("Cannot start playback - audio not initialized yet");
                        alert("Please enable audio first by clicking the 'Enable Audio' button");
                        return;
                    }

                    try {
                        // Start audio context and wait for it to be ready
                        await Tone.start();
                        console.log("Audio context started for playback");

                        // Flatten all chords
                        const allChords = [];
                        this.currentProgression.sections.forEach((section, sectionIndex) => {
                            if (section.chords && Array.isArray(section.chords)) {
                                section.chords.forEach((chord, chordIndex) => {
                                    allChords.push({
                                        chord: chord,
                                        sectionIndex: sectionIndex,
                                        chordIndex: chordIndex,
                                        sectionName: section.name || `Section ${sectionIndex + 1}`
                                    });
                                });
                            }
                        });

                        if (allChords.length === 0) {
                            console.warn("No chords to play");
                            return;
                        }

                        // Reset voice leading state
                        this.voiceLeadingState = {
                            previousNotes: null,
                            currentVoicing: null
                        };

                        // Apply voice leading to first chord
                        const firstChordInfo = allChords[0];
                        const voicedFirstChord = this.applyInitialVoiceLeading(firstChordInfo.chord);

                        // CRITICAL: Play the first chord immediately
                        console.log("PLAYING FIRST CHORD IMMEDIATELY");
                        this.playVoicedChord(voicedFirstChord);

                        // Update UI for first chord
                        this.currentChordName = this.getChordDisplayName(firstChordInfo.chord);
                        this.currentSectionName = firstChordInfo.sectionName;
                        this.selectedChordIndices = {
                            section: firstChordInfo.sectionIndex,
                            chord: firstChordInfo.chordIndex
                        };

                        // Set playing state
                        this.isPlaying = true;
                        this.totalTime = allChords.length * this.chordDuration;

                        // Only schedule the remaining chords
                        if (allChords.length > 1) {
                            this.scheduleRemainingChordsWithVoiceLeading(allChords.slice(1));
                        } else {
                            // If only one chord, set a timer to finish playback
                            setTimeout(() => {
                                this.progressPercentage = 100;
                                setTimeout(() => {
                                    this.isPlaying = false;
                                    this.currentChordName = "";
                                    this.currentSectionName = "";
                                    this.selectedChordIndices = { section: null, chord: null };
                                }, 500);
                            }, this.chordDuration * 1000);
                        }
                    } catch (e) {
                        console.error("Failed to start playback:", e);
                        alert("Failed to start audio. Please try again.");
                    }
                },

                /**
                 * Apply initial voice leading to the first chord
                 */
                applyInitialVoiceLeading(chord) {
                    if (!chord || !chord.notes || !Array.isArray(chord.notes)) {
                        console.warn("Invalid chord for voice leading:", chord);
                        return chord;
                    }

                    try {
                        // Generate a note pool for this chord
                        const pool = this.getChordNotePool(chord);

                        // Select initial voicing from pool - use existing notes if possible
                        let selectedNotes = [...chord.notes];

                        // Ensure we have valid notes
                        selectedNotes = selectedNotes.filter(note =>
                            typeof note === 'string' && /^[A-G][#b]?[0-9]$/.test(note)
                        );

                        // Sort by pitch for consistent voicing
                        selectedNotes.sort((a, b) => {
                            try {
                                return this.getMIDI(a) - this.getMIDI(b);
                            } catch (e) {
                                return 0;
                            }
                        });

                        // Ensure we have enough notes for rich jazz harmony
                        while (selectedNotes.length < 4 && pool.length > selectedNotes.length) {
                            const nextNote = pool[selectedNotes.length % pool.length];
                            if (!selectedNotes.includes(nextNote)) {
                                selectedNotes.push(nextNote);
                            }
                        }

                        // Initialize voice leading state
                        this.previousVoicing = selectedNotes.slice();
                        this.voiceLeadingState.previousNotes = selectedNotes.slice();
                        this.voiceLeadingState.currentVoicing = selectedNotes.slice();

                        // Return a copy of the chord with the selected notes
                        return {
                            ...chord,
                            playbackNotes: selectedNotes
                        };
                    } catch (e) {
                        console.error("Error in initial voice leading:", e);
                        return chord; // Return original chord as fallback
                    }
                },

                /**
                 * Schedule remaining chords with voice leading
                 */
                scheduleRemainingChordsWithVoiceLeading(chords) {
                    let currentIndex = 0;

                    const playNextChord = () => {
                        // Check if we should stop
                        if (!this.isPlaying || currentIndex >= chords.length) {
                            this.progressPercentage = 100;
                            setTimeout(() => {
                                this.isPlaying = false;
                                this.currentChordName = "";
                                this.currentSectionName = "";
                                this.selectedChordIndices = { section: null, chord: null };
                            }, 500);
                            return;
                        }

                        // Get current chord info
                        const chordInfo = chords[currentIndex];
                        const currentChord = chordInfo.chord;

                        // Apply voice leading to this chord
                        const voicedChord = this.applyVoiceLeadingToNextChord(currentChord);

                        console.log(`Playing chord ${currentIndex + 2} of ${chords.length + 1} with voice leading`);
                        this.playVoicedChord(voicedChord);

                        // Update UI
                        this.currentChordName = this.getChordDisplayName(currentChord);
                        this.currentSectionName = chordInfo.sectionName;
                        this.selectedChordIndices = {
                            section: chordInfo.sectionIndex,
                            chord: chordInfo.chordIndex
                        };

                        // Update progress - account for first chord already played
                        const totalChords = chords.length + 1; // +1 for first chord
                        this.elapsedTime = (currentIndex + 1) * this.chordDuration; // +1 for first chord
                        this.progressPercentage = Math.min(
                            ((currentIndex + 2) / totalChords) * 100, // +2 because index starts at 0 and first chord
                            99.5
                        );

                        // Schedule next chord
                        currentIndex++;
                        this.playbackTimer = setTimeout(playNextChord, this.chordDuration * 1000);
                    };

                    // Start the chain with a delay for the first chord duration
                    this.playbackTimer = setTimeout(playNextChord, this.chordDuration * 1000);
                },

                /**
                 * Apply voice leading to next chord based on previous chord
                 */
                applyVoiceLeadingToNextChord(chord) {
                    if (!chord || !chord.notes || !Array.isArray(chord.notes)) {
                        console.warn("Invalid chord for voice leading:", chord);
                        return chord;
                    }

                    try {
                        // Generate a note pool for this chord
                        const pool = this.getChordNotePool(chord);

                        if (!this.voiceLeadingState.previousNotes || !Array.isArray(this.voiceLeadingState.previousNotes)) {
                            // If no previous notes, initialize with this chord's notes
                            return this.applyInitialVoiceLeading(chord);
                        }

                        // Find closest notes from previous chord
                        const newNotes = this.voiceLeadingState.previousNotes.map(prevNote => {
                            try {
                                return this.findClosestNote(prevNote, pool);
                            } catch (e) {
                                console.warn("Error finding closest note:", e);
                                return pool[0]; // Fallback to first note in pool
                            }
                        });

                        // Adjust octaves for smoothness
                        const adjustedNotes = newNotes.map((note, i) => {
                            try {
                                if (i < this.voiceLeadingState.previousNotes.length) {
                                    return this.adjustOctaveForSmoothness(note, this.voiceLeadingState.previousNotes[i]);
                                }
                                return note;
                            } catch (e) {
                                console.warn("Error adjusting octave:", e);
                                return note;
                            }
                        });

                        // Add bass note for slash chords if it doesn't exist in the voicing
                        if (chord.bass && chord.bass !== chord.root) {
                            const bassNote = chord.bass + "2"; // Place the bass note in octave 2
                            if (!adjustedNotes.some(note => note.startsWith(chord.bass))) {
                                adjustedNotes.unshift(bassNote);
                            }
                        }

                        // Ensure root is present in some octave
                        if (!adjustedNotes.some(note => note.startsWith(chord.root))) {
                            const rootNote = chord.root + "3"; // Add root in octave 3
                            adjustedNotes.push(rootNote);
                        }

                        // Update state for next chord
                        this.voiceLeadingState.previousNotes = adjustedNotes.slice();
                        this.voiceLeadingState.currentVoicing = adjustedNotes.slice();

                        // Return a copy of the chord with voice-led notes
                        return {
                            ...chord,
                            playbackNotes: adjustedNotes
                        };
                    } catch (e) {
                        console.error("Error in voice leading for next chord:", e);
                        return chord; // Return original chord as fallback
                    }
                },

                /**
                 * Play a chord with voice-led notes
                 */
                playVoicedChord(chord) {
                    try {
                        // Use voice-led notes if available, otherwise use original notes
                        const notesToPlay = chord.playbackNotes || chord.notes;

                        if (!notesToPlay || !Array.isArray(notesToPlay) || notesToPlay.length === 0) {
                            console.warn("No valid notes to play in chord:", chord);
                            return;
                        }

                        // Filter for valid notes
                        const validNotes = notesToPlay.filter(note =>
                            typeof note === 'string' && /^[A-G][#b]?[0-9]$/.test(note)
                        );

                        if (validNotes.length === 0) {
                            console.warn("No valid notes after filtering:", notesToPlay);
                            return;
                        }

                        // Play the chord with optimized notes
                        const optimizedNotes = this.optimizeChordNotes(validNotes);

                        // IMPORTANT: Special handling for the notorious Gmaj9 chord
                        if (validNotes.includes('G2') && validNotes.includes('B2') && validNotes.includes('D3')) {
                            console.log("Detected potentially problematic Gmaj9 chord - applying special handling");
                            this.synth.triggerAttackRelease(optimizedNotes, 0.6);
                        } else {
                            this.synth.triggerAttackRelease(optimizedNotes, 0.5);
                        }
                    } catch (e) {
                        console.error("Error playing voiced chord:", e);
                        // Fallback to basic playChord if there's an error
                        this.playChord(chord);
                    }
                },


                /**
                 * Clears progress update interval timer.
                 */
                clearProgressTimer() {
                    if (this.progressUpdateInterval) {
                        clearInterval(this.progressUpdateInterval);
                        this.progressUpdateInterval = null;
                    }
                },


                /**
    * Play a section with voice leading
    */
                async playSection(sectionIndex) {
                    // First, stop any current playback
                    this.stopPlayback();

                    if (!this.synth) {
                        console.warn("Cannot play section - audio not initialized yet");
                        return;
                    }

                    try {
                        // Validate section index
                        if (sectionIndex < 0 || sectionIndex >= this.currentProgression.sections.length) {
                            console.warn("Invalid section index:", sectionIndex);
                            return;
                        }

                        const section = this.currentProgression.sections[sectionIndex];
                        const chords = section.chords || [];

                        if (chords.length === 0) {
                            console.warn("No chords in section");
                            return;
                        }

                        console.log("Playing section with", chords.length, "chords with voice leading");

                        // Reset voice leading state
                        this.voiceLeadingState = {
                            previousNotes: null,
                            currentVoicing: null
                        };

                        // Start audio context and wait for it to be ready
                        await Tone.start();
                        console.log("Audio context started for section playback");

                        // Apply voice leading to first chord
                        const voicedFirstChord = this.applyInitialVoiceLeading(chords[0]);

                        // CRITICAL: Play the first chord immediately
                        console.log("PLAYING FIRST CHORD IMMEDIATELY");
                        this.playVoicedChord(voicedFirstChord);

                        // Update UI for first chord
                        this.currentChordName = this.getChordDisplayName(chords[0]);
                        this.selectedChordIndices = { section: sectionIndex, chord: 0 };
                        this.currentSectionName = section.name || `Section ${sectionIndex + 1}`;

                        // Set playing state
                        this.isPlaying = true;
                        this.totalTime = chords.length * this.chordDuration;

                        // Schedule remaining chords if any
                        if (chords.length > 1) {
                            // Create chord info objects for the remaining chords
                            const remainingChords = chords.slice(1).map((chord, idx) => ({
                                chord: chord,
                                sectionIndex: sectionIndex,
                                chordIndex: idx + 1,
                                sectionName: section.name || `Section ${sectionIndex + 1}`
                            }));

                            this.scheduleRemainingChordsWithVoiceLeading(remainingChords);
                        } else {
                            // If only one chord, set a timer to finish playback
                            setTimeout(() => {
                                this.isPlaying = false;
                                this.currentChordName = "";
                                this.currentSectionName = "";
                                this.selectedChordIndices = { section: null, chord: null };
                            }, this.chordDuration * 1000);
                        }
                    } catch (e) {
                        console.error("Error playing section:", e);
                        this.isPlaying = false;
                    }
                },

                startSectionSequence(validChords, sectionIndex) {
                    // Create the sequence with triggerAttackRelease for proper note duration
                    this.chordSequence = new Tone.Sequence((time, chord) => {
                        const optimizedNotes = this.optimizeChordNotes(chord.notes);
                        this.synth.triggerAttackRelease(optimizedNotes, this.chordDuration - 0.01, time);

                        // Update UI
                        this.currentChordName = this.getChordDisplayName(chord);
                        this.currentSectionName = chord.sectionName;
                        this.selectedChordIndices = {
                            section: chord.sectionIndex,
                            chord: chord.chordIndex
                        };
                        this.updateProgress();
                    }, validChords, this.chordDuration);

                    // Set tempo and start playback
                    Tone.Transport.bpm.value = this.tempo;
                    Tone.Transport.start("+0.1"); // Slight delay for stability
                    this.chordSequence.start(0);

                    this.isPlaying = true;
                    this.totalTime = validChords.length * this.chordDuration;
                },


                /**
  /**
   * Enhanced stop playback that ensures proper cleanup.
   */
                stopPlayback() {
                    try {
                        // Clear any scheduled timeout
                        if (this.playbackTimer) {
                            clearTimeout(this.playbackTimer);
                            this.playbackTimer = null;
                        }

                        // Clear progress update interval
                        this.clearProgressTimer();

                        // Stop and clear Tone.Transport
                        if (Tone.Transport) {
                            Tone.Transport.stop();
                            Tone.Transport.cancel(0);
                        }

                        // Silence synth immediately, then release
                        if (this.synth) {
                            const currentVolume = this.synth.volume.value;
                            this.synth.volume.value = -Infinity; // Immediate silence
                            this.synth.releaseAll();
                            setTimeout(() => {
                                this.synth.volume.value = currentVolume; // Restore volume
                            }, 50); // Brief delay to ensure release completes
                        }

                        // Reset playback state
                        this.isPlaying = false;
                        this.currentChordName = "";
                        this.currentSectionName = "";
                        this.progressPercentage = 0;
                        this.elapsedTime = 0;

                        // Clear selection
                        this.selectedChordIndices = { section: null, chord: null };

                        console.log("Playback stopped - cleaned up resources with immediate silence");
                    } catch (e) {
                        console.error("Error stopping playback:", e);
                    }
                },

                /**
                 * Validates and ensures all chords in the progression are in audible range.
                 * Call this after loading a preset or initializing the app.
                 */
                validateProgressionNotes() {
                    if (!this.currentProgression || !this.currentProgression.sections) return;

                    console.log("Validating chord notes in progression...");

                    this.currentProgression.sections.forEach((section, sIndex) => {
                        if (!section.chords || !Array.isArray(section.chords)) return;

                        section.chords.forEach((chord, cIndex) => {
                            if (!chord || !chord.notes || !Array.isArray(chord.notes)) return;

                            // Check if any notes are outside audible range or duplicated
                            let hasLowNotes = chord.notes.some(note => {
                                if (typeof note !== 'string') return false;
                                const octave = parseInt(note.slice(-1));
                                return octave < 2;
                            });

                            let hasHighNotes = chord.notes.some(note => {
                                if (typeof note !== 'string') return false;
                                const octave = parseInt(note.slice(-1));
                                return octave > 6;
                            });

                            // If notes need adjustment, fix them
                            if (hasLowNotes || hasHighNotes) {
                                console.log(`Fixing notes in chord ${cIndex} of section ${sIndex}:`, chord.name);

                                // Adjust notes to be in audible range
                                chord.notes = chord.notes.map(note => {
                                    if (typeof note !== 'string') return 'C4';

                                    const name = note.slice(0, -1);
                                    const octave = parseInt(note.slice(-1));

                                    // Move very low notes up an octave
                                    if (octave < 2) {
                                        return name + '3';
                                    }
                                    // Move very high notes down an octave
                                    else if (octave > 6) {
                                        return name + '5';
                                    }
                                    return note;
                                });

                                console.log("Adjusted notes:", chord.notes);
                            }

                            // Ensure there are enough notes (at least 3)
                            if (chord.notes.length < 3) {
                                console.log(`Adding notes to chord ${cIndex} of section ${sIndex} - too few notes`);

                                // Add basic triad notes based on chord type
                                const intervals = this.getIntervalsForChordType(chord.type || 'major');
                                const additionalNotes = this.generateChordNotes(chord.root || 'C', intervals);

                                // Combine original and additional notes, removing duplicates
                                const allNotes = [...new Set([...chord.notes, ...additionalNotes])];
                                chord.notes = allNotes;

                                console.log("Enhanced notes:", chord.notes);
                            }
                        });
                    });

                    console.log("Validation complete");
                },


                restartPlayback() {
                    if (this.isPlaying) {
                        this.stopPlayback();
                        setTimeout(() => {
                            this.startPlayback();
                        }, 100);
                    } else {
                        this.startPlayback();
                    }
                },

                updateProgress() {
                    try {
                        // If we're playing an entire progression
                        if (this.chordSequence && this.chordSequence.events) {
                            // Find the current position
                            const allChords = this.chordSequence.events;
                            const currentIndex = allChords.findIndex(c =>
                                c.sectionIndex === this.selectedChordIndices.section &&
                                c.chordIndex === this.selectedChordIndices.chord
                            );

                            if (currentIndex !== -1) {
                                this.elapsedTime = currentIndex * this.chordDuration;
                                this.progressPercentage = (this.elapsedTime / this.totalTime) * 100;
                            }
                        }
                    } catch (e) {
                        console.error("Error updating progress:", e);
                    }
                },

                seekToPosition(event) {
                    if (!this.chordSequence || !this.isPlaying) return;

                    try {
                        const rect = event.target.getBoundingClientRect();
                        const x = event.clientX - rect.left;
                        const percentage = (x / rect.width) * 100;

                        // Calculate the time position
                        const timePosition = (percentage / 100) * this.totalTime;

                        // Calculate the chord index
                        const chordIndex = Math.floor(timePosition / this.chordDuration);

                        // Ensure we have a valid chord index
                        if (chordIndex >= 0 && this.chordSequence.events && chordIndex < this.chordSequence.events.length) {
                            // Stop current sequence
                            this.chordSequence.stop();

                            // Start from the new position
                            this.chordSequence.start(0, chordIndex);

                            // Update progress
                            this.progressPercentage = percentage;
                            this.elapsedTime = timePosition;
                        }
                    } catch (e) {
                        console.error("Error seeking to position:", e);
                    }
                },

                isChordPlaying(sectionIndex, chordIndex) {
                    try {
                        return this.isPlaying &&
                            this.selectedChordIndices &&
                            this.selectedChordIndices.section === sectionIndex &&
                            this.selectedChordIndices.chord === chordIndex;
                    } catch (e) {
                        return false;
                    }
                },

                /**
                 * Changes the instrument used for playback with high-quality analog-style sounds.
                 * Completely redesigned for better audio quality with warm subtractive synthesis.
                 */
                changeInstrument() {
                    try {
                        // Track previous playing state
                        const wasPlaying = this.isPlaying;

                        // Stop any current playback temporarily
                        if (wasPlaying) {
                            this.stopPlayback();
                        }

                        // Dispose of the old synth and effects
                        if (this.synth) {
                            this.synth.disconnect();
                            this.synth.dispose();
                        }

                        // Clean up previous effects
                        if (this.instrumentEffects) {
                            this.instrumentEffects.forEach(effect => {
                                if (effect && typeof effect.dispose === 'function') {
                                    effect.dispose();
                                }
                            });
                        }
                        this.instrumentEffects = [];

                        // Create shared components we'll use across multiple instruments
                        const filter = new Tone.Filter({
                            type: "lowpass",
                            frequency: 3000,
                            Q: 1
                        });
                        this.instrumentEffects.push(filter);

                        // Create a subtle chorus for richness
                        const chorus = new Tone.Chorus({
                            frequency: 1.5,
                            delayTime: 3.5,
                            depth: 0.7,
                            wet: 0.3,
                        }).start();
                        this.instrumentEffects.push(chorus);

                        // Create a compressor for better dynamics
                        const compressor = new Tone.Compressor({
                            threshold: -24,
                            ratio: 3,
                            attack: 0.05,
                            release: 0.1
                        });
                        this.instrumentEffects.push(compressor);

                        // Create a new synth based on the selected instrument (with better sounds)
                        switch (this.instrument) {
                            case "piano":
                                // Warm grand piano approximation
                                this.synth = new Tone.PolySynth(Tone.Synth, {
                                    maxPolyphony: 256,
                                    oscillator: {
                                        type: "triangle",
                                    },
                                    envelope: {
                                        attack: 0.008,   // Fast but not instant
                                        decay: 0.6,      // Moderate decay
                                        sustain: 0.4,    // Medium sustain for warmth
                                        release: 1.8     // Long, natural release
                                    },
                                    volume: -3           // Proper volume level
                                });

                                // Piano-specific filter
                                const pianoFilter = new Tone.Filter({
                                    type: "lowpass",
                                    frequency: 5000,     // Brighter sound
                                    Q: 0.5
                                });
                                this.instrumentEffects.push(pianoFilter);

                                // Chain through effects
                                this.synth.chain(pianoFilter, compressor, this.masterEQ || Tone.Destination);
                                break;

                            case "rhodes":
                                // Warm electric piano with subtle drive
                                this.synth = new Tone.PolySynth(Tone.Synth, {
                                    maxPolyphony: 256,
                                    oscillator: {
                                        type: "sine",
                                    },
                                    envelope: {
                                        attack: 0.05,    // Soft attack
                                        decay: 0.7,      // Medium decay
                                        sustain: 0.5,    // Moderate sustain
                                        release: 2.0     // Long release
                                    },
                                    volume: -2           // Slightly louder
                                });

                                // Add subtle drive for warmth
                                const drive = new Tone.Distortion({
                                    distortion: 0.1,
                                    wet: 0.2
                                });
                                this.instrumentEffects.push(drive);

                                // Add subtle phaser for movement
                                const phaser = new Tone.Phaser({
                                    frequency: 0.5,
                                    octaves: 3,
                                    baseFrequency: 400,
                                    wet: 0.3
                                });
                                this.instrumentEffects.push(phaser);

                                // Chain through effects
                                this.synth.chain(drive, phaser, compressor, this.masterEQ || Tone.Destination);
                                break;

                            case "synth":
                                // Rich Moog-inspired synth
                                this.synth = new Tone.PolySynth(Tone.MonoSynth, {
                                    maxPolyphony: 256,
                                    oscillator: {
                                        type: "sawtooth",
                                    },
                                    filter: {
                                        Q: 2,
                                        type: "lowpass",
                                        rolloff: -12,
                                        frequency: 1000
                                    },
                                    envelope: {
                                        attack: 0.1,
                                        decay: 0.3,
                                        sustain: 0.6,
                                        release: 1.5
                                    },
                                    filterEnvelope: {
                                        attack: 0.8,
                                        decay: 1.0,
                                        sustain: 0.4,
                                        release: 1.5,
                                        baseFrequency: 400,
                                        octaves: 2
                                    },
                                    volume: -5
                                });

                                // Chain through subtle chorus for warmth
                                this.synth.chain(chorus, compressor, this.masterEQ || Tone.Destination);
                                break;

                            case "marimba":
                                // Properly audible and warm marimba sound
                                this.synth = new Tone.PolySynth(Tone.Synth, {
                                    maxPolyphony: 256,
                                    oscillator: {
                                        type: "sine",
                                    },
                                    envelope: {
                                        attack: 0.001,   // Very fast attack
                                        decay: 0.4,      // Moderate decay
                                        sustain: 0.01,   // Low sustain for percussive feel
                                        release: 0.7     // Quick release
                                    },
                                    volume: 2            // LOUDER - properly audible now
                                });

                                // Add a filter envelope for the characteristic marimba sound
                                const marimbaFilter = new Tone.AutoFilter({
                                    frequency: 4,
                                    type: "sine",
                                    depth: 0.5,
                                    baseFrequency: 200,
                                    octaves: 3,
                                    filter: {
                                        type: "lowpass",
                                        rolloff: -12,
                                        Q: 1
                                    },
                                    wet: 0.5
                                }).start();
                                this.instrumentEffects.push(marimbaFilter);

                                // Chain through effects
                                this.synth.chain(marimbaFilter, this.masterEQ || Tone.Destination);
                                break;

                            case "vibraphone":
                                // Warm vibraphone with natural tremolo
                                this.synth = new Tone.PolySynth(Tone.Synth, {
                                    maxPolyphony: 256,
                                    oscillator: {
                                        type: "sine",
                                    },
                                    envelope: {
                                        attack: 0.03,    // Soft attack
                                        decay: 0.7,      // Moderate decay
                                        sustain: 0.2,    // Low sustain for percussive feel
                                        release: 2.0     // Longer release for resonance
                                    },
                                    volume: 0            // Standard volume
                                });

                                // Classic vibraphone tremolo
                                const tremolo = new Tone.Tremolo({
                                    frequency: 7,
                                    depth: 0.8,
                                    spread: 180,
                                    wet: 0.7
                                }).start();
                                this.instrumentEffects.push(tremolo);

                                // Chain through effects
                                this.synth.chain(tremolo, compressor, this.masterEQ || Tone.Destination);
                                break;

                            case "warm-pad":
                                // NEW: Rich warm pad sound
                                this.synth = new Tone.PolySynth(Tone.Synth, {
                                    maxPolyphony: 256,
                                    oscillator: {
                                        type: "sine",
                                    },
                                    envelope: {
                                        attack: 0.8,     // Slow, gentle attack
                                        decay: 1.2,      // Slow decay
                                        sustain: 0.7,    // High sustain
                                        release: 3.0     // Very long release
                                    },
                                    volume: -6           // Quieter for background
                                });

                                // Add subtle chorus and reverb
                                const padChorus = new Tone.Chorus({
                                    frequency: 0.6,
                                    delayTime: 4,
                                    depth: 0.9,
                                    spread: 180,
                                    wet: 0.5
                                }).start();
                                this.instrumentEffects.push(padChorus);

                                const padReverb = new Tone.Reverb({
                                    decay: 3.0,
                                    wet: 0.4
                                });
                                this.instrumentEffects.push(padReverb);

                                // Chain through effects
                                this.synth.chain(padChorus, padReverb, this.masterEQ || Tone.Destination);
                                break;

                            case "analog-saw":
                                // NEW: Warm detuned analog saw sound
                                this.synth = new Tone.PolySynth(Tone.FatOscillator, {
                                    maxPolyphony: 256,
                                    oscillator: {
                                        type: "sawtooth",
                                        count: 3,        // 3 oscillators for fatness
                                        spread: 30,      // Slight detuning
                                    },
                                    envelope: {
                                        attack: 0.05,
                                        decay: 0.2,
                                        sustain: 0.7,
                                        release: 1.5
                                    },
                                    volume: -8           // Keep it balanced
                                });

                                // Add analog-style filter
                                const analogFilter = new Tone.Filter({
                                    type: "lowpass",
                                    frequency: 1200,
                                    Q: 1,
                                    rolloff: -24
                                });
                                this.instrumentEffects.push(analogFilter);

                                // Chain through effects
                                this.synth.chain(analogFilter, compressor, this.masterEQ || Tone.Destination);
                                break;

                            default:
                                // Default to a clean, warm synth sound
                                this.synth = new Tone.PolySynth(Tone.Synth, {
                                    maxPolyphony: 256,
                                    oscillator: {
                                        type: "triangle"
                                    },
                                    envelope: {
                                        attack: 0.05,
                                        decay: 0.3,
                                        sustain: 0.7,
                                        release: 1.5
                                    },
                                    volume: -4
                                });

                                // Chain through master processing
                                this.synth.chain(filter, compressor, this.masterEQ || Tone.Destination);
                        }

                        // Apply current volume setting
                        this.updateVolume();

                        // Restart playback if it was playing before
                        if (wasPlaying) {
                            setTimeout(() => {
                                this.startPlayback();
                            }, 100);
                        }

                        console.log(`Changed instrument to ${this.instrument}`);
                    } catch (e) {
                        console.error("Error changing instrument:", e);
                        alert("There was an error changing the instrument. Please try again.");
                    }
                },

                updateEffects() {
                    if (this.reverb_effect) {
                        this.reverb_effect.wet.value = this.reverb;
                    }
                },

                updateVolume() {
                    if (this.synth) {
                        this.synth.volume.value = Tone.gainToDb(this.volume);
                    }
                },

                updateTempo() {
                    Tone.Transport.bpm.value = this.tempo;
                },

                updateTotalTime() {
                    const totalChords = this.currentProgression.sections.reduce(
                        (sum, section) => sum + section.chords.length, 0
                    );
                    this.totalTime = totalChords * this.chordDuration;
                },

                // Import/Export Functions
                saveProgressionToFile() {
                    try {
                        // Prepare the data to save
                        const dataToSave = JSON.stringify(this.currentProgression, null, 2);

                        // Use FileSaver.js to save the file
                        const blob = new Blob([dataToSave], { type: "application/json" });
                        const filename = (this.currentProgression.name || "jazz-progression").replace(/\s+/g, '-').toLowerCase() + ".json";
                        saveAs(blob, filename);
                    } catch (error) {
                        console.error("Error saving progression:", error);
                        alert("Error saving progression: " + error.message);
                    }
                },

                openImportModal() {
                    this.importTab = 'file';
                    this.importJsonText = '';
                    this.importMessage = '';
                    this.showImportModal = true;
                },

                closeImportModal() {
                    this.showImportModal = false;
                },

                /**
                 * Handles file upload for importing progressions.
                 * @param {Event} event - The file upload event.
                 */
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) {
                        this.importMessage = "No file selected.";
                        return;
                    }

                    // Validate file type
                    if (file.type !== "application/json" && !file.name.endsWith('.json')) {
                        this.importMessage = "Invalid file type. Please select a JSON file.";
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const content = e.target.result;

                            // Basic validation for JSON format
                            try {
                                const progression = JSON.parse(content);

                                // Check for minimum required structure
                                if (!progression.sections || !Array.isArray(progression.sections)) {
                                    throw new Error("Invalid progression format: missing sections array");
                                }

                                this.importMessage = `File "${file.name}" loaded successfully. Click Import to apply.`;
                                this.importJsonText = content;

                                // Auto-import
                                this.importFromText();
                            } catch (parseError) {
                                throw new Error("Invalid JSON format: " + parseError.message);
                            }
                        } catch (error) {
                            console.error("Error processing file:", error);
                            this.importMessage = "Error loading file: " + error.message;
                        }
                    };

                    reader.onerror = () => {
                        this.importMessage = "Error reading file. Please try again.";
                    };

                    reader.readAsText(file);
                },

                /**
                 * Imports a progression from JSON text with enhanced validation and error handling.
                 */
                importFromText() {
                    try {
                        if (!this.importJsonText || this.importJsonText.trim() === '') {
                            this.importMessage = "Please enter JSON text to import.";
                            return;
                        }

                        let progression;
                        try {
                            progression = JSON.parse(this.importJsonText);
                        } catch (parseError) {
                            throw new Error("Invalid JSON format: " + parseError.message);
                        }

                        // Basic structure validation
                        if (!progression || typeof progression !== 'object') {
                            throw new Error("Invalid progression format: not an object");
                        }

                        if (!progression.sections || !Array.isArray(progression.sections)) {
                            throw new Error("Invalid progression format: missing sections array");
                        }

                        // Ensure name and description exist
                        progression.name = progression.name || "Imported Progression";
                        progression.description = progression.description || "";

                        // Validate sections structure and repair if possible
                        progression.sections = progression.sections.map((section, i) => {
                            // Ensure section has a name
                            if (!section.name) {
                                section.name = `Section ${String.fromCharCode(65 + i)}`; // A, B, C, etc.
                            }

                            // Ensure chords array exists
                            if (!section.chords || !Array.isArray(section.chords)) {
                                section.chords = [];
                            }

                            // Ensure collapsed property exists
                            section.collapsed = !!section.collapsed;

                            // Ensure annotation property exists
                            section.annotation = section.annotation || "";

                            // Validate each chord and attempt to repair
                            section.chords = section.chords.map((chord, j) => {
                                const validChord = { ...chord };

                                // Ensure minimal chord properties
                                if (!validChord.root) {
                                    console.warn(`Chord at index ${j} in section "${section.name}" missing root note. Using C.`);
                                    validChord.root = "C";
                                }

                                if (!validChord.type) {
                                    console.warn(`Chord at index ${j} in section "${section.name}" missing type. Using major.`);
                                    validChord.type = "major";
                                }

                                // Generate chord name if missing
                                if (!validChord.name) {
                                    validChord.name = this.getChordDisplayName(validChord);
                                }

                                // Generate notes if missing or invalid
                                if (!validChord.notes || !Array.isArray(validChord.notes) || validChord.notes.length === 0) {
                                    try {
                                        const intervals = this.getIntervalsForChordType(validChord.type);
                                        validChord.notes = this.generateChordNotes(validChord.root, intervals);
                                        console.log(`Generated notes for chord ${validChord.name}:`, validChord.notes);
                                    } catch (noteError) {
                                        console.error(`Could not generate notes for chord at index ${j}:`, noteError);
                                        validChord.notes = [`${validChord.root}3`, `${validChord.root}4`]; // Fallback
                                    }
                                }

                                // Ensure other properties are set
                                validChord.bass = validChord.bass || "";
                                validChord.annotation = validChord.annotation || "";
                                validChord.voicingStyle = validChord.voicingStyle || "close";
                                validChord.baseOctave = validChord.baseOctave || 3;
                                validChord.octaveSpan = validChord.octaveSpan || 2;
                                validChord.density = validChord.density || validChord.notes.length;

                                return validChord;
                            });

                            return section;
                        });

                        // Set the current progression to the imported one
                        this.currentProgression = progression;

                        // Initialize sortable for each section
                        setTimeout(() => {
                            this.currentProgression.sections.forEach((section, index) => {
                                this.initSectionSortable(index);
                            });
                        }, 100);

                        // Close the modal
                        this.closeImportModal();

                        // Update total time
                        this.updateTotalTime();

                        // Show success message
                        alert(`Successfully imported "${progression.name}" with ${progression.sections.length} sections.`);
                    } catch (error) {
                        console.error("Error importing progression:", error);
                        this.importMessage = "Error importing progression: " + error.message;
                    }
                },

                // Progression Management
                newProgression() {
                    if (confirm("Create a new progression? Any unsaved changes will be lost.")) {
                        this.currentProgression = {
                            name: "New Progression",
                            description: "",
                            sections: [{
                                name: "Section A",
                                chords: [],
                                collapsed: false,
                                annotation: ""
                            }]
                        };

                        // Initialize sortable
                        setTimeout(() => {
                            this.initSectionSortable(0);
                        }, 100);

                        // Update total time
                        this.updateTotalTime();
                    }
                },

                editProgressionName() {
                    this.editingProgressionName = this.currentProgression.name;
                    this.editingProgressionDescription = this.currentProgression.description;
                    this.showNameEditModal = true;
                },

                cancelNameEdit() {
                    this.showNameEditModal = false;
                },

                saveProgressionName() {
                    this.currentProgression.name = this.editingProgressionName;
                    this.currentProgression.description = this.editingProgressionDescription;
                    this.showNameEditModal = false;
                },

                // Annotation Management
                addAnnotationToSection(sectionIndex) {
                    this.annotationModalTitle = "Add Section Annotation";
                    this.editingAnnotation = this.currentProgression.sections[sectionIndex].annotation || "";
                    this.annotationTarget = { type: 'section', sectionIndex, chordIndex: null };
                    this.showAnnotationModal = true;
                },

                editSectionAnnotation(sectionIndex) {
                    this.annotationModalTitle = "Edit Section Annotation";
                    this.editingAnnotation = this.currentProgression.sections[sectionIndex].annotation || "";
                    this.annotationTarget = { type: 'section', sectionIndex, chordIndex: null };
                    this.showAnnotationModal = true;
                },

                addChordAnnotation(sectionIndex, chordIndex) {
                    this.annotationModalTitle = "Add Chord Annotation";
                    this.editingAnnotation = this.currentProgression.sections[sectionIndex].chords[chordIndex].annotation || "";
                    this.annotationTarget = { type: 'chord', sectionIndex, chordIndex };
                    this.showAnnotationModal = true;
                },

                editChordAnnotation(sectionIndex, chordIndex) {
                    this.annotationModalTitle = "Edit Chord Annotation";
                    this.editingAnnotation = this.currentProgression.sections[sectionIndex].chords[chordIndex].annotation || "";
                    this.annotationTarget = { type: 'chord', sectionIndex, chordIndex };
                    this.showAnnotationModal = true;
                },

                cancelAnnotation() {
                    this.showAnnotationModal = false;
                },

                saveAnnotation() {
                    if (this.annotationTarget.type === 'section') {
                        this.currentProgression.sections[this.annotationTarget.sectionIndex].annotation = this.editingAnnotation;
                    } else if (this.annotationTarget.type === 'chord') {
                        this.currentProgression.sections[this.annotationTarget.sectionIndex]
                            .chords[this.annotationTarget.chordIndex].annotation = this.editingAnnotation;
                    }

                    this.showAnnotationModal = false;
                },

                // Chord Management Functions
                duplicateChord(sectionIndex, chordIndex) {
                    // Create a deep copy of the chord
                    const chordCopy = JSON.parse(
                        JSON.stringify(this.currentProgression.sections[sectionIndex].chords[chordIndex])
                    );

                    // Insert after the original
                    this.currentProgression.sections[sectionIndex].chords.splice(chordIndex + 1, 0, chordCopy);
                },

                moveChordLeft(sectionIndex, chordIndex) {
                    if (chordIndex > 0) {
                        const chords = [...this.currentProgression.sections[sectionIndex].chords];
                        const temp = chords[chordIndex];
                        chords[chordIndex] = chords[chordIndex - 1];
                        chords[chordIndex - 1] = temp;
                        this.currentProgression.sections[sectionIndex].chords = chords;
                    }
                },

                moveChordRight(sectionIndex, chordIndex) {
                    if (chordIndex < this.currentProgression.sections[sectionIndex].chords.length - 1) {
                        const chords = [...this.currentProgression.sections[sectionIndex].chords];
                        const temp = chords[chordIndex];
                        chords[chordIndex] = chords[chordIndex + 1];
                        chords[chordIndex + 1] = temp;
                        this.currentProgression.sections[sectionIndex].chords = chords;
                    }
                },

                deleteChord(sectionIndex, chordIndex) {
                    this.currentProgression.sections[sectionIndex].chords.splice(chordIndex, 1);
                },

                // Other utility functions
                formatTime(seconds) {
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}:${secs.toString().padStart(2, '0')}`;
                },

                copyCurrentProgressionAsText() {
                    // Create a text representation of the progression
                    let text = `${this.currentProgression.name}\n`;
                    if (this.currentProgression.description) {
                        text += `${this.currentProgression.description}\n`;
                    }
                    text += '\n';

                    this.currentProgression.sections.forEach(section => {
                        text += `=== ${section.name} ===\n`;
                        if (section.annotation) {
                            text += `${section.annotation}\n`;
                        }
                        text += '\n';

                        section.chords.forEach(chord => {
                            text += `${this.getChordDisplayName(chord)}  `;
                            if (chord.annotation) {
                                text += `(${chord.annotation})`;
                            }
                            text += '\n';
                        });

                        text += '\n';
                    });

                    // Copy to clipboard
                    navigator.clipboard.writeText(text).then(() => {
                        alert("Progression copied to clipboard as text!");
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                        alert("Failed to copy to clipboard: " + err.message);
                    });
                },

                openSettingsModal() {
                    this.showSettingsModal = true;
                },

                closeSettingsModal() {
                    this.showSettingsModal = false;
                    this.updateEffects();
                },

                openHelpModal() {
                    this.helpTab = 'basics';
                    this.showHelpModal = true;
                },

                // Preset Management
                openPresetsModal() {
                    // Initialize the featured preset preview
                    this.updateFeaturedPresetPreview('gemma3');
                    this.showPresetsModal = true;
                },

                closePresetsModal() {
                    this.showPresetsModal = false;
                },

                updateFeaturedPresetPreview(presetId) {
                    // Update the featured preset info
                    this.featuredPreset.id = presetId;

                    const presetData = this.presets[presetId];
                    if (presetData) {
                        this.featuredPreset.name = presetData.name;
                        this.featuredPreset.description = presetData.description;
                    }

                    // Generate preview data for table
                    if (presetId === 'gemma3') {
                        this.featuredPreset.preview = [
                            { bar: 1, name: 'Cmaj9(#11)', notes: 'Lush, ambiguous start with #11' },
                            { bar: 2, name: 'F#m7b5(b9)', notes: 'Altered dominant resolving deceptively' },
                            { bar: 3, name: 'B7alt', notes: 'Highly altered dominant' },
                            { bar: 4, name: 'Em7/B', notes: 'E minor 7th over a B bass' },
                            { bar: '...', name: '...', notes: '...' },
                            { bar: 16, name: 'Cmaj7', notes: 'Simple Cmaj7 to ground the progression' }
                        ];
                    } else if (presetId === 'chatgpt45') {
                        this.featuredPreset.preview = [
                            { bar: 1, name: 'F#m9(maj7)/C#', notes: 'Dark, modal minor color (melodic minor)' },
                            { bar: 2, name: 'C13(b9)/E', notes: 'Altered dominant (Phrygian dominant)' },
                            { bar: 3, name: 'Bbmaj13(#11)', notes: 'Lydian color creating brightness' },
                            { bar: 4, name: 'A7alt', notes: 'Fully altered dominant (super Locrian)' },
                            { bar: '...', name: '...', notes: '...' },
                            { bar: 16, name: 'Gm11b5/C', notes: 'Ambiguous minor dominant suspended hybrid' }
                        ];
                    } else if (presetId === 'claude37') {
                        this.featuredPreset.preview = [
                            { bar: 'A1', name: 'Ebmaj7(#11)/G', notes: 'Upper-structure triads over unexpected bass' },
                            { bar: 'A2', name: 'G7(b9,#11)', notes: 'Creates tension with altered extensions' },
                            { bar: 'A3', name: 'Cmaj7(b5)/Bb', notes: 'Unusual bass note creates instability' },
                            { bar: 'B1', name: 'Dmaj9(#11)', notes: 'Start of chromatic metamorphosis' },
                            { bar: '...', name: '...', notes: '...' },
                            { bar: 'T4', name: 'Am11(b5)/E', notes: 'Sophisticated harmonic conclusion' }
                        ];
                    }
                },

                previewPreset(event, presetId) {
                    // If you already use Alpines @click.stop, you can omit the next line.
                    // event.stopPropagation();
                    // First update the featured preset preview.
                    this.updateFeaturedPresetPreview(presetId);
                    // Then play a representative chord from the preset.
                    const presetData = this.presets[presetId];
                    if (
                        presetData &&
                        presetData.sections &&
                        presetData.sections.length > 0 &&
                        presetData.sections[0].chords &&
                        presetData.sections[0].chords.length > 0
                    ) {
                        // Deep copy to avoid reference issues.
                        const sampleChord = JSON.parse(JSON.stringify(presetData.sections[0].chords[0]));
                        if (sampleChord.notes && Array.isArray(sampleChord.notes) && sampleChord.notes.length > 0) {
                            this.playChord(sampleChord);
                        }
                    }
                },

                /**
                 * Loads a preset progression with improved error handling and audio initialization.
                 * @param {string} presetId - The ID of the preset to load.
                 */
                loadPreset(presetId) {
                    try {
                        const hasExistingChords = this.currentProgression.sections.some(section =>
                            section.chords && Array.isArray(section.chords) && section.chords.length > 0
                        );
                        if (hasExistingChords && !confirm("This will replace your current progression. Continue?")) {
                            return;
                        }
                        if (this.isPlaying) this.stopPlayback();
                        const presetData = JSON.parse(JSON.stringify(this.presets[presetId]));
                        presetData.sections.forEach(section => {
                            section.chords = section.chords.map(chord => {
                                const validChord = { ...chord };
                                validChord.root = validChord.root || "C";
                                validChord.type = validChord.type || "major";
                                validChord.name = validChord.name || this.getChordDisplayName(validChord);
                                validChord.notes = (validChord.notes && Array.isArray(validChord.notes) && validChord.notes.length > 0) ?
                                    validChord.notes.filter(note => /^[A-G][#b]?\d$/.test(note)) :
                                    this.generateChordNotes(validChord.root, this.getIntervalsForChordType(validChord.type));
                                validChord.bass = validChord.bass || "";
                                validChord.annotation = validChord.annotation || "";
                                validChord.voicingStyle = validChord.voicingStyle || "close";
                                validChord.baseOctave = validChord.baseOctave || 3;
                                validChord.octaveSpan = validChord.octaveSpan || 2;
                                validChord.density = validChord.density || validChord.notes.length;
                                return validChord;
                            });
                        });
                        this.currentProgression = presetData;
                        setTimeout(() => {
                            this.currentProgression.sections.forEach((section, index) => {
                                this.initSectionSortable(index);
                            });
                        }, 100);
                        this.closePresetsModal();
                        this.featuredPreset.id = presetId;
                        this.featuredPreset.name = presetData.name || "Unnamed Preset";
                        this.featuredPreset.description = presetData.description || "";
                        this.updateTotalTime();
                        Tone.start().then(() => {
                            console.log("Audio context started for preset playback");
                            this.startPlayback();
                        }).catch(e => {
                            console.error("Failed to start audio for preset playback:", e);
                            alert("Click anywhere on the page to enable audio, then try playing again.");
                        });
                    } catch (e) {
                        console.error("Error loading preset:", e);
                        alert("There was an error loading the preset. Please try again.");
                    }
                },

                // Preset Data
                presets: {
                    // Preset 1: Gemma 3
                    'gemma3': {
                        name: "Sophisticated Jazz Progression (Gemma 3)",
                        description: "A 16-bar progression featuring polychords, altered dominants, and non-functional harmony",
                        sections: [
                            {
                                name: "16-Bar Progression",
                                chords: [
                                    {
                                        name: "Cmaj9(#11)",
                                        root: "C",
                                        type: "maj9",
                                        bass: "",
                                        notes: ['C3', 'E3', 'G3', 'B3', 'D4', 'F#4'],
                                        s11: true,
                                        annotation: "Lush, ambiguous start. The #11 adds a modern flavor."
                                    },
                                    {
                                        name: "F#m7b5(b9)",
                                        root: "F#",
                                        type: "m7b5",
                                        bass: "",
                                        notes: ['F#3', 'A3', 'C4', 'E4', 'G4'],
                                        b9: true,
                                        annotation: "Altered dominant resolving deceptively. Creates tension."
                                    },
                                    {
                                        name: "B7alt",
                                        root: "B",
                                        type: "alt",
                                        bass: "",
                                        notes: ['B2', 'D#3', 'F#3', 'A3', 'C4', 'E4', 'G4'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: "Highly altered dominant. Expect a surprising resolution."
                                    },
                                    {
                                        name: "Em7/B",
                                        root: "E",
                                        type: "m7",
                                        bass: "B",
                                        notes: ['B2', 'E3', 'G3', 'D4', 'F#4', 'A4', 'C5'],
                                        annotation: "E minor 7th over a B bass. Smooth voice leading from the B7alt."
                                    },
                                    {
                                        name: "Am7/C",
                                        root: "A",
                                        type: "m7",
                                        bass: "C",
                                        notes: ['C3', 'E3', 'G3', 'B3', 'D4', 'F4', 'A4'],
                                        annotation: "A minor 7th over a C bass. Creates a modal feel."
                                    },
                                    {
                                        name: "D7(b9,#9,#11)",
                                        root: "D",
                                        type: "7",
                                        bass: "",
                                        notes: ['D3', 'F#3', 'A3', 'C4', 'E#4', 'G#4', 'B#4'],
                                        b9: true,
                                        s9: true,
                                        s11: true,
                                        annotation: "Extremely altered dominant. Maximum tension."
                                    },
                                    {
                                        name: "Gm7/B",
                                        root: "G",
                                        type: "m7",
                                        bass: "B",
                                        notes: ['B2', 'D3', 'F3', 'A3', 'C4', 'E4', 'G4'],
                                        annotation: "G minor 7th over a B bass. Unexpected harmonic shift."
                                    },
                                    {
                                        name: "Cmaj7(#11)",
                                        root: "C",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['C3', 'E3', 'G3', 'B3', 'D#4', 'F#4', 'A#4'],
                                        s11: true,
                                        annotation: "Return to the opening chord, but with a different feel after the journey."
                                    },
                                    {
                                        name: "F#m7b5(b9)/A",
                                        root: "F#",
                                        type: "m7b5",
                                        bass: "A",
                                        notes: ['A2', 'C3', 'E3', 'G3', 'B3', 'D4', 'F4'],
                                        b9: true,
                                        annotation: "F#m7b5(b9) over an A bass. Adds a layer of complexity."
                                    },
                                    {
                                        name: "B7sus4(b9)",
                                        root: "B",
                                        type: "7sus4",
                                        bass: "",
                                        notes: ['B2', 'E3', 'F#3', 'A3', 'C4', 'D4', 'G4'],
                                        b9: true,
                                        annotation: "Suspended dominant with alterations. Prolongs the tension."
                                    },
                                    {
                                        name: "Em7/B",
                                        root: "E",
                                        type: "m7",
                                        bass: "B",
                                        notes: ['B2', 'E3', 'G3', 'D4', 'F#4', 'A4', 'C5'],
                                        annotation: "Return to the Em7/B, creating a cyclical feel."
                                    },
                                    {
                                        name: "Am7/C",
                                        root: "A",
                                        type: "m7",
                                        bass: "C",
                                        notes: ['C3', 'E3', 'G3', 'B3', 'D4', 'F4', 'A4'],
                                        annotation: "Return to the Am7/C, reinforcing the modal quality."
                                    },
                                    {
                                        name: "D7(b9,#9,#11)",
                                        root: "D",
                                        type: "7",
                                        bass: "",
                                        notes: ['D3', 'F#3', 'A3', 'C4', 'E#4', 'G#4', 'B#4'],
                                        b9: true,
                                        s9: true,
                                        s11: true,
                                        annotation: "Another highly altered dominant, building towards the climax."
                                    },
                                    {
                                        name: "Gm7/B",
                                        root: "G",
                                        type: "m7",
                                        bass: "B",
                                        notes: ['B2', 'D3', 'F3', 'A3', 'C4', 'E4', 'G4'],
                                        annotation: "Gm7/B again, creating a sense of inevitability."
                                    },
                                    {
                                        name: "Cmaj9(#11)",
                                        root: "C",
                                        type: "maj9",
                                        bass: "",
                                        notes: ['C3', 'E3', 'G3', 'B3', 'D4', 'F#4'],
                                        s11: true,
                                        annotation: "Return to the opening chord, but now with a sense of resolution."
                                    },
                                    {
                                        name: "Cmaj7",
                                        root: "C",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['C3', 'E3', 'G3', 'B3'],
                                        annotation: "Simple Cmaj7 to ground the progression."
                                    }
                                ],
                                collapsed: false,
                                annotation: "This progression uses polychords, slash chords, altered dominants and modal interchange to create a sophisticated harmonic palette."
                            }
                        ]
                    },

                    // Preset 2: ChatGPT 4.5
                    'chatgpt45': {
                        name: "Intricate Jazz Progression (ChatGPT 4.5)",
                        description: "A 16-bar progression with modal interchange, bitonal chords, and altered dominants",
                        sections: [
                            {
                                name: "16-Bar Progression",
                                chords: [
                                    {
                                        name: "F#m9(maj7)/C#",
                                        root: "F#",
                                        type: "m9",
                                        bass: "C#",
                                        notes: ['C#2', 'F#3', 'A3', 'E4', 'G#4', 'C#5'],
                                        annotation: "Dark, modal minor color (melodic minor), inverted for tension."
                                    },
                                    {
                                        name: "C13(b9)/E",
                                        root: "C",
                                        type: "13",
                                        bass: "E",
                                        notes: ['E2', 'C3', 'E3', 'G3', 'Bb3', 'D4', 'A4', 'Db4'],
                                        b9: true,
                                        annotation: "Altered dominant (Phrygian dominant); first-inversion voicing."
                                    },
                                    {
                                        name: "Bbmaj13(#11)",
                                        root: "Bb",
                                        type: "maj13",
                                        bass: "",
                                        notes: ['Bb2', 'D3', 'F3', 'A3', 'D4', 'E4', 'G4'],
                                        s11: true,
                                        annotation: "Lydian color creating brightness and openness."
                                    },
                                    {
                                        name: "A7alt",
                                        root: "A",
                                        type: "alt",
                                        bass: "",
                                        notes: ['A2', 'C#3', 'Eb3', 'G3', 'Bb3', 'D#4'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: "Fully altered dominant (super Locrian) for tense resolution."
                                    },
                                    {
                                        name: "Dm11/C",
                                        root: "D",
                                        type: "m11",
                                        bass: "C",
                                        notes: ['C2', 'D3', 'F3', 'A3', 'C4', 'G4'],
                                        annotation: "Modal Dorian minor with pedal bass for suspense."
                                    },
                                    {
                                        name: "G13sus4(b9)",
                                        root: "G",
                                        type: "13sus4",
                                        bass: "",
                                        notes: ['G2', 'C3', 'D3', 'F3', 'Ab3', 'E4'],
                                        b9: true,
                                        annotation: "Suspended altered dominant, hybrid phrygian/modal sound."
                                    },
                                    {
                                        name: "Abmaj7(#5)",
                                        root: "Ab",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['Ab2', 'C3', 'E3', 'G3'],
                                        s5: true,
                                        annotation: "Lydian Augmented sound creating dreamy, floating quality."
                                    },
                                    {
                                        name: "Gb13(#11)/B",
                                        root: "Gb",
                                        type: "13",
                                        bass: "B",
                                        notes: ['B2', 'Gb3', 'Bb3', 'Db3', 'F3', 'Ab3', 'C4'],
                                        s11: true,
                                        annotation: "Tritone-related dominant, polytonal feel due to bass note."
                                    },
                                    {
                                        name: "Emaj9(#11)/F",
                                        root: "E",
                                        type: "maj9",
                                        bass: "F",
                                        notes: ['F2', 'E3', 'G#3', 'B3', 'D#4', 'F#4', 'A#4'],
                                        s11: true,
                                        annotation: "Bitonal chord voicing; an E Lydian sound over unrelated bass."
                                    },
                                    {
                                        name: "Ebm9/Gb",
                                        root: "Eb",
                                        type: "m9",
                                        bass: "Gb",
                                        notes: ['Gb2', 'Eb3', 'Gb3', 'Bb3', 'Db4', 'F4'],
                                        annotation: "Rich minor coloration (Aeolian), third inversion adds ambiguity."
                                    },
                                    {
                                        name: "Db13sus2/F",
                                        root: "Db",
                                        type: "13",
                                        bass: "F",
                                        notes: ['F2', 'Db3', 'Eb3', 'Ab3', 'B3', 'F4', 'Bb4'],
                                        annotation: "Modern suspended chord with subtle cluster voicing."
                                    },
                                    {
                                        name: "Cmaj9/E",
                                        root: "C",
                                        type: "maj9",
                                        bass: "E",
                                        notes: ['E2', 'C3', 'E3', 'G3', 'B3', 'D4'],
                                        annotation: "Smooth pivot, major chord in first inversion for clarity."
                                    },
                                    {
                                        name: "Bbm6/9",
                                        root: "Bb",
                                        type: "m6",
                                        bass: "",
                                        notes: ['Bb2', 'Db3', 'F3', 'G3', 'C4'],
                                        annotation: "Darker minor voicing (Dorian minor), sophisticated flavor."
                                    },
                                    {
                                        name: "Eb7(#9#5)",
                                        root: "Eb",
                                        type: "7",
                                        bass: "",
                                        notes: ['Eb3', 'G3', 'B3', 'Db4', 'F#4'],
                                        s9: true,
                                        s5: true,
                                        annotation: "Highly altered dominant chord, strongly dissonant tension."
                                    },
                                    {
                                        name: "Abmaj7sus2(#11)",
                                        root: "Ab",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['Ab2', 'Bb2', 'Eb3', 'G3', 'D4'],
                                        s11: true,
                                        annotation: "Dreamy modal voicing, expansive open harmony."
                                    },
                                    {
                                        name: "Gm11b5/C",
                                        root: "G",
                                        type: "m11",
                                        bass: "C",
                                        notes: ['C2', 'G3', 'Db3', 'F3', 'Bb3', 'D4'],
                                        b5: true,
                                        annotation: "Ambiguous minor dominant suspended hybrid; floating suspension."
                                    }
                                ],
                                collapsed: false,
                                annotation: "This progression uses strategic inversions, bitonality, modal borrowing, and altered tones for an unconventional yet highly musical narrative."
                            }
                        ]
                    },

                    // Preset 3: Claude 3.7 Sonnet
                    'claude37': {
                        name: "Sophisticated Jazz Progression (Claude 3.7 Sonnet)",
                        description: "A multi-section progression with polytonal concepts and upper structure triads",
                        sections: [
                            {
                                name: "Section A - Ethereal Opening",
                                chords: [
                                    {
                                        name: "Ebmaj7(#11)/G",
                                        root: "Eb",
                                        type: "maj7",
                                        bass: "G",
                                        notes: ['G2', 'Eb3', 'G3', 'Bb3', 'D4', 'A4'],
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "G7(b9,#11)",
                                        root: "G",
                                        type: "7",
                                        bass: "",
                                        notes: ['G2', 'F3', 'Ab3', 'B3', 'D4', 'Eb4'],
                                        b9: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Cmaj7(b5)/Bb",
                                        root: "C",
                                        type: "maj7",
                                        bass: "Bb",
                                        notes: ['Bb2', 'C3', 'E3', 'Gb3', 'B3', 'E4'],
                                        b5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Abmaj9(#11)",
                                        root: "Ab",
                                        type: "maj9",
                                        bass: "",
                                        notes: ['Ab2', 'C3', 'Eb3', 'G3', 'Bb3', 'D4'],
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "F13(b9)",
                                        root: "F",
                                        type: "13",
                                        bass: "",
                                        notes: ['F2', 'Eb3', 'A3', 'C4', 'D4', 'Gb4'],
                                        b9: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "E7alt/Bb",
                                        root: "E",
                                        type: "alt",
                                        bass: "Bb",
                                        notes: ['Bb2', 'E3', 'G#3', 'D4', 'F#4', 'Bb4'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Amaj7(#9)/D",
                                        root: "A",
                                        type: "maj7",
                                        bass: "D",
                                        notes: ['D2', 'A3', 'C#3', 'E3', 'G#3', 'B#3'],
                                        s9: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Dbmaj7(#5,#11)",
                                        root: "Db",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['Db3', 'F3', 'A3', 'C4', 'G4'],
                                        s5: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Gmaj7(b13)/C",
                                        root: "G",
                                        type: "maj7",
                                        bass: "C",
                                        notes: ['C2', 'G3', 'B3', 'D4', 'F#4', 'Eb4'],
                                        b13: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "C7(#9,b13)",
                                        root: "C",
                                        type: "7",
                                        bass: "",
                                        notes: ['C3', 'E3', 'Bb3', 'D#4', 'Ab4'],
                                        s9: true,
                                        b13: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "F#m11(b5)",
                                        root: "F#",
                                        type: "m11",
                                        bass: "",
                                        notes: ['F#2', 'A3', 'C#4', 'E4', 'B4'],
                                        b5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "B7alt(add maj7)",
                                        root: "B",
                                        type: "alt",
                                        bass: "",
                                        notes: ['B2', 'A#3', 'D#4', 'F4', 'Ab4', 'C5'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: ""
                                    }
                                ],
                                collapsed: false,
                                annotation: "Section A creates tension through upper-structure triads over unexpected bass notes and unresolved dissonance. The progression uses quartal harmony and borrowed chords that defy traditional resolution."
                            },
                            {
                                name: "Section B - Chromatic Metamorphosis",
                                chords: [
                                    {
                                        name: "Dmaj9(#11)",
                                        root: "D",
                                        type: "maj9",
                                        bass: "",
                                        notes: ['D2', 'F#3', 'A3', 'C#4', 'E4', 'G#4'],
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "D#dim7(add13)",
                                        root: "D#",
                                        type: "dim7",
                                        bass: "",
                                        notes: ['D#2', 'F#3', 'A3', 'C4', 'B4'],
                                        annotation: ""
                                    },
                                    {
                                        name: "Ebmaj13/F",
                                        root: "Eb",
                                        type: "maj13",
                                        bass: "F",
                                        notes: ['F2', 'Eb3', 'G3', 'Bb3', 'D4', 'C5'],
                                        annotation: ""
                                    },
                                    {
                                        name: "F#7sus4(b9)/A",
                                        root: "F#",
                                        type: "7sus4",
                                        bass: "A",
                                        notes: ['A2', 'F#3', 'B3', 'E4', 'G4'],
                                        b9: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Bbmaj7(#5)/D",
                                        root: "Bb",
                                        type: "maj7",
                                        bass: "D",
                                        notes: ['D2', 'Bb3', 'D3', 'F3', 'A3'],
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "D7(#9,#11,b13)",
                                        root: "D",
                                        type: "7",
                                        bass: "",
                                        notes: ['D2', 'F#3', 'C4', 'F4', 'Ab4', 'B4'],
                                        s9: true,
                                        s11: true,
                                        b13: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "G-6/9(#11)",
                                        root: "G",
                                        type: "6",
                                        bass: "",
                                        notes: ['G2', 'Bb3', 'D3', 'Eb3', 'A3', 'C#4'],
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "C#7alt(add maj7)",
                                        root: "C#",
                                        type: "alt",
                                        bass: "",
                                        notes: ['C#3', 'C3', 'E3', 'G3', 'Bb3', 'D#4'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Fmaj7(#9,#11)/A",
                                        root: "F",
                                        type: "maj7",
                                        bass: "A",
                                        notes: ['A2', 'F3', 'A3', 'C4', 'E4', 'G#4', 'B4'],
                                        s9: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Ab13(#11,b9)",
                                        root: "Ab",
                                        type: "13",
                                        bass: "",
                                        notes: ['Ab2', 'G3', 'C4', 'Eb4', 'Gb4', 'D4'],
                                        s11: true,
                                        b9: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Dbmaj9(add6)/F",
                                        root: "Db",
                                        type: "maj9",
                                        bass: "F",
                                        notes: ['F2', 'Db3', 'F3', 'Ab3', 'C4', 'Eb4', 'Bb4'],
                                        annotation: ""
                                    },
                                    {
                                        name: "Bm11(b5)/F#",
                                        root: "B",
                                        type: "m11",
                                        bass: "F#",
                                        notes: ['F#2', 'B3', 'D4', 'F4', 'A4', 'E5'],
                                        b5: true,
                                        annotation: ""
                                    }
                                ],
                                collapsed: false,
                                annotation: "Section B explores chromatic movement with unconventional voice leading. The progression uses polychords and applies the concept of constant structure through chromatic shifts."
                            },
                            {
                                name: "Section C - Polytonal Resolution",
                                chords: [
                                    {
                                        name: "E7sus4(b9,13)/A",
                                        root: "E",
                                        type: "7sus4",
                                        bass: "A",
                                        notes: ['A2', 'E3', 'A3', 'B3', 'D4', 'F4', 'C5'],
                                        b9: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "A7(#9,#5)/D",
                                        root: "A",
                                        type: "7",
                                        bass: "D",
                                        notes: ['D2', 'A3', 'C#4', 'E4', 'G4', 'B#4'],
                                        s9: true,
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Dmaj9(b5)/G",
                                        root: "D",
                                        type: "maj9",
                                        bass: "G",
                                        notes: ['G2', 'D3', 'F#3', 'Ab3', 'C#4', 'E4'],
                                        b5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Gb13(#11)",
                                        root: "Gb",
                                        type: "13",
                                        bass: "",
                                        notes: ['Gb2', 'Bb3', 'Db4', 'Fb4', 'B4', 'Eb5'],
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Cmaj7(#9,#11)/E",
                                        root: "C",
                                        type: "maj7",
                                        bass: "E",
                                        notes: ['E2', 'C3', 'E3', 'G3', 'B3', 'D#4', 'F#4'],
                                        s9: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "E7alt(add4)",
                                        root: "E",
                                        type: "alt",
                                        bass: "",
                                        notes: ['E2', 'G#3', 'D4', 'F4', 'Ab4', 'A4'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Am11(maj7)/D",
                                        root: "A",
                                        type: "m11",
                                        bass: "D",
                                        notes: ['D2', 'A3', 'C4', 'E4', 'G4', 'G#4'],
                                        annotation: ""
                                    },
                                    {
                                        name: "D13(b9,#11)",
                                        root: "D",
                                        type: "13",
                                        bass: "",
                                        notes: ['D2', 'F#3', 'C4', 'Eb4', 'G#4', 'B4'],
                                        b9: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Gmaj13(#11)/B",
                                        root: "G",
                                        type: "maj13",
                                        bass: "B",
                                        notes: ['B2', 'G3', 'B3', 'D4', 'F#4', 'A4', 'C#5'],
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "B7(b9,b5,add11)",
                                        root: "B",
                                        type: "7",
                                        bass: "",
                                        notes: ['B2', 'D#3', 'A3', 'C3', 'E4', 'F4'],
                                        b9: true,
                                        b5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Em9(maj7)",
                                        root: "E",
                                        type: "m9",
                                        bass: "",
                                        notes: ['E3', 'G3', 'B3', 'D#4', 'F#4'],
                                        annotation: ""
                                    },
                                    {
                                        name: "Abmaj7(#9,#5)",
                                        root: "Ab",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['Ab2', 'C3', 'Eb3', 'G3', 'B3', 'C5'],
                                        s9: true,
                                        s5: true,
                                        annotation: ""
                                    }
                                ],
                                collapsed: false,
                                annotation: "Section C employs polytonal concepts with upper structure triads against pedal points, creating harmonic ambiguity. The progression concludes with deceptive resolution."
                            },
                            {
                                name: "Extended Turnaround",
                                chords: [
                                    {
                                        name: "Fmaj9(#5)/A",
                                        root: "F",
                                        type: "maj9",
                                        bass: "A",
                                        notes: ['A2', 'F3', 'A3', 'C4', 'E4', 'G4', 'C#5'],
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "F#7(b9,#11)/A#",
                                        root: "F#",
                                        type: "7",
                                        bass: "A#",
                                        notes: ['A#2', 'F#3', 'A#3', 'C#4', 'E4', 'G4', 'C5'],
                                        b9: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Bmaj13(b5)",
                                        root: "B",
                                        type: "maj13",
                                        bass: "",
                                        notes: ['B2', 'D#3', 'F4', 'A#4', 'C#5', 'G#5'],
                                        b5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "E7alt(add maj7)",
                                        root: "E",
                                        type: "alt",
                                        bass: "",
                                        notes: ['E2', 'D#3', 'G#3', 'Bb3', 'D4', 'G4'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Amaj9(#11)/C#",
                                        root: "A",
                                        type: "maj9",
                                        bass: "C#",
                                        notes: ['C#2', 'A3', 'C#4', 'E4', 'G#4', 'B4', 'D#5'],
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "D13(b9,#11)/F#",
                                        root: "D",
                                        type: "13",
                                        bass: "F#",
                                        notes: ['F#2', 'D3', 'F#3', 'A3', 'C4', 'Eb4', 'G#4'],
                                        b9: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "G7sus4(b13,9)",
                                        root: "G",
                                        type: "7sus4",
                                        bass: "",
                                        notes: ['G2', 'D3', 'F3', 'A3', 'C4', 'Eb4'],
                                        b13: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "C#7alt",
                                        root: "C#",
                                        type: "alt",
                                        bass: "",
                                        notes: ['C#3', 'F3', 'G3', 'B3', 'E4'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Fmaj7(#9,#11,13)",
                                        root: "F",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['F2', 'A3', 'C4', 'E4', 'G#4', 'B4', 'D5'],
                                        s9: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Bb13(#9,b5)",
                                        root: "Bb",
                                        type: "13",
                                        bass: "",
                                        notes: ['Bb2', 'D3', 'Ab3', 'C#4', 'F4', 'A4'],
                                        s9: true,
                                        b5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Ebmaj7(#5,9)",
                                        root: "Eb",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['Eb2', 'G3', 'Bb3', 'D4', 'F#4', 'F4'],
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Am11(b5)/E",
                                        root: "A",
                                        type: "m11",
                                        bass: "E",
                                        notes: ['E2', 'A3', 'C4', 'Eb4', 'G4', 'D5'],
                                        b5: true,
                                        annotation: ""
                                    }
                                ],
                                collapsed: false,
                                annotation: "The extended turnaround incorporates distant key relationships with chromatic median movements and upper structure triads to create a sophisticated harmonic conclusion."
                            }
                        ]
                    }
                }
            }));
        });
    </script>
</body>

</html>