<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Jazz Chord Progression Editor & Player</title>
    <!-- Make sure this meta tag is present in your head section -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Add these meta tags for better mobile experience -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1f2937">

    <!-- Load FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Alpine.js for interactions -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js"></script>
    <!-- Load Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- Load DaisyUI for enhanced components -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/daisyui/4.4.19/full.min.css" rel="stylesheet" type="text/css" />
    <!-- Load Tone.js for audio synthesis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Load SortableJS for drag-and-drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Load FileSaver.js for exporting files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Load Tonal.js for music theory utilities -->
    <script src="https://cdn.jsdelivr.net/npm/@tonaljs/tonal/browser/tonal.min.js"></script>
    <!-- Load Tippy.js for tooltips -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css" />

    <style>
        .chord-card.active {
            background-color: rgba(139, 92, 246, 0.2);
            border-color: #8b5cf6;
        }

        .chord-card.playing {
            animation: pulse 2s infinite;
            border-color: #8b5cf6;
            background-color: rgba(139, 92, 246, 0.3);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(139, 92, 246, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0);
            }
        }

        .chord-palette-item:hover {
            background-color: rgba(139, 92, 246, 0.1);
            cursor: pointer;
        }

        .sortable-ghost {
            opacity: 0.5;
            background: #f0f0f0;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2a303c;
        }

        ::-webkit-scrollbar-thumb {
            background: #3d4451;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #8b5cf6;
        }

        .timeline-scrubber {
            position: relative;
            height: 6px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 10px 0;
        }

        .timeline-progress {
            position: absolute;
            height: 100%;
            background: #8b5cf6;
            border-radius: 3px;
        }

        .timeline-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            top: 50%;
            margin-top: -6px;
            margin-left: -6px;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.4);
        }

        /* Virtual piano keyboard */
        .piano-key {
            height: 60px;
            border: 1px solid #ccc;
            display: inline-block;
            cursor: pointer;
            position: relative;
        }

        .white-key {
            background-color: white;
            width: 30px;
            z-index: 0;
        }

        .black-key {
            background-color: #333;
            width: 20px;
            height: 40px;
            z-index: 1;
            position: absolute;
            margin-left: -10px;
        }

        .piano-note-label {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #666;
        }

        .black-key .piano-note-label {
            color: white;
            bottom: 2px;
        }

        /* Better mobile scrolling */
        .overflow-y-auto,
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }

        /* Improved touch area for range sliders */
        input[type="range"] {
            height: 2rem;
        }

        /* Add momentum-based scrolling on iOS */
        .chord-palette-mobile {
            height: 80vh;
            max-height: 80vh;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 40;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.2);
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
        }

        .chord-palette-mobile.open {
            transform: translateY(0);
        }

        /* Add a safe area for iOS notches and home indicators */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .player-controls {
                padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            }

            .chord-palette-mobile {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Add tap highlight transparency for better mobile feel */
        * {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        }

        /* Helper class for better touch targets */
        .touch-manipulation {
            touch-action: manipulation;
        }

        .chord-card {
            transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s;
            touch-action: pan-y;
            /* Allow vertical scrolling but capture horizontal swipes */
        }

        .chord-card:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .sortable-chosen {
            background-color: rgba(139, 92, 246, 0.1) !important;
            border-color: #8b5cf6 !important;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.4) !important;
            z-index: 10;
        }

        .sortable-drag {
            opacity: 0.8 !important;
            transform: scale(1.02) !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
        }

        .sortable-ghost {
            background: rgba(255, 255, 255, 0.1) !important;
            opacity: 0.3 !important;
            border: 2px dashed rgba(139, 92, 246, 0.5) !important;
        }


        @keyframes swipeHint {
            0% {
                right: 10px;
                opacity: 0;
            }

            50% {
                right: 5px;
                opacity: 0.5;
            }

            100% {
                right: 0px;
                opacity: 0;
            }
        }

        @media (max-width: 768px) {

            input,
            select,
            textarea,
            button {
                font-size: 16px !important;
            }

            .modal-box {
                max-height: 80vh;
                overflow-y: auto;
            }

            /* Ensure full width for chord cards */
            .chord-card {
                width: 100% !important;
                max-width: 100% !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
                padding: 0.75rem !important;
                border-radius: 0.5rem !important;
                margin-bottom: 0.5rem !important;
            }

            /* Add a swipe hint for chord cards */
            .chord-card::after {
                content: '';
                position: absolute;
                top: 50%;
                width: 30px;
                height: 30px;
                transform: translateY(-50%);
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='rgba(139, 92, 246, 0.3)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M17 8l4 4-4 4M3 12h18'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                opacity: 0;
                transition: opacity 0.3s;
                pointer-events: none;
            }

            .chord-card:active::after {
                opacity: 0.7;
                animation: swipeHint 1s infinite;
            }

            /* Reduce unnecessary padding */
            .p-4,
            .p-6 {
                padding: 0.5rem !important;
            }

            /* Ensure the main editor uses full width */
            .flex-1 {
                width: 100% !important;
            }

            /* Make sure the sections use full width */
            [id^="chords-container-"] {
                width: 100% !important;
                display: grid;
                grid-template-columns: 1fr !important;
                /* Force single column on small screens */
            }

            body {
                position: relative;
                margin: 0;
                padding: 0;
                width: 100vw;
                overflow-x: hidden;
            }

            /* Prevent horizontal touch scrolling in the main content area */
            .progression-container {
                touch-action: pan-y;
                overflow-x: hidden;
                max-width: 100%;
            }

            /* Make section headings smaller and add truncation */
            .section-heading {
                font-size: 0.8rem !important;
                max-width: 85% !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Larger touch targets on mobile */
            .btn {
                min-height: 2.5rem;
            }

            .btn-circle {
                height: 2rem;
                width: 2rem;
                min-height: 2rem;
            }

            /* Remove rounded corners on mobile for edge-to-edge feel */
            .rounded-lg,
            .rounded-md {
                border-radius: 0 !important;
            }

            /* Remove horizontal padding on container elements */
            .container,
            .mx-auto {
                padding-left: 0 !important;
                padding-right: 0 !important;
                max-width: 100vw !important;
            }

            /* Add stretch animation for chord card interaction */
            .chord-card:active {
                transform: scaleX(0.98);
            }

            /* Force mobile dropdowns to appear in the center of the screen as a modal */
            .mobile-dropdown .dropdown-content {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 80vw !important;
                max-width: 300px !important;
                max-height: 80vh !important;
                overflow-y: auto !important;
                z-index: 999 !important;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.5) !important;
            }

            /* Add backdrop for better visibility */
            .dropdown.open::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 998;
            }

            /* Increase spacing for piano keys on touch devices */
            .piano-key {
                height: 80px;
            }

            .white-key {
                width: 40px;
            }

            .black-key {
                width: 24px;
                height: 50px;
                margin-left: -12px;
            }

            .player-controls .dropdown button,
            .player-controls select,
            .player-controls .btn {
                min-height: 2.5rem !important;
                min-width: 2.5rem !important;
                z-index: 5;
                position: relative;
            }

            /* Increase the dropdown z-index to ensure it appears above other elements */
            .player-controls .dropdown-content {
                z-index: 30 !important;
            }

            /* Add some spacing to prevent overlap */
            .player-controls .flex {
                gap: 0.5rem !important;
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen" x-data="chordEditor()" x-init="init()"
    @keydown.escape="closeAllModals()">

    <!-- Main layout -->
    <div class="flex flex-col h-screen">
        <!-- Top Navigation Bar -->
        <nav class="bg-gray-800 shadow-lg p-2 sm:p-4 flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-music text-violet-400 text-xl sm:text-2xl mr-2"></i>
                <h1 class="text-base sm:text-xl font-bold">
                    <span class="hidden sm:inline">Jazz Chord Progression Editor</span>
                    <span class="sm:hidden">Jazz Progressions</span>
                </h1>
            </div>

            <div class="flex space-x-1 sm:space-x-2">
                <button @click="emergencyResetAudio()" class="btn btn-xs sm:btn-sm btn-ghost"
                    title="Emergency Reset for Stuck Audio">
                    <i class="fas fa-bolt sm:mr-1"></i><span class="hidden sm:inline">Reset Audio</span>
                </button>

                <!-- Inline toggle for Advanced Voicing, neatly fitting in the nav row -->
                <div class="hidden md:flex items-center space-x-2">
                    <label class="label cursor-pointer m-0 gap-2">
                        <span class="text-sm">Advanced Voicing</span>
                        <input type="checkbox" class="toggle toggle-primary toggle-sm" x-model="useAdvancedVoicing" />
                    </label>
                    <span class="text-xs text-gray-400" x-text="useAdvancedVoicing
                            ? 'Advanced chord-voicing system enabled.'
                            : 'Using simpler chord-voicing logic.'">
                    </span>
                </div>

                <button @click="newProgression()" class="btn btn-xs sm:btn-sm btn-ghost">
                    <i class="fas fa-file sm:mr-1"></i><span class="hidden sm:inline">New</span>
                </button>
                <button @click="openPresetsModal()" class="btn btn-xs sm:btn-sm btn-ghost btn-primary text-white">
                    <i class="fas fa-star sm:mr-1"></i><span class="hidden sm:inline">Presets</span>
                </button>
                <button @click="saveProgressionToFile()" class="btn btn-xs sm:btn-sm btn-ghost">
                    <i class="fas fa-download sm:mr-1"></i><span class="hidden sm:inline">Export</span>
                </button>
                <button @click="openImportModal()" class="btn btn-xs sm:btn-sm btn-ghost">
                    <i class="fas fa-upload sm:mr-1"></i><span class="hidden sm:inline">Import</span>
                </button>
                <div class="dropdown dropdown-end mobile-dropdown">
                    <label tabindex="0" class="btn btn-xs sm:btn-sm btn-ghost">
                        <i class="fas fa-sliders-h"></i>
                    </label>
                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                        <li><a @click="openSettingsModal()"><i class="fas fa-cog mr-2"></i> Settings</a></li>
                        <li><a @click="openHelpModal()"><i class="fas fa-question-circle mr-2"></i> Help</a></li>
                        <li class="md:hidden"><a @click="toggleAdvancedVoicing()"><i class="fas fa-sliders-h mr-2"></i>
                                <span x-text="useAdvancedVoicing ? 'Simple Voicing' : 'Advanced Voicing'"></span></a>
                        </li>
                        <li><a @click="copyCurrentProgressionAsText()"><i class="fas fa-copy mr-2"></i> Copy as Text</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
            <!-- Left Sidebar - Chord Palette -->
            <div class="w-full md:w-72 bg-gray-800 p-4 overflow-y-auto fixed md:static inset-0 z-30"
                x-show="showChordPalette" x-transition:enter="transition ease-out duration-300 transform"
                x-transition:enter-start="translate-y-full md:translate-y-0" x-transition:enter-end="translate-y-0"
                x-transition:leave="transition ease-in duration-200 transform" x-transition:leave-start="translate-y-0"
                x-transition:leave-end="translate-y-full md:translate-y-0"
                @click.away="if(window.innerWidth < 768) toggleChordPalette()">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-violet-400">Chord Palette</h2>
                    <button @click="toggleChordPalette()" class="btn btn-sm btn-ghost md:hidden">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Add a floating button to open the chord palette on mobile -->
                <button @click="toggleChordPalette()"
                    class="fixed bottom-20 right-4 z-20 btn btn-primary btn-circle md:hidden shadow-lg"
                    x-show="!showChordPalette">
                    <i class="fas fa-book"></i>
                </button>


                <div class="mb-4">
                    <div class="form-control">
                        <div class="input-group">
                            <input type="text" placeholder="Search chords..."
                                class="input input-sm input-bordered w-full" x-model="chordSearchQuery"
                                @input="filterChordPalette()">
                            <button class="btn btn-sm btn-square">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="tabs tabs-boxed mb-4">
                    <a class="tab" :class="{'tab-active': activeChordCategory === 'basic'}"
                        @click="setChordCategory('basic')">Basic</a>
                    <a class="tab" :class="{'tab-active': activeChordCategory === 'jazz'}"
                        @click="setChordCategory('jazz')">Jazz</a>
                    <a class="tab" :class="{'tab-active': activeChordCategory === 'extended'}"
                        @click="setChordCategory('extended')">Extended</a>
                </div>

                <div class="collapse collapse-plus bg-base-200 mb-2" x-data="{open: true}">
                    <input type="checkbox" x-model="open" />
                    <div class="collapse-title text-sm font-medium">
                        Root Note
                    </div>
                    <div class="collapse-content" x-show="open">
                        <div class="grid grid-cols-4 gap-1">
                            <template x-for="note in rootNotes" :key="note">
                                <div class="btn btn-xs"
                                    :class="{'btn-primary': selectedRoot === note, 'btn-outline': selectedRoot !== note}"
                                    @click="selectedRoot = note" x-text="note"></div>
                            </template>
                        </div>
                    </div>
                </div>

                <div class="space-y-1 mt-4">
                    <template x-for="(category, categoryName) in filteredChordTypes" :key="categoryName">
                        <div class="mb-4">
                            <h3 class="text-sm font-semibold text-gray-400 mb-2" x-text="categoryName"></h3>
                            <div class="space-y-1">
                                <template x-for="chord in category" :key="chord.name">
                                    <div class="chord-palette-item px-3 py-2 rounded-md text-sm flex justify-between items-center"
                                        @click="addChordToProgression(chord)">
                                        <span x-text="selectedRoot + chord.suffix"></span>
                                        <button class="btn btn-xs btn-ghost btn-circle"
                                            @click.stop="previewChord(chord)">
                                            <i class="fas fa-play text-xs"></i>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="divider my-4">Custom Chord</div>

                <div class="bg-base-200 p-3 rounded-lg">
                    <div class="form-control mb-2">
                        <label class="label pt-0">
                            <span class="label-text text-xs">Root</span>
                        </label>
                        <select class="select select-sm select-bordered w-full" x-model="customChord.root">
                            <template x-for="note in rootNotes" :key="note">
                                <option :value="note" x-text="note"></option>
                            </template>
                        </select>
                    </div>

                    <div class="form-control mb-2">
                        <label class="label pt-0">
                            <span class="label-text text-xs">Chord Type</span>
                        </label>
                        <select class="select select-sm select-bordered w-full" x-model="customChord.type">
                            <option value="major">Major</option>
                            <option value="minor">Minor</option>
                            <option value="7">Dominant 7th</option>
                            <option value="maj7">Major 7th</option>
                            <option value="m7">Minor 7th</option>
                            <option value="dim">Diminished</option>
                            <option value="aug">Augmented</option>
                            <option value="sus4">Sus4</option>
                            <option value="6">6th</option>
                            <option value="m6">Minor 6th</option>
                            <option value="9">9th</option>
                            <option value="maj9">Major 9th</option>
                            <option value="m9">Minor 9th</option>
                            <option value="11">11th</option>
                            <option value="13">13th</option>
                            <option value="alt">Altered</option>
                        </select>
                    </div>

                    <div class="form-control mb-2">
                        <label class="label pt-0">
                            <span class="label-text text-xs">Extensions (optional)</span>
                        </label>
                        <div class="grid grid-cols-2 gap-1">
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="customChord.b5">
                                <span class="label-text text-xs">b5</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="customChord.s5">
                                <span class="label-text text-xs">#5</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="customChord.b9">
                                <span class="label-text text-xs">b9</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="customChord.s9">
                                <span class="label-text text-xs">#9</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="customChord.s11">
                                <span class="label-text text-xs">#11</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="customChord.b13">
                                <span class="label-text text-xs">b13</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-control mb-2">
                        <label class="label pt-0">
                            <span class="label-text text-xs">Bass Note (optional)</span>
                        </label>
                        <select class="select select-sm select-bordered w-full" x-model="customChord.bass">
                            <option value="">Same as root</option>
                            <template x-for="note in rootNotes" :key="note">
                                <option :value="note" x-text="note"></option>
                            </template>
                        </select>
                    </div>

                    <button class="btn btn-sm btn-primary w-full mt-2" @click="addCustomChord()">
                        Add Custom Chord
                    </button>
                </div>
            </div>

            <!-- Main Editor Area -->
            <div class="flex-1 p-2 sm:p-4 md:p-6 overflow-y-auto relative w-full">

                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-2">
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold">
                            <span x-text="currentProgression.name || 'Untitled Progression'"
                                class="truncate block"></span>
                            <button @click="editProgressionName()" class="btn btn-xs btn-ghost ml-2">
                                <i class="fas fa-edit"></i>
                            </button>
                        </h2>
                        <p class="text-gray-400 text-sm" x-show="currentProgression.description">
                            <span x-text="currentProgression.description"></span>
                        </p>
                    </div>

                    <div class="flex gap-2">
                        <button @click="toggleChordPalette()" class="btn btn-sm btn-outline md:hidden">
                            <i class="fas fa-book"></i> Palette
                        </button>
                        <button @click="createNewSection()" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus"></i> <span class="hidden xs:inline">Add Section</span>
                        </button>
                    </div>
                </div>
                <div class="space-y-6 mb-10 progression-container">
                    <template x-for="(section, sectionIndex) in currentProgression.sections" :key="sectionIndex">
                        <div class="bg-gray-800 rounded-lg p-2 sm:p-4 w-full">
                            <div class="flex justify-between items-center mb-3 sm:mb-4">
                                <div class="flex items-center max-w-[70%]">
                                    <button class="btn btn-xs btn-circle mr-2"
                                        @click="toggleSectionCollapse(sectionIndex)">
                                        <i class="fas"
                                            :class="section.collapsed ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
                                    </button>

                                    <div x-show="!section.isEditingName" class="flex items-center">
                                        <h3 class="text-lg sm:text-xl font-bold section-heading truncate"
                                            x-text="section.name"></h3>
                                        <button @click="startEditSectionName(sectionIndex)"
                                            class="btn btn-xs btn-ghost ml-2">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>

                                    <div x-show="section.isEditingName" class="flex">
                                        <input type="text" class="input input-xs sm:input-sm input-bordered mr-2"
                                            x-model="section.editNameValue"
                                            @keyup.enter="saveSectionName(sectionIndex)">
                                        <button @click="saveSectionName(sectionIndex)" class="btn btn-xs btn-primary">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="flex gap-1">
                                    <button class="btn btn-xs btn-outline" @click="playSection(sectionIndex)">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="btn btn-xs btn-outline" @click="addChordToSection(sectionIndex)">
                                        <i class="fas fa-plus"></i> <span class="hidden xs:inline">Add</span>
                                    </button>
                                    <div class="dropdown dropdown-end">
                                        <label tabindex="0" class="btn btn-xs btn-ghost">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </label>
                                        <ul tabindex="0"
                                            class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-48">
                                            <li><a @click="duplicateSection(sectionIndex)">
                                                    <i class="fas fa-copy mr-2"></i> Duplicate Section
                                                </a></li>
                                            <li><a @click="addAnnotationToSection(sectionIndex)">
                                                    <i class="fas fa-comment mr-2"></i> Add Section Annotation
                                                </a></li>
                                            <li><a @click="moveSectionUp(sectionIndex)" x-show="sectionIndex > 0">
                                                    <i class="fas fa-arrow-up mr-2"></i> Move Up
                                                </a></li>
                                            <li><a @click="moveSectionDown(sectionIndex)"
                                                    x-show="sectionIndex < currentProgression.sections.length - 1">
                                                    <i class="fas fa-arrow-down mr-2"></i> Move Down
                                                </a></li>
                                            <li><a @click="deleteSection(sectionIndex)" class="text-error">
                                                    <i class="fas fa-trash mr-2"></i> Delete Section
                                                </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div x-show="section.annotation"
                                class="bg-base-300 rounded-md p-2 sm:p-3 mb-3 sm:mb-4 text-xs sm:text-sm">
                                <div class="flex justify-between">
                                    <p x-text="section.annotation"></p>
                                    <button @click="editSectionAnnotation(sectionIndex)" class="btn btn-xs btn-ghost">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>

                            <div x-show="!section.collapsed">
                                <div :id="'chords-container-' + sectionIndex"
                                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 w-full max-w-full">
                                    <template x-for="(chord, chordIndex) in section.chords" :key="chordIndex">
                                        <div class="chord-card border border-gray-700 rounded-md p-2 sm:p-3 transition-all touch-manipulation"
                                            :class="{'playing': isChordPlaying(sectionIndex, chordIndex), 'active': selectedChordIndices.section === sectionIndex && selectedChordIndices.chord === chordIndex}">

                                            <div class="absolute left-0 top-0 bottom-0 w-12 opacity-0 hover:opacity-30 active:opacity-50 bg-gradient-to-r from-red-500 to-transparent md:hidden"
                                                @click="moveChordLeft(sectionIndex, chordIndex)"
                                                x-show="chordIndex > 0">
                                                <div class="flex h-full items-center justify-center">
                                                    <i class="fas fa-chevron-left text-white"></i>
                                                </div>
                                            </div>

                                            <div class="absolute right-0 top-0 bottom-0 w-12 opacity-0 hover:opacity-30 active:opacity-50 bg-gradient-to-l from-green-500 to-transparent md:hidden"
                                                @click="moveChordRight(sectionIndex, chordIndex)"
                                                x-show="chordIndex < section.chords.length - 1">
                                                <div class="flex h-full items-center justify-center">
                                                    <i class="fas fa-chevron-right text-white"></i>
                                                </div>
                                            </div>


                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <div class="text-lg font-bold" x-text="getChordDisplayName(chord)">
                                                    </div>
                                                    <div class="text-xs text-gray-400 mt-1">
                                                        <span x-text="formatChordNotes(chord.notes)"
                                                            class="truncate block max-w-[120px] sm:max-w-full"></span>
                                                    </div>
                                                </div>
                                                <div class="flex gap-1">
                                                    <button @click="playChord(chord)"
                                                        class="btn btn-xs btn-circle btn-ghost">
                                                        <i class="fas fa-play text-xs"></i>
                                                    </button>
                                                    <div class="dropdown dropdown-end">
                                                        <label tabindex="0"
                                                            class="btn btn-xs btn-circle btn-ghost cursor-pointer">
                                                            <i class="fas fa-ellipsis-v"></i>
                                                        </label>
                                                        <ul tabindex="0"
                                                            class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-48">
                                                            <li><a @click="editChord(sectionIndex, chordIndex)">
                                                                    <i class="fas fa-edit mr-2"></i> Edit Chord
                                                                </a></li>
                                                            <li>
                                                                @click="addChordAnnotation(sectionIndex, chordIndex)">
                                                                <i class="fas fa-comment mr-2"></i> Add Annotation
                                                                </a>
                                                            </li>
                                                            <li><a @click="duplicateChord(sectionIndex, chordIndex)">
                                                                    <i class="fas fa-copy mr-2"></i> Duplicate
                                                                </a></li>
                                                            <li><a @click="moveChordLeft(sectionIndex, chordIndex)"
                                                                    x-show="chordIndex > 0">
                                                                    <i class="fas fa-arrow-left mr-2"></i> Move Left
                                                                </a></li>
                                                            <li><a @click="moveChordRight(sectionIndex, chordIndex)"
                                                                    x-show="chordIndex < section.chords.length - 1">
                                                                    <i class="fas fa-arrow-right mr-2"></i> Move Right
                                                                </a></li>
                                                            <li><a @click="deleteChord(sectionIndex, chordIndex)"
                                                                    class="text-error">
                                                                    <i class="fas fa-trash mr-2"></i> Delete
                                                                </a></li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>

                                            <div x-show="chord.annotation"
                                                class="mt-2 sm:mt-3 text-xs bg-base-300 p-1 sm:p-2 rounded text-gray-300">
                                                <div class="flex justify-between">
                                                    <p x-text="chord.annotation"></p>
                                                    <button @click="editChordAnnotation(sectionIndex, chordIndex)"
                                                        class="btn btn-xs btn-ghost btn-circle">
                                                        <i class="fas fa-edit text-xs"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Inside the Player Controls div -->
        <div class="bg-gray-800 border-t border-gray-700 p-4 shadow-lg player-controls">
            <div class="container mx-auto">
                <!-- Replace the existing content with this enhanced version -->
                <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-4 w-full lg:w-auto">
                        <div class="flex gap-2">
                            <button @click="restartPlayback()" class="btn btn-circle btn-sm btn-outline">
                                <i class="fas fa-step-backward"></i>
                            </button>

                            <button @click="togglePlay()" class="btn btn-circle btn-md sm:btn-sm">
                                <i :class="isPlaying ? 'fas fa-pause' : 'fas fa-play'"></i>
                            </button>

                            <button @click="stopPlayback()" class="btn btn-circle btn-sm btn-outline">
                                <i class="fas fa-stop"></i>
                            </button>
                        </div>

                        <div class="text-sm">
                            <div class="font-semibold" x-text="currentChordName || 'Not Playing'"></div>
                            <div class="text-xs text-gray-400" x-text="currentSectionName || ''"></div>
                        </div>
                    </div>

                    <div class="w-full lg:w-1/2">
                        <div class="timeline-scrubber" @click="seekToPosition($event)">
                            <div class="timeline-progress" :style="'width: ' + progressPercentage + '%'"></div>
                            <div class="timeline-handle" :style="'left: ' + progressPercentage + '%'"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-400">
                            <span x-text="formatTime(elapsedTime)"></span>
                            <span x-text="formatTime(totalTime)"></span>
                        </div>
                    </div>

                    <!-- Mobile-optimized controls with dropdown for settings -->
                    <div class="flex items-center gap-4 w-full lg:w-auto">
                        <div class="hidden sm:flex items-center gap-2">
                            <i class="fas fa-music text-sm"></i>
                            <select x-model="instrument" @change="changeInstrument()"
                                class="select select-sm select-bordered">
                                <option value="piano">Piano</option>
                                <option value="rhodes">Electric Piano</option>
                                <option value="synth">Moog Synth</option>
                                <option value="warm-pad">Warm Pad</option>
                                <option value="analog-saw">Analog Saw</option>
                                <option value="marimba">Marimba</option>
                                <option value="vibraphone">Vibraphone</option>
                            </select>
                        </div>

                        <div class="hidden sm:flex items-center gap-2">
                            <i class="fas fa-volume-up text-sm"></i>
                            <input type="range" min="0" max="1" step="0.1" x-model="volume" @change="updateVolume()"
                                class="range range-xs range-primary w-20">
                        </div>

                        <div class="hidden sm:flex items-center gap-2">
                            <i class="fas fa-tachometer-alt text-sm"></i>
                            <select x-model="tempo" @change="updateTempo()" class="select select-sm select-bordered">
                                <option value="40">40 BPM</option>
                                <option value="60">60 BPM</option>
                                <option value="80">80 BPM</option>
                                <option value="100">100 BPM</option>
                                <option value="120">120 BPM</option>
                                <option value="140">140 BPM</option>
                                <option value="160">160 BPM</option>
                            </select>
                        </div>

                        <!-- Mobile-only dropdown for settings -->
                        <div class="dropdown dropdown-end sm:hidden">
                            <label tabindex="0" class="btn btn-sm btn-circle"><i class="fas fa-sliders-h"></i></label>
                            <ul tabindex="0"
                                class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 mt-4 z-40">
                                <li>
                                    <div class="p-2 w-full">
                                        <label class="label">Instrument</label>
                                        <select x-model="instrument" @change="changeInstrument()"
                                            class="select select-sm select-bordered w-full">
                                            <option value="piano">Piano</option>
                                            <option value="rhodes">Electric Piano</option>
                                            <option value="synth">Moog Synth</option>
                                            <option value="warm-pad">Warm Pad</option>
                                            <option value="analog-saw">Analog Saw</option>
                                            <option value="marimba">Marimba</option>
                                            <option value="vibraphone">Vibraphone</option>
                                        </select>
                                    </div>
                                </li>
                                <li>
                                    <div class="p-2 w-full">
                                        <label class="label">Volume</label>
                                        <input type="range" min="0" max="1" step="0.1" x-model="volume"
                                            @change="updateVolume()" class="range range-xs range-primary w-full">
                                    </div>
                                </li>
                                <li>
                                    <div class="p-2 w-full">
                                        <label class="label">Tempo</label>
                                        <select x-model="tempo" @change="updateTempo()"
                                            class="select select-sm select-bordered w-full">
                                            <option value="40">40 BPM</option>
                                            <option value="60">60 BPM</option>
                                            <option value="80">80 BPM</option>
                                            <option value="100">100 BPM</option>
                                            <option value="120">120 BPM</option>
                                            <option value="140">140 BPM</option>
                                            <option value="160">160 BPM</option>
                                        </select>
                                    </div>
                                </li>
                            </ul>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <!-- Presets Modal -->
        <div class="modal" :class="{'modal-open': showPresetsModal}">
            <div class="modal-box w-11/12 max-w-2xl">
                <h3 class="font-bold text-lg mb-4">Jazz Progression Presets</h3>
                <p class="text-sm text-gray-400 mb-6">Select a professionally crafted jazz chord progression to use as a
                    starting point</p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Preset 1 - Gemma 3 -->
                    <div class="card bg-base-200 hover:bg-base-300 transition-colors cursor-pointer">
                        <div class="card-body">
                            <h2 class="card-title">
                                <span class="badge badge-primary">Gemma 3</span>
                            </h2>
                            <p class="text-sm">16-bar progression with polychords, altered dominants, and non-functional
                                harmony</p>
                            <div class="card-actions justify-end mt-2">
                                <button class="btn btn-sm btn-outline" @click.stop="previewPreset('gemma3')">
                                    <i class="fas fa-play mr-1"></i> Preview
                                </button>
                                <button class="btn btn-sm btn-primary" @click.stop="loadPreset('gemma3')">
                                    <i class="fas fa-check mr-1"></i> Select
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Preset 2 - ChatGPT 4.5 -->
                    <div class="card bg-base-200 hover:bg-base-300 transition-colors cursor-pointer">
                        <div class="card-body">
                            <h2 class="card-title">
                                <span class="badge badge-secondary">ChatGPT 4.5</span>
                            </h2>
                            <p class="text-sm">16-bar sequence with modal interchange, bitonal chords, and altered
                                dominants</p>
                            <div class="card-actions justify-end mt-2">
                                <button class="btn btn-sm btn-outline" @click.stop="previewPreset('chatgpt45')">
                                    <i class="fas fa-play mr-1"></i> Preview
                                </button>
                                <button class="btn btn-sm btn-primary" @click.stop="loadPreset('chatgpt45')">
                                    <i class="fas fa-check mr-1"></i> Select
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Preset 3 - Claude 3.7 Sonnet -->
                    <div class="card bg-base-200 hover:bg-base-300 transition-colors cursor-pointer">
                        <div class="card-body">
                            <h2 class="card-title">
                                <span class="badge badge-accent">Claude 3.7</span>
                            </h2>
                            <p class="text-sm">Sophisticated 4-section progression with polytonal concepts and upper
                                structure triads</p>
                            <div class="card-actions justify-end mt-2">
                                <button class="btn btn-sm btn-outline" @click.stop="previewPreset('claude37')">
                                    <i class="fas fa-play mr-1"></i> Preview
                                </button>
                                <button class="btn btn-sm btn-primary" @click.stop="loadPreset('claude37')">
                                    <i class="fas fa-check mr-1"></i> Select
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="divider my-4">Featured Progression</div>

                <div class="bg-base-200 p-4 rounded-lg">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="font-bold text-lg" x-text="featuredPreset.name"></h3>
                            <p class="text-sm text-gray-400" x-text="featuredPreset.description"></p>
                        </div>
                        <button class="btn btn-primary" @click="loadPreset(featuredPreset.id)">
                            Use This Progression
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th>Bar</th>
                                    <th>Chord</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(chord, index) in featuredPreset.preview" :key="index">
                                    <tr>
                                        <td x-text="chord.bar"></td>
                                        <td x-text="chord.name"></td>
                                        <td x-text="chord.notes"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="modal-action">
                    <button @click="closePresetsModal()" class="btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Edit Chord Modal -->
        <div class="modal" :class="{'modal-open': showEditChordModal}">
            <div class="modal-box w-11/12 max-w-2xl">
                <h3 class="font-bold text-lg mb-4">Edit Chord</h3>

                <div class="tabs tabs-boxed mb-4">
                    <a class="tab" :class="{'tab-active': editChordTab === 'basic'}"
                        @click="editChordTab = 'basic'">Basic</a>
                    <a class="tab" :class="{'tab-active': editChordTab === 'advanced'}"
                        @click="editChordTab = 'advanced'">Advanced</a>
                    <a class="tab" :class="{'tab-active': editChordTab === 'notes'}"
                        @click="editChordTab = 'notes'">Notes</a>
                </div>

                <div x-show="editChordTab === 'basic'">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Root Note</span>
                            </label>
                            <select class="select select-bordered w-full" x-model="editingChord.root">
                                <template x-for="note in rootNotes" :key="note">
                                    <option :value="note" x-text="note"></option>
                                </template>
                            </select>
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Chord Type</span>
                            </label>
                            <select class="select select-bordered w-full" x-model="editingChord.type"
                                @change="updateEditingChordFromType()">
                                <option value="major">Major</option>
                                <option value="minor">Minor</option>
                                <option value="7">Dominant 7th</option>
                                <option value="maj7">Major 7th</option>
                                <option value="m7">Minor 7th</option>
                                <option value="dim">Diminished</option>
                                <option value="aug">Augmented</option>
                                <option value="sus4">Sus4</option>
                                <option value="6">6th</option>
                                <option value="m6">Minor 6th</option>
                                <option value="9">9th</option>
                                <option value="maj9">Major 9th</option>
                                <option value="m9">Minor 9th</option>
                                <option value="11">11th</option>
                                <option value="13">13th</option>
                                <option value="alt">Altered</option>
                            </select>
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Bass Note (for slash chords)</span>
                            </label>
                            <select class="select select-bordered w-full" x-model="editingChord.bass">
                                <option value="">Same as root</option>
                                <template x-for="note in rootNotes" :key="note">
                                    <option :value="note" x-text="note"></option>
                                </template>
                            </select>
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Annotation (optional)</span>
                            </label>
                            <input type="text" class="input input-bordered w-full" x-model="editingChord.annotation"
                                placeholder="Add a note about this chord...">
                        </div>
                    </div>

                    <div class="form-control mt-4">
                        <label class="label">
                            <span class="label-text">Extensions & Alterations</span>
                        </label>
                        <div class="grid grid-cols-3 md:grid-cols-6 gap-2">
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.b5">
                                <span class="label-text">b5</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.s5">
                                <span class="label-text">#5</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.b9">
                                <span class="label-text">b9</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.s9">
                                <span class="label-text">#9</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.s11">
                                <span class="label-text">#11</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.b13">
                                <span class="label-text">b13</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-control mt-4">
                        <label class="label">
                            <span class="label-text">Preview</span>
                        </label>
                        <div class="bg-base-300 p-4 rounded-md flex justify-between items-center">
                            <div>
                                <div class="text-lg font-bold" x-text="getChordDisplayName(editingChord)"></div>
                                <div class="text-sm text-gray-400" x-text="formatChordNotes(editingChord.notes)"></div>
                            </div>
                            <button @click="previewEditingChord()" class="btn btn-sm btn-primary">
                                <i class="fas fa-play mr-1"></i> Play
                            </button>
                        </div>
                    </div>
                </div>

                <div x-show="editChordTab === 'advanced'">
                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text">Voicing Style</span>
                        </label>
                        <select class="select select-bordered w-full" x-model="editingChord.voicingStyle"
                            @change="regenerateChordNotes()">
                            <option value="close">Close Voicing</option>
                            <option value="open">Open Voicing</option>
                            <option value="drop2">Drop 2 Voicing</option>
                            <option value="spread">Spread Voicing</option>
                            <option value="quartal">Quartal (4ths)</option>
                            <option value="cluster">Cluster</option>
                        </select>
                    </div>

                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text">Octave Range</span>
                        </label>
                        <div class="flex gap-4">
                            <div class="w-1/2">
                                <label class="label pt-0">
                                    <span class="label-text text-xs">Bass Octave</span>
                                </label>
                                <select class="select select-bordered w-full" x-model="editingChord.baseOctave"
                                    @change="regenerateChordNotes()">
                                    <option value="1">Very Low (1)</option>
                                    <option value="2">Low (2)</option>
                                    <option value="3">Middle (3)</option>
                                    <option value="4">High (4)</option>
                                </select>
                            </div>
                            <div class="w-1/2">
                                <label class="label pt-0">
                                    <span class="label-text text-xs">Span (octaves)</span>
                                </label>
                                <select class="select select-bordered w-full" x-model="editingChord.octaveSpan"
                                    @change="regenerateChordNotes()">
                                    <option value="1">Tight (1)</option>
                                    <option value="2">Normal (2)</option>
                                    <option value="3">Wide (3)</option>
                                    <option value="4">Very Wide (4)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text">Tension Notes (add to chord)</span>
                        </label>
                        <div class="grid grid-cols-4 gap-2">
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.tensions" value="add9" @change="regenerateChordNotes()">
                                <span class="label-text">add9</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.tensions" value="add11" @change="regenerateChordNotes()">
                                <span class="label-text">add11</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.tensions" value="add13" @change="regenerateChordNotes()">
                                <span class="label-text">add13</span>
                            </label>
                            <label class="label cursor-pointer justify-start gap-2 bg-base-300 rounded-md px-2">
                                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary"
                                    x-model="editingChord.tensions" value="addb9" @change="regenerateChordNotes()">
                                <span class="label-text">addb9</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-control mb-4">
                        <label class="label flex justify-between">
                            <span class="label-text">Chord Density</span>
                            <span class="label-text-alt" x-text="editingChord.density + ' notes'"></span>
                        </label>
                        <input type="range" min="3" max="7" class="range range-primary" x-model="editingChord.density"
                            @change="regenerateChordNotes()">
                        <div class="w-full flex justify-between text-xs px-2 mt-1">
                            <span>Triad</span>
                            <span>Tetrad</span>
                            <span>Complex</span>
                        </div>
                    </div>
                </div>

                <div x-show="editChordTab === 'notes'">
                    <p class="text-sm mb-4">Manually adjust individual notes in the chord. Click on the piano keyboard
                        to hear each note.</p>

                    <div class="flex justify-center mb-6 overflow-x-auto">
                        <!-- Mini piano keyboard for note selection -->
                        <div class="relative h-[60px] whitespace-nowrap">
                            <!-- White keys -->
                            <template x-for="(note, i) in pianoNotes.filter(n => !n.includes('#'))" :key="i">
                                <div :data-note="note" class="piano-key white-key inline-block align-top"
                                    :class="{'bg-violet-200': isNoteInChord(note)}" @click="toggleNoteInChord(note)">
                                    <div class="piano-note-label" x-text="note.slice(0, -1)"></div>
                                </div>
                            </template>

                            <!-- Black keys -->
                            <template x-for="(note, i) in pianoNotes.filter(n => n.includes('#'))" :key="i">
                                <div :data-note="note" class="piano-key black-key inline-block align-top"
                                    :class="{'bg-violet-800': isNoteInChord(note)}"
                                    :style="`left: ${getBlackKeyPosition(note)}px`" @click="toggleNoteInChord(note)">
                                    <div class="piano-note-label" x-text="note.slice(0, -1)"></div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="bg-base-300 p-4 rounded-md mb-4">
                        <h4 class="font-semibold mb-2">Current Notes</h4>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="(note, index) in editingChord.notes" :key="index">
                                <div class="badge badge-lg badge-primary gap-1">
                                    <span x-text="note"></span>
                                    <button @click="removeNoteFromChord(index)" class="btn btn-xs btn-circle btn-ghost">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Add New Note</span>
                        </label>
                        <div class="flex gap-2">
                            <select class="select select-bordered w-full" x-model="newNoteToAdd">
                                <template x-for="note in noteLetters" :key="note">
                                    <option :value="note" x-text="note"></option>
                                </template>
                            </select>
                            <select class="select select-bordered w-full" x-model="newNoteOctave">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                            <button @click="addNoteToChord()" class="btn btn-primary">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <button @click="sortChordNotes()" class="btn btn-sm btn-outline mt-4">
                        <i class="fas fa-sort mr-1"></i> Sort Notes
                    </button>
                </div>

                <div class="modal-action">
                    <button @click="cancelEditChord()" class="btn">Cancel</button>
                    <button @click="saveEditedChord()" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Import Modal -->
        <div class="modal" :class="{'modal-open': showImportModal}">
            <div class="modal-box w-11/12 max-w-2xl">
                <h3 class="font-bold text-lg mb-4">Import Progression</h3>

                <div class="tabs tabs-boxed mb-4">
                    <a class="tab" :class="{'tab-active': importTab === 'file'}" @click="importTab = 'file'">From
                        File</a>
                    <a class="tab" :class="{'tab-active': importTab === 'text'}" @click="importTab = 'text'">From
                        Text</a>
                </div>

                <div x-show="importTab === 'file'">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">Upload JSON file</span>
                        </label>
                        <input type="file" class="file-input file-input-bordered w-full" accept=".json"
                            @change="handleFileUpload($event)">
                    </div>

                    <div class="alert alert-info mt-4" x-show="importMessage">
                        <i class="fas fa-info-circle"></i>
                        <span x-text="importMessage"></span>
                    </div>
                </div>

                <div x-show="importTab === 'text'">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">Paste progression JSON</span>
                        </label>
                        <textarea class="textarea textarea-bordered h-40"
                            placeholder="Paste your chord progression JSON here..." x-model="importJsonText"></textarea>
                    </div>
                </div>

                <div class="modal-action">
                    <button @click="closeImportModal()" class="btn">Cancel</button>
                    <button @click="importFromText()" x-show="importTab === 'text'"
                        class="btn btn-primary">Import</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal" :class="{'modal-open': showSettingsModal}">
            <div class="modal-box w-11/12 max-w-2xl">
                <h3 class="font-bold text-lg mb-4">Settings</h3>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Default Chord Duration (seconds)</span>
                    </label>
                    <input type="range" min="0.5" max="4" step="0.5" class="range range-primary"
                        x-model="chordDuration">
                    <div class="flex justify-between text-xs px-2 mt-1">
                        <span>0.5s</span>
                        <span>1s</span>
                        <span>2s</span>
                        <span>3s</span>
                        <span>4s</span>
                    </div>
                </div>

                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Default Reverb Amount</span>
                    </label>
                    <input type="range" min="0" max="1" step="0.1" class="range range-primary" x-model="reverb"
                        @change="updateEffects()">
                    <div class="flex justify-between text-xs px-2 mt-1">
                        <span>None</span>
                        <span>Low</span>
                        <span>Medium</span>
                        <span>High</span>
                        <span>Max</span>
                    </div>
                </div>

                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Interface Theme</span>
                    </label>
                    <select class="select select-bordered w-full" x-model="theme" @change="applyTheme()">
                        <option value="dark">Dark</option>
                        <option value="synthwave">Synthwave</option>
                        <option value="luxury">Luxury</option>
                        <option value="dracula">Dracula</option>
                        <option value="business">Business</option>
                        <option value="night">Night</option>
                    </select>
                </div>

                <div class="modal-action">
                    <button @click="closeSettingsModal()" class="btn btn-primary">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div class="modal" :class="{'modal-open': showHelpModal}">
            <div class="modal-box w-11/12 max-w-2xl">
                <h3 class="font-bold text-lg mb-4">Jazz Chord Progression Editor Help</h3>

                <div class="tabs tabs-boxed mb-4">
                    <a class="tab" :class="{'tab-active': helpTab === 'basics'}" @click="helpTab = 'basics'">Basics</a>
                    <a class="tab" :class="{'tab-active': helpTab === 'chords'}" @click="helpTab = 'chords'">Chord
                        Types</a>
                    <a class="tab" :class="{'tab-active': helpTab === 'keyboard'}"
                        @click="helpTab = 'keyboard'">Keyboard Shortcuts</a>
                </div>

                <div class="overflow-y-auto pr-2" style="max-height: 60vh;">
                    <div x-show="helpTab === 'basics'">
                        <h4 class="font-bold mb-2">Getting Started</h4>
                        <ul class="list-disc ml-6 space-y-2 mb-4">
                            <li>Use the <b>Chord Palette</b> on the left to browse and add chords to your progression.
                            </li>
                            <li>Create <b>Sections</b> to organize your progression (verse, chorus, bridge, etc.).</li>
                            <li>Add <b>Annotations</b> to sections or individual chords to include notes about
                                performance or theory.</li>
                            <li>Use the playback controls at the bottom to listen to your progression.</li>
                        </ul>

                        <h4 class="font-bold mb-2">Managing Your Work</h4>
                        <ul class="list-disc ml-6 space-y-2 mb-4">
                            <li>Use <b>Export</b> to save your progression as a JSON file that you can share or reuse
                                later.</li>
                            <li>Use <b>Import</b> to load a previously saved progression.</li>
                            <li>The <b>New</b> button creates a fresh progression.</li>
                        </ul>

                        <h4 class="font-bold mb-2">Editing Chords</h4>
                        <ul class="list-disc ml-6 space-y-2">
                            <li>Click the <b>three dots</b> menu on any chord to edit, delete, or duplicate it.</li>
                            <li>In the chord editor, use the <b>Basic</b> tab for quick changes or the <b>Advanced</b>
                                tab for detailed voicing options.</li>
                            <li>The <b>Notes</b> tab allows you to manually edit the specific notes in each chord.</li>
                        </ul>
                    </div>

                    <div x-show="helpTab === 'chords'" class="space-y-4">
                        <h4 class="font-bold mb-2">Common Jazz Chord Types</h4>

                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Symbol</th>
                                        <th>Example</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Major 7th</td>
                                        <td>maj7</td>
                                        <td>Cmaj7</td>
                                        <td>C E G B</td>
                                    </tr>
                                    <tr>
                                        <td>Dominant 7th</td>
                                        <td>7</td>
                                        <td>C7</td>
                                        <td>C E G Bb</td>
                                    </tr>
                                    <tr>
                                        <td>Minor 7th</td>
                                        <td>m7</td>
                                        <td>Cm7</td>
                                        <td>C Eb G Bb</td>
                                    </tr>
                                    <tr>
                                        <td>Half-diminished</td>
                                        <td>m7b5</td>
                                        <td>Cm7b5</td>
                                        <td>C Eb Gb Bb</td>
                                    </tr>
                                    <tr>
                                        <td>Diminished 7th</td>
                                        <td>dim7</td>
                                        <td>Cdim7</td>
                                        <td>C Eb Gb A</td>
                                    </tr>
                                    <tr>
                                        <td>Augmented</td>
                                        <td>aug</td>
                                        <td>Caug</td>
                                        <td>C E G#</td>
                                    </tr>
                                    <tr>
                                        <td>Major 9th</td>
                                        <td>maj9</td>
                                        <td>Cmaj9</td>
                                        <td>C E G B D</td>
                                    </tr>
                                    <tr>
                                        <td>Dominant 9th</td>
                                        <td>9</td>
                                        <td>C9</td>
                                        <td>C E G Bb D</td>
                                    </tr>
                                    <tr>
                                        <td>Minor 9th</td>
                                        <td>m9</td>
                                        <td>Cm9</td>
                                        <td>C Eb G Bb D</td>
                                    </tr>
                                    <tr>
                                        <td>Dominant 13th</td>
                                        <td>13</td>
                                        <td>C13</td>
                                        <td>C E G Bb D F A</td>
                                    </tr>
                                    <tr>
                                        <td>Altered Dominant</td>
                                        <td>7alt</td>
                                        <td>C7alt</td>
                                        <td>C E G Bb Db Eb Ab</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h4 class="font-bold mb-2">Common Extensions & Alterations</h4>
                        <ul class="list-disc ml-6 space-y-1">
                            <li><b>b5</b> - Flattened 5th (Gb in C chord)</li>
                            <li><b>#5</b> - Sharpened 5th (G# in C chord)</li>
                            <li><b>b9</b> - Flattened 9th (Db in C chord)</li>
                            <li><b>#9</b> - Sharpened 9th (D# in C chord)</li>
                            <li><b>#11</b> - Sharpened 11th (F# in C chord)</li>
                            <li><b>b13</b> - Flattened 13th (Ab in C chord)</li>
                        </ul>
                    </div>

                    <div x-show="helpTab === 'keyboard'">
                        <h4 class="font-bold mb-2">Keyboard Shortcuts</h4>
                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full">
                                <thead>
                                    <tr>
                                        <th>Shortcut</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><kbd class="kbd">Space</kbd></td>
                                        <td>Play/Pause progression</td>
                                    </tr>
                                    <tr>
                                        <td><kbd class="kbd">Esc</kbd></td>
                                        <td>Close any open modal</td>
                                    </tr>
                                    <tr>
                                        <td><kbd class="kbd">Ctrl</kbd> + <kbd class="kbd">S</kbd></td>
                                        <td>Export progression</td>
                                    </tr>
                                    <tr>
                                        <td><kbd class="kbd">Ctrl</kbd> + <kbd class="kbd">N</kbd></td>
                                        <td>New progression</td>
                                    </tr>
                                    <tr>
                                        <td><kbd class="kbd">Ctrl</kbd> + <kbd class="kbd">O</kbd></td>
                                        <td>Open import modal</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="modal-action">
                    <button @click="closeHelpModal()" class="btn">Close</button>
                </div>
            </div>
        </div>

        <!-- Name Edit Modal -->
        <div class="modal" :class="{'modal-open': showNameEditModal}">
            <div class="modal-box w-11/12 max-w-2xl">
                <h3 class="font-bold text-lg mb-4">Edit Progression Details</h3>

                <div class="form-control mb-4">
                    <label class="label">
                        <span class="label-text">Progression Name</span>
                    </label>
                    <input type="text" class="input input-bordered w-full" x-model="editingProgressionName"
                        placeholder="Enter a name...">
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Description (optional)</span>
                    </label>
                    <textarea class="textarea textarea-bordered h-20" x-model="editingProgressionDescription"
                        placeholder="Enter a description..."></textarea>
                </div>

                <div class="modal-action">
                    <button @click="cancelNameEdit()" class="btn">Cancel</button>
                    <button @click="saveProgressionName()" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>

        <!-- Annotation Modal -->
        <div class="modal" :class="{'modal-open': showAnnotationModal}">
            <div class="modal-box w-11/12 max-w-2xl">
                <h3 class="font-bold text-lg mb-4" x-text="annotationModalTitle"></h3>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Annotation Text</span>
                    </label>
                    <textarea class="textarea textarea-bordered h-32" x-model="editingAnnotation"
                        placeholder="Enter annotation text..."></textarea>
                </div>

                <div class="modal-action">
                    <button @click="cancelAnnotation()" class="btn">Cancel</button>
                    <button @click="saveAnnotation()" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Libraries -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('chordEditor', () => ({
                // UI State
                audioInitialized: false,
                showChordPalette: true,
                showEditChordModal: false,
                showImportModal: false,
                showSettingsModal: false,
                showHelpModal: false,
                showNameEditModal: false,
                showAnnotationModal: false,
                showPresetsModal: false,
                activeChordCategory: 'basic',
                editChordTab: 'basic',
                importTab: 'file',
                helpTab: 'basics',
                chordSearchQuery: '',
                theme: 'dark',
                featuredPreset: {
                    id: 'gemma3',
                    name: 'Sophisticated Jazz Progression (Gemma 3)',
                    description: 'A 16-bar progression with polychords, altered dominants, and non-functional harmony',
                    preview: []
                },

                // Player State
                isPlaying: true,
                useAdvancedVoicing: false,
                tempo: 60,
                chordDuration: 2,
                currentChordIndex: 0,
                currentSectionIndex: 0,
                currentChordName: "",
                currentSectionName: "",
                progressPercentage: 0,
                elapsedTime: 0,
                totalTime: 0,
                instrument: "synth",
                reverb: 0.7,
                volume: 0.7,
                isMobile: window.innerWidth < 768,
                safeAreaBottom: 0,

                // Editing State
                editingSectionIndex: null,
                editingChordIndex: null,
                editingChord: {
                    name: "",
                    root: "C",
                    type: "maj7",
                    bass: "",
                    notes: [],
                    b5: false,
                    s5: false,
                    b9: false,
                    s9: false,
                    s11: false,
                    b13: false,
                    annotation: "",
                    voicingStyle: "close",
                    baseOctave: 3,
                    octaveSpan: 2,
                    density: 4,
                    tensions: []
                },
                editingProgressionName: "",
                editingProgressionDescription: "",
                editingAnnotation: "",
                annotationModalTitle: "",
                annotationTarget: { type: null, sectionIndex: null, chordIndex: null },
                selectedChordIndices: { section: null, chord: null },
                importJsonText: "",
                importMessage: "",

                // Custom Chord Builder
                customChord: {
                    root: "C",
                    type: "major",
                    b5: false,
                    s5: false,
                    b9: false,
                    s9: false,
                    s11: false,
                    b13: false,
                    bass: ""
                },

                // Piano keyboard
                pianoNotes: ['C3', 'C#3', 'D3', 'D#3', 'E3', 'F3', 'F#3', 'G3', 'G#3', 'A3', 'A#3', 'B3', 'C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4', 'A#4', 'B4'],
                noteLetters: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],
                newNoteToAdd: 'C',
                newNoteOctave: '3',

                // Audio
                synth: null,
                chordSequence: null,
                reverb_effect: null,

                // Chord data
                rootNotes: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],
                selectedRoot: 'C',

                // Voice leading state
                voiceLeadingState: {
                    previousNotes: null,
                    currentVoicing: null
                },

                toggleAdvancedVoicing() {
                    this.useAdvancedVoicing = !this.useAdvancedVoicing;
                },

                // Current progression data
                currentProgression: {
                    name: "My Jazz Progression",
                    description: "",
                    sections: [
                        {
                            name: "Section A",
                            chords: [
                                {
                                    name: "Cmaj7(#11)",
                                    root: "C",
                                    type: "maj7",
                                    bass: "",
                                    notes: ['C3', 'E3', 'G3', 'B3', 'F#4'],
                                    s11: true,
                                    annotation: "",
                                    voicingStyle: "close",
                                    baseOctave: 3,
                                    octaveSpan: 2,
                                    density: 5,
                                    tensions: ["#11"]
                                },
                                {
                                    name: "D7(b9)",
                                    root: "D",
                                    type: "7",
                                    bass: "",
                                    notes: ['D3', 'F#3', 'A3', 'C4', 'Eb4'],
                                    b9: true,
                                    annotation: "",
                                    voicingStyle: "close",
                                    baseOctave: 3,
                                    octaveSpan: 2,
                                    density: 5
                                },
                                {
                                    name: "Gmaj9",
                                    root: "G",
                                    type: "maj9",
                                    bass: "",
                                    notes: ['G2', 'B2', 'D3', 'F#3', 'A3'],
                                    annotation: "",
                                    voicingStyle: "close",
                                    baseOctave: 2,
                                    octaveSpan: 2,
                                    density: 5
                                },
                                {
                                    name: "E7alt",
                                    root: "E",
                                    type: "alt",
                                    bass: "",
                                    notes: ['E2', 'G#2', 'D3', 'F3', 'Bb3'],
                                    b9: true,
                                    s9: true,
                                    b5: true,
                                    s5: true,
                                    annotation: "",
                                    voicingStyle: "close",
                                    baseOctave: 2,
                                    octaveSpan: 2,
                                    density: 5
                                }
                            ],
                            collapsed: false,
                            annotation: "Ethereal opening section with advanced harmonic techniques"
                        }
                    ]
                },

                // Chord type definitions
                chordTypes: {
                    'Basic': [
                        { name: 'Major', suffix: '', notes: ['1', '3', '5'] },
                        { name: 'Minor', suffix: 'm', notes: ['1', 'b3', '5'] },
                        { name: 'Diminished', suffix: 'dim', notes: ['1', 'b3', 'b5'] },
                        { name: 'Augmented', suffix: 'aug', notes: ['1', '3', '#5'] },
                        { name: 'Sus4', suffix: 'sus4', notes: ['1', '4', '5'] },
                        { name: 'Sus2', suffix: 'sus2', notes: ['1', '2', '5'] },
                        { name: '6th', suffix: '6', notes: ['1', '3', '5', '6'] },
                        { name: 'Minor 6th', suffix: 'm6', notes: ['1', 'b3', '5', '6'] }
                    ],
                    'Seventh Chords': [
                        { name: 'Major 7th', suffix: 'maj7', notes: ['1', '3', '5', '7'] },
                        { name: 'Dominant 7th', suffix: '7', notes: ['1', '3', '5', 'b7'] },
                        { name: 'Minor 7th', suffix: 'm7', notes: ['1', 'b3', '5', 'b7'] },
                        { name: 'Minor Major 7th', suffix: 'mMaj7', notes: ['1', 'b3', '5', '7'] },
                        { name: 'Half-Diminished', suffix: 'm7b5', notes: ['1', 'b3', 'b5', 'b7'] },
                        { name: 'Diminished 7th', suffix: 'dim7', notes: ['1', 'b3', 'b5', 'bb7'] },
                        { name: 'Augmented 7th', suffix: 'aug7', notes: ['1', '3', '#5', 'b7'] },
                        { name: 'Augmented Major 7th', suffix: 'augMaj7', notes: ['1', '3', '#5', '7'] }
                    ],
                    'Extended Chords': [
                        { name: 'Major 9th', suffix: 'maj9', notes: ['1', '3', '5', '7', '9'] },
                        { name: 'Dominant 9th', suffix: '9', notes: ['1', '3', '5', 'b7', '9'] },
                        { name: 'Minor 9th', suffix: 'm9', notes: ['1', 'b3', '5', 'b7', '9'] },
                        { name: 'Dominant 11th', suffix: '11', notes: ['1', '3', '5', 'b7', '9', '11'] },
                        { name: 'Minor 11th', suffix: 'm11', notes: ['1', 'b3', '5', 'b7', '9', '11'] },
                        { name: 'Dominant 13th', suffix: '13', notes: ['1', '3', '5', 'b7', '9', '11', '13'] },
                        { name: 'Major 13th', suffix: 'maj13', notes: ['1', '3', '5', '7', '9', '11', '13'] },
                        { name: 'Minor 13th', suffix: 'm13', notes: ['1', 'b3', '5', 'b7', '9', '11', '13'] }
                    ],
                    'Altered Chords': [
                        { name: 'Dominant 7 b9', suffix: '7b9', notes: ['1', '3', '5', 'b7', 'b9'] },
                        { name: 'Dominant 7 #9', suffix: '7#9', notes: ['1', '3', '5', 'b7', '#9'] },
                        { name: 'Dominant 7 #11', suffix: '7#11', notes: ['1', '3', '5', 'b7', '#11'] },
                        { name: 'Dominant 7 b13', suffix: '7b13', notes: ['1', '3', '5', 'b7', 'b13'] },
                        { name: 'Dominant 7 b5', suffix: '7b5', notes: ['1', '3', 'b5', 'b7'] },
                        { name: 'Dominant 7 #5', suffix: '7#5', notes: ['1', '3', '#5', 'b7'] },
                        { name: 'Altered Dominant', suffix: '7alt', notes: ['1', '3', 'b5/#5', 'b7', 'b9/#9'] },
                        { name: 'Lydian Dominant', suffix: '7#11', notes: ['1', '3', '5', 'b7', '9', '#11'] }
                    ],
                    'Jazz Voicings': [
                        { name: 'Major 7 #11', suffix: 'maj7#11', notes: ['1', '3', '5', '7', '#11'] },
                        { name: 'Minor 9 b5', suffix: 'm9b5', notes: ['1', 'b3', 'b5', 'b7', '9'] },
                        { name: 'Dominant 9 sus4', suffix: '9sus4', notes: ['1', '4', '5', 'b7', '9'] },
                        { name: 'Dominant 13 sus4', suffix: '13sus4', notes: ['1', '4', '5', 'b7', '9', '13'] },
                        { name: 'Dominant 7 b9 sus4', suffix: '7b9sus4', notes: ['1', '4', '5', 'b7', 'b9'] },
                        { name: 'Minor 6/9', suffix: 'm6/9', notes: ['1', 'b3', '5', '6', '9'] },
                        { name: 'Major 6/9', suffix: '6/9', notes: ['1', '3', '5', '6', '9'] },
                        { name: 'Dominant 9 b5', suffix: '9b5', notes: ['1', '3', 'b5', 'b7', '9'] }
                    ]
                },
                filteredChordTypes: {},

                init() {
                    if (this.isInitialized) {
                        console.log("Already initialized, skipping...");
                        return;
                    }
                    try {
                        console.log("Initializing Jazz Chord Editor...");

                        this.filterChordPalette();
                        this.applyTheme();
                        this.updateTotalTime();
                        this.updateFeaturedPresetPreview('gemma3');

                        // Store the keydown handler as a property so we can remove it later
                        this.keydownHandler = (e) => {
                            try {
                                if (e.key === ' ' && !this.isModalOpen()) {
                                    e.preventDefault();
                                    this.togglePlay();
                                }
                                if (e.ctrlKey && e.key === 's') {
                                    e.preventDefault();
                                    this.saveProgressionToFile();
                                }
                                if (e.ctrlKey && e.key === 'n') {
                                    e.preventDefault();
                                    this.newProgression();
                                }
                                if (e.ctrlKey && e.key === 'o') {
                                    e.preventDefault();
                                    this.openImportModal();
                                }
                            } catch (e) {
                                console.error("Error in keyboard event handler:", e);
                            }
                        };

                        // Add the event listener
                        window.addEventListener('keydown', this.keydownHandler);

                        if (!this.audioInitialized) {
                            this.createAudioEnableOverlay();
                        } else {
                            console.log('Audio is already initialized, skipping overlay');
                        }

                        console.log("Basic initialization complete. Audio will be initialized after user interaction.");
                        this.isInitialized = true; // Mark as initialized

                        // Set up unload handler for cleanup
                        window.addEventListener('beforeunload', () => this.cleanup());

                        // Validate progression notes
                        this.validateProgressionNotes();

                        // Add event listeners for custom swipe events
                        document.addEventListener('move-chord-right', (e) => {
                            const { sectionIndex, chordIndex } = e.detail;
                            this.moveChordRight(sectionIndex, chordIndex);
                        });

                        document.addEventListener('move-chord-left', (e) => {
                            const { sectionIndex, chordIndex } = e.detail;
                            this.moveChordLeft(sectionIndex, chordIndex);
                        });

                        // Initialize swipe gestures when DOM is ready
                        this.$nextTick(() => {
                            this.initSwipeGestures();

                            // Re-initialize after any section changes
                            this.$watch('currentProgression.sections', () => {
                                setTimeout(() => {
                                    this.initSwipeGestures();
                                }, 200);
                            }, { deep: true });
                        });

                        // Track touch start position for swipe detection
                        this.touchStartX = null;

                        document.addEventListener('touchstart', e => {
                            this.touchStartX = e.changedTouches[0].pageX;
                        });

                        // Add touch indicators on mobile
                        if (window.innerWidth < 768) {
                            this.addTouchIndicators();
                        }


                    } catch (e) {
                        console.error("Error initializing app:", e);
                    }
                },

                cleanup() {
                    try {
                        console.log("Cleaning up Jazz Chord Editor resources...");
                        if (this.keydownHandler) {
                            window.removeEventListener('keydown', this.keydownHandler);
                            this.keydownHandler = null;
                        }
                        if (this.isPlaying) this.stopPlayback();
                        if (Tone.Transport) {
                            Tone.Transport.stop();
                            Tone.Transport.cancel(0);
                        }
                        if (this.chordSequence) {
                            this.chordSequence.dispose();
                            this.chordSequence = null;
                        }
                        if (this.synth) {
                            this.synth.dispose();
                            this.synth = null;
                        }
                        if (this.reverb_effect) {
                            this.reverb_effect.dispose();
                            this.reverb_effect = null;
                        }
                        if (this.masterEQ) {
                            this.masterEQ.dispose();
                            this.masterEQ = null;
                        }
                        if (this.limiter) {
                            this.limiter.dispose();
                            this.limiter = null;
                        }
                        if (this.instrumentEffects) {
                            this.instrumentEffects.forEach(effect => effect.dispose());
                            this.instrumentEffects = [];
                        }
                        console.log("Cleanup complete");
                    } catch (e) {
                        console.error("Error during cleanup:", e);
                    }
                },

                mounted() {
                    // Check if device is mobile
                    this.isMobile = window.innerWidth < 768;

                    // Add resize listener
                    window.addEventListener('resize', () => {
                        this.isMobile = window.innerWidth < 768;
                    });

                    // Get safe area insets for iOS
                    if (CSS.supports('padding-bottom: env(safe-area-inset-bottom)')) {
                        const safeAreaValue = getComputedStyle(document.documentElement).getPropertyValue('--sat-safe-area-bottom');
                        this.safeAreaBottom = parseInt(safeAreaValue) || 0;
                    }
                },

                // Improved modal handling for mobile
                openModalMobile(modalName) {
                    this[modalName] = true;
                    document.body.style.overflow = 'hidden';
                },

                closeModalMobile(modalName) {
                    this[modalName] = false;
                    document.body.style.overflow = '';
                },

                // Add this method to your Alpine.js component
                addTouchIndicators() {
                    // Create visual indicators for touch actions
                    const touchIndicators = {
                        left: document.createElement('div'),
                        right: document.createElement('div')
                    };

                    // Style the indicators
                    Object.values(touchIndicators).forEach(indicator => {
                        indicator.style.position = 'fixed';
                        indicator.style.top = '50%';
                        indicator.style.transform = 'translateY(-50%)';
                        indicator.style.width = '40px';
                        indicator.style.height = '40px';
                        indicator.style.borderRadius = '50%';
                        indicator.style.display = 'flex';
                        indicator.style.alignItems = 'center';
                        indicator.style.justifyContent = 'center';
                        indicator.style.color = 'white';
                        indicator.style.fontSize = '1.5rem';
                        indicator.style.zIndex = '9999';
                        indicator.style.opacity = '0';
                        indicator.style.transition = 'opacity 0.2s';
                        document.body.appendChild(indicator);
                    });

                    // Left indicator
                    touchIndicators.left.style.left = '10px';
                    touchIndicators.left.style.backgroundColor = 'rgba(255, 0, 0, 0.5)';
                    touchIndicators.left.innerHTML = '<i class="fas fa-chevron-left"></i>';

                    // Right indicator
                    touchIndicators.right.style.right = '10px';
                    touchIndicators.right.style.backgroundColor = 'rgba(0, 255, 0, 0.5)';
                    touchIndicators.right.innerHTML = '<i class="fas fa-chevron-right"></i>';

                    // Show indicators based on swipe direction
                    document.addEventListener('touchmove', e => {
                        if (!this.touchStartX) return;

                        const touchObj = e.changedTouches[0];
                        const distX = touchObj.pageX - this.touchStartX;

                        if (Math.abs(distX) > 50) {
                            if (distX < 0) {
                                // Swiping left
                                touchIndicators.left.style.opacity = '0.7';
                                touchIndicators.right.style.opacity = '0';
                            } else {
                                // Swiping right
                                touchIndicators.right.style.opacity = '0.7';
                                touchIndicators.left.style.opacity = '0';
                            }
                        } else {
                            // Reset if not enough movement
                            touchIndicators.left.style.opacity = '0';
                            touchIndicators.right.style.opacity = '0';
                        }
                    });

                    // Hide indicators when touch ends
                    document.addEventListener('touchend', () => {
                        touchIndicators.left.style.opacity = '0';
                        touchIndicators.right.style.opacity = '0';
                    });
                },

                // New method to create an overlay that requires user interaction
                createAudioEnableOverlay() {
                    // If we've already initialized, don't show again
                    if (this.audioInitialized) {
                        console.log("Audio already initialized, skipping overlay");
                        return;
                    }

                    const overlay = document.createElement('div');
                    overlay.id = 'audio-enable-overlay';
                    overlay.style.position = 'fixed';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.width = '100%';
                    overlay.style.height = '100%';
                    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                    overlay.style.display = 'flex';
                    overlay.style.justifyContent = 'center';
                    overlay.style.alignItems = 'center';
                    overlay.style.zIndex = '9999';

                    const content = document.createElement('div');
                    content.style.backgroundColor = '#2a303c';
                    content.style.padding = '2rem';
                    content.style.borderRadius = '0.5rem';
                    content.style.maxWidth = '500px';
                    content.style.textAlign = 'center';

                    const title = document.createElement('h2');
                    title.innerText = 'Enable Audio';
                    title.style.color = '#fff';
                    title.style.marginBottom = '1rem';

                    const message = document.createElement('p');
                    message.innerText = 'This application uses Web Audio to play jazz chord progressions. Browser security requires a user interaction before audio can be enabled.';
                    message.style.color = '#ccc';
                    message.style.marginBottom = '1.5rem';

                    const button = document.createElement('button');
                    button.innerText = 'Click to Enable Audio';
                    button.className = 'btn btn-primary btn-lg';
                    button.style.padding = '0.75rem 1.5rem';

                    // Store reference to overlay for retries
                    this.audioOverlay = overlay;

                    // Add error message container (hidden by default)
                    const errorContainer = document.createElement('div');
                    errorContainer.style.color = '#ff6b6b';
                    errorContainer.style.marginTop = '1rem';
                    errorContainer.style.display = 'none';
                    this.audioErrorContainer = errorContainer;

                    content.appendChild(title);
                    content.appendChild(message);
                    content.appendChild(button);
                    content.appendChild(errorContainer);
                    overlay.appendChild(content);

                    // Add event listener for the simplest possible audio initialization
                    button.addEventListener('click', () => {
                        try {
                            // Mark that we've started initialization
                            this.audioInitialized = true;

                            // Show loading state
                            button.disabled = true;
                            button.innerText = 'Initializing Audio...';
                            errorContainer.style.display = 'none';

                            // Use the most basic audio initialization possible
                            this.basicAudioInitialization(button, errorContainer, overlay);
                        } catch (e) {
                            console.error("Error in click handler:", e);
                            this.showAudioError("Unexpected error. Please try again.", button, errorContainer);
                            // Reset if there was an error
                            this.audioInitialized = false;
                        }
                    });

                    document.body.appendChild(overlay);
                },

                /**
                 * Initializes the audio subsystem with proper error handling.
                 * @param {HTMLElement} button - The button element to update.
                 * @param {HTMLElement} errorContainer - Container for error messages.
                 * @param {HTMLElement} overlay - The overlay to remove on success.
                 */
                basicAudioInitialization(button, errorContainer, overlay) {
                    try {
                        // First try with a simple approach
                        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

                        // Check if audio context started
                        if (audioCtx.state !== 'running') {
                            audioCtx.resume().then(() => {
                                console.log("AudioContext resumed successfully.");

                                // IMPORTANT: Call Tone.start() right here in the same user gesture,
                                // so Chrome sees it as a direct click action and unsuspends audio.
                                Tone.start().then(() => {
                                    console.log("Tone.js successfully started. Now initializing the main synth...");

                                    // Now initialize Tone.js with our custom routine
                                    this.initSimpleTone(audioCtx, button, errorContainer, overlay);

                                    // Remove overlay after successful init
                                    if (overlay && overlay.parentNode) {
                                        document.body.removeChild(overlay);
                                    }
                                }).catch(err => {
                                    console.error("Failed to start Tone.js:", err);
                                    this.showAudioError("Could not start Tone.js. Please try again.", button, errorContainer);
                                    // Reset audio initialization flag
                                    this.audioInitialized = false;
                                });
                            }).catch(err => {
                                console.error("Failed to resume AudioContext:", err);
                                this.showAudioError("Could not start audio system. Please try again.", button, errorContainer);
                                // Reset audio initialization flag
                                this.audioInitialized = false;
                            });
                        } else {
                            // If it's already running, just init
                            this.initSimpleTone(audioCtx, button, errorContainer, overlay);

                            // Remove overlay
                            if (overlay && overlay.parentNode) {
                                document.body.removeChild(overlay);
                            }
                        }
                    } catch (e) {
                        console.error("Error in audio initialization:", e);
                        this.showAudioError("Unexpected audio initialization error. Please try again.", button, errorContainer);
                        // Reset audio initialization flag
                        this.audioInitialized = false;
                    }
                },

                initSimpleTone(audioCtx, button, errorContainer, overlay) {
                    try {
                        // Clean up any existing Tone Transport or events
                        if (Tone.Transport) {
                            Tone.Transport.stop();
                            Tone.Transport.cancel(0);
                        }

                        // Dispose of previous instances to prevent memory leaks
                        if (this.synth) {
                            this.synth.dispose();
                            this.synth = null;
                        }
                        if (this.reverb_effect) {
                            this.reverb_effect.dispose();
                            this.reverb_effect = null;
                        }
                        if (this.masterEQ) {
                            this.masterEQ.dispose();
                            this.masterEQ = null;
                        }
                        if (this.limiter) {
                            this.limiter.dispose();
                            this.limiter = null;
                        }

                        // Ensure Tone is using the provided AudioContext
                        Tone.setContext(audioCtx);

                        // Create a limiter to prevent clipping
                        this.limiter = new Tone.Limiter(-2).toDestination();

                        // Create a reverb effect with controlled settings
                        this.reverb_effect = new Tone.Reverb({
                            decay: 1.2,
                            wet: this.reverb || 0.6,
                            preDelay: 0.01
                        }).connect(this.limiter);

                        // Create a master EQ for better frequency balance
                        this.masterEQ = new Tone.EQ3({
                            low: 0,      // Neutral lows
                            mid: -1,     // Slight mid scoop for clarity
                            high: 1,     // Slight boost to highs for clarity
                            lowFrequency: 250,
                            highFrequency: 2500
                        }).connect(this.reverb_effect);

                        // Check if we're using the Moog synth (instrument === "synth")
                        if (this.instrument === "synth") {
                            // Create a balanced Moog-style synth
                            this.synth = new Tone.PolySynth(Tone.Synth, {
                                maxPolyphony: 24,
                                oscillator: {
                                    type: "sawtooth" // Classic Moog sawtooth
                                },
                                envelope: {
                                    attack: 0.05,  // Moderate attack
                                    decay: 0.2,
                                    sustain: 0.7,
                                    release: 0.6   // Good balance for chord transitions
                                }
                            });

                            // Add a filter for Moog character
                            const filter = new Tone.Filter({
                                type: "lowpass",
                                frequency: 2500,
                                rolloff: -12,
                                Q: 2
                            });

                            // Add subtle chorus for analog warmth
                            const chorus = new Tone.Chorus({
                                frequency: 1.5,
                                delayTime: 3.5,
                                depth: 0.3,
                                spread: 180,
                                wet: 0.2
                            }).start();

                            // Connect components
                            this.synth.chain(filter, chorus);

                            // Connect to master chain
                            chorus.connect(this.masterEQ);

                            // Store effects for later cleanup
                            this.instrumentEffects = [filter, chorus];

                            // Set volume
                            this.synth.volume.value = -4;
                        } else {
                            // Standard synth for other instruments
                            this.synth = new Tone.PolySynth(Tone.Synth, {
                                maxPolyphony: 32,
                                oscillator: {
                                    type: "triangle"
                                },
                                envelope: {
                                    attack: 0.03,
                                    decay: 0.15,
                                    sustain: 0.6,
                                    release: 0.4
                                }
                            });

                            // Chain through EQ, reverb, limiter
                            this.synth.chain(this.masterEQ, this.reverb_effect, this.limiter);

                            // Set volume
                            this.synth.volume.value = -5;
                        }

                        // Make sure the context is running
                        if (audioCtx.state !== "running") {
                            audioCtx.resume();
                        }

                        // Mark as successfully initialized
                        this.audioInitialized = true;

                        console.log(`Audio system initialized successfully with ${this.instrument === "synth" ? "balanced Moog" : "jazz-optimized"} settings!`);
                    } catch (e) {
                        console.error("Error in Tone.js initialization:", e);
                        this.showAudioError("Could not initialize audio system. Please try again.", button, errorContainer);
                        // Reset audio initialization flag
                        this.audioInitialized = false;
                    }
                },


                getNoteIndex(noteName) {
                    // Expanded noteMap to include flats so we don't get undefined for "Eb","Ab","Bb", etc.
                    const noteMap = {
                        'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4,
                        'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9,
                        'A#': 10, 'Bb': 10, 'B': 11
                    };
                    return (noteMap[noteName] !== undefined) ? noteMap[noteName] : 0;
                },

                /**
            * Generates a pool of possible notes for a chord across multiple octaves for voice-leading.
            * Now with robust error handling.
            * @param {Object} chord - The chord object with root, type, extensions, etc.
            * @returns {string[]} Array of note strings (e.g., ['C2', 'E2', 'G2', ...]).
            */
                getChordNotePool(chord) {
                    // Validate input
                    if (!chord || typeof chord !== 'object' || !chord.root) {
                        console.warn("Invalid chord in getChordNotePool:", chord);
                        return ['C3', 'E3', 'G3', 'C4', 'E4', 'G4']; // Return C major across octaves as fallback
                    }

                    const noteMap = {
                        'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'F': 5,
                        'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11
                    };

                    // Check if root note is valid
                    if (!noteMap.hasOwnProperty(chord.root)) {
                        console.warn("Invalid root note in getChordNotePool:", chord.root);
                        return ['C3', 'E3', 'G3', 'C4', 'E4', 'G4']; // Return C major as fallback
                    }

                    const intervalMap = {
                        '1': { semitones: 0, octaveOffset: 0 },
                        'b2': { semitones: 1, octaveOffset: 0 },
                        '2': { semitones: 2, octaveOffset: 0 },
                        '#2': { semitones: 3, octaveOffset: 0 },
                        'b3': { semitones: 3, octaveOffset: 0 },
                        '3': { semitones: 4, octaveOffset: 0 },
                        '4': { semitones: 5, octaveOffset: 0 },
                        '#4': { semitones: 6, octaveOffset: 0 },
                        'b5': { semitones: 6, octaveOffset: 0 },
                        '5': { semitones: 7, octaveOffset: 0 },
                        '#5': { semitones: 8, octaveOffset: 0 },
                        'b6': { semitones: 8, octaveOffset: 0 },
                        '6': { semitones: 9, octaveOffset: 0 },
                        'b7': { semitones: 10, octaveOffset: 0 },
                        '7': { semitones: 11, octaveOffset: 0 },
                        'bb7': { semitones: 9, octaveOffset: 0 },
                        '9': { semitones: 2, octaveOffset: 1 },
                        'b9': { semitones: 1, octaveOffset: 1 },
                        '#9': { semitones: 3, octaveOffset: 1 },
                        '11': { semitones: 5, octaveOffset: 1 },
                        '#11': { semitones: 6, octaveOffset: 1 },
                        'b13': { semitones: 8, octaveOffset: 1 },
                        '13': { semitones: 9, octaveOffset: 1 }
                    };

                    // Get intervals safely
                    let intervals = [];
                    try {
                        intervals = this.getIntervalsForChordType(chord.type || 'major');
                    } catch (e) {
                        console.warn("Error getting intervals for chord type:", chord.type, e);
                        intervals = ['1', '3', '5']; // Default to major triad
                    }

                    // Add extensions based on chord properties
                    if (chord.b5) intervals.push('b5');
                    if (chord.s5) intervals.push('#5');
                    if (chord.b9) intervals.push('b9');
                    if (chord.s9) intervals.push('#9');
                    if (chord.s11) intervals.push('#11');
                    if (chord.b13) intervals.push('b13');

                    const notePool = [];

                    // Safely generate note pool
                    try {
                        intervals.forEach(interval => {
                            if (!(interval in intervalMap)) return;

                            const { semitones, octaveOffset } = intervalMap[interval];
                            const totalSemitones = noteMap[chord.root] + semitones;
                            const noteIndex = ((totalSemitones % 12) + 12) % 12;

                            // Find note name from index (prefer natural, then sharp)
                            const possibleNames = Object.keys(noteMap).filter(key => noteMap[key] === noteIndex);
                            const noteName = possibleNames.find(n => n.length === 1) || // Natural notes first (C, D, E...)
                                possibleNames.find(n => n.includes('#')) || // Then prefer sharps
                                possibleNames[0];                          // Fallback to first

                            if (!noteName) return; // Skip if no name found

                            // Generate notes across octaves 2 to 6
                            for (let oct = 2; oct <= 6; oct++) {
                                let noteOctave = oct + octaveOffset;
                                if (noteOctave >= 2 && noteOctave <= 6) {
                                    notePool.push(noteName + noteOctave);
                                }
                            }
                        });
                    } catch (e) {
                        console.error("Error generating note pool:", e);
                        // Add fallback notes
                        for (let oct = 2; oct <= 6; oct++) {
                            notePool.push('C' + oct, 'E' + oct, 'G' + oct);
                        }
                    }

                    return notePool.length > 0 ? notePool : ['C3', 'E3', 'G3', 'C4', 'E4', 'G4']; // Ensure pool is never empty
                },

                parseNote(note) {
                    const match = note.match(/^([A-G][#b]?)(\d+)$/);
                    if (!match) {
                        console.warn("Invalid note format:", note);
                        return { noteName: "C", octave: 4 }; // Safe default
                    }
                    return { noteName: match[1], octave: parseInt(match[2]) };
                },


                /**
                 * Converts a note string to its MIDI number with robust error handling.
                 * @param {string} note - Note string (e.g., 'C4', 'Eb3').
                 * @returns {number} MIDI number (e.g., 60 for 'C4').
                 */
                getMIDI(note) {
                    // Add defensive check for undefined or invalid input.
                    if (!note || typeof note !== 'string') {
                        console.warn('Invalid note passed to getMIDI:', note);
                        return 60; // Default to middle C (60) instead of crashing.
                    }
                    const { noteName, octave } = this.parseNote(note);
                    const noteMap = {
                        'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4,
                        'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9,
                        'A#': 10, 'Bb': 10, 'B': 11
                    };
                    const semitone = (noteMap[noteName] !== undefined) ? noteMap[noteName] : 0;
                    return 12 * (octave + 1) + semitone;
                },


                /**
                 * Finds the closest note in a pool to a previous note based on MIDI distance.
                 * Now with robust error handling.
                 * @param {string} prevNote - Previous note (e.g., 'C4').
                 * @param {string[]} pool - Array of note strings to choose from.
                 * @returns {string} Closest note from the pool.
                 */
                findClosestNote(prevNote, pool) {
                    // Defensive checks
                    if (!prevNote || typeof prevNote !== 'string') {
                        console.warn('Invalid previous note in findClosestNote:', prevNote);
                        return pool && pool.length > 0 ? pool[0] : 'C4';
                    }

                    if (!pool || !Array.isArray(pool) || pool.length === 0) {
                        console.warn('Invalid or empty pool in findClosestNote');
                        return 'C4'; // Return middle C as fallback
                    }

                    try {
                        const prevMIDI = this.getMIDI(prevNote);
                        let closestNote = pool[0];
                        let minDiff = Math.abs(this.getMIDI(pool[0]) - prevMIDI);

                        for (let i = 1; i < pool.length; i++) {
                            if (typeof pool[i] !== 'string') continue; // Skip invalid notes

                            const diff = Math.abs(this.getMIDI(pool[i]) - prevMIDI);
                            if (diff < minDiff) {
                                minDiff = diff;
                                closestNote = pool[i];
                            }
                        }

                        return closestNote;
                    } catch (e) {
                        console.error("Error in findClosestNote:", e);
                        return pool[0]; // Return first note in pool as fallback
                    }
                },
                /**
                 * Adjusts the octave of a note to minimize movement from a previous note.
                 * @param {string} note - The note to adjust (e.g., 'C3').
                 * @param {string} prevNote - The previous note (e.g., 'C4').
                 * @returns {string} The adjusted note with the optimal octave.
                 */
                adjustOctaveForSmoothness(note, prevNote) {
                    // Parse both notes using the helper.
                    const { noteName: base, octave: currentOct } = this.parseNote(note);
                    const { octave: prevOct } = this.parseNote(prevNote);
                    const prevPitch = this.getNoteIndex(this.parseNote(prevNote).noteName) + prevOct * 12;
                    let bestOct = currentOct;
                    let bestDiff = Math.abs((this.getNoteIndex(base) + currentOct * 12) - prevPitch);
                    for (let delta = -2; delta <= 2; delta++) {
                        const trialOct = currentOct + delta;
                        const trialPitch = this.getNoteIndex(base) + trialOct * 12;
                        const diff = Math.abs(trialPitch - prevPitch);
                        if (diff < bestDiff) {
                            bestDiff = diff;
                            bestOct = trialOct;
                        }
                    }
                    bestOct = Math.max(0, Math.min(8, bestOct)); // Clamp octave between 0 and 8.
                    return base + bestOct;
                },

                /**
                 * Applies voice-leading by selecting the closest notes and adjusting octaves for smoothness.
                 * @param {string[]} newNotes - Array of note strings for the new chord.
                 * @returns {string[]} Adjusted notes for voice-leading.
                 */
                applyVoiceLeading(newNotes) {
                    if (!this.previousVoicing || this.previousVoicing.length === 0) {
                        this.previousVoicing = newNotes.slice();
                        return newNotes;
                    }

                    // Select closest notes based on previous voicing
                    const pool = this.getChordNotePool(this.editingChord);
                    const adjustedNotes = this.previousVoicing.map(prevNote => this.findClosestNote(prevNote, pool));

                    // Adjust octaves for smoothness
                    const finalNotes = adjustedNotes.map((note, i) => this.adjustOctaveForSmoothness(note, this.previousVoicing[i]));

                    this.previousVoicing = finalNotes.slice();
                    return finalNotes;
                },

                showAudioError(message, button, errorContainer) {
                    // Display error and reset button
                    errorContainer.innerText = message;
                    errorContainer.style.display = 'block';
                    button.disabled = false;
                    button.innerText = 'Try Again';
                },

                initTone() {
                    // Start the audio context (Tone.js convenience method)
                    Tone.start();

                    // Create a polyphonic synth with higher polyphony
                    this.synth = new Tone.PolySynth(Tone.Synth, {
                        maxPolyphony: 128, // ensure we can play large chords
                        oscillator: {
                            type: "triangle"
                        },
                        envelope: {
                            attack: 0.02,
                            decay: 0.1,
                            sustain: 0.8,
                            release: 1.5
                        }
                    }).toDestination();

                    // Set the synth volume based on the user's volume setting
                    this.synth.volume.value = Tone.gainToDb(this.volume);

                    // Create and connect a reverb effect
                    this.reverb_effect = new Tone.Reverb(2.5).toDestination();
                    this.synth.connect(this.reverb_effect);
                    this.reverb_effect.wet.value = this.reverb;
                },

                // Initialize all the sections' sortable functionality
                initSortable() {
                    try {
                        // For each section, initialize sortable for chord cards
                        this.currentProgression.sections.forEach((section, index) => {
                            this.initSectionSortable(index);
                        });
                    } catch (error) {
                        console.error("Error initializing sortable:", error);
                    }
                },

                // Add this function to your JavaScript
                initSwipeGestures() {
                    // Find all chord cards
                    document.querySelectorAll('.chord-card').forEach(card => {
                        let startX, startY, distX, distY;
                        let threshold = 100; // minimum distance for a swipe
                        let restraint = 100; // maximum perpendicular distance allowed
                        let allowedTime = 300; // maximum time allowed for the swipe
                        let startTime;

                        card.addEventListener('touchstart', function (e) {
                            const touchObj = e.changedTouches[0];
                            startX = touchObj.pageX;
                            startY = touchObj.pageY;
                            startTime = new Date().getTime();
                            e.preventDefault();
                        }, { passive: false });

                        card.addEventListener('touchend', function (e) {
                            const touchObj = e.changedTouches[0];
                            distX = touchObj.pageX - startX;
                            distY = touchObj.pageY - startY;
                            const elapsedTime = new Date().getTime() - startTime;

                            // Check if swipe meets criteria
                            if (elapsedTime <= allowedTime) {
                                if (Math.abs(distX) >= threshold && Math.abs(distY) <= restraint) {
                                    // Horizontal swipe detected
                                    const direction = distX < 0 ? 'left' : 'right';

                                    // Find the section and chord index
                                    const sectionEl = card.closest('[id^="chords-container-"]');
                                    if (sectionEl) {
                                        const sectionIndex = parseInt(sectionEl.id.replace('chords-container-', ''));
                                        const cards = Array.from(sectionEl.querySelectorAll('.chord-card'));
                                        const chordIndex = cards.indexOf(card);

                                        // Execute the move based on direction
                                        if (direction === 'left' && chordIndex < cards.length - 1) {
                                            // Use Alpine.js function to move right (counter-intuitive, but this is what "moveChordRight" does)
                                            const moveEvent = new CustomEvent('move-chord-right', {
                                                detail: { sectionIndex, chordIndex }
                                            });
                                            document.dispatchEvent(moveEvent);
                                        } else if (direction === 'right' && chordIndex > 0) {
                                            // Use Alpine.js function to move left
                                            const moveEvent = new CustomEvent('move-chord-left', {
                                                detail: { sectionIndex, chordIndex }
                                            });
                                            document.dispatchEvent(moveEvent);
                                        }
                                    }
                                }
                            }
                        }, { passive: false });
                    });
                },

                // Initialize sortable for a specific section
                initSectionSortable(sectionIndex) {
                    // Initialize sortable with a slight delay to ensure DOM is ready
                    setTimeout(() => {
                        try {
                            const el = document.getElementById('chords-container-' + sectionIndex);
                            if (el) {
                                new Sortable(el, {
                                    animation: 150,
                                    ghostClass: 'sortable-ghost',
                                    // Enhanced mobile settings
                                    delay: 0,                  // No delay for mobile
                                    delayOnTouchOnly: false,   // Disable delay on touch
                                    touchStartThreshold: 3,    // Reduce touch threshold for faster response
                                    forceFallback: false,      // Use native drag when possible
                                    fallbackTolerance: 3,      // Lower tolerance for better response
                                    scrollSpeed: 40,           // Faster scrolling
                                    scrollSensitivity: 80,     // More sensitive scrolling
                                    swapThreshold: 0.5,        // Threshold for swapping
                                    direction: "horizontal",   // Force horizontal direction for mobile
                                    // Enhanced touch feedback
                                    chosenClass: "sortable-chosen",  // Add visual feedback class
                                    dragClass: "sortable-drag",      // Class during dragging
                                    // When grid layout is used, we need to specify this to ensure horizontal movement
                                    gridClass: el.classList.contains('grid') ? 'grid-sizer' : null,
                                    onStart: function (evt) {
                                        // Add haptic feedback if available
                                        if (navigator.vibrate) {
                                            navigator.vibrate(10);
                                        }
                                        // Add visual feedback
                                        evt.item.classList.add('opacity-70', 'scale-105', 'shadow-lg');
                                    },
                                    onEnd: (evt) => {
                                        try {
                                            // Remove visual feedback
                                            evt.item.classList.remove('opacity-70', 'scale-105', 'shadow-lg');
                                            // Provide completion feedback
                                            if (navigator.vibrate) {
                                                navigator.vibrate(5);
                                            }
                                            // Update the chord order in the data model
                                            const chords = [...this.currentProgression.sections[sectionIndex].chords];
                                            const movedChord = chords.splice(evt.oldIndex, 1)[0];
                                            chords.splice(evt.newIndex, 0, movedChord);
                                            this.currentProgression.sections[sectionIndex].chords = chords;
                                        } catch (e) {
                                            console.error("Error in sortable onEnd handler:", e);
                                        }
                                    }
                                });
                            }
                        } catch (e) {
                            console.error("Error setting up sortable for section", sectionIndex, ":", e);
                        }
                    }, 100);
                },

                initTooltips() {
                    // Initialize tooltips with Tippy.js
                    tippy('[data-tippy-content]', {
                        animation: 'scale',
                        theme: 'light'
                    });
                },

                // UI Utilities
                isModalOpen() {
                    return this.showEditChordModal ||
                        this.showImportModal ||
                        this.showSettingsModal ||
                        this.showHelpModal ||
                        this.showNameEditModal ||
                        this.showAnnotationModal;
                },

                closeAllModals() {
                    this.showEditChordModal = false;
                    this.showImportModal = false;
                    this.showSettingsModal = false;
                    this.showHelpModal = false;
                    this.showNameEditModal = false;
                    this.showAnnotationModal = false;
                },

                toggleChordPalette() {
                    this.showChordPalette = !this.showChordPalette;
                    // Prevent body scrolling when palette is open on mobile
                    if (window.innerWidth < 768) {
                        if (this.showChordPalette) {
                            document.body.style.overflow = 'hidden';
                        } else {
                            document.body.style.overflow = '';
                        }
                    }
                },

                applyTheme() {
                    document.documentElement.setAttribute('data-theme', this.theme);
                },

                // Chord Palette Functions
                setChordCategory(category) {
                    this.activeChordCategory = category;
                    this.filterChordPalette();
                },

                filterChordPalette() {
                    // Filter chord types based on category and search query
                    this.filteredChordTypes = {};

                    Object.entries(this.chordTypes).forEach(([category, chords]) => {
                        // Filter by category
                        let shouldIncludeCategory = false;

                        if (this.activeChordCategory === 'basic') {
                            shouldIncludeCategory = ['Basic', 'Seventh Chords'].includes(category);
                        } else if (this.activeChordCategory === 'jazz') {
                            shouldIncludeCategory = ['Seventh Chords', 'Extended Chords', 'Jazz Voicings'].includes(category);
                        } else if (this.activeChordCategory === 'extended') {
                            shouldIncludeCategory = ['Extended Chords', 'Altered Chords', 'Jazz Voicings'].includes(category);
                        }

                        if (shouldIncludeCategory) {
                            // Filter by search query
                            const searchQuery = this.chordSearchQuery.toLowerCase();
                            const filteredChords = searchQuery ?
                                chords.filter(chord =>
                                    chord.name.toLowerCase().includes(searchQuery) ||
                                    chord.suffix.toLowerCase().includes(searchQuery)) :
                                chords;

                            if (filteredChords.length > 0) {
                                this.filteredChordTypes[category] = filteredChords;
                            }
                        }
                    });
                },

                // Chord Handling
                addChordToProgression(chord) {
                    const chordTypeInfo = this.getChordTypeFromSuffix(chord.suffix);
                    const intervals = this.getIntervalsForChordType(chordTypeInfo.type);
                    if (chordTypeInfo.b5) intervals.push('b5');
                    if (chordTypeInfo.s5) intervals.push('#5');
                    if (chordTypeInfo.b9) intervals.push('b9');
                    if (chordTypeInfo.s9) intervals.push('#9');
                    if (chordTypeInfo.s11) intervals.push('#11');
                    if (chordTypeInfo.b13) intervals.push('b13');
                    const notes = this.generateChordNotes(this.selectedRoot, intervals);
                    const newChord = {
                        name: this.selectedRoot + chord.suffix,
                        root: this.selectedRoot,
                        type: chordTypeInfo.type,
                        bass: "",
                        notes: notes,
                        annotation: "",
                        voicingStyle: "close",
                        baseOctave: 3,
                        octaveSpan: 2,
                        density: notes.length,
                        ...chordTypeInfo
                    };

                    if (this.currentProgression.sections.length > 0) {
                        const lastSectionIndex = this.currentProgression.sections.length - 1;
                        this.currentProgression.sections[lastSectionIndex].chords.push(newChord);
                        this.playChord(newChord);
                    } else {
                        this.createNewSection();
                        this.currentProgression.sections[0].chords.push(newChord);
                        this.playChord(newChord);
                    }
                },

                getChordTypeFromSuffix(suffix) {
                    // Map suffixes to chord types
                    const suffixMap = {
                        '': 'major',
                        'm': 'minor',
                        'dim': 'dim',
                        'aug': 'aug',
                        'sus4': 'sus4',
                        'sus2': 'sus2',
                        '6': '6',
                        'm6': 'm6',
                        'maj7': 'maj7',
                        '7': '7',
                        'm7': 'm7',
                        'mMaj7': 'mMaj7',
                        'm7b5': 'm7b5',
                        'dim7': 'dim7',
                        'aug7': 'aug7',
                        'augMaj7': 'augMaj7',
                        'maj9': 'maj9',
                        '9': '9',
                        'm9': 'm9',
                        '11': '11',
                        'm11': 'm11',
                        '13': '13',
                        'maj13': 'maj13',
                        'm13': 'm13',
                        '7b9': '7',
                        '7#9': '7',
                        '7#11': '7',
                        '7b13': '7',
                        '7b5': '7',
                        '7#5': '7',
                        '7alt': 'alt',
                        'maj7#11': 'maj7',
                        'm9b5': 'm9',
                        '9sus4': '9sus4',
                        '13sus4': '13sus4',
                        '7b9sus4': '7sus4',
                        'm6/9': 'm6',
                        '6/9': '6'
                    };
                    const baseType = suffixMap[suffix] || 'major';
                    const alterations = {};
                    if (suffix.includes('b5')) alterations.b5 = true;
                    if (suffix.includes('#5')) alterations.s5 = true;
                    if (suffix.includes('b9')) alterations.b9 = true;
                    if (suffix.includes('#9')) alterations.s9 = true;
                    if (suffix.includes('#11')) alterations.s11 = true;
                    if (suffix.includes('b13')) alterations.b13 = true;
                    return { type: baseType, ...alterations };
                },

                /**
                 * Generates chord notes from root and intervals.
                 * @param {string} root - Root note (e.g., 'C', 'F#').
                 * @param {string[]} intervals - Array of interval names (e.g., ['1', '3', '5']).
                 * @param {number} [baseOct=3] - Base octave for generated notes.
                 * @returns {string[]} Array of note strings (e.g., ['C3', 'E3', 'G3']).
                 */
                generateChordNotes(root, intervals, baseOct = 3) {
                    // Convert scale degree intervals to actual notes
                    const noteMap = {
                        'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4,
                        'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9,
                        'A#': 10, 'Bb': 10, 'B': 11
                    };

                    if (!(root in noteMap))
                        throw new Error("Invalid root note: " + root);
                    if (!Array.isArray(intervals))
                        throw new Error("Intervals must be an array");

                    // Use the provided baseOct parameter or default to 3
                    const baseOctave = baseOct;

                    // Interval mapping: Each key maps to its semitone offset and octave offset.
                    // Base chord tones (octaveOffset: 0)
                    const intervalMap = {
                        '1': { semitones: 0, octaveOffset: 0 },
                        'b2': { semitones: 1, octaveOffset: 0 },
                        '2': { semitones: 2, octaveOffset: 0 },
                        'sus2': { semitones: 2, octaveOffset: 0 },
                        '#2': { semitones: 3, octaveOffset: 0 }, // enharmonic with b3
                        'b3': { semitones: 3, octaveOffset: 0 },
                        '3': { semitones: 4, octaveOffset: 0 },
                        'maj3': { semitones: 4, octaveOffset: 0 },
                        'min3': { semitones: 3, octaveOffset: 0 }, // synonym for b3
                        '4': { semitones: 5, octaveOffset: 0 },
                        'sus4': { semitones: 5, octaveOffset: 0 },
                        '#4': { semitones: 6, octaveOffset: 0 }, // same as b5
                        'b5': { semitones: 6, octaveOffset: 0 },
                        '5': { semitones: 7, octaveOffset: 0 },
                        'aug5': { semitones: 8, octaveOffset: 0 },
                        '#5': { semitones: 8, octaveOffset: 0 },
                        'b6': { semitones: 8, octaveOffset: 0 }, // minor sixth, same pitch as #5
                        '6': { semitones: 9, octaveOffset: 0 },
                        'maj6': { semitones: 9, octaveOffset: 0 },
                        'b7': { semitones: 10, octaveOffset: 0 },
                        'min7': { semitones: 10, octaveOffset: 0 },
                        '7': { semitones: 11, octaveOffset: 0 },
                        'maj7': { semitones: 11, octaveOffset: 0 },
                        'bb7': { semitones: 9, octaveOffset: 0 }, // double-flat 7

                        // Extended chord tones (typically played one octave higher: octaveOffset: 1)
                        '9': { semitones: 2, octaveOffset: 1 },
                        'maj9': { semitones: 2, octaveOffset: 1 },
                        'b9': { semitones: 1, octaveOffset: 1 },
                        'min9': { semitones: 1, octaveOffset: 1 },
                        '#9': { semitones: 3, octaveOffset: 1 },
                        '11': { semitones: 5, octaveOffset: 1 },
                        'maj11': { semitones: 5, octaveOffset: 1 },
                        '#11': { semitones: 6, octaveOffset: 1 },
                        'b13': { semitones: 8, octaveOffset: 1 },
                        '13': { semitones: 9, octaveOffset: 1 },
                        'maj13': { semitones: 9, octaveOffset: 1 },
                        'min13': { semitones: 8, octaveOffset: 1 }
                    };

                    // Map each interval to its corresponding note string
                    return intervals.map(interval => {
                        if (!(interval in intervalMap))
                            throw new Error("Unrecognized interval: " + interval);

                        const { semitones, octaveOffset } = intervalMap[interval];

                        // Calculate total semitones from root and derive note index and octave
                        const totalSemitones = noteMap[root] + semitones;
                        let noteOctave = baseOctave + Math.floor(totalSemitones / 12) + octaveOffset;
                        noteOctave = Math.min(Math.max(noteOctave, 0), 8); // Clamp octave range
                        noteOctave = Math.max(0, Math.min(8, noteOctave))

                        const noteIndex = ((totalSemitones % 12) + 12) % 12;

                        // Reverse lookup for note name using the noteMap
                        // Find the appropriate note name (prefer sharps by default)
                        const noteNames = Object.keys(noteMap).filter(key => noteMap[key] === noteIndex);
                        const noteName = noteNames.find(name => name.length === 1) || // Prefer naturals (C, D, E, etc.)
                            noteNames.find(name => name.includes('#')) || // Then prefer sharps (C#, D#, etc.)
                            noteNames[0]; // Fallback to first available

                        return noteName ? noteName + noteOctave : null;
                    }).filter(n => n !== null);
                },

                addCustomChord() {
                    // Determine the chord type and alterations
                    let type = this.customChord.type;
                    let alterations = [];

                    if (this.customChord.b5) alterations.push('b5');
                    if (this.customChord.s5) alterations.push('#5');
                    if (this.customChord.b9) alterations.push('b9');
                    if (this.customChord.s9) alterations.push('#9');
                    if (this.customChord.s11) alterations.push('#11');
                    if (this.customChord.b13) alterations.push('b13');

                    // Generate chord name
                    let name = this.customChord.root;

                    // Add type suffix
                    switch (type) {
                        case 'major': break; // No suffix for major
                        case 'minor': name += 'm'; break;
                        case 'dim': name += 'dim'; break;
                        case 'aug': name += 'aug'; break;
                        case 'sus4': name += 'sus4'; break;
                        default: name += type; break;
                    }

                    // Add alterations in parentheses if any
                    if (alterations.length > 0) {
                        name += '(' + alterations.join(',') + ')';
                    }

                    // Add bass note for slash chords
                    if (this.customChord.bass && this.customChord.bass !== this.customChord.root) {
                        name += '/' + this.customChord.bass;
                    }

                    // Generate notes for the chord
                    const intervals = this.getIntervalsForChordType(type);
                    let notes = this.generateChordNotes(this.customChord.root, intervals);

                    // Add bass note as the lowest note if specified
                    if (this.customChord.bass && this.customChord.bass !== this.customChord.root) {
                        notes.unshift(this.customChord.bass + '2');
                    }

                    // Create the chord object
                    const newChord = {
                        name: name,
                        root: this.customChord.root,
                        type: type,
                        bass: this.customChord.bass,
                        notes: notes,
                        annotation: "",
                        voicingStyle: "close",
                        baseOctave: 3,
                        octaveSpan: 2,
                        density: intervals.length,
                        ...Object.fromEntries(
                            ['b5', 's5', 'b9', 's9', 's11', 'b13'].map(
                                key => [key, this.customChord[key]]
                            )
                        )
                    };

                    // Add to the last section
                    if (this.currentProgression.sections.length > 0) {
                        const lastSectionIndex = this.currentProgression.sections.length - 1;
                        this.currentProgression.sections[lastSectionIndex].chords.push(newChord);

                        // Play the chord
                        this.playChord(newChord);
                    } else {
                        this.createNewSection();
                        this.currentProgression.sections[0].chords.push(newChord);
                        this.playChord(newChord);
                    }

                    // Reset the custom chord form
                    this.resetCustomChordForm();
                },

                resetCustomChordForm() {
                    this.customChord = {
                        root: this.customChord.root,
                        type: "major",
                        b5: false,
                        s5: false,
                        b9: false,
                        s9: false,
                        s11: false,
                        b13: false,
                        bass: ""
                    };
                },

                getIntervalsForChordType(type) {
                    // Map chord types to interval structures
                    const intervalMap = {
                        'major': ['1', '3', '5'],
                        'minor': ['1', 'b3', '5'],
                        'dim': ['1', 'b3', 'b5'],
                        'aug': ['1', '3', '#5'],
                        'sus4': ['1', '4', '5'],
                        'sus2': ['1', '2', '5'],
                        '6': ['1', '3', '5', '6'],
                        'm6': ['1', 'b3', '5', '6'],
                        '7': ['1', '3', '5', 'b7'],
                        'maj7': ['1', '3', '5', '7'],
                        'm7': ['1', 'b3', '5', 'b7'],
                        'dim7': ['1', 'b3', 'b5', 'bb7'],
                        'aug7': ['1', '3', '#5', 'b7'],
                        'm7b5': ['1', 'b3', 'b5', 'b7'],
                        '9': ['1', '3', '5', 'b7', '9'],
                        'maj9': ['1', '3', '5', '7', '9'],
                        'm9': ['1', 'b3', '5', 'b7', '9'],
                        '11': ['1', '3', '5', 'b7', '9', '11'],
                        '13': ['1', '3', '5', 'b7', '9', '11', '13'],
                        'alt': ['1', '3', 'b5', 'b7', 'b9', '#9']
                    };

                    return intervalMap[type] || ['1', '3', '5']; // Default to major triad
                },

                // Helper method to ensure the audio context is running
                ensureAudioContextRunning() {
                    if (!Tone.context || Tone.context.state !== 'running') {
                        return Tone.start().then(() => {
                            console.log("Audio context started");
                        }).catch(e => {
                            console.error("Failed to start audio context:", e);
                            throw e;
                        });
                    }
                    return Promise.resolve();
                },

                // Update the playChord method
                playChord(chord) {
                    if (!this.synth || !chord || !chord.notes || !Array.isArray(chord.notes)) {
                        return;
                    }

                    try {
                        // First release any currently playing notes
                        this.synth.releaseAll();

                        // Small delay to ensure release has been processed
                        setTimeout(() => {
                            try {
                                // Filter out any invalid notes
                                const validNotes = (chord.playbackNotes || chord.notes).filter(note =>
                                    typeof note === 'string' && /^[A-G][#b]?[0-9]$/.test(note)
                                );

                                if (validNotes.length === 0) return;

                                // Calculate a slightly shorter duration than the full chord duration
                                // to ensure a tiny gap between chords
                                const playDuration = this.chordDuration * 0.9;

                                // Play the chord with proper timing
                                this.synth.triggerAttackRelease(validNotes, playDuration);
                            } catch (e) {
                                console.error("Error in chord playback:", e);
                            }
                        }, 10);
                    } catch (e) {
                        console.error("Error preparing chord playback:", e);
                    }
                },

                previewChord(event, chord) {
                    // If you already use Alpine’s @click.stop, you can omit the next line.
                    // event.stopPropagation();
                    // Create a temporary chord with the selected root.
                    const tempChord = {
                        notes: this.generateChordNotes(this.selectedRoot, chord.notes)
                    };
                    // Play the chord.
                    this.playChord(tempChord);
                },

                previewEditingChord() {
                    this.playChord(this.editingChord);
                },

                // Section Management
                createNewSection() {
                    const newSection = {
                        name: "Section " + String.fromCharCode(65 + this.currentProgression.sections.length), // A, B, C, etc.
                        chords: [],
                        collapsed: false,
                        annotation: ""
                    };

                    this.currentProgression.sections.push(newSection);

                    // Initialize sortable for the new section
                    setTimeout(() => {
                        this.initSectionSortable(this.currentProgression.sections.length - 1);
                    }, 100);
                },

                toggleSectionCollapse(sectionIndex) {
                    this.currentProgression.sections[sectionIndex].collapsed =
                        !this.currentProgression.sections[sectionIndex].collapsed;
                },

                startEditSectionName(sectionIndex) {
                    // Set editing state
                    this.currentProgression.sections[sectionIndex].isEditingName = true;
                    this.currentProgression.sections[sectionIndex].editNameValue =
                        this.currentProgression.sections[sectionIndex].name;
                },

                saveSectionName(sectionIndex) {
                    // Save the edited name
                    this.currentProgression.sections[sectionIndex].name =
                        this.currentProgression.sections[sectionIndex].editNameValue;

                    // Exit editing state
                    this.currentProgression.sections[sectionIndex].isEditingName = false;
                },

                duplicateSection(sectionIndex) {
                    // Create a deep copy of the section
                    const sectionCopy = JSON.parse(JSON.stringify(this.currentProgression.sections[sectionIndex]));
                    sectionCopy.name += " (Copy)";

                    // Insert after the original
                    this.currentProgression.sections.splice(sectionIndex + 1, 0, sectionCopy);

                    // Initialize sortable for the new section
                    setTimeout(() => {
                        this.initSectionSortable(sectionIndex + 1);
                    }, 100);
                },

                moveSectionUp(sectionIndex) {
                    if (sectionIndex > 0) {
                        const sections = [...this.currentProgression.sections];
                        const temp = sections[sectionIndex];
                        sections[sectionIndex] = sections[sectionIndex - 1];
                        sections[sectionIndex - 1] = temp;
                        this.currentProgression.sections = sections;
                    }
                },

                moveSectionDown(sectionIndex) {
                    if (sectionIndex < this.currentProgression.sections.length - 1) {
                        const sections = [...this.currentProgression.sections];
                        const temp = sections[sectionIndex];
                        sections[sectionIndex] = sections[sectionIndex + 1];
                        sections[sectionIndex + 1] = temp;
                        this.currentProgression.sections = sections;
                    }
                },

                deleteSection(sectionIndex) {
                    if (confirm("Are you sure you want to delete this section?")) {
                        this.currentProgression.sections.splice(sectionIndex, 1);
                    }
                },

                addChordToSection(sectionIndex) {
                    // Open chord palette on mobile if it's not already open
                    if (!this.showChordPalette && window.innerWidth < 768) {
                        this.showChordPalette = true;
                    }

                    // Add a basic C major chord as a placeholder
                    const newChord = {
                        name: "Cmaj7",
                        root: "C",
                        type: "maj7",
                        bass: "",
                        notes: ['C3', 'E3', 'G3', 'B3'],
                        annotation: "",
                        voicingStyle: "close",
                        baseOctave: 3,
                        octaveSpan: 2,
                        density: 4
                    };

                    this.currentProgression.sections[sectionIndex].chords.push(newChord);

                    // Edit the chord right away
                    setTimeout(() => {
                        this.editChord(sectionIndex, this.currentProgression.sections[sectionIndex].chords.length - 1);
                    }, 100);
                },

                // Chord Editing
                editChord(sectionIndex, chordIndex) {
                    // Store the indices
                    this.editingSectionIndex = sectionIndex;
                    this.editingChordIndex = chordIndex;

                    // Make a deep copy of the chord to edit
                    this.editingChord = JSON.parse(
                        JSON.stringify(this.currentProgression.sections[sectionIndex].chords[chordIndex])
                    );

                    // Set defaults for properties that might not exist in older chord objects
                    if (!this.editingChord.voicingStyle) this.editingChord.voicingStyle = "close";
                    if (!this.editingChord.baseOctave) this.editingChord.baseOctave = 3;
                    if (!this.editingChord.octaveSpan) this.editingChord.octaveSpan = 2;
                    if (!this.editingChord.density) this.editingChord.density = this.editingChord.notes.length;
                    if (!this.editingChord.tensions) this.editingChord.tensions = [];

                    // Switch to edit tab
                    this.editChordTab = 'basic';

                    // Open the modal
                    this.showEditChordModal = true;
                },

                cancelEditChord() {
                    this.showEditChordModal = false;
                },

                saveEditedChord() {
                    // Update the chord name based on parameters
                    this.editingChord.name = this.getChordDisplayName(this.editingChord);

                    // Save the edited chord back to the progression
                    this.currentProgression.sections[this.editingSectionIndex].chords[this.editingChordIndex] =
                        JSON.parse(JSON.stringify(this.editingChord));

                    // Close the modal
                    this.showEditChordModal = false;

                    // Play the updated chord
                    this.playChord(this.editingChord);
                },

                updateEditingChordFromType() {
                    // Update chord intervals based on selected type
                    const intervals = this.getIntervalsForChordType(this.editingChord.type);

                    // FIXED: Clear any existing notes and regenerate
                    this.editingChord.notes = [];

                    // Regenerate notes
                    this.regenerateChordNotes();
                },

                regenerateChordNotes() {
                    // Get base intervals for the chord type
                    const baseIntervals = this.getIntervalsForChordType(this.editingChord.type);

                    // FIXED: Properly handle the chord type
                    const isMajor = !this.editingChord.type?.includes('m') && !this.editingChord.type?.includes('dim');
                    const isDominant = this.editingChord.type?.includes('7') && !this.editingChord.type?.includes('maj7');
                    const hasMajor7 = this.editingChord.type?.includes('maj7');
                    const isMinor = this.editingChord.type?.includes('m');

                    // Add extensions based on density and tensions
                    let intervals = [...baseIntervals];

                    // Limit the number of notes based on density setting
                    intervals = intervals.slice(0, this.editingChord.density);

                    // Add tensions if specified
                    if (this.editingChord.tensions) {
                        this.editingChord.tensions.forEach(tension => {
                            if (tension === 'add9' && !intervals.includes('9')) intervals.push('9');
                            if (tension === 'add11' && !intervals.includes('11')) intervals.push('11');
                            if (tension === 'add13' && !intervals.includes('13')) intervals.push('13');
                            if (tension === 'addb9' && !intervals.includes('b9')) intervals.push('b9');
                        });
                    }

                    // For altered chords, drop redundant tensions if both conflicting flags are true
                    if (this.editingChord.type === 'alt') {
                        if (this.editingChord.b5 && this.editingChord.s5) {
                            // Prefer '#5' over 'b5'
                            this.editingChord.b5 = false;
                        }
                        if (this.editingChord.b9 && this.editingChord.s9) {
                            // Prefer 'b9' over '#9'
                            this.editingChord.s9 = false;
                        }
                    }

                    // Apply alterations
                    if (this.editingChord.b5) {
                        const idx = intervals.indexOf('5');
                        if (idx !== -1) intervals[idx] = 'b5';
                    }
                    if (this.editingChord.s5) {
                        const idx = intervals.indexOf('5');
                        if (idx !== -1) intervals[idx] = '#5';
                    }

                    // Generate the actual notes
                    // FIXED: Generate notes with proper octaves for jazz
                    const baseOctave = parseInt(this.editingChord.baseOctave) || 3;

                    // Generate proper jazz voicing based on chord type
                    let notes = [];

                    // Always add root in bass register
                    notes.push(this.editingChord.root + (baseOctave - 1));

                    // Add 3rd and 7th in middle register (core jazz sound)
                    if (isMajor) {
                        notes.push(this.getChordToneByInterval(this.editingChord.root, '3') + baseOctave);
                    } else if (isMinor) {
                        notes.push(this.getChordToneByInterval(this.editingChord.root, 'b3') + baseOctave);
                    }

                    if (hasMajor7) {
                        notes.push(this.getChordToneByInterval(this.editingChord.root, '7') + baseOctave);
                    } else if (isDominant || this.editingChord.type?.includes('m7')) {
                        notes.push(this.getChordToneByInterval(this.editingChord.root, 'b7') + baseOctave);
                    }

                    // Add fifth
                    let fifth = this.editingChord.b5 ? 'b5' : (this.editingChord.s5 ? '#5' : '5');
                    notes.push(this.getChordToneByInterval(this.editingChord.root, fifth) + baseOctave);

                    // Add extensions in higher register
                    if (this.editingChord.b9) {
                        notes.push(this.getChordToneByInterval(this.editingChord.root, 'b9') + (baseOctave + 1));
                    } else if (this.editingChord.s9) {
                        notes.push(this.getChordToneByInterval(this.editingChord.root, '#9') + (baseOctave + 1));
                    } else if (this.editingChord.type?.includes('9')) {
                        notes.push(this.getChordToneByInterval(this.editingChord.root, '9') + (baseOctave + 1));
                    }

                    if (this.editingChord.s11) {
                        notes.push(this.getChordToneByInterval(this.editingChord.root, '#11') + (baseOctave + 1));
                    } else if (this.editingChord.type?.includes('11') && isMinor) {
                        notes.push(this.getChordToneByInterval(this.editingChord.root, '11') + (baseOctave + 1));
                    }

                    if (this.editingChord.b13) {
                        notes.push(this.getChordToneByInterval(this.editingChord.root, 'b13') + (baseOctave + 1));
                    } else if (this.editingChord.type?.includes('13')) {
                        notes.push(this.getChordToneByInterval(this.editingChord.root, '13') + (baseOctave + 1));
                    }

                    // Apply voicing style (but with fixed jazz-appropriate approach)
                    notes = this.applyJazzVoicingStyle(notes, this.editingChord.voicingStyle);

                    // Apply octave range with limitation for smaller chords
                    notes = this.applyOctaveRange(notes, baseOctave, parseInt(this.editingChord.octaveSpan));

                    // Add bass note for slash chords
                    if (this.editingChord.bass && this.editingChord.bass !== this.editingChord.root) {
                        notes = notes.filter(note => !note.startsWith(this.editingChord.bass));
                        notes.unshift(this.editingChord.bass + (baseOctave - 1));
                    }

                    // Update the notes in the editing chord
                    this.editingChord.notes = notes;
                },

                // New jazz-focused voicing style application
                applyJazzVoicingStyle(notes, style) {
                    // First sort by pitch
                    const sortedNotes = [...notes].sort((a, b) => this.getMIDI(a) - this.getMIDI(b));

                    if (sortedNotes.length < 3) return sortedNotes; // Not enough notes for voicing techniques

                    // Create note objects for easier manipulation
                    const noteObjects = sortedNotes.map(note => {
                        const noteName = note.slice(0, -1);
                        const octave = parseInt(note.slice(-1));
                        return { name: noteName, octave: octave };
                    });

                    // Apply different voicing styles
                    let revoiced = [...noteObjects];

                    switch (style) {
                        case 'drop2':
                            // Drop 2 voicing: move the second highest note down an octave
                            if (noteObjects.length >= 4) {
                                revoiced[revoiced.length - 2].octave -= 1;
                            }
                            break;

                        case 'drop3':
                            // Drop 3 voicing: move the third highest note down an octave
                            if (noteObjects.length >= 5) {
                                revoiced[revoiced.length - 3].octave -= 1;
                            }
                            break;

                        case 'open':
                            // Open voicing: spread out middle voices
                            if (noteObjects.length >= 4) {
                                // Keep bass and lead notes, spread middle voices
                                for (let i = 2; i < revoiced.length - 1; i += 2) {
                                    revoiced[i].octave += 1;
                                }
                            }
                            break;

                        case 'spread':
                            // Spread voicing: gradually increase octaves for upper voices
                            for (let i = 2; i < revoiced.length; i++) {
                                revoiced[i].octave += 1;
                            }
                            break;

                        case 'quartal':
                            // Best for sus chords and modal sounds
                            // Just distribute notes in proper registers
                            if (noteObjects.length >= 4) {
                                revoiced[1].octave = noteObjects[1].octave;
                                revoiced[2].octave = noteObjects[1].octave;
                                for (let i = 3; i < revoiced.length; i++) {
                                    revoiced[i].octave = noteObjects[1].octave + 1;
                                }
                            }
                            break;

                        case 'cluster':
                            // Used for altered dominants and non-functional harmony
                            if (noteObjects.length >= 5) {
                                // Keep bass, group upper notes more closely
                                revoiced[1].octave = noteObjects[1].octave;
                                revoiced[2].octave = noteObjects[1].octave;
                                for (let i = 3; i < revoiced.length; i++) {
                                    revoiced[i].octave = noteObjects[1].octave + 1;
                                }
                            }
                            break;

                        case 'close':
                        default:
                            // Close position: keep lowest 4 notes in same octave, higher notes up an octave
                            const baseOctave = noteObjects[1].octave;
                            revoiced[0].octave = noteObjects[0].octave; // Keep bass note position

                            for (let i = 1; i < Math.min(revoiced.length, 5); i++) {
                                revoiced[i].octave = baseOctave;
                            }

                            for (let i = 5; i < revoiced.length; i++) {
                                revoiced[i].octave = baseOctave + 1;
                            }
                            break;
                    }

                    // Convert back to note strings
                    return revoiced.map(note => note.name + note.octave);
                },

                applyVoicingStyle(notes, style) {
                    // Apply different voicing styles to the chord
                    const noteObjects = notes.map(note => {
                        const noteName = note.slice(0, -1);
                        const octave = parseInt(note.slice(-1));
                        return { name: noteName, octave: octave };
                    });

                    // Sort by pitch
                    noteObjects.sort((a, b) => {
                        const aIndex = this.getNoteIndex(a.name);
                        const bIndex = this.getNoteIndex(b.name);
                        return (a.octave * 12 + aIndex) - (b.octave * 12 + bIndex);
                    });

                    // Apply the selected voicing style
                    let revoiced = [...noteObjects];

                    if (style === 'drop2' && noteObjects.length >= 4) {
                        // Drop 2 voicing: move the second highest note down an octave
                        revoiced[revoiced.length - 2].octave -= 1;
                    } else if (style === 'open') {
                        // Open voicing: spread out the notes by alternating octaves
                        for (let i = 1; i < revoiced.length; i += 2) {
                            revoiced[i].octave += 1;
                        }
                    } else if (style === 'spread') {
                        // Spread voicing: gradually increase octaves
                        for (let i = 1; i < revoiced.length; i++) {
                            revoiced[i].octave += Math.floor(i / 2);
                        }
                    } else if (style === 'quartal') {
                        // Quartal voicing: rearrange notes to be in fourths where possible
                        // This is a simplification - proper quartal voicing would require more complex reharmonization
                        revoiced.sort((a, b) => {
                            const aIndex = this.getNoteIndex(a.name);
                            const bIndex = this.getNoteIndex(b.name);
                            // Try to arrange notes in 4ths (5 semitones)
                            const diff = (bIndex - aIndex + 12) % 12;
                            return Math.abs(diff - 5);
                        });
                    } else if (style === 'cluster') {
                        // Cluster voicing: put everything close together
                        for (let i = 0; i < revoiced.length; i++) {
                            revoiced[i].octave = Math.floor(i / 3) + 3;
                        }
                    }

                    // Convert back to note strings
                    return revoiced.map(note => note.name + note.octave);
                },

                /**
                 * Adjusts the octave range of the notes, limiting the span for smaller chords.
                 * @param {string[]} notes - Array of note strings (e.g., ['C4', 'E4', 'G4']).
                 * @param {number} baseOctave - The base octave (e.g., 3).
                 * @param {number} span - The desired octave span (e.g., 2).
                 * @returns {string[]} Adjusted notes with controlled octave range.
                 */
                applyOctaveRange(notes, baseOctave, span) {
                    const noteObjects = notes.map(note => {
                        const noteName = note.slice(0, -1);
                        const octave = parseInt(note.slice(-1));
                        return { name: noteName, octave };
                    });

                    // Limit voicing range for chords with 4 or fewer notes
                    let effectiveSpan = span;
                    if (noteObjects.length <= 4) {
                        effectiveSpan = Math.min(span, 2); // Cap at 2 octaves for smaller chords
                    }

                    // Distribute notes across the effective span
                    for (let i = 0; i < noteObjects.length; i++) {
                        let newOctave = baseOctave + Math.floor((i * effectiveSpan) / noteObjects.length);
                        newOctave = Math.max(0, Math.min(8, newOctave)); // Clamp between 0 and 8
                        noteObjects[i].octave = newOctave;
                    }

                    return noteObjects.map(note => note.name + note.octave);
                },

                /**
                 * Gets the semitone index of a note name (without octave).
                 * @param {string} noteName - Note name (e.g., 'C', 'Eb').
                 * @returns {number} Semitone index (0-11).
                 */
                getNoteIndex(noteName) {
                    // Expanded noteMap to handle all flats and sharps
                    const noteMap = {
                        'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4,
                        'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9,
                        'A#': 10, 'Bb': 10, 'B': 11
                    };

                    return (noteMap[noteName] !== undefined) ? noteMap[noteName] : 0;
                },

                // Piano keyboard note management
                getBlackKeyPosition(note) {
                    // Calculate position for black keys on the piano keyboard
                    const noteName = note.slice(0, -1);
                    const whiteKeyWidth = 30;
                    const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

                    // Map black keys to their position relative to white keys
                    const blackKeyPositions = {
                        'C#': 0.7,
                        'D#': 1.7,
                        'F#': 3.7,
                        'G#': 4.7,
                        'A#': 5.7
                    };

                    return blackKeyPositions[noteName] * whiteKeyWidth;
                },

                isNoteInChord(note) {
                    // Check if a note is in the editing chord
                    const noteName = note.slice(0, -1);
                    const noteOctave = note.slice(-1);

                    return this.editingChord.notes.some(chordNote => {
                        const chordNoteName = chordNote.slice(0, -1);
                        const chordNoteOctave = chordNote.slice(-1);
                        return chordNoteName === noteName && chordNoteOctave === noteOctave;
                    });
                },

                toggleNoteInChord(note) {
                    if (this.isNoteInChord(note)) {
                        this.removeNoteFromChord(
                            this.editingChord.notes.findIndex(n => n === note)
                        );
                    } else {
                        this.editingChord.notes.push(note);

                        // Play the note
                        this.synth.triggerAttackRelease([note], "8n");
                    }
                },

                removeNoteFromChord(index) {
                    this.editingChord.notes.splice(index, 1);
                },

                addNoteToChord() {
                    const newNote = this.newNoteToAdd + this.newNoteOctave;

                    if (!this.editingChord.notes.includes(newNote)) {
                        this.editingChord.notes.push(newNote);

                        // Play the note
                        this.synth.triggerAttackRelease([newNote], "8n");
                    }
                },

                sortChordNotes() {
                    // Sort notes by pitch
                    this.editingChord.notes.sort((a, b) => {
                        const aNoteName = a.slice(0, -1);
                        const aOctave = parseInt(a.slice(-1));
                        const bNoteName = b.slice(0, -1);
                        const bOctave = parseInt(b.slice(-1));

                        const aIndex = this.getNoteIndex(aNoteName);
                        const bIndex = this.getNoteIndex(bNoteName);

                        return (aOctave * 12 + aIndex) - (bOctave * 12 + bIndex);
                    });
                },

                // Chord Display Functions
                getChordDisplayName(chord) {
                    if (!chord || typeof chord !== 'object') {
                        return "";
                    }

                    try {
                        // Handle case where chord might be a proxy object
                        let root = chord.root;
                        let type = chord.type;
                        let bass = chord.bass;
                        let b5 = chord.b5;
                        let s5 = chord.s5;
                        let b9 = chord.b9;
                        let s9 = chord.s9;
                        let s11 = chord.s11;
                        let b13 = chord.b13;

                        if (!root) {
                            return chord.name || "";
                        }

                        let name = root;

                        // Add chord type
                        switch (type) {
                            case 'major': break; // Major has no suffix
                            case 'minor': name += 'm'; break;
                            case 'dim': name += 'dim'; break;
                            case 'aug': name += 'aug'; break;
                            case 'sus4': name += 'sus4'; break;
                            default:
                                if (type) name += type;
                                break;
                        }

                        // Add alterations if any
                        let alterations = [];
                        if (b5) alterations.push('b5');
                        if (s5) alterations.push('#5');
                        if (b9) alterations.push('b9');
                        if (s9) alterations.push('#9');
                        if (s11) alterations.push('#11');
                        if (b13) alterations.push('b13');

                        if (alterations.length > 0) {
                            name += '(' + alterations.join(',') + ')';
                        }

                        // Add bass note for slash chords
                        if (bass && bass !== root) {
                            name += '/' + bass;
                        }

                        return name;
                    } catch (e) {
                        console.error("Error generating chord display name:", e);
                        return chord.name || "";
                    }
                },

                formatChordNotes(notes) {
                    if (!notes || !Array.isArray(notes)) return '';

                    // Format notes for display, removing octave numbers
                    try {
                        return notes.map(note => note.slice(0, -1)).join(', ');
                    } catch (e) {
                        console.error("Error formatting chord notes:", e, notes);
                        return '';
                    }
                },

                /**
                 * Toggles between play and pause states.
                 */
                togglePlay() {
                    if (this.isPlaying) {
                        this.stopPlayback();
                    } else {
                        this.startPlayback();
                    }
                },

                preparePlayback() {
                    // Stop any current playback and ensure we're in a clean state
                    if (this.isPlaying) {
                        this.stopPlayback();

                        // Give a short delay to ensure cleanup completes
                        return new Promise(resolve => {
                            const checkCleanup = () => {
                                if (this.audioCleanupInProgress) {
                                    setTimeout(checkCleanup, 50);
                                } else {
                                    resolve();
                                }
                            };
                            setTimeout(checkCleanup, 50);
                        });
                    }

                    // Reset voice leading state to ensure clean start
                    this.voiceLeadingState = {
                        previousNotes: null,
                        currentVoicing: null
                    };

                    // We're ready to play
                    return Promise.resolve();
                },


                async startPlayback() {
                    // Use the consolidated preparation function
                    await this.preparePlayback();

                    if (!this.synth || !Tone.context) {
                        console.warn("Cannot start playback - audio not initialized yet");
                        alert("Please enable audio first by clicking the 'Enable Audio' button");
                        return;
                    }

                    // FIXED: Wait for any audio cleanup to complete
                    if (this.audioCleanupInProgress) {
                        console.log("Audio cleanup in progress, delaying playback start");
                        setTimeout(() => this.startPlayback(), 150);
                        return;
                    }

                    // First, stop any current playback
                    this.stopPlayback();

                    if (!this.synth || !Tone.context) {
                        console.warn("Cannot start playback - audio not initialized yet");
                        alert("Please enable audio first by clicking the 'Enable Audio' button");
                        return;
                    }

                    try {
                        // Start audio context and wait for it to be ready
                        await Tone.start();
                        console.log("Audio context started for playback");

                        // Flatten all chords
                        const allChords = [];
                        this.currentProgression.sections.forEach((section, sectionIndex) => {
                            if (section.chords && Array.isArray(section.chords)) {
                                section.chords.forEach((chord, chordIndex) => {
                                    allChords.push({
                                        chord: chord,
                                        sectionIndex: sectionIndex,
                                        chordIndex: chordIndex,
                                        sectionName: section.name || `Section ${sectionIndex + 1}`
                                    });
                                });
                            }
                        });

                        if (allChords.length === 0) {
                            console.warn("No chords to play");
                            return;
                        }

                        // Check if chordDuration is too short for the envelope
                        if (this.chordDuration < 1.0) {
                            console.warn(`Warning: Chord duration (${this.chordDuration}s) may be too short for clean playback.`);
                        }

                        // Reset voice leading state
                        this.voiceLeadingState = {
                            previousNotes: null,
                            currentVoicing: null
                        };

                        // Set playing state
                        this.isPlaying = true;
                        this.totalTime = allChords.length * this.chordDuration;

                        // Start from the first chord
                        let currentIndex = 0;

                        // Function to play each chord with proper timing
                        const playNextChord = () => {
                            if (!this.isPlaying || currentIndex >= allChords.length) {
                                this.stopPlayback();
                                return;
                            }

                            // Get current chord info
                            const chordInfo = allChords[currentIndex];
                            const currentChord = chordInfo.chord;

                            // Critical fix: Always release all previous notes first
                            this.synth.releaseAll();

                            // Add a very small delay to ensure audio engine has processed the release
                            setTimeout(() => {
                                try {
                                    // Apply voice leading and play the chord
                                    let voicedChord;
                                    if (this.useAdvancedVoicing) {
                                        // Call your "advanced" logic (the formerly unused functions).
                                        // E.g.:
                                        const func = this.determineChordFunction(chord);
                                        const advancedNotes = this.generateJazzVoicing(chord, func, chord.notes);
                                        voicedChord = { ...chord, playbackNotes: advancedNotes };
                                    } else {
                                        // The simple approach, as before:
                                        voicedChord = this.applyVoiceLeadingToNextChord(chord);
                                    }
                                    this.playVoicedChord(voicedChord);

                                    // Update UI
                                    this.currentChordName = this.getChordDisplayName(currentChord);
                                    this.currentSectionName = chordInfo.sectionName;
                                    this.selectedChordIndices = {
                                        section: chordInfo.sectionIndex,
                                        chord: chordInfo.chordIndex
                                    };

                                    // Update progress
                                    this.elapsedTime = currentIndex * this.chordDuration;
                                    this.progressPercentage = (currentIndex / allChords.length) * 100;

                                    // Schedule next chord with proper timing
                                    currentIndex++;
                                    this.playbackTimer = setTimeout(playNextChord, this.chordDuration * 1000);
                                } catch (e) {
                                    console.error("Error playing chord:", e);
                                    currentIndex++;
                                    this.playbackTimer = setTimeout(playNextChord, this.chordDuration * 1000);
                                }
                            }, 20); // 20ms delay for clean separation
                        };

                        // Start the playback chain
                        playNextChord();

                    } catch (e) {
                        console.error("Failed to start playback:", e);
                        alert("Failed to start audio. Please try again.");
                        this.isPlaying = false;
                    }
                },

                applyInitialVoiceLeading(chord) {
                    if (!chord || !chord.notes || !Array.isArray(chord.notes)) {
                        console.warn("Invalid chord for voice leading:", chord);
                        return chord;
                    }

                    try {
                        // Generate a note pool for this chord
                        const pool = this.getChordNotePool(chord);

                        // Select initial voicing from pool - use existing notes if possible
                        let selectedNotes = [...chord.notes];

                        // Ensure we have valid notes
                        selectedNotes = selectedNotes.filter(note =>
                            typeof note === 'string' && /^[A-G][#b]?[0-9]$/.test(note)
                        );

                        // Sort by pitch for consistent voicing
                        selectedNotes.sort((a, b) => {
                            try {
                                return this.getMIDI(a) - this.getMIDI(b);
                            } catch (e) {
                                return 0;
                            }
                        });

                        // Ensure we have enough notes for rich jazz harmony
                        while (selectedNotes.length < 4 && pool.length > selectedNotes.length) {
                            const nextNote = pool[selectedNotes.length % pool.length];
                            if (!selectedNotes.includes(nextNote)) {
                                selectedNotes.push(nextNote);
                            }
                        }

                        // Initialize voice leading state
                        this.previousVoicing = selectedNotes.slice();
                        this.voiceLeadingState.previousNotes = selectedNotes.slice();
                        this.voiceLeadingState.currentVoicing = selectedNotes.slice();

                        // Return a copy of the chord with the selected notes
                        return {
                            ...chord,
                            playbackNotes: selectedNotes
                        };
                    } catch (e) {
                        console.error("Error in initial voice leading:", e);
                        return chord; // Return original chord as fallback
                    }
                },

                scheduleRemainingChordsWithVoiceLeading(chords) {
                    let currentIndex = 0;

                    const playNextChord = () => {
                        // Check if we should stop - add check for cleanup in progress
                        if (!this.isPlaying || this.audioCleanupInProgress || currentIndex >= chords.length) {
                            this.progressPercentage = 100;

                            // NUCLEAR OPTION STARTS EARLIER - 75% through the last chord
                            const cleanupDelay = this.chordDuration * 750; // 75% of chord duration in ms

                            console.log(`🧨 END OF PROGRESSION: Nuclear cleanup will begin in ${cleanupDelay}ms`);

                            setTimeout(() => {
                                console.log("🧨 END OF PROGRESSION: Nuclear cleanup beginning");

                                // Mark cleanup as in progress to prevent other operations
                                this.audioCleanupInProgress = true;

                                // Stop any running timers
                                if (this.playbackTimer) {
                                    clearTimeout(this.playbackTimer);
                                    this.playbackTimer = null;
                                }

                                // IMMEDIATELY silence everything
                                if (this.synth) {
                                    this.synth.volume.value = -Infinity;

                                    // Stop all active notes
                                    this.synth.releaseAll();

                                    // Cancel any scheduled events in Tone.js
                                    Tone.Transport.cancel();

                                    // Complete disposal of the synth
                                    try {
                                        console.log("💥 Disposing synth after final chord");

                                        // Disconnect and dispose
                                        this.synth.disconnect();
                                        this.synth.dispose();
                                        this.synth = null;

                                        // Create a new minimal synth
                                        setTimeout(() => {
                                            try {
                                                console.log("🔧 Creating new synth");

                                                // Create a simple synth with minimal settings
                                                this.synth = new Tone.PolySynth(Tone.Synth, {
                                                    oscillator: { type: "triangle" },
                                                    envelope: {
                                                        attack: 0.03,
                                                        decay: 0.2,
                                                        sustain: 0.7,
                                                        release: 0.5
                                                    }
                                                }).toDestination();

                                                // Set volume to normal level
                                                this.synth.volume.value = Tone.gainToDb(this.volume || 0.7);

                                                console.log("✅ End of progression cleanup complete");
                                            } catch (e) {
                                                console.error("Error creating new synth:", e);
                                            } finally {
                                                // Always update UI and clear flags
                                                this.isPlaying = false;
                                                this.currentChordName = "";
                                                this.currentSectionName = "";
                                                this.selectedChordIndices = { section: null, chord: null };
                                                this.audioCleanupInProgress = false;
                                            }
                                        }, 50);
                                    } catch (e) {
                                        console.error("Error disposing synth:", e);
                                        // Make sure to reset flags even if there's an error
                                        this.isPlaying = false;
                                        this.audioCleanupInProgress = false;
                                    }
                                } else {
                                    // No synth to dispose
                                    this.isPlaying = false;
                                    this.audioCleanupInProgress = false;
                                    this.currentChordName = "";
                                    this.currentSectionName = "";
                                    this.selectedChordIndices = { section: null, chord: null };
                                }
                            }, cleanupDelay); // Start cleanup earlier

                            return;
                        }

                        // Rest of the function remains the same
                        const chordInfo = chords[currentIndex];
                        const currentChord = chordInfo.chord;

                        // Apply voice leading to this chord
                        const voicedChord = this.applyVoiceLeadingToNextChord(currentChord);

                        console.log(`Playing chord ${currentIndex + 2} of ${chords.length + 1} with voice leading`);
                        this.playVoicedChord(voicedChord);

                        // Update UI
                        this.currentChordName = this.getChordDisplayName(currentChord);
                        this.currentSectionName = chordInfo.sectionName;
                        this.selectedChordIndices = {
                            section: chordInfo.sectionIndex,
                            chord: chordInfo.chordIndex
                        };

                        // Update progress - account for first chord already played
                        const totalChords = chords.length + 1; // +1 for first chord
                        this.elapsedTime = (currentIndex + 1) * this.chordDuration; // +1 for first chord
                        this.progressPercentage = Math.min(
                            ((currentIndex + 2) / totalChords) * 100, // +2 because index starts at 0 and first chord
                            99.5
                        );

                        // Schedule next chord
                        currentIndex++;
                        this.playbackTimer = setTimeout(playNextChord, this.chordDuration * 1000);
                    };

                    // Start the chain with a delay for the first chord duration
                    this.playbackTimer = setTimeout(playNextChord, this.chordDuration * 1000);
                },

                playChord(chord) {
                    if (!this.synth || !Tone.context) {
                        console.warn("Cannot play chord - audio not initialized yet");
                        return;
                    }

                    if (!chord || (!chord.notes && !chord.playbackNotes) ||
                        (chord.notes && (!Array.isArray(chord.notes) || chord.notes.length === 0)) &&
                        (chord.playbackNotes && (!Array.isArray(chord.playbackNotes) || chord.playbackNotes.length === 0))) {
                        console.warn("Invalid chord for playback:", chord);
                        return;
                    }

                    try {
                        // Always release previous notes first
                        this.synth.releaseAll();

                        // Temporarily silence the synth during transition
                        const originalVolume = this.synth.volume.value;
                        this.synth.volume.value = -Infinity;

                        // Increased delay to ensure complete release (from 10ms to 30ms)
                        setTimeout(() => {
                            try {
                                // Restore volume
                                this.synth.volume.value = originalVolume;

                                // FIXED: Prefer playbackNotes if available, otherwise fall back to notes
                                const notesToUse = chord.playbackNotes || chord.notes;

                                // Filter and validate notes
                                const validNotes = notesToUse.filter(note =>
                                    typeof note === 'string' && /^[A-G][#b]?[0-9]$/.test(note)
                                );

                                if (validNotes.length === 0) {
                                    console.warn("No valid notes to play in chord:", notesToUse);
                                    return;
                                }

                                // Limit the number of notes and remove duplicates
                                const optimizedNotes = this.optimizeChordNotes(validNotes);

                                // Use a shorter duration to ensure gap between chords
                                const playDuration = Math.min(this.chordDuration * 0.8, 1.5);

                                this.synth.triggerAttackRelease(optimizedNotes, playDuration);
                            } catch (innerErr) {
                                console.error("Error playing chord notes:", innerErr);
                            }
                        }, 30); // Increased from 10ms to 30ms for more reliable release
                    } catch (err) {
                        console.error("Error in chord playback:", err);
                    }
                },


                optimizeChordNotes(notes) {
                    if (!notes || !Array.isArray(notes)) {
                        console.warn("Invalid notes array in optimizeChordNotes:", notes);
                        return [];
                    }
                    // Remove duplicates using Set
                    const uniqueNotes = [...new Set(notes)];
                    // Sort by MIDI value for logical order
                    uniqueNotes.sort((a, b) => this.getMIDI(a) - this.getMIDI(b));
                    // Limit to 12 notes, keeping lowest 6 and highest 6 for balance
                    if (uniqueNotes.length > 12) {
                        const lowest = uniqueNotes.slice(0, 6);
                        const highest = uniqueNotes.slice(-6);
                        const optimized = [...new Set([...lowest, ...highest])];
                        console.log(`Optimized notes (reduced from ${uniqueNotes.length} to ${optimized.length}):`, optimized);
                        return optimized;
                    }
                    console.log("Optimized notes (no reduction needed):", uniqueNotes);
                    return uniqueNotes;
                },

                /**
                 * Comprehensive stopPlayback with thorough cleanup
                 */
                // Fix for the stopPlayback function
                stopPlayback() {
                    try {
                        // Mark cleanup as in progress to prevent race conditions
                        this.audioCleanupInProgress = true;

                        // Clear any scheduled timers
                        if (this.playbackTimer) {
                            clearTimeout(this.playbackTimer);
                            this.playbackTimer = null;
                        }

                        if (this.progressUpdateInterval) {
                            clearInterval(this.progressUpdateInterval);
                            this.progressUpdateInterval = null;
                        }

                        // Clear problematic chord safety timer
                        if (this.problematicChordTimer) {
                            clearTimeout(this.problematicChordTimer);
                            this.problematicChordTimer = null;
                        }

                        // Cancel all Tone.js scheduled events
                        Tone.Transport.stop();
                        Tone.Transport.cancel(0);

                        // Three-step note release process for maximum reliability:
                        if (this.synth) {
                            // Step 1: Call triggerRelease on all currently active notes
                            this.synth.triggerRelease();

                            // Step 2: Immediately silence to stop any lingering sounds
                            const originalVolume = this.synth.volume.value;
                            this.synth.volume.value = -Infinity;

                            // Step 3: Reset the synth's internal state
                            this.synth.releaseAll();

                            // Step 4: Disconnect the synth completely
                            let destination = null;
                            if (this.synth.context && this.synth.context.destination) {
                                destination = this.synth.context.destination;
                            }
                            this.synth.disconnect();

                            // Restore settings after a longer delay (150ms instead of 100ms)
                            setTimeout(() => {
                                try {
                                    // Reconnect the synth
                                    if (this.synth) {
                                        if (this.masterEQ) {
                                            this.synth.connect(this.masterEQ);
                                        } else if (destination) {
                                            this.synth.connect(destination);
                                        }

                                        // Restore volume
                                        this.synth.volume.value = originalVolume;
                                    }

                                    // Mark cleanup as complete
                                    this.audioCleanupInProgress = false;
                                } catch (innerE) {
                                    console.error("Error reconnecting audio chain:", innerE);
                                    this.audioCleanupInProgress = false;
                                }
                            }, 150);
                        } else {
                            // If no synth, still clear the flag
                            this.audioCleanupInProgress = false;
                        }

                        // Reset playback state
                        this.isPlaying = false;
                        this.currentChordName = "";
                        this.currentSectionName = "";
                        this.selectedChordIndices = { section: null, chord: null };
                        this.progressPercentage = 0;
                        this.elapsedTime = 0;
                    } catch (e) {
                        console.error("Error in stopPlayback:", e);
                        // Clear flag even in case of error
                        this.audioCleanupInProgress = false;
                        // Try emergency reset as last resort
                        this.emergencyResetAudio();
                    }
                },

                emergencyResetAudio() {
                    console.warn("Performing emergency audio reset");

                    // Cancel any pending operations immediately
                    if (this.playbackTimer) {
                        clearTimeout(this.playbackTimer);
                        this.playbackTimer = null;
                    }

                    if (this.problematicChordTimer) {
                        clearTimeout(this.problematicChordTimer);
                        this.problematicChordTimer = null;
                    }

                    // Set playing to false immediately to prevent further scheduling
                    this.isPlaying = false;

                    // Force cleanup in progress flag to prevent other operations
                    this.audioCleanupInProgress = true;

                    if (this.synth) {
                        try {
                            // Force volume to zero immediately
                            this.synth.volume.value = -Infinity;
                            // Release all notes
                            this.synth.releaseAll();
                            // Disconnect
                            this.synth.disconnect();
                            // Dispose
                            this.synth.dispose();
                            this.synth = null;
                        } catch (e) {
                            console.error("Error disposing synth:", e);
                        }
                    }

                    if (Tone.context) {
                        try {
                            Tone.context.close().then(() => {
                                console.log("Audio context closed as emergency measure");
                                // Reinitialize on next user interaction
                                this.audioInitialized = false;
                                // Create overlay for user to re-initialize
                                this.createAudioEnableOverlay();
                                // Clear the cleanup flag
                                this.audioCleanupInProgress = false;
                            }).catch(e => {
                                console.error("Error closing audio context:", e);
                                this.audioCleanupInProgress = false;
                                this.audioInitialized = false;
                                this.createAudioEnableOverlay();
                            });
                        } catch (e2) {
                            console.error("Failed emergency audio stop:", e2);
                            this.audioCleanupInProgress = false;
                            this.audioInitialized = false;
                            this.createAudioEnableOverlay();
                        }
                    } else {
                        this.audioCleanupInProgress = false;
                        this.audioInitialized = false;
                        this.createAudioEnableOverlay();
                    }

                    // Reset all state
                    this.currentChordName = "";
                    this.currentSectionName = "";
                    this.selectedChordIndices = { section: null, chord: null };
                    this.progressPercentage = 0;
                    this.elapsedTime = 0;
                },

                initSimpleTone(audioCtx, button, errorContainer, overlay) {
                    try {
                        // Clean up any existing Tone Transport or events
                        if (Tone.Transport) {
                            Tone.Transport.stop();
                            Tone.Transport.cancel(0);
                        }

                        // Dispose of previous instances to prevent memory leaks
                        if (this.synth) {
                            this.synth.dispose();
                            this.synth = null;
                        }
                        if (this.reverb_effect) {
                            this.reverb_effect.dispose();
                            this.reverb_effect = null;
                        }
                        if (this.masterEQ) {
                            this.masterEQ.dispose();
                            this.masterEQ = null;
                        }
                        if (this.limiter) {
                            this.limiter.dispose();
                            this.limiter = null;
                        }

                        // Ensure Tone is using the provided AudioContext
                        Tone.setContext(audioCtx);

                        // Create a limiter to prevent clipping
                        this.limiter = new Tone.Limiter(-2).toDestination();

                        // Create a reverb effect with controlled settings
                        this.reverb_effect = new Tone.Reverb({
                            decay: 1.2,
                            wet: this.reverb || 0.3,
                            preDelay: 0.01
                        }).connect(this.limiter);

                        // Create a master EQ for better frequency balance
                        this.masterEQ = new Tone.EQ3({
                            low: -1,      // Slight reduction of lows to reduce muddiness
                            mid: 0,       // Keep mids neutral
                            high: 1,      // Slight boost to highs for clarity
                            lowFrequency: 250,
                            highFrequency: 2500
                        }).connect(this.reverb_effect);

                        // CRITICAL IMPROVEMENT: Jazz-optimized synth settings
                        this.synth = new Tone.PolySynth(Tone.Synth, {
                            maxPolyphony: 32, // Reasonable polyphony that won't overwhelm the system
                            oscillator: {
                                type: "triangle" // Triangle is smoother for chords
                            },
                            envelope: {
                                attack: 0.03,   // Slightly faster attack for jazz clarity
                                decay: 0.15,    // Quicker decay for definition
                                sustain: 0.6,   // Lower sustain to reduce overlap
                                release: 0.4    // CRITICAL: Much shorter release for clean transitions
                            }
                        });

                        // Chain through EQ, reverb, limiter
                        this.synth.chain(this.masterEQ, this.reverb_effect, this.limiter);

                        // Overall volume level
                        this.synth.volume.value = -5;

                        // Make sure the context is running
                        if (audioCtx.state !== "running") {
                            audioCtx.resume();
                        }

                        // Mark as successfully initialized
                        this.audioInitialized = true;

                        console.log("Audio system initialized successfully with jazz-optimized envelope!");
                    } catch (e) {
                        console.error("Error in Tone.js initialization:", e);
                        this.showAudioError("Could not initialize audio system. Please try again.", button, errorContainer);
                        // Reset audio initialization flag
                        this.audioInitialized = false;
                    }
                },

                applyVoiceLeadingToNextChord(chord) {
                    console.group("VOICE LEADING");
                    console.log("🎵 Processing voice leading for chord:", this.getChordDisplayName(chord));

                    if (!chord || !chord.notes || !Array.isArray(chord.notes)) {
                        console.warn("⚠️ Invalid chord for voice leading:", chord);
                        console.groupEnd();
                        return chord;
                    }

                    try {
                        // Generate a note pool for this chord
                        console.log("⚙️ Generating note pool from chord properties");
                        const pool = this.getChordNotePool(chord);
                        console.log("📝 Available note pool:", pool);

                        if (!this.voiceLeadingState.previousNotes || !Array.isArray(this.voiceLeadingState.previousNotes)) {
                            console.log("🔄 No previous voicing found - initializing with algorithmic voicing");
                            // First chord - create a balanced initial voicing
                            const balancedVoicing = this.createBalancedInitialVoicing(chord);
                            console.log("✨ Initial balanced voicing:", balancedVoicing);

                            this.voiceLeadingState.previousNotes = balancedVoicing.slice();
                            this.voiceLeadingState.currentVoicing = balancedVoicing.slice();

                            console.log("🏁 Returning initial voicing (no voice leading applied yet)");
                            console.groupEnd();
                            return {
                                ...chord,
                                playbackNotes: balancedVoicing
                            };
                        }

                        // Find closest notes from previous chord with fallback
                        console.log("🔄 Finding closest notes from previous voicing");
                        console.log("📝 Previous voicing:", this.voiceLeadingState.previousNotes);

                        // Define essential chord tones based on chord type
                        const essential = this.getEssentialChordTones(chord);
                        console.log("📝 Essential chord tones:", essential);

                        // Create a mapping of previous notes to new notes
                        const voiceAssignments = [];

                        // COMPLETELY NEW APPROACH: 
                        // 1. First, handle essential chord tones with minimal movement
                        // 2. Then add non-essential tones

                        // Step 1: First, assign essential chord tones with minimal movement
                        const usedPrevNotes = new Set();
                        const usedNewNotes = new Set();

                        essential.forEach(essentialNote => {
                            // Find the closest previous note to this essential tone
                            let bestPrevNote = null;
                            let minDistance = Infinity;

                            this.voiceLeadingState.previousNotes.forEach(prevNote => {
                                if (usedPrevNotes.has(prevNote)) return; // Skip already used notes

                                const distance = Math.abs(this.getMIDI(prevNote) - this.getMIDI(essentialNote));
                                if (distance < minDistance) {
                                    minDistance = distance;
                                    bestPrevNote = prevNote;
                                }
                            });

                            if (bestPrevNote) {
                                console.log(`👉 Essential tone ${essentialNote} paired with previous ${bestPrevNote} (distance: ${minDistance} semitones)`);
                                voiceAssignments.push({
                                    prevNote: bestPrevNote,
                                    newNote: essentialNote,
                                    prevMidi: this.getMIDI(bestPrevNote),
                                    newMidi: this.getMIDI(essentialNote),
                                    isEssential: true
                                });

                                usedPrevNotes.add(bestPrevNote);
                                usedNewNotes.add(essentialNote);
                            }
                        });

                        // Step 2: For each remaining previous note, find closest new note
                        this.voiceLeadingState.previousNotes.forEach(prevNote => {
                            if (usedPrevNotes.has(prevNote)) return; // Skip already used notes

                            let bestNewNote = null;
                            let minDistance = Infinity;

                            // Find closest unused note from the pool
                            pool.forEach(newNote => {
                                const newNoteName = newNote.slice(0, -1);
                                // Skip if this note name is already used
                                if ([...usedNewNotes].some(used => used.startsWith(newNoteName))) return;

                                const distance = Math.abs(this.getMIDI(prevNote) - this.getMIDI(newNote));
                                if (distance < minDistance) {
                                    minDistance = distance;
                                    bestNewNote = newNote;
                                }
                            });

                            if (bestNewNote) {
                                console.log(`👉 Previous note ${prevNote} moves to closest available ${bestNewNote} (distance: ${minDistance} semitones)`);
                                voiceAssignments.push({
                                    prevNote,
                                    newNote: bestNewNote,
                                    prevMidi: this.getMIDI(prevNote),
                                    newMidi: this.getMIDI(bestNewNote),
                                    isEssential: false
                                });

                                usedNewNotes.add(bestNewNote);
                            }
                        });

                        console.log("📝 Voice assignments before adjustment:", voiceAssignments);

                        // Step 3: Adjust octaves to minimize movement (MAX_JUMP = 5 semitones for smooth voice leading)
                        const MAX_JUMP = 5; // Perfect 4th is preferred maximum for smooth voice leading
                        const adjustedAssignments = voiceAssignments.map(assignment => {
                            const { prevNote, newNote, prevMidi, newMidi, isEssential } = assignment;
                            const noteNameOnly = newNote.slice(0, -1);
                            const currentOctave = parseInt(newNote.slice(-1));

                            // Calculate current jump size
                            const currentJump = Math.abs(newMidi - prevMidi);

                            // For essential tones, preserve the octave even with larger jumps
                            if (isEssential && currentJump <= 7) {
                                console.log(`👉 Essential note ${noteNameOnly}: Jump of ${currentJump} semitones is acceptable`);
                                return assignment;
                            }

                            if (currentJump <= MAX_JUMP) {
                                // Jump is already acceptable
                                console.log(`👉 Note ${noteNameOnly}: Jump of ${currentJump} semitones is acceptable`);
                                return assignment;
                            }

                            // Try different octaves to find minimum jump
                            let bestOctave = currentOctave;
                            let minJump = currentJump;

                            // Try octaves 2-5 (standard piano range for jazz voicings)
                            for (let oct = 2; oct <= 5; oct++) {
                                const testNote = noteNameOnly + oct;
                                const testMidi = this.getMIDI(testNote);
                                const testJump = Math.abs(testMidi - prevMidi);

                                if (testJump < minJump) {
                                    minJump = testJump;
                                    bestOctave = oct;
                                }
                            }

                            const adjustedNote = noteNameOnly + bestOctave;
                            console.log(`👉 Note ${noteNameOnly}: Adjusted from ${newNote} to ${adjustedNote} (jump reduced from ${currentJump} to ${minJump} semitones)`);

                            return {
                                prevNote,
                                newNote: adjustedNote,
                                prevMidi,
                                newMidi: this.getMIDI(adjustedNote),
                                isEssential
                            };
                        });

                        console.log("📝 Voice assignments after adjustment:", adjustedAssignments);

                        // Step 4: Extract the adjusted notes in the correct order
                        let adjustedNotes = adjustedAssignments.map(a => a.newNote);
                        console.log("📝 After octave adjustment:", adjustedNotes);

                        // Step 5: Apply further optimizations for jazz voicing
                        adjustedNotes = this.optimizeJazzVoicing(chord, adjustedNotes);
                        console.log("✨ Final voice-led voicing:", adjustedNotes);

                        // Update state for next chord
                        this.voiceLeadingState.previousNotes = adjustedNotes.slice();
                        this.voiceLeadingState.currentVoicing = adjustedNotes.slice();

                        console.log("🏁 Completed voice leading");
                        console.groupEnd();

                        // Return a copy of the chord with the voice-led notes
                        return {
                            ...chord,
                            playbackNotes: adjustedNotes
                        };
                    } catch (e) {
                        console.error("❌ Error in voice leading for next chord:", e);
                        console.groupEnd();
                        return chord; // Return original chord as fallback
                    }
                },

                // Helper function to get essential chord tones with proper octaves
                getEssentialChordTones(chord) {
                    const root = chord.root;
                    if (!root) return [];

                    // Determine if chord is major, minor, dominant, etc.
                    const isMajor = !chord.type?.includes('m') && !chord.type?.includes('dim');
                    const isDominant = chord.type?.includes('7') && !chord.type?.includes('maj7');
                    const isMinor = chord.type?.includes('m');
                    const hasMajor7 = chord.type?.includes('maj7');

                    // Always include root in bass register
                    const essentialTones = [root + '2'];

                    // Add third (essential for chord quality)
                    const third = isMajor ? this.getChordToneByInterval(root, '3') :
                        this.getChordToneByInterval(root, 'b3');
                    essentialTones.push(third + '3'); // Mid register for third

                    // Add seventh if applicable (essential for chord function)
                    if (hasMajor7) {
                        essentialTones.push(this.getChordToneByInterval(root, '7') + '3');
                    } else if (isDominant || chord.type?.includes('m7')) {
                        essentialTones.push(this.getChordToneByInterval(root, 'b7') + '3');
                    }

                    // Add fifth (less essential, but still part of the core)
                    let fifth = chord.b5 ? this.getChordToneByInterval(root, 'b5') :
                        chord.s5 ? this.getChordToneByInterval(root, '#5') :
                            this.getChordToneByInterval(root, '5');
                    essentialTones.push(fifth + '3');

                    // For altered dominants, add ONE characteristic alteration in higher register
                    if (isDominant && (chord.b9 || chord.s9 || chord.b5 || chord.s5 || chord.b13)) {
                        if (chord.b9) {
                            essentialTones.push(this.getChordToneByInterval(root, 'b9') + '4');
                        } else if (chord.s9) {
                            essentialTones.push(this.getChordToneByInterval(root, '#9') + '4');
                        } else if (chord.b13) {
                            essentialTones.push(this.getChordToneByInterval(root, 'b13') + '4');
                        }
                    }

                    // For Lydian chords, add #11 in higher register
                    if (chord.s11) {
                        essentialTones.push(this.getChordToneByInterval(root, '#11') + '4');
                    }

                    return essentialTones;
                },

                createBalancedInitialVoicing(chord) {
                    try {
                        // Get basic chord tones from the chord's root and type
                        const root = chord.root;
                        if (!root) return chord.notes;

                        // Determine if chord is major, minor, dominant, etc.
                        const isMajor = !chord.type?.includes('m') && !chord.type?.includes('dim');
                        const isDominant = chord.type?.includes('7') && !chord.type?.includes('maj7');
                        const isMinor = chord.type?.includes('m');
                        const hasMajor7 = chord.type?.includes('maj7');
                        const hasAlterations = chord.b5 || chord.s5 || chord.b9 || chord.s9 || chord.s11 || chord.b13;

                        // Build a balanced voicing with proper spacing
                        const voicing = [];

                        // Add root in bass register (octave 2)
                        voicing.push(root + '2');

                        // Add chord tones in middle register (octave 3)
                        // For jazz voicings, the 3rd and 7th are most important
                        if (isMajor) {
                            voicing.push(this.getChordToneByInterval(root, '3') + '3');
                        } else if (isMinor) {
                            voicing.push(this.getChordToneByInterval(root, 'b3') + '3');
                        } else if (chord.type?.includes('sus4')) {
                            voicing.push(this.getChordToneByInterval(root, '4') + '3');
                        } else if (chord.type?.includes('sus2')) {
                            voicing.push(this.getChordToneByInterval(root, '2') + '3');
                        } else {
                            // Default to major third if type is unclear
                            voicing.push(this.getChordToneByInterval(root, '3') + '3');
                        }

                        // Add seventh or sixth if applicable
                        if (hasMajor7) {
                            voicing.push(this.getChordToneByInterval(root, '7') + '3');
                        } else if (isDominant || chord.type?.includes('m7')) {
                            voicing.push(this.getChordToneByInterval(root, 'b7') + '3');
                        } else if (chord.type?.includes('dim7')) {
                            voicing.push(this.getChordToneByInterval(root, 'bb7') + '3');
                        } else if (chord.type?.includes('6')) {
                            voicing.push(this.getChordToneByInterval(root, '6') + '3');
                        }

                        // Add fifth (but respect alterations)
                        let fifth = '5';
                        if (chord.b5) fifth = 'b5';
                        if (chord.s5) fifth = '#5';

                        // Place fifth in appropriate register
                        if (chord.type?.includes('dim') || chord.type?.includes('b5')) {
                            // For diminished chords, place fifth in middle register
                            voicing.push(this.getChordToneByInterval(root, fifth) + '3');
                        } else {
                            // For other chords, can place fifth in higher register
                            voicing.push(this.getChordToneByInterval(root, fifth) + '4');
                        }

                        // Add extensions in upper register (octave 4)
                        // This follows proper jazz practice of placing extensions above the 7th

                        // Ninth extensions
                        if (chord.type?.includes('9') || chord.b9 || chord.s9) {
                            let ninth;
                            if (chord.b9) ninth = 'b9';
                            else if (chord.s9) ninth = '#9';
                            else ninth = '9';

                            voicing.push(this.getChordToneByInterval(root, ninth) + '4');
                        }

                        // Eleventh extensions
                        if (chord.type?.includes('11') || chord.s11) {
                            let eleventh = chord.s11 ? '#11' : '11';
                            // #11 always goes in upper register
                            if (eleventh === '#11') {
                                voicing.push(this.getChordToneByInterval(root, eleventh) + '4');
                            }
                            // Natural 11 only used in minor chords typically
                            else if (isMinor || chord.type?.includes('sus')) {
                                voicing.push(this.getChordToneByInterval(root, eleventh) + '4');
                            }
                        }

                        // Thirteenth extensions
                        if (chord.type?.includes('13') || chord.b13) {
                            let thirteenth = chord.b13 ? 'b13' : '13';
                            voicing.push(this.getChordToneByInterval(root, thirteenth) + '4');
                        }

                        // Handle altered dominants specially (very important for jazz sound)
                        if (isDominant && hasAlterations && chord.type?.includes('alt')) {
                            // For altered dominants, create a more compact voicing 
                            // with a clear harmonic function
                            return this.createAlteredDominantVoicing(chord);
                        }

                        // Sort by pitch to ensure logical order
                        return voicing.sort((a, b) => this.getMIDI(a) - this.getMIDI(b));
                    } catch (e) {
                        console.error("Error creating balanced initial voicing:", e);
                        return chord.notes || []; // Return original notes as fallback
                    }
                },

                // Helper function for specialized altered dominant voicings
                createAlteredDominantVoicing(chord) {
                    const root = chord.root;
                    const voicing = [];

                    // Add root in bass register
                    voicing.push(root + '2');

                    // 3rd and b7th define dominant function
                    voicing.push(this.getChordToneByInterval(root, '3') + '3');
                    voicing.push(this.getChordToneByInterval(root, 'b7') + '3');

                    // Add altered tones selectively to avoid overcrowding
                    // Add altered 5ths
                    if (chord.b5) {
                        voicing.push(this.getChordToneByInterval(root, 'b5') + '3');
                    } else if (chord.s5) {
                        voicing.push(this.getChordToneByInterval(root, '#5') + '3');
                    }

                    // Add altered 9ths in upper register
                    if (chord.b9) {
                        voicing.push(this.getChordToneByInterval(root, 'b9') + '4');
                    }
                    if (chord.s9) {
                        voicing.push(this.getChordToneByInterval(root, '#9') + '4');
                    }

                    // Add other alterations (sparingly)
                    if (chord.b13) {
                        voicing.push(this.getChordToneByInterval(root, 'b13') + '4');
                    }

                    // Sort by pitch
                    return voicing.sort((a, b) => this.getMIDI(a) - this.getMIDI(b));
                },

                // If we have too many notes, prioritize the most important ones
                prioritizeChordTones(notes, chord, chordFunction) {
                    // Sort by pitch
                    const sortedNotes = [...notes].sort((a, b) => this.getMIDI(a) - this.getMIDI(b));

                    // Convert to note names (without octaves) for easier comparison
                    const noteNames = sortedNotes.map(note => note.slice(0, -1));

                    // Identify root, third, seventh, and fifth correctly
                    const root = chord.root;
                    const third = chordFunction.isMajor ? this.getChordToneByInterval(root, '3') : this.getChordToneByInterval(root, 'b3');
                    const fifth = this.getChordToneByInterval(root, chordFunction.hasB5 ? 'b5' :
                        (chordFunction.hasS5 ? '#5' : '5'));
                    const seventh = chordFunction.isTonic ? this.getChordToneByInterval(root, '7') :
                        (chordFunction.isDominant || chord.type?.includes('m7') ? this.getChordToneByInterval(root, 'b7') : null);

                    // Keep track of which notes to keep
                    const keepIndices = [];

                    // Always keep bass note
                    keepIndices.push(0);

                    // Keep most important chord tones - ROOT AND THIRD ARE MANDATORY
                    for (let i = 0; i < sortedNotes.length; i++) {
                        const noteName = noteNames[i];

                        // Root and third are most important in jazz
                        if (noteName === root || noteName === third) {
                            if (!keepIndices.includes(i)) {
                                keepIndices.push(i);
                            }
                        }
                    }

                    // Add seventh if applicable (critical for jazz harmony)
                    if (seventh) {
                        let foundSeventh = false;
                        for (let i = 0; i < sortedNotes.length; i++) {
                            if (noteNames[i] === seventh && !keepIndices.includes(i)) {
                                keepIndices.push(i);
                                foundSeventh = true;
                                break;
                            }
                        }

                        // If we didn't find a seventh, we need to add one with appropriate octave
                        if (!foundSeventh && seventh) {
                            // Add seventh in proper register (around middle C)
                            const seventhOctave = 3; // Middle register for sevenths
                            sortedNotes.push(seventh + seventhOctave);
                            keepIndices.push(sortedNotes.length - 1);
                        }
                    }

                    // Add fifth (less important in jazz than R, 3, 7)
                    for (let i = 0; i < sortedNotes.length; i++) {
                        if (noteNames[i] === fifth && !keepIndices.includes(i)) {
                            keepIndices.push(i);
                            break;
                        }
                    }

                    // If we're an altered dominant, include one alteration - CRITICAL FOR THE SOUND
                    if (chordFunction.isAltered) {
                        // Look for b9, #9, b5, #5
                        const alterations = [
                            this.getChordToneByInterval(root, 'b9'),
                            this.getChordToneByInterval(root, '#9'),
                            this.getChordToneByInterval(root, 'b5'),
                            this.getChordToneByInterval(root, '#5'),
                            this.getChordToneByInterval(root, 'b13')
                        ];

                        let foundAlteration = false;
                        // Try to find an alteration in upper register for better sound
                        for (let i = sortedNotes.length - 1; i >= 0; i--) {
                            if (alterations.includes(noteNames[i]) && !keepIndices.includes(i)) {
                                keepIndices.push(i);
                                foundAlteration = true;
                                break;
                            }
                        }

                        // If no alteration found but we need one, add b9 in proper register
                        if (!foundAlteration && chord.b9) {
                            const b9Note = this.getChordToneByInterval(root, 'b9');
                            // Add b9 in upper register for proper altered sound
                            sortedNotes.push(b9Note + '4');
                            keepIndices.push(sortedNotes.length - 1);
                        }
                    }

                    // If we're a major7#11, include the #11 - CRITICAL FOR LYDIAN SOUND
                    if (chord.type?.includes('maj7') && chordFunction.hasS11) {
                        const sharpEleven = this.getChordToneByInterval(root, '#11');
                        let foundSharpEleven = false;

                        for (let i = 0; i < sortedNotes.length; i++) {
                            if (noteNames[i] === sharpEleven && !keepIndices.includes(i)) {
                                keepIndices.push(i);
                                foundSharpEleven = true;
                                break;
                            }
                        }

                        // If no #11 found but we need one, add it in upper register
                        if (!foundSharpEleven) {
                            sortedNotes.push(sharpEleven + '4'); // Add #11 in upper register
                            keepIndices.push(sortedNotes.length - 1);
                        }
                    }

                    // Fill remaining slots with other notes, prioritizing higher ones for color
                    while (keepIndices.length < 8 && keepIndices.length < sortedNotes.length) {
                        for (let i = sortedNotes.length - 1; i >= 0; i--) {
                            if (!keepIndices.includes(i)) {
                                keepIndices.push(i);
                                break;
                            }
                        }
                    }

                    // Sort indices and get the corresponding notes
                    keepIndices.sort((a, b) => a - b);
                    const result = keepIndices.map(i => sortedNotes[i]);

                    return result;
                },


                // New helper function to get chord tones by interval
                getChordToneByInterval(rootNote, interval) {
                    const noteMap = {
                        'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4,
                        'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9,
                        'A#': 10, 'Bb': 10, 'B': 11
                    };

                    const intervalMap = {
                        '1': 0, 'b2': 1, '2': 2, '#2': 3,
                        'b3': 3, '3': 4,
                        '4': 5, '#4': 6,
                        'b5': 6, '5': 7, '#5': 8,
                        'b6': 8, '6': 9, '#6': 10,
                        'b7': 10, '7': 11,
                        'b9': 1, '9': 2, '#9': 3,
                        'b11': 4, '11': 5, '#11': 6,
                        'b13': 8, '13': 9
                    };

                    if (rootNote in noteMap && interval in intervalMap) {
                        const rootIndex = noteMap[rootNote];
                        const intervalValue = intervalMap[interval];

                        // Calculate the target note index
                        const targetIndex = (rootIndex + intervalValue) % 12;

                        // Find the note name for this index (preferring standard jazz notation)
                        // Jazz typically uses flats rather than sharps, except for F# and C#
                        if (targetIndex === 1) return 'Db';
                        if (targetIndex === 3) return 'Eb';
                        if (targetIndex === 6) return 'F#'; // Exception - F# is common in jazz
                        if (targetIndex === 8) return 'Ab';
                        if (targetIndex === 10) return 'Bb';

                        // For the rest, find the matching note name
                        for (const [note, index] of Object.entries(noteMap)) {
                            if (index === targetIndex && note.length === 1) {
                                return note; // Return natural notes as priority
                            }
                        }

                        // Fallback to first found match
                        for (const [note, index] of Object.entries(noteMap)) {
                            if (index === targetIndex) {
                                return note;
                            }
                        }
                    }

                    // Fallback to root note if something goes wrong
                    return rootNote;
                },

                playVoicedChord(chord) {
                    try {
                        console.group("CHORD PLAYBACK");
                        console.log("🎹 PLAYING CHORD:", this.getChordDisplayName(chord));

                        // Use voice-led notes if available, otherwise use original notes
                        const notesToPlay = chord.playbackNotes || chord.notes;

                        console.log("⚙️ Chord details:", {
                            root: chord.root,
                            type: chord.type,
                            bass: chord.bass,
                            alterations: {
                                b5: chord.b5,
                                s5: chord.s5,
                                b9: chord.b9,
                                s9: chord.s9,
                                s11: chord.s11,
                                b13: chord.b13
                            }
                        });

                        if (!notesToPlay || !Array.isArray(notesToPlay) || notesToPlay.length === 0) {
                            console.error("❌ ERROR: No valid notes to play in chord:", chord);
                            console.groupEnd();
                            return;
                        }

                        console.log("📝 Original notes array:", notesToPlay);

                        // CRITICAL FIX: Always use releaseAll with proper timing
                        if (this.synth) {
                            // First silence the synth immediately to stop any ongoing sound
                            const originalVolume = this.synth.volume.value;
                            this.synth.volume.value = -Infinity;

                            console.log("🔇 Set synth volume to -Infinity for clean transition");

                            // Then release all notes
                            this.synth.releaseAll();
                            console.log("🔓 Released all previous notes");

                            // Set a clean delay between release and new attack
                            setTimeout(() => {
                                try {
                                    // Restore volume
                                    this.synth.volume.value = originalVolume;
                                    console.log("🔊 Restored synth volume to", originalVolume);

                                    // Filter for valid notes
                                    const validNotes = notesToPlay.filter(note =>
                                        typeof note === 'string' && /^[A-G][#b]?[0-9]$/.test(note)
                                    );

                                    console.log("✅ Valid notes after filtering:", validNotes);

                                    if (validNotes.length === 0) {
                                        console.error("❌ ERROR: No valid notes after filtering:", notesToPlay);
                                        console.groupEnd();
                                        return;
                                    }

                                    // NEW APPROACH: Always use our algorithmic voicing system
                                    console.log("🔄 Running optimized jazz voicing algorithm...");
                                    const optimizedVoicing = this.optimizeJazzVoicing(chord, validNotes);

                                    console.log("✨ Final optimized voicing:", optimizedVoicing);
                                    console.log("📊 MIDI values:", optimizedVoicing.map(note => ({
                                        note: note,
                                        midi: this.getMIDI(note)
                                    })));

                                    // Check if the voicing might be problematic
                                    if (this.hasDenseClusterVoicing(optimizedVoicing)) {
                                        console.warn("⚠️ WARNING: Dense cluster voicing detected, may sound dissonant");
                                    }

                                    if (this.hasExtremeIntervalSpread(optimizedVoicing)) {
                                        console.warn("⚠️ WARNING: Extreme interval spread detected, may sound disconnected");
                                    }

                                    // Use consistent duration
                                    const playDuration = Math.min(this.chordDuration * 0.8, 1.5);
                                    console.log("⏱️ Play duration:", playDuration, "seconds");

                                    // Play the optimized jazz voicing
                                    console.log("▶️ TRIGGERING CHORD PLAYBACK with", optimizedVoicing.length, "notes");
                                    this.synth.triggerAttackRelease(optimizedVoicing, playDuration);

                                } catch (e) {
                                    console.error("❌ ERROR playing voiced chord:", e);
                                    this.synth.releaseAll(); // Ensure notes are released on error
                                }
                                console.groupEnd();
                            }, 40); // 40ms clean delay between release and attack
                        } else {
                            console.error("❌ ERROR: No synth available for playback");
                            console.groupEnd();
                        }
                    } catch (e) {
                        console.error("❌ CRITICAL ERROR in playVoicedChord:", e);
                        if (this.synth) this.synth.releaseAll(); // Safety release
                        console.groupEnd();
                    }
                },


                // New helper function to detect genuinely problematic voicings
                hasDenseClusterVoicing(notes) {
                    if (notes.length < 4) return false;

                    // Convert to MIDI numbers
                    const midiNotes = notes.map(note => this.getMIDI(note)).sort((a, b) => a - b);

                    // Count how many semitone clusters exist (notes only 1 semitone apart)
                    let clusterCount = 0;
                    for (let i = 1; i < midiNotes.length; i++) {
                        if (midiNotes[i] - midiNotes[i - 1] === 1) {
                            clusterCount++;
                        }
                    }

                    // More than 2 semitone clusters is genuinely problematic
                    return clusterCount > 2;
                },


                hasExtremeIntervalSpread(notes) {
                    if (notes.length < 2) return false;

                    // Convert to MIDI numbers
                    const midiNotes = notes.map(note => this.getMIDI(note)).sort((a, b) => a - b);

                    // More than 4 octaves (48 semitones) is extreme
                    return (midiNotes[midiNotes.length - 1] - midiNotes[0]) > 48;
                },


                // Fully algorithmic jazz voicing system
                optimizeJazzVoicing(chord, notes) {
                    console.group("JAZZ VOICING OPTIMIZATION");
                    console.log("🎵 Optimizing voicing for chord:", this.getChordDisplayName(chord));
                    console.log("📝 Input notes:", notes);

                    try {
                        // REVISED APPROACH: Focus on proper jazz voicing principles

                        // Step 1: Make sure we have the right root, and add it if missing
                        let rootNote = chord.root + '2'; // Bass register for root
                        let hasRoot = notes.some(note => note.startsWith(chord.root));
                        let workingNotes = [...notes];

                        if (!hasRoot) {
                            workingNotes.unshift(rootNote);
                            console.log("📝 Added missing root note:", rootNote);
                        }

                        // Step 2: Identify the chord type for proper voicing
                        const isMajor = !chord.type?.includes('m') && !chord.type?.includes('dim');
                        const isDominant = chord.type?.includes('7') && !chord.type?.includes('maj7');
                        const isMinor = chord.type?.includes('m') || chord.type?.includes('min');
                        const hasAlterations = chord.b5 || chord.s5 || chord.b9 || chord.s9 || chord.s11 || chord.b13;

                        // Step 3: Ensure presence of critical chord tones
                        // Get the third (major or minor)
                        const thirdDegree = isMajor ? '3' : 'b3';
                        const thirdNote = this.getChordToneByInterval(chord.root, thirdDegree);
                        let hasThird = workingNotes.some(note => note.slice(0, -1) === thirdNote);

                        if (!hasThird) {
                            // Add third in middle register - critical for chord quality
                            workingNotes.push(thirdNote + '3');
                            console.log("📝 Added missing third:", thirdNote + '3');
                        }

                        // Get the seventh if applicable
                        if (chord.type?.includes('7') || chord.type?.includes('9') ||
                            chord.type?.includes('11') || chord.type?.includes('13')) {

                            const seventhDegree = isDominant || isMinor ? 'b7' : '7';
                            const seventhNote = this.getChordToneByInterval(chord.root, seventhDegree);
                            let hasSeventh = workingNotes.some(note => note.slice(0, -1) === seventhNote);

                            if (!hasSeventh) {
                                // Add seventh in middle register
                                workingNotes.push(seventhNote + '3');
                                console.log("📝 Added missing seventh:", seventhNote + '3');
                            }
                        }

                        // Step 4: Handle alterations properly
                        if (hasAlterations) {
                            // For altered chords, ensure alterations are in UPPER registers
                            // Check and add alterations in upper register if missing
                            if (chord.b9) {
                                const b9Note = this.getChordToneByInterval(chord.root, 'b9');
                                if (!workingNotes.some(note => note.slice(0, -1) === b9Note)) {
                                    workingNotes.push(b9Note + '4'); // Upper register for tension
                                    console.log("📝 Added missing b9 alteration:", b9Note + '4');
                                }
                            }

                            if (chord.s9) {
                                const s9Note = this.getChordToneByInterval(chord.root, '#9');
                                if (!workingNotes.some(note => note.slice(0, -1) === s9Note)) {
                                    workingNotes.push(s9Note + '4'); // Upper register for tension
                                    console.log("📝 Added missing #9 alteration:", s9Note + '4');
                                }
                            }

                            if (chord.s11) {
                                const s11Note = this.getChordToneByInterval(chord.root, '#11');
                                if (!workingNotes.some(note => note.slice(0, -1) === s11Note)) {
                                    workingNotes.push(s11Note + '4'); // Upper register for tension
                                    console.log("📝 Added missing #11 alteration:", s11Note + '4');
                                }
                            }
                        }

                        // Step 5: Apply proper voicing type based on chord quality
                        console.log("📝 Applying proper voicing type for chord quality");

                        if (isDominant && hasAlterations) {
                            console.log("📝 Using altered dominant voicing structure");
                            // Altered dominants need careful voicing
                            workingNotes = this.applyAlteredDominantVoicing(chord, workingNotes);
                        } else if (chord.type?.includes('maj') && chord.s11) {
                            console.log("📝 Using maj7#11 Lydian voicing structure");
                            // Lydian major voicings need the #11 properly placed
                            workingNotes = this.applyLydianVoicing(chord, workingNotes);
                        } else if (isMinor && chord.type?.includes('11')) {
                            console.log("📝 Using minor 11 voicing structure");
                            // Minor 11 voicings benefit from quartal structures
                            workingNotes = this.applyMinor11Voicing(chord, workingNotes);
                        }

                        // Step 6: Ensure proper register spacing with emphasis on mid-range
                        workingNotes = this.applyProperJazzRegisters(workingNotes);
                        console.log("📝 After register adjustments:", workingNotes);

                        // Step 7: Remove duplicate notes and sort
                        const uniqueNotes = [];
                        const seenNoteNames = new Set();

                        for (const note of workingNotes) {
                            const noteName = note.slice(0, -1);
                            if (!seenNoteNames.has(noteName)) {
                                seenNoteNames.add(noteName);
                                uniqueNotes.push(note);
                            }
                        }

                        console.log("📝 After removing duplicates:", uniqueNotes);

                        // Step 8: Final sorting by MIDI note number for logical voicing order
                        const result = uniqueNotes.sort((a, b) => this.getMIDI(a) - this.getMIDI(b));

                        // Limit number of notes for playability
                        const finalVoicing = result.slice(0, Math.min(result.length, 6));

                        console.log("✨ Final optimized jazz voicing:", finalVoicing);
                        console.log("📊 MIDI values:", finalVoicing.map(note => ({
                            note: note,
                            midi: this.getMIDI(note)
                        })));

                        console.groupEnd();
                        return finalVoicing;
                    } catch (e) {
                        console.error("❌ Error in jazz voicing optimization:", e);
                        console.groupEnd();
                        // Return the original notes as fallback
                        return notes;
                    }
                },

                // New helper methods for optimizeJazzVoicing:
                applyAlteredDominantVoicing(chord, notes) {
                    // For altered dominants, we want:
                    // - Root in bass
                    // - Third and seventh in mid register
                    // - Alterations in upper register

                    const root = chord.root;
                    const third = this.getChordToneByInterval(root, '3');
                    const seventh = this.getChordToneByInterval(root, 'b7');

                    // Find existing notes by name
                    const notesWithoutOctave = notes.map(note => note.slice(0, -1));

                    // Create the new voicing
                    let voicing = [];

                    // Start with root in bass
                    voicing.push(root + '2');

                    // Add third and seventh in middle register
                    voicing.push(third + '3');
                    voicing.push(seventh + '3');

                    // Add alterations in upper register
                    if (chord.b5 || chord.s5) {
                        const fifth = chord.b5 ? this.getChordToneByInterval(root, 'b5') :
                            this.getChordToneByInterval(root, '#5');
                        voicing.push(fifth + '4');
                    }

                    if (chord.b9 || chord.s9) {
                        const ninth = chord.b9 ? this.getChordToneByInterval(root, 'b9') :
                            this.getChordToneByInterval(root, '#9');
                        voicing.push(ninth + '4');
                    }

                    if (chord.b13) {
                        voicing.push(this.getChordToneByInterval(root, 'b13') + '4');
                    }

                    // Ensure we preserve any other notes that might be important
                    notes.forEach(note => {
                        const noteName = note.slice(0, -1);
                        // Skip notes we've already added
                        if (!voicing.some(v => v.startsWith(noteName))) {
                            // For any remaining notes, add them in upper register
                            const octave = Math.max(parseInt(note.slice(-1)), 4);
                            voicing.push(noteName + octave);
                        }
                    });

                    return voicing;
                },

                applyLydianVoicing(chord, notes) {
                    // For Lydian Major (maj7#11) voicings:
                    // - Root in bass
                    // - 3, 5, 7 in middle register
                    // - #11 and 9 (if present) in upper register

                    const root = chord.root;
                    const third = this.getChordToneByInterval(root, '3');
                    const fifth = this.getChordToneByInterval(root, '5');
                    const seventh = this.getChordToneByInterval(root, '7');
                    const sharpEleven = this.getChordToneByInterval(root, '#11');

                    // Create the new voicing
                    let voicing = [];

                    // Start with root in bass
                    voicing.push(root + '2');

                    // Add third, fifth, seventh in middle register
                    voicing.push(third + '3');
                    voicing.push(fifth + '3');
                    voicing.push(seventh + '3');

                    // Add #11 in upper register
                    voicing.push(sharpEleven + '4');

                    // Add 9 in upper register if present in chord type
                    if (chord.type?.includes('9')) {
                        voicing.push(this.getChordToneByInterval(root, '9') + '4');
                    }

                    return voicing;
                },

                applyMinor11Voicing(chord, notes) {
                    // For minor 11 voicings:
                    // - Root in bass
                    // - b3, 5, b7 in middle
                    // - 9, 11 in upper register

                    const root = chord.root;
                    const flatThird = this.getChordToneByInterval(root, 'b3');
                    const fifth = this.getChordToneByInterval(root, '5');
                    const flatSeventh = this.getChordToneByInterval(root, 'b7');
                    const ninth = this.getChordToneByInterval(root, '9');
                    const eleventh = this.getChordToneByInterval(root, '11');

                    // Create the new voicing
                    let voicing = [];

                    // Start with root in bass
                    voicing.push(root + '2');

                    // Add b3, 5, b7 in middle register
                    voicing.push(flatThird + '3');
                    voicing.push(fifth + '3');
                    voicing.push(flatSeventh + '3');

                    // Add 9, 11 in upper register
                    voicing.push(ninth + '4');
                    voicing.push(eleventh + '4');

                    return voicing;
                },

                applyProperJazzRegisters(notes) {
                    // First, sort notes by pitch
                    const sortedNotes = [...notes].sort((a, b) => this.getMIDI(a) - this.getMIDI(b));

                    // If no notes, return empty array
                    if (sortedNotes.length === 0) return [];

                    // Identify the lowest note (usually root)
                    const lowestNote = sortedNotes[0];
                    const lowestNoteName = lowestNote.slice(0, -1);

                    // We'll keep the lowest note in position, but adjust others
                    const result = [lowestNote];

                    // For jazz voicings, we want the next few notes in the middle register (3-4)
                    // and upper extensions in higher registers
                    for (let i = 1; i < sortedNotes.length; i++) {
                        const noteName = sortedNotes[i].slice(0, -1);
                        let targetOctave;

                        if (i <= 3) {
                            // Middle voices (typically 3rd, 5th, 7th) go in mid register
                            targetOctave = 3;
                        } else {
                            // Upper extensions (9ths, 11ths, 13ths) go in upper register
                            targetOctave = 4;
                        }

                        result.push(noteName + targetOctave);
                    }

                    return result;
                },

                // Analyze the harmonic function and character of the chord
                determineChordFunction(chord) {
                    console.group("CHORD FUNCTION ANALYSIS");
                    console.log("🎵 Analyzing chord function for:", this.getChordDisplayName(chord));

                    if (!chord || typeof chord !== 'object') {
                        console.warn("Invalid chord in determineChordFunction:", chord);
                        console.groupEnd();
                        return {};
                    }

                    // Checks for chord’s structural hints
                    const isMajor = !chord.type?.includes('m') && !chord.type?.includes('dim');
                    const isMinor = chord.type?.includes('m') && !chord.type?.includes('maj7');
                    const isDominant = chord.type?.includes('7') && !chord.type?.includes('maj7');
                    const isHalfDiminished = chord.type?.includes('m7b5');
                    const isDiminished = chord.type?.includes('dim7') || chord.type === 'dim';
                    const isSus = chord.type?.includes('sus');

                    // If chord explicitly has these properties set
                    const hasB5 = chord.b5 === true;
                    const hasS5 = chord.s5 === true;
                    const hasB9 = chord.b9 === true;
                    const hasS9 = chord.s9 === true;
                    const hasS11 = chord.s11 === true;
                    const hasB13 = chord.b13 === true;

                    // “Altered” if either chord.type says "alt" or it’s a dominant with typical alterations
                    const isAltered = chord.type?.includes('alt') ||
                        (isDominant && (hasB5 || hasS5 || hasB9 || hasS9 || hasB13 || hasS11));

                    // Additional “function” hints from your advanced code
                    const isMinorTonic = (isMinor && chord.type?.includes('maj7')) || chord.type === 'm6';
                    const isTonic = isMajor && chord.type?.includes('maj7') && !isDominant;
                    const isModal = isSus || isMinorTonic || (isMajor && hasS11);

                    // Preferences for certain voicing styles
                    const preferQuartal = (isSus || chord.type?.includes('11')) && !isAltered;
                    const useCluster = (hasB9 && hasS9) || (isAltered && hasB5 && hasS5);

                    const chordFunction = {
                        isMajor,
                        isMinor,
                        isDominant,
                        isDiminished,
                        isHalfDiminished,
                        isSus,
                        isAltered,
                        isTonic,
                        isMinorTonic,
                        isModal,
                        preferQuartal,
                        useCluster,
                        hasB5,
                        hasS5,
                        hasB9,
                        hasS9,
                        hasS11,
                        hasB13
                    };

                    console.log("🔍 Determined chord function:", chordFunction);
                    console.groupEnd();
                    return chordFunction;
                },

                // Generate the actual jazz voicing based on chord properties and function
                generateJazzVoicing(chord, chordFunction, originalNotes) {
                    console.group("ADVANCED VOICING: generateJazzVoicing");
                    console.log("🎵 Generating advanced voicing for chord:", this.getChordDisplayName(chord));
                    console.log("🔧 chordFunction:", chordFunction);
                    console.log("🎼 Original chord notes for reference:", originalNotes);

                    // Step 1: pick a voicing style
                    const voicingType = this.selectVoicingType(chord, chordFunction);
                    console.log("🎨 Chosen voicingType:", voicingType);

                    // Step 2: get the chord’s fundamental intervals
                    let coreIntervals = this.getCoreIntervals(chord, chordFunction);
                    console.log("🔩 coreIntervals:", coreIntervals);

                    // Step 3: add chord extensions and/or alterations
                    let fullIntervals = this.addExtensionsAndAlterations(coreIntervals, chord, chordFunction);
                    console.log("🎨 after addExtensionsAndAlterations:", fullIntervals);

                    // Step 4: apply a voicing technique (drop2, cluster, spread, etc.)
                    let voicedIntervals = this.applyVoicingTechnique(fullIntervals, voicingType, chord);
                    console.log("🎨 after applyVoicingTechnique:", voicedIntervals);

                    // Step 5: convert those intervals to actual note strings (C3, D#4, etc.)
                    let noteList = this.intervalsToNotes(chord.root, voicedIntervals);
                    console.log("🎹 intervalsToNotes =>", noteList);

                    // Step 6: handle slash chords if chord.bass differs from chord.root
                    if (chord.bass && chord.bass !== chord.root) {
                        console.log("🪗 Handling slash chord - forcing bass:", chord.bass);
                        noteList = this.ensureCorrectBass(noteList, chord.bass);
                    }

                    // Step 7: do register-range adjustments (avoid muddy lows or too-wide spans)
                    noteList = this.applyRegisterAdjustments(noteList);
                    console.log("✅ final advanced voicing noteList:", noteList);

                    console.groupEnd();
                    return noteList;
                },


                // Select the appropriate jazz voicing technique
                selectVoicingType(chord, chordFunction) {
                    console.group("selectVoicingType");
                    console.log("🎵 Deciding voicing type for chord:", this.getChordDisplayName(chord));
                    console.log("🔧 chordFunction data:", chordFunction);

                    let voicingType = 'close'; // default fallback

                    // Use your advanced logic to pick a style
                    if (chordFunction.isAltered && chordFunction.isDominant) {
                        voicingType = 'altered';
                        console.log("🔮 isAltered + isDominant => 'altered' voicing");
                    } else if (chordFunction.useCluster) {
                        voicingType = 'cluster';
                        console.log("🔊 chordFunction.useCluster => 'cluster' voicing");
                    } else if (chordFunction.preferQuartal || chordFunction.isSus) {
                        voicingType = 'quartal';
                        console.log("🧱 preferQuartal or isSus => 'quartal' voicing");
                    } else if (chordFunction.isMinor) {
                        voicingType = 'drop2';
                        console.log("🎵 isMinor => 'drop2' voicing (example preference)");
                    } else if (chordFunction.isMajor && !chordFunction.isAltered) {
                        voicingType = 'open';
                        console.log("🪘 isMajor => 'open' voicing");
                    } else {
                        console.log("No specialized logic triggered; using 'close' by default.");
                    }

                    console.log("🎨 final voicingType:", voicingType);
                    console.groupEnd();
                    return voicingType;
                },

                // Get the core intervals for this chord type
                getCoreIntervals(chord, chordFunction) {
                    console.group("getCoreIntervals");
                    console.log("🧩 Determining core intervals for chord:", this.getChordDisplayName(chord));
                    const intervals = [];

                    // 1) root
                    intervals.push({ degree: '1', octaveOffset: 0 });

                    // 2) third or sus
                    if (chordFunction.isSus) {
                        if (chord.type?.includes('sus2')) {
                            intervals.push({ degree: '2', octaveOffset: 0 });
                        } else {
                            intervals.push({ degree: '4', octaveOffset: 0 });
                        }
                    } else if (chordFunction.isMinor || chordFunction.isHalfDiminished || chordFunction.isDiminished) {
                        intervals.push({ degree: 'b3', octaveOffset: 0 });
                    } else {
                        intervals.push({ degree: '3', octaveOffset: 0 });
                    }

                    // 3) fifth (may get replaced by b5/#5 later if chord says so)
                    intervals.push({ degree: '5', octaveOffset: 0 });

                    // 4) seventh if chord type includes 7,9,11,13
                    if (chord.type?.includes('7') || chord.type?.includes('9') ||
                        chord.type?.includes('11') || chord.type?.includes('13')) {
                        if (chord.type?.includes('maj7')) {
                            intervals.push({ degree: '7', octaveOffset: 0 });
                        } else if (chordFunction.isDiminished) {
                            intervals.push({ degree: 'bb7', octaveOffset: 0 });
                        } else {
                            intervals.push({ degree: 'b7', octaveOffset: 0 });
                        }
                    }

                    console.log("🧩 coreIntervals result:", intervals);
                    console.groupEnd();
                    return intervals;
                },

                // Add extensions and alterations based on chord properties
                addExtensionsAndAlterations(intervals, chord, chordFunction) {
                    console.group("addExtensionsAndAlterations");
                    console.log("Before:", intervals);
                    const result = [...intervals];

                    // If chord or chordFunction indicates b5 / #5, replace the existing '5'
                    if (chordFunction.hasB5) {
                        const idx5 = result.findIndex(x => x.degree === '5');
                        if (idx5 >= 0) {
                            result[idx5].degree = 'b5';
                        }
                    } else if (chordFunction.hasS5) {
                        const idx5 = result.findIndex(x => x.degree === '5');
                        if (idx5 >= 0) {
                            result[idx5].degree = '#5';
                        }
                    }

                    // For typical jazz usage, put altered tensions an octave higher
                    if (chordFunction.hasB9) {
                        result.push({ degree: 'b9', octaveOffset: 1 });
                    }
                    if (chordFunction.hasS9) {
                        result.push({ degree: '#9', octaveOffset: 1 });
                    }
                    if (chordFunction.hasS11) {
                        result.push({ degree: '#11', octaveOffset: 1 });
                    }
                    if (chordFunction.hasB13) {
                        result.push({ degree: 'b13', octaveOffset: 1 });
                    }

                    console.log("After applying chord’s extensions/alterations:", result);
                    console.groupEnd();
                    return result;
                },


                // Apply the selected voicing technique to the intervals
                applyVoicingTechnique(intervals, voicingType, chord) {
                    console.group("applyVoicingTechnique");
                    console.log("🎵 voicingType:", voicingType);
                    console.log("Intervals before technique:", intervals);

                    // Sort intervals by scale-degree value so we know which is highest, second-highest, etc.
                    let result = [...intervals];
                    result.sort((a, b) => this.getDegreeValue(a.degree) - this.getDegreeValue(b.degree));

                    switch (voicingType) {
                        case 'close':
                            console.log("Applying close voicing (minimal spacing).");
                            // We keep them as is, no special offset changes
                            break;

                        case 'open':
                            console.log("Applying open voicing (wider spacing).");
                            // E.g. raise every other note by +1 octave
                            for (let i = 1; i < result.length; i += 2) {
                                result[i].octaveOffset += 1;
                            }
                            break;

                        case 'drop2':
                            console.log("Applying drop2 voicing.");
                            if (result.length >= 4) {
                                const secondHighest = result.length - 2;
                                result[secondHighest].octaveOffset -= 1;
                            }
                            break;

                        case 'drop3':
                            console.log("Applying drop3 voicing.");
                            if (result.length >= 4) {
                                const thirdHighest = result.length - 3;
                                result[thirdHighest].octaveOffset -= 1;
                            }
                            break;

                        case 'spread':
                            console.log("Applying spread voicing (gradual bigger intervals).");
                            for (let i = 1; i < result.length; i++) {
                                result[i].octaveOffset += Math.floor(i / 2);
                            }
                            break;

                        case 'quartal':
                            console.log("Applying quartal voicing (stacking in 4ths).");
                            // If you want a naive approach: raise each subsequent note by i//2
                            // or do something more complex for real 4th alignment
                            for (let i = 1; i < result.length; i++) {
                                result[i].octaveOffset += Math.floor(i / 2);
                            }
                            break;

                        case 'cluster':
                            console.log("Applying cluster voicing (tight spacing for upper notes).");
                            // Keep the first few intervals close, push some up one octave
                            for (let i = 0; i < result.length; i++) {
                                if (i > 2) {
                                    result[i].octaveOffset += 1;
                                }
                            }
                            break;

                        case 'shell':
                            console.log("Applying shell voicing (just root, 3rd, 7th).");
                            // Filter out everything except 1, 3/b3, 7/b7
                            result = result.filter(iv => (
                                iv.degree === '1' || iv.degree === '3' || iv.degree === 'b3' ||
                                iv.degree === '7' || iv.degree === 'b7'
                            ));
                            break;

                        case 'altered':
                            console.log("Applying 'altered' voicing technique for heavily changed dominants.");
                            // Maybe cluster all extended notes above the 5th
                            for (let i = 0; i < result.length; i++) {
                                if (this.getDegreeValue(result[i].degree) >= this.getDegreeValue('b9')) {
                                    // push them at least an octave up
                                    result[i].octaveOffset = Math.max(result[i].octaveOffset, 1);
                                }
                            }
                            break;

                        case 'upper-structure':
                            console.log("Applying upper-structure triad approach (like partial triad on top).");
                            // E.g. keep root & 7 in lower octave, push 3 or 5 or tensions up
                            if (result.length >= 4) {
                                result[1].octaveOffset += 1;
                                result[2].octaveOffset += 1;
                            }
                            break;

                        default:
                            console.log("Unknown voicingType; applying close by default.");
                            break;
                    }

                    console.log("Result after voicing technique:", result);
                    console.groupEnd();
                    return result;
                },

                // Convert interval notation to semitone values
                getDegreeValue(degree) {
                    // Return 0..11 for the basic chord tones, plus typical tensions
                    const map = {
                        '1': 0, 'b2': 1, '2': 2, '#2': 3, 'b3': 3, '3': 4, '4': 5, '#4': 6,
                        'b5': 6, '5': 7, '#5': 8, 'b6': 8, '6': 9, 'b7': 10, '7': 11,
                        'b9': 1, '9': 2, '#9': 3, '11': 5, '#11': 6, 'b13': 8, '13': 9,
                        'bb7': 9 // for fully diminished 7th
                    };
                    return map[degree] !== undefined ? map[degree] : 0;
                },


                // Convert intervals to actual note names with octaves
                intervalsToNotes(root, intervals) {
                    console.group("intervalsToNotes");
                    console.log("Converting intervals => notes. root:", root, intervals);

                    // We assume there's a base octave of 3. If you had a chord baseOctave, you can incorporate that.
                    const baseOctave = 3;

                    const finalNotes = intervals.map(iv => {
                        const semitonesFromRoot = this.getDegreeValue(iv.degree);
                        // get the numerical index for root
                        const rootVal = this.getNoteIndex(root); // define getNoteIndex(...) or use this.noteMap
                        const totalSemitones = rootVal + semitonesFromRoot;
                        const noteOctave = baseOctave + (iv.octaveOffset || 0) + Math.floor(totalSemitones / 12);
                        const noteIndex = ((totalSemitones % 12) + 12) % 12;

                        // find the best note name from your noteMap
                        const possibleNames = Object.keys(this.noteMap).filter(k => this.noteMap[k] === noteIndex);
                        // prefer a natural or sharp name if possible
                        let noteName = possibleNames.find(n => !n.includes('b')) || possibleNames[0] || 'C';

                        return noteName + noteOctave;
                    });

                    console.log("=> intervalsToNotes result:", finalNotes);
                    console.groupEnd();
                    return finalNotes;
                },

                // Ensure slash chords have correct bass note
                ensureCorrectBass(noteList, bassNote) {
                    console.group("ensureCorrectBass");
                    console.log("Original noteList:", noteList, "slash chord bassNote:", bassNote);

                    // remove any occurrence of that noteName (any octave), to avoid duplicates
                    let filtered = noteList.filter(n => {
                        // e.g. if it starts with “C#”, that’s the same letter as “C#” ignoring the octave
                        const noteLetter = n.replace(/[0-9]/g, '');
                        return noteLetter !== bassNote;
                    });

                    // pick an octave for the slash note. Usually 2 or 3
                    const forcedOctave = 2;
                    const slashNote = bassNote + forcedOctave;
                    filtered.unshift(slashNote);

                    console.log("Result with forced slash chord bass:", filtered);
                    console.groupEnd();
                    return filtered;
                },

                // Apply register-specific spacing adjustments
                applyRegisterAdjustments(noteList) {
                    console.group("applyRegisterAdjustments");
                    console.log("Before register fix:", noteList);

                    // convert to MIDI for analysis
                    let midiData = noteList.map(nt => {
                        return { note: nt, midi: this.getMIDI(nt) }; // we assume you have this.getMIDI(nt)
                    });
                    midiData.sort((a, b) => a.midi - b.midi);

                    if (midiData.length > 1) {
                        // for example, if top minus bottom is more than 24 semitones, try moving top down
                        const maxSpan = 24;
                        while ((midiData[midiData.length - 1].midi - midiData[0].midi) > maxSpan) {
                            midiData[midiData.length - 1].midi -= 12;
                            midiData.sort((a, b) => a.midi - b.midi);
                        }

                        // also ensure bottom note isn't below MIDI 36 (C2). If it is, push it up
                        // you can adapt for your preference
                        const minMIDI = 36;
                        if (midiData[0].midi < minMIDI) {
                            let diff = minMIDI - midiData[0].midi;
                            for (let i = 0; i < midiData.length; i++) {
                                midiData[i].midi += diff;
                            }
                            midiData.sort((a, b) => a.midi - b.midi);
                        }
                    }

                    // Rebuild final noteList
                    const finalList = midiData.map(obj => {
                        const semitone = obj.midi % 12;
                        const octave = Math.floor(obj.midi / 12) - 1;
                        const possible = Object.keys(this.noteMap).filter(k => this.noteMap[k] === semitone);
                        // prefer a “natural or sharp” name if possible
                        let noteName = possible.find(x => !x.includes('b')) || possible[0] || 'C';
                        return noteName + octave;
                    });

                    console.log("After register adjustments:", finalList);
                    console.groupEnd();
                    return finalList;
                },

                // If we have too many notes, prioritize the most important ones
                prioritizeChordTones(notes, chord, chordFunction) {
                    // Sort by pitch
                    const sortedNotes = [...notes].sort((a, b) => this.getMIDI(a) - this.getMIDI(b));

                    // Convert to note names (without octaves) for easier comparison
                    const noteNames = sortedNotes.map(note => note.slice(0, -1));

                    // Identify root, third, seventh, and fifth
                    const root = chord.root;
                    const third = this.getChordToneByInterval(root, chordFunction.isMajor ? '3' : 'b3');
                    const fifth = this.getChordToneByInterval(root, chordFunction.hasB5 ? 'b5' :
                        (chordFunction.hasS5 ? '#5' : '5'));
                    const seventh = this.getChordToneByInterval(root, chordFunction.isTonic ? '7' : 'b7');

                    // Keep track of which notes to keep
                    const keepIndices = [];

                    // Always keep bass note
                    keepIndices.push(0);

                    // Keep most important chord tones
                    for (let i = 0; i < sortedNotes.length; i++) {
                        const noteName = noteNames[i];

                        // Root, third, and seventh are most important in jazz
                        if (noteName === root || noteName === third || noteName === seventh) {
                            if (!keepIndices.includes(i)) {
                                keepIndices.push(i);
                            }
                        }
                    }

                    // Add fifth (less important in jazz than R, 3, 7)
                    for (let i = 0; i < sortedNotes.length; i++) {
                        if (noteNames[i] === fifth && !keepIndices.includes(i)) {
                            keepIndices.push(i);
                        }
                    }

                    // If we're an altered dominant, include one alteration
                    if (chordFunction.isAltered) {
                        // Look for b9, #9, b5, #5
                        const alterations = [
                            this.getChordToneByInterval(root, 'b9'),
                            this.getChordToneByInterval(root, '#9'),
                            this.getChordToneByInterval(root, 'b5'),
                            this.getChordToneByInterval(root, '#5'),
                            this.getChordToneByInterval(root, 'b13')
                        ];

                        // Add first found alteration
                        for (let i = 0; i < sortedNotes.length; i++) {
                            if (alterations.includes(noteNames[i]) && !keepIndices.includes(i)) {
                                keepIndices.push(i);
                                break;
                            }
                        }
                    }

                    // If we're a major7#11, include the #11
                    if (chord.type?.includes('maj7') && chordFunction.hasS11) {
                        const sharpEleven = this.getChordToneByInterval(root, '#11');
                        for (let i = 0; i < sortedNotes.length; i++) {
                            if (noteNames[i] === sharpEleven && !keepIndices.includes(i)) {
                                keepIndices.push(i);
                            }
                        }
                    }

                    // Fill remaining slots with other notes, prioritizing higher ones for color
                    while (keepIndices.length < 8 && keepIndices.length < sortedNotes.length) {
                        for (let i = sortedNotes.length - 1; i >= 0; i--) {
                            if (!keepIndices.includes(i)) {
                                keepIndices.push(i);
                                break;
                            }
                        }
                    }

                    // Sort indices and get the corresponding notes
                    keepIndices.sort((a, b) => a - b);
                    const result = keepIndices.map(i => sortedNotes[i]);

                    return result;
                },
                /**
                 * Clears progress update interval timer.
                 */
                clearProgressTimer() {
                    if (this.progressUpdateInterval) {
                        clearInterval(this.progressUpdateInterval);
                        this.progressUpdateInterval = null;
                    }
                },

                async playSection(sectionIndex) {
                    // First, stop any current playback
                    try {
                        this.stopPlayback();
                    } catch (stopError) {
                        console.error("Error stopping playback:", stopError);
                        // If stopping fails, don't continue with playback
                        return;
                    }

                    if (!this.synth) {
                        console.warn("Cannot play section - audio not initialized yet");
                        return;
                    }

                    try {
                        // Validate section index
                        if (sectionIndex < 0 || sectionIndex >= this.currentProgression.sections.length) {
                            console.warn("Invalid section index:", sectionIndex);
                            return;
                        }

                        const section = this.currentProgression.sections[sectionIndex];
                        const chords = section.chords || [];

                        if (chords.length === 0) {
                            console.warn("No chords in section");
                            return;
                        }

                        console.log("Playing section with", chords.length, "chords with voice leading");

                        // Reset voice leading state
                        this.voiceLeadingState = {
                            previousNotes: null,
                            currentVoicing: null
                        };

                        // Start audio context and wait for it to be ready
                        await Tone.start();
                        console.log("Audio context started for section playback");

                        // Apply voice leading to first chord
                        const voicedFirstChord = this.applyInitialVoiceLeading(chords[0]);

                        // CRITICAL: Play the first chord immediately
                        console.log("PLAYING FIRST CHORD IMMEDIATELY");
                        this.playVoicedChord(voicedFirstChord);

                        // Update UI for first chord
                        this.currentChordName = this.getChordDisplayName(chords[0]);
                        this.selectedChordIndices = { section: sectionIndex, chord: 0 };
                        this.currentSectionName = section.name || `Section ${sectionIndex + 1}`;

                        // Set playing state
                        this.isPlaying = true;
                        this.totalTime = chords.length * this.chordDuration;

                        // In the playSection method, replace the single-chord case:

                        if (chords.length > 1) {
                            // Multi-chord case (unchanged)
                            const remainingChords = chords.slice(1).map((chord, idx) => ({
                                chord: chord,
                                sectionIndex: sectionIndex,
                                chordIndex: idx + 1,
                                sectionName: section.name || `Section ${sectionIndex + 1}`
                            }));

                            this.scheduleRemainingChordsWithVoiceLeading(remainingChords);
                        } else {
                            // SINGLE CHORD CASE - EARLIER NUCLEAR CLEANUP
                            const cleanupDelay = this.chordDuration * 750; // 75% of chord duration in ms

                            console.log(`🧨 SINGLE CHORD: Nuclear cleanup will begin in ${cleanupDelay}ms`);

                            // If only one chord, use the nuclear option after 75% of chord duration
                            setTimeout(() => {
                                console.log("🧨 SINGLE CHORD: Nuclear cleanup beginning");

                                // Mark cleanup as in progress to prevent other operations
                                this.audioCleanupInProgress = true;

                                // First silence everything IMMEDIATELY
                                if (this.synth) {
                                    this.synth.volume.value = -Infinity;

                                    // Stop all active notes
                                    this.synth.releaseAll();

                                    // Cancel any scheduled events in Tone.js
                                    Tone.Transport.cancel();

                                    // Complete disposal of the synth immediately
                                    try {
                                        console.log("💥 Disposing synth after single chord");

                                        // Disconnect and dispose
                                        this.synth.disconnect();
                                        this.synth.dispose();
                                        this.synth = null;

                                        // Create a new minimal synth
                                        setTimeout(() => {
                                            try {
                                                console.log("🔧 Creating new synth");

                                                // Create a simple synth with minimal settings
                                                this.synth = new Tone.PolySynth(Tone.Synth, {
                                                    oscillator: { type: "triangle" },
                                                    envelope: {
                                                        attack: 0.03,
                                                        decay: 0.2,
                                                        sustain: 0.7,
                                                        release: 0.5
                                                    }
                                                }).toDestination();

                                                // Set volume to normal level
                                                this.synth.volume.value = Tone.gainToDb(this.volume || 0.7);

                                                console.log("✅ Single chord cleanup complete");
                                            } catch (e) {
                                                console.error("Error creating new synth:", e);
                                            } finally {
                                                // Always update UI and clear flags
                                                this.isPlaying = false;
                                                this.currentChordName = "";
                                                this.currentSectionName = "";
                                                this.selectedChordIndices = { section: null, chord: null };
                                                this.audioCleanupInProgress = false;
                                            }
                                        }, 50);
                                    } catch (e) {
                                        console.error("Error disposing synth:", e);
                                        // Make sure to reset flags even if there's an error
                                        this.isPlaying = false;
                                        this.audioCleanupInProgress = false;
                                    }
                                } else {
                                    // No synth to dispose
                                    this.isPlaying = false;
                                    this.audioCleanupInProgress = false;
                                    this.currentChordName = "";
                                    this.currentSectionName = "";
                                    this.selectedChordIndices = { section: null, chord: null };
                                }
                            }, cleanupDelay); // Start cleanup at 75% of chord duration
                        }
                    } catch (e) {
                        console.error("Error playing section:", e);
                        this.isPlaying = false;
                        this.stopPlayback();
                    }
                },

                startSectionSequence(validChords, sectionIndex) {
                    // Create the sequence with triggerAttackRelease for proper note duration
                    this.chordSequence = new Tone.Sequence((time, chord) => {
                        const optimizedNotes = this.optimizeChordNotes(chord.notes);
                        this.synth.triggerAttackRelease(optimizedNotes, this.chordDuration - 0.01, time);

                        // Update UI
                        this.currentChordName = this.getChordDisplayName(chord);
                        this.currentSectionName = chord.sectionName;
                        this.selectedChordIndices = {
                            section: chord.sectionIndex,
                            chord: chord.chordIndex
                        };
                        this.updateProgress();
                    }, validChords, this.chordDuration);

                    // Set tempo and start playback
                    Tone.Transport.bpm.value = this.tempo;
                    Tone.Transport.start("+0.1"); // Slight delay for stability
                    this.chordSequence.start(0);

                    this.isPlaying = true;
                    this.totalTime = validChords.length * this.chordDuration;
                },

                stopPlayback() {
                    try {
                        // Mark cleanup as in progress to prevent race conditions
                        this.audioCleanupInProgress = true;

                        // Clear any scheduled timers immediately
                        if (this.playbackTimer) {
                            clearTimeout(this.playbackTimer);
                            this.playbackTimer = null;
                        }

                        if (this.progressUpdateInterval) {
                            clearInterval(this.progressUpdateInterval);
                            this.progressUpdateInterval = null;
                        }

                        // Clear problematic chord safety timer
                        if (this.problematicChordTimer) {
                            clearTimeout(this.problematicChordTimer);
                            this.problematicChordTimer = null;
                        }

                        // Cancel all Tone.js scheduled events
                        if (Tone.Transport) {
                            Tone.Transport.stop();
                            Tone.Transport.cancel(0);
                        }

                        // IMPROVED: Three-step clean note release process
                        if (this.synth) {
                            // Step 1: Immediately silence the synth to stop any sound
                            const originalVolume = this.synth.volume.value;
                            this.synth.volume.value = -Infinity;

                            // Step 2: Release all notes with multiple methods for maximum reliability
                            this.synth.releaseAll();

                            // Step 3: Briefly disconnect from audio chain
                            try {
                                this.synth.disconnect();
                            } catch (disconnectErr) {
                                console.warn("Non-critical disconnect error:", disconnectErr);
                            }

                            // Reconnect and restore after a safe delay
                            setTimeout(() => {
                                try {
                                    // Reconnect if possible
                                    if (this.synth) {
                                        if (this.masterEQ) {
                                            try {
                                                this.synth.connect(this.masterEQ);
                                            } catch (reconnectErr) {
                                                console.warn("Reconnect to EQ failed, trying direct connection");
                                                this.synth.toDestination();
                                            }
                                        } else {
                                            this.synth.toDestination();
                                        }

                                        // Restore volume
                                        this.synth.volume.value = originalVolume;
                                    }
                                } catch (finalErr) {
                                    console.warn("Error in final audio restore:", finalErr);
                                    // Try emergency reset as last resort if reconnection fails
                                    this.tryRecreateBasicSynth();
                                } finally {
                                    // Always mark cleanup as complete
                                    this.audioCleanupInProgress = false;
                                }
                            }, 150); // Slightly longer delay (150ms) for more reliable cleanup
                        } else {
                            this.audioCleanupInProgress = false;
                        }

                        // Reset playback state
                        this.isPlaying = false;
                        this.currentChordName = "";
                        this.currentSectionName = "";
                        this.selectedChordIndices = { section: null, chord: null };
                        this.progressPercentage = 0;
                        this.elapsedTime = 0;
                    } catch (e) {
                        console.error("Error in stopPlayback:", e);
                        this.audioCleanupInProgress = false;

                        // Last resort emergency measure
                        this.tryRecreateBasicSynth();
                    }
                },

                // Simple function to recreate the synth as a last resort
                tryRecreateBasicSynth() {
                    try {
                        if (this.synth) {
                            try {
                                this.synth.dispose();
                            } catch (e) {
                                console.warn("Failed to dispose old synth");
                            }
                            this.synth = null;
                        }

                        // Create a minimal, basic synth
                        this.synth = new Tone.PolySynth(Tone.Synth, {
                            maxPolyphony: 16,
                            envelope: {
                                attack: 0.05,
                                decay: 0.1,
                                sustain: 0.7,
                                release: 0.3
                            }
                        }).toDestination();

                        this.synth.volume.value = -5;

                        console.log("Created basic fallback synth");
                    } catch (e) {
                        console.error("Failed to create fallback synth:", e);
                    }
                },

                /**
                 * Emergency audio reset for worst-case scenarios
                 */
                emergencyResetAudio() {
                    console.warn("Performing emergency audio reset");
                    if (Tone.context) {
                        try {
                            Tone.context.close().then(() => {
                                console.log("Audio context closed as emergency measure");
                                // Reinitialize on next user interaction
                                this.audioInitialized = false;
                                // Create overlay for user to re-initialize
                                this.createAudioEnableOverlay();
                            });
                        } catch (e2) {
                            console.error("Failed emergency audio stop:", e2);
                        }
                    }
                },

                /**
                 * Validates and ensures all chords in the progression are in audible range.
                 * Call this after loading a preset or initializing the app.
                 */
                validateProgressionNotes() {
                    if (!this.currentProgression || !this.currentProgression.sections) return;

                    console.log("Validating chord notes in progression...");

                    this.currentProgression.sections.forEach((section, sIndex) => {
                        if (!section.chords || !Array.isArray(section.chords)) return;

                        section.chords.forEach((chord, cIndex) => {
                            if (!chord || !chord.notes || !Array.isArray(chord.notes)) return;

                            // Check if any notes are outside audible range or duplicated
                            let hasLowNotes = chord.notes.some(note => {
                                if (typeof note !== 'string') return false;
                                const octave = parseInt(note.slice(-1));
                                return octave < 2;
                            });

                            let hasHighNotes = chord.notes.some(note => {
                                if (typeof note !== 'string') return false;
                                const octave = parseInt(note.slice(-1));
                                return octave > 6;
                            });

                            // If notes need adjustment, fix them
                            if (hasLowNotes || hasHighNotes) {
                                console.log(`Fixing notes in chord ${cIndex} of section ${sIndex}:`, chord.name);

                                // Adjust notes to be in audible range
                                chord.notes = chord.notes.map(note => {
                                    if (typeof note !== 'string') return 'C4';

                                    const name = note.slice(0, -1);
                                    const octave = parseInt(note.slice(-1));

                                    // Move very low notes up an octave
                                    if (octave < 2) {
                                        return name + '3';
                                    }
                                    // Move very high notes down an octave
                                    else if (octave > 6) {
                                        return name + '5';
                                    }
                                    return note;
                                });

                                console.log("Adjusted notes:", chord.notes);
                            }

                            // Ensure there are enough notes (at least 3)
                            if (chord.notes.length < 3) {
                                console.log(`Adding notes to chord ${cIndex} of section ${sIndex} - too few notes`);

                                // Add basic triad notes based on chord type
                                const intervals = this.getIntervalsForChordType(chord.type || 'major');
                                const additionalNotes = this.generateChordNotes(chord.root || 'C', intervals);

                                // Combine original and additional notes, removing duplicates
                                const allNotes = [...new Set([...chord.notes, ...additionalNotes])];
                                chord.notes = allNotes;

                                console.log("Enhanced notes:", chord.notes);
                            }
                        });
                    });

                    console.log("Validation complete");
                },


                restartPlayback() {
                    if (this.isPlaying) {
                        this.stopPlayback();
                        setTimeout(() => {
                            this.startPlayback();
                        }, 100);
                    } else {
                        this.startPlayback();
                    }
                },

                updateProgress() {
                    try {
                        // If we're playing an entire progression
                        if (this.chordSequence && this.chordSequence.events) {
                            // Find the current position
                            const allChords = this.chordSequence.events;
                            const currentIndex = allChords.findIndex(c =>
                                c.sectionIndex === this.selectedChordIndices.section &&
                                c.chordIndex === this.selectedChordIndices.chord
                            );

                            if (currentIndex !== -1) {
                                this.elapsedTime = currentIndex * this.chordDuration;
                                this.progressPercentage = (this.elapsedTime / this.totalTime) * 100;
                            }
                        }
                    } catch (e) {
                        console.error("Error updating progress:", e);
                    }
                },

                seekToPosition(event) {
                    if (!this.chordSequence || !this.isPlaying) return;

                    try {
                        const rect = event.target.getBoundingClientRect();
                        const x = event.clientX - rect.left;
                        const percentage = (x / rect.width) * 100;

                        // Calculate the time position
                        const timePosition = (percentage / 100) * this.totalTime;

                        // Calculate the chord index
                        const chordIndex = Math.floor(timePosition / this.chordDuration);

                        // Ensure we have a valid chord index
                        if (chordIndex >= 0 && this.chordSequence.events && chordIndex < this.chordSequence.events.length) {
                            // Stop current sequence
                            this.chordSequence.stop();

                            // Start from the new position
                            this.chordSequence.start(0, chordIndex);

                            // Update progress
                            this.progressPercentage = percentage;
                            this.elapsedTime = timePosition;
                        }
                    } catch (e) {
                        console.error("Error seeking to position:", e);
                    }
                },

                isChordPlaying(sectionIndex, chordIndex) {
                    try {
                        return this.isPlaying &&
                            this.selectedChordIndices &&
                            this.selectedChordIndices.section === sectionIndex &&
                            this.selectedChordIndices.chord === chordIndex;
                    } catch (e) {
                        return false;
                    }
                },

                changeInstrument() {
                    try {
                        // Track previous playing state
                        const wasPlaying = this.isPlaying;

                        // Stop any current playback
                        if (wasPlaying) {
                            this.stopPlayback();
                        }

                        // FIXED: Use a promise to ensure everything happens in the right order
                        const performChange = async () => {
                            try {
                                // Wait for any ongoing cleanup to complete
                                while (this.audioCleanupInProgress) {
                                    await new Promise(resolve => setTimeout(resolve, 50));
                                }

                                // Dispose of the old synth
                                if (this.synth) {
                                    this.synth.releaseAll();
                                    this.synth.disconnect();
                                    this.synth.dispose();
                                    this.synth = null;
                                }

                                // Clean up effects
                                if (this.instrumentEffects) {
                                    this.instrumentEffects.forEach(effect => {
                                        if (effect && typeof effect.dispose === 'function') {
                                            effect.disconnect();
                                            effect.dispose();
                                        }
                                    });
                                }
                                this.instrumentEffects = [];

                                // --- CUSTOM MOOG SETUP FOR SYNTH INSTRUMENT ---
                                if (this.instrument === "synth") {
                                    // Create a balanced Moog-style synth
                                    this.synth = new Tone.PolySynth(Tone.Synth, {
                                        maxPolyphony: 24,
                                        oscillator: {
                                            type: "sawtooth" // Classic Moog sawtooth
                                        },
                                        envelope: {
                                            attack: 0.05,  // Moderate attack
                                            decay: 0.2,
                                            sustain: 0.7,
                                            release: 0.6   // Good balance for chord transitions
                                        }
                                    });

                                    // Add a filter for Moog character
                                    const filter = new Tone.Filter({
                                        type: "lowpass",
                                        frequency: 2500,
                                        rolloff: -12,
                                        Q: 2
                                    });

                                    // Add subtle chorus for analog warmth
                                    const chorus = new Tone.Chorus({
                                        frequency: 1.5,
                                        delayTime: 3.5,
                                        depth: 0.3,
                                        spread: 180,
                                        wet: 0.2
                                    }).start();

                                    // Connect components
                                    this.synth.chain(filter, chorus);

                                    // Connect to master chain
                                    if (this.masterEQ) {
                                        chorus.connect(this.masterEQ);
                                    } else {
                                        chorus.toDestination();
                                    }

                                    // Store effects for later cleanup
                                    this.instrumentEffects = [filter, chorus];

                                    // Set volume
                                    this.synth.volume.value = -4;
                                } else {
                                    // Create a basic synth with appropriate envelope for other instruments
                                    this.synth = new Tone.PolySynth(Tone.Synth, {
                                        maxPolyphony: 512,
                                        oscillator: {
                                            type: this.getOscillatorTypeForInstrument()
                                        },
                                        envelope: {
                                            attack: this.getAttackForInstrument(),
                                            decay: 0.2,
                                            sustain: 0.7,
                                            release: 1.0
                                        },
                                        volume: this.getVolumeForInstrument()
                                    });

                                    // Connect to the master chain
                                    if (this.masterEQ) {
                                        this.synth.connect(this.masterEQ);
                                    } else {
                                        this.synth.toDestination();
                                    }
                                }

                                // Apply current volume setting
                                this.updateVolume();

                                // Restart playback if it was playing before
                                if (wasPlaying) {
                                    // Allow a moment for the new instrument to fully initialize
                                    await new Promise(resolve => setTimeout(resolve, 100));
                                    this.startPlayback();
                                }

                                console.log(`Changed instrument to ${this.instrument} with reliable settings`);
                            } catch (e) {
                                console.error("Error changing instrument:", e);
                                alert("There was an error changing the instrument. Please try again.");
                            }
                        };

                        // Execute the change process
                        performChange();
                    } catch (e) {
                        console.error("Error in changeInstrument:", e);
                    }
                },

                /**
                 * Helper methods for instrument configuration
                 */
                getOscillatorTypeForInstrument() {
                    switch (this.instrument) {
                        case "piano": return "triangle";
                        case "rhodes": return "sine";
                        case "synth": return "sawtooth"; // Keep sawtooth as base but we'll enhance it
                        case "warm-pad": return "sine";
                        case "vibraphone": return "sine";
                        case "marimba": return "sine";
                        default: return "triangle";
                    }
                },

                getAttackForInstrument() {
                    switch (this.instrument) {
                        case "piano": return 0.01;
                        case "rhodes": return 0.05;
                        case "synth": return 0.08; // Slightly slower attack for vintage Moog feel
                        case "warm-pad": return 0.5;
                        case "vibraphone": return 0.03;
                        case "marimba": return 0.005;
                        default: return 0.02;
                    }
                },

                getVolumeForInstrument() {
                    switch (this.instrument) {
                        case "piano": return -4;
                        case "rhodes": return -3;
                        case "synth": return -5; // Slightly louder for better presence
                        case "warm-pad": return -8;
                        case "vibraphone": return -2;
                        case "marimba": return 0; // Louder for percussion
                        default: return -4;
                    }
                },

                updateEffects() {
                    if (this.reverb_effect) {
                        this.reverb_effect.wet.value = this.reverb;
                    }
                },

                updateVolume() {
                    if (this.synth) {
                        this.synth.volume.value = Tone.gainToDb(this.volume);
                    }
                },

                updateTempo() {
                    Tone.Transport.bpm.value = this.tempo;
                },

                updateTotalTime() {
                    const totalChords = this.currentProgression.sections.reduce(
                        (sum, section) => sum + section.chords.length, 0
                    );
                    this.totalTime = totalChords * this.chordDuration;
                },

                // Import/Export Functions
                saveProgressionToFile() {
                    try {
                        // Prepare the data to save
                        const dataToSave = JSON.stringify(this.currentProgression, null, 2);

                        // Use FileSaver.js to save the file
                        const blob = new Blob([dataToSave], { type: "application/json" });
                        const filename = (this.currentProgression.name || "jazz-progression").replace(/\s+/g, '-').toLowerCase() + ".json";
                        saveAs(blob, filename);
                    } catch (error) {
                        console.error("Error saving progression:", error);
                        alert("Error saving progression: " + error.message);
                    }
                },

                openImportModal() {
                    this.importTab = 'file';
                    this.importJsonText = '';
                    this.importMessage = '';
                    this.showImportModal = true;
                },

                closeImportModal() {
                    this.showImportModal = false;
                },

                /**
                 * Handles file upload for importing progressions.
                 * @param {Event} event - The file upload event.
                 */
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) {
                        this.importMessage = "No file selected.";
                        return;
                    }

                    // Validate file type
                    if (file.type !== "application/json" && !file.name.endsWith('.json')) {
                        this.importMessage = "Invalid file type. Please select a JSON file.";
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const content = e.target.result;

                            // Basic validation for JSON format
                            try {
                                const progression = JSON.parse(content);

                                // Check for minimum required structure
                                if (!progression.sections || !Array.isArray(progression.sections)) {
                                    throw new Error("Invalid progression format: missing sections array");
                                }

                                this.importMessage = `File "${file.name}" loaded successfully. Click Import to apply.`;
                                this.importJsonText = content;

                                // Auto-import
                                this.importFromText();
                            } catch (parseError) {
                                throw new Error("Invalid JSON format: " + parseError.message);
                            }
                        } catch (error) {
                            console.error("Error processing file:", error);
                            this.importMessage = "Error loading file: " + error.message;
                        }
                    };

                    reader.onerror = () => {
                        this.importMessage = "Error reading file. Please try again.";
                    };

                    reader.readAsText(file);
                },

                /**
                 * Imports a progression from JSON text with enhanced validation and error handling.
                 */
                importFromText() {
                    try {
                        if (!this.importJsonText || this.importJsonText.trim() === '') {
                            this.importMessage = "Please enter JSON text to import.";
                            return;
                        }

                        let progression;
                        try {
                            progression = JSON.parse(this.importJsonText);
                        } catch (parseError) {
                            throw new Error("Invalid JSON format: " + parseError.message);
                        }

                        // Basic structure validation
                        if (!progression || typeof progression !== 'object') {
                            throw new Error("Invalid progression format: not an object");
                        }

                        if (!progression.sections || !Array.isArray(progression.sections)) {
                            throw new Error("Invalid progression format: missing sections array");
                        }

                        // Ensure name and description exist
                        progression.name = progression.name || "Imported Progression";
                        progression.description = progression.description || "";

                        // Validate sections structure and repair if possible
                        progression.sections = progression.sections.map((section, i) => {
                            // Ensure section has a name
                            if (!section.name) {
                                section.name = `Section ${String.fromCharCode(65 + i)}`; // A, B, C, etc.
                            }

                            // Ensure chords array exists
                            if (!section.chords || !Array.isArray(section.chords)) {
                                section.chords = [];
                            }

                            // Ensure collapsed property exists
                            section.collapsed = !!section.collapsed;

                            // Ensure annotation property exists
                            section.annotation = section.annotation || "";

                            // Validate each chord and attempt to repair
                            section.chords = section.chords.map((chord, j) => {
                                const validChord = { ...chord };

                                // Ensure minimal chord properties
                                if (!validChord.root) {
                                    console.warn(`Chord at index ${j} in section "${section.name}" missing root note. Using C.`);
                                    validChord.root = "C";
                                }

                                if (!validChord.type) {
                                    console.warn(`Chord at index ${j} in section "${section.name}" missing type. Using major.`);
                                    validChord.type = "major";
                                }

                                // Generate chord name if missing
                                if (!validChord.name) {
                                    validChord.name = this.getChordDisplayName(validChord);
                                }

                                // Generate notes if missing or invalid
                                if (!validChord.notes || !Array.isArray(validChord.notes) || validChord.notes.length === 0) {
                                    try {
                                        const intervals = this.getIntervalsForChordType(validChord.type);
                                        validChord.notes = this.generateChordNotes(validChord.root, intervals);
                                        console.log(`Generated notes for chord ${validChord.name}:`, validChord.notes);
                                    } catch (noteError) {
                                        console.error(`Could not generate notes for chord at index ${j}:`, noteError);
                                        validChord.notes = [`${validChord.root}3`, `${validChord.root}4`]; // Fallback
                                    }
                                }

                                // Ensure other properties are set
                                validChord.bass = validChord.bass || "";
                                validChord.annotation = validChord.annotation || "";
                                validChord.voicingStyle = validChord.voicingStyle || "close";
                                validChord.baseOctave = validChord.baseOctave || 3;
                                validChord.octaveSpan = validChord.octaveSpan || 2;
                                validChord.density = validChord.density || validChord.notes.length;

                                return validChord;
                            });

                            return section;
                        });

                        // Set the current progression to the imported one
                        this.currentProgression = progression;

                        // Initialize sortable for each section
                        setTimeout(() => {
                            this.currentProgression.sections.forEach((section, index) => {
                                this.initSectionSortable(index);
                            });
                        }, 100);

                        // Close the modal
                        this.closeImportModal();

                        // Update total time
                        this.updateTotalTime();

                        // Show success message
                        alert(`Successfully imported "${progression.name}" with ${progression.sections.length} sections.`);
                    } catch (error) {
                        console.error("Error importing progression:", error);
                        this.importMessage = "Error importing progression: " + error.message;
                    }
                },

                // Progression Management
                newProgression() {
                    if (confirm("Create a new progression? Any unsaved changes will be lost.")) {
                        this.currentProgression = {
                            name: "New Progression",
                            description: "",
                            sections: [{
                                name: "Section A",
                                chords: [],
                                collapsed: false,
                                annotation: ""
                            }]
                        };

                        // Initialize sortable
                        setTimeout(() => {
                            this.initSectionSortable(0);
                        }, 100);

                        // Update total time
                        this.updateTotalTime();
                    }
                },

                editProgressionName() {
                    this.editingProgressionName = this.currentProgression.name;
                    this.editingProgressionDescription = this.currentProgression.description;
                    this.showNameEditModal = true;
                },

                cancelNameEdit() {
                    this.showNameEditModal = false;
                },

                saveProgressionName() {
                    this.currentProgression.name = this.editingProgressionName;
                    this.currentProgression.description = this.editingProgressionDescription;
                    this.showNameEditModal = false;
                },

                // Annotation Management
                addAnnotationToSection(sectionIndex) {
                    this.annotationModalTitle = "Add Section Annotation";
                    this.editingAnnotation = this.currentProgression.sections[sectionIndex].annotation || "";
                    this.annotationTarget = { type: 'section', sectionIndex, chordIndex: null };
                    this.showAnnotationModal = true;
                },

                editSectionAnnotation(sectionIndex) {
                    this.annotationModalTitle = "Edit Section Annotation";
                    this.editingAnnotation = this.currentProgression.sections[sectionIndex].annotation || "";
                    this.annotationTarget = { type: 'section', sectionIndex, chordIndex: null };
                    this.showAnnotationModal = true;
                },

                addChordAnnotation(sectionIndex, chordIndex) {
                    this.annotationModalTitle = "Add Chord Annotation";
                    this.editingAnnotation = this.currentProgression.sections[sectionIndex].chords[chordIndex].annotation || "";
                    this.annotationTarget = { type: 'chord', sectionIndex, chordIndex };
                    this.showAnnotationModal = true;
                },

                editChordAnnotation(sectionIndex, chordIndex) {
                    this.annotationModalTitle = "Edit Chord Annotation";
                    this.editingAnnotation = this.currentProgression.sections[sectionIndex].chords[chordIndex].annotation || "";
                    this.annotationTarget = { type: 'chord', sectionIndex, chordIndex };
                    this.showAnnotationModal = true;
                },

                cancelAnnotation() {
                    this.showAnnotationModal = false;
                },

                saveAnnotation() {
                    if (this.annotationTarget.type === 'section') {
                        this.currentProgression.sections[this.annotationTarget.sectionIndex].annotation = this.editingAnnotation;
                    } else if (this.annotationTarget.type === 'chord') {
                        this.currentProgression.sections[this.annotationTarget.sectionIndex]
                            .chords[this.annotationTarget.chordIndex].annotation = this.editingAnnotation;
                    }

                    this.showAnnotationModal = false;
                },

                // Chord Management Functions
                duplicateChord(sectionIndex, chordIndex) {
                    // Create a deep copy of the chord
                    const chordCopy = JSON.parse(
                        JSON.stringify(this.currentProgression.sections[sectionIndex].chords[chordIndex])
                    );

                    // Insert after the original
                    this.currentProgression.sections[sectionIndex].chords.splice(chordIndex + 1, 0, chordCopy);
                },

                moveChordLeft(sectionIndex, chordIndex) {
                    if (chordIndex > 0) {
                        const chords = [...this.currentProgression.sections[sectionIndex].chords];
                        const temp = chords[chordIndex];
                        chords[chordIndex] = chords[chordIndex - 1];
                        chords[chordIndex - 1] = temp;
                        this.currentProgression.sections[sectionIndex].chords = chords;
                    }
                },

                moveChordRight(sectionIndex, chordIndex) {
                    if (chordIndex < this.currentProgression.sections[sectionIndex].chords.length - 1) {
                        const chords = [...this.currentProgression.sections[sectionIndex].chords];
                        const temp = chords[chordIndex];
                        chords[chordIndex] = chords[chordIndex + 1];
                        chords[chordIndex + 1] = temp;
                        this.currentProgression.sections[sectionIndex].chords = chords;
                    }
                },

                deleteChord(sectionIndex, chordIndex) {
                    this.currentProgression.sections[sectionIndex].chords.splice(chordIndex, 1);
                },

                // Other utility functions
                formatTime(seconds) {
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}:${secs.toString().padStart(2, '0')}`;
                },

                copyCurrentProgressionAsText() {
                    // Create a text representation of the progression
                    let text = `${this.currentProgression.name}\n`;
                    if (this.currentProgression.description) {
                        text += `${this.currentProgression.description}\n`;
                    }
                    text += '\n';

                    this.currentProgression.sections.forEach(section => {
                        text += `=== ${section.name} ===\n`;
                        if (section.annotation) {
                            text += `${section.annotation}\n`;
                        }
                        text += '\n';

                        section.chords.forEach(chord => {
                            text += `${this.getChordDisplayName(chord)}  `;
                            if (chord.annotation) {
                                text += `(${chord.annotation})`;
                            }
                            text += '\n';
                        });

                        text += '\n';
                    });

                    // Copy to clipboard
                    navigator.clipboard.writeText(text).then(() => {
                        alert("Progression copied to clipboard as text!");
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                        alert("Failed to copy to clipboard: " + err.message);
                    });
                },

                openSettingsModal() {
                    this.showSettingsModal = true;
                },

                closeSettingsModal() {
                    this.showSettingsModal = false;
                    this.updateEffects();
                },

                openHelpModal() {
                    this.helpTab = 'basics';
                    this.showHelpModal = true;
                },

                // Preset Management
                openPresetsModal() {
                    // Initialize the featured preset preview
                    this.updateFeaturedPresetPreview('gemma3');
                    this.showPresetsModal = true;
                },

                closePresetsModal() {
                    this.showPresetsModal = false;
                },

                updateFeaturedPresetPreview(presetId) {
                    // Update the featured preset info
                    this.featuredPreset.id = presetId;

                    const presetData = this.presets[presetId];
                    if (presetData) {
                        this.featuredPreset.name = presetData.name;
                        this.featuredPreset.description = presetData.description;
                    }

                    // Generate preview data for table
                    if (presetId === 'gemma3') {
                        this.featuredPreset.preview = [
                            { bar: 1, name: 'Cmaj9(#11)', notes: 'Lush, ambiguous start with #11' },
                            { bar: 2, name: 'F#m7b5(b9)', notes: 'Altered dominant resolving deceptively' },
                            { bar: 3, name: 'B7alt', notes: 'Highly altered dominant' },
                            { bar: 4, name: 'Em7/B', notes: 'E minor 7th over a B bass' },
                            { bar: '...', name: '...', notes: '...' },
                            { bar: 16, name: 'Cmaj7', notes: 'Simple Cmaj7 to ground the progression' }
                        ];
                    } else if (presetId === 'chatgpt45') {
                        this.featuredPreset.preview = [
                            { bar: 1, name: 'F#m9(maj7)/C#', notes: 'Dark, modal minor color (melodic minor)' },
                            { bar: 2, name: 'C13(b9)/E', notes: 'Altered dominant (Phrygian dominant)' },
                            { bar: 3, name: 'Bbmaj13(#11)', notes: 'Lydian color creating brightness' },
                            { bar: 4, name: 'A7alt', notes: 'Fully altered dominant (super Locrian)' },
                            { bar: '...', name: '...', notes: '...' },
                            { bar: 16, name: 'Gm11b5/C', notes: 'Ambiguous minor dominant suspended hybrid' }
                        ];
                    } else if (presetId === 'claude37') {
                        this.featuredPreset.preview = [
                            { bar: 'A1', name: 'Ebmaj7(#11)/G', notes: 'Upper-structure triads over unexpected bass' },
                            { bar: 'A2', name: 'G7(b9,#11)', notes: 'Creates tension with altered extensions' },
                            { bar: 'A3', name: 'Cmaj7(b5)/Bb', notes: 'Unusual bass note creates instability' },
                            { bar: 'B1', name: 'Dmaj9(#11)', notes: 'Start of chromatic metamorphosis' },
                            { bar: '...', name: '...', notes: '...' },
                            { bar: 'T4', name: 'Am11(b5)/E', notes: 'Sophisticated harmonic conclusion' }
                        ];
                    }
                },

                previewPreset(event, presetId) {
                    // If you already use Alpine’s @click.stop, you can omit the next line.
                    // event.stopPropagation();
                    // First update the featured preset preview.
                    this.updateFeaturedPresetPreview(presetId);
                    // Then play a representative chord from the preset.
                    const presetData = this.presets[presetId];
                    if (
                        presetData &&
                        presetData.sections &&
                        presetData.sections.length > 0 &&
                        presetData.sections[0].chords &&
                        presetData.sections[0].chords.length > 0
                    ) {
                        // Deep copy to avoid reference issues.
                        const sampleChord = JSON.parse(JSON.stringify(presetData.sections[0].chords[0]));
                        if (sampleChord.notes && Array.isArray(sampleChord.notes) && sampleChord.notes.length > 0) {
                            this.playChord(sampleChord);
                        }
                    }
                },

                /**
                 * Loads a preset progression with improved error handling and audio initialization.
                 * @param {string} presetId - The ID of the preset to load.
                 */
                loadPreset(presetId) {
                    try {
                        const hasExistingChords = this.currentProgression.sections.some(section =>
                            section.chords && Array.isArray(section.chords) && section.chords.length > 0
                        );
                        if (hasExistingChords && !confirm("This will replace your current progression. Continue?")) {
                            return;
                        }
                        if (this.isPlaying) this.stopPlayback();
                        const presetData = JSON.parse(JSON.stringify(this.presets[presetId]));
                        presetData.sections.forEach(section => {
                            section.chords = section.chords.map(chord => {
                                const validChord = { ...chord };
                                validChord.root = validChord.root || "C";
                                validChord.type = validChord.type || "major";
                                validChord.name = validChord.name || this.getChordDisplayName(validChord);
                                validChord.notes = (validChord.notes && Array.isArray(validChord.notes) && validChord.notes.length > 0) ?
                                    validChord.notes.filter(note => /^[A-G][#b]?\d$/.test(note)) :
                                    this.generateChordNotes(validChord.root, this.getIntervalsForChordType(validChord.type));
                                validChord.bass = validChord.bass || "";
                                validChord.annotation = validChord.annotation || "";
                                validChord.voicingStyle = validChord.voicingStyle || "close";
                                validChord.baseOctave = validChord.baseOctave || 3;
                                validChord.octaveSpan = validChord.octaveSpan || 2;
                                validChord.density = validChord.density || validChord.notes.length;
                                return validChord;
                            });
                        });
                        this.currentProgression = presetData;
                        setTimeout(() => {
                            this.currentProgression.sections.forEach((section, index) => {
                                this.initSectionSortable(index);
                            });
                        }, 100);
                        this.closePresetsModal();
                        this.featuredPreset.id = presetId;
                        this.featuredPreset.name = presetData.name || "Unnamed Preset";
                        this.featuredPreset.description = presetData.description || "";
                        this.updateTotalTime();
                        Tone.start().then(() => {
                            console.log("Audio context started for preset playback");
                            this.startPlayback();
                        }).catch(e => {
                            console.error("Failed to start audio for preset playback:", e);
                            alert("Click anywhere on the page to enable audio, then try playing again.");
                        });
                    } catch (e) {
                        console.error("Error loading preset:", e);
                        alert("There was an error loading the preset. Please try again.");
                    }
                },

                // Preset Data
                presets: {
                    // Preset 1: Gemma 3
                    'gemma3': {
                        name: "Sophisticated Jazz Progression (Gemma 3)",
                        description: "A 16-bar progression featuring polychords, altered dominants, and non-functional harmony",
                        sections: [
                            {
                                name: "16-Bar Progression",
                                chords: [
                                    {
                                        name: "Cmaj9(#11)",
                                        root: "C",
                                        type: "maj9",
                                        bass: "",
                                        notes: ['C3', 'E3', 'G3', 'B3', 'D4', 'F#4'],
                                        s11: true,
                                        annotation: "Lush, ambiguous start. The #11 adds a modern flavor."
                                    },
                                    {
                                        name: "F#m7b5(b9)",
                                        root: "F#",
                                        type: "m7b5",
                                        bass: "",
                                        notes: ['F#3', 'A3', 'C4', 'E4', 'G4'],
                                        b9: true,
                                        annotation: "Altered dominant resolving deceptively. Creates tension."
                                    },
                                    {
                                        name: "B7alt",
                                        root: "B",
                                        type: "alt",
                                        bass: "",
                                        notes: ['B2', 'D#3', 'F#3', 'A3', 'C4', 'E4', 'G4'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: "Highly altered dominant. Expect a surprising resolution."
                                    },
                                    {
                                        name: "Em7/B",
                                        root: "E",
                                        type: "m7",
                                        bass: "B",
                                        notes: ['B2', 'E3', 'G3', 'D4', 'F#4', 'A4', 'C5'],
                                        annotation: "E minor 7th over a B bass. Smooth voice leading from the B7alt."
                                    },
                                    {
                                        name: "Am7/C",
                                        root: "A",
                                        type: "m7",
                                        bass: "C",
                                        notes: ['C3', 'E3', 'G3', 'B3', 'D4', 'F4', 'A4'],
                                        annotation: "A minor 7th over a C bass. Creates a modal feel."
                                    },
                                    {
                                        name: "D7(b9,#9,#11)",
                                        root: "D",
                                        type: "7",
                                        bass: "",
                                        notes: ['D3', 'F#3', 'A3', 'C4', 'E#4', 'G#4', 'B#4'],
                                        b9: true,
                                        s9: true,
                                        s11: true,
                                        annotation: "Extremely altered dominant. Maximum tension."
                                    },
                                    {
                                        name: "Gm7/B",
                                        root: "G",
                                        type: "m7",
                                        bass: "B",
                                        notes: ['B2', 'D3', 'F3', 'A3', 'C4', 'E4', 'G4'],
                                        annotation: "G minor 7th over a B bass. Unexpected harmonic shift."
                                    },
                                    {
                                        name: "Cmaj7(#11)",
                                        root: "C",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['C3', 'E3', 'G3', 'B3', 'D#4', 'F#4', 'A#4'],
                                        s11: true,
                                        annotation: "Return to the opening chord, but with a different feel after the journey."
                                    },
                                    {
                                        name: "F#m7b5(b9)/A",
                                        root: "F#",
                                        type: "m7b5",
                                        bass: "A",
                                        notes: ['A2', 'C3', 'E3', 'G3', 'B3', 'D4', 'F4'],
                                        b9: true,
                                        annotation: "F#m7b5(b9) over an A bass. Adds a layer of complexity."
                                    },
                                    {
                                        name: "B7sus4(b9)",
                                        root: "B",
                                        type: "7sus4",
                                        bass: "",
                                        notes: ['B2', 'E3', 'F#3', 'A3', 'C4', 'D4', 'G4'],
                                        b9: true,
                                        annotation: "Suspended dominant with alterations. Prolongs the tension."
                                    },
                                    {
                                        name: "Em7/B",
                                        root: "E",
                                        type: "m7",
                                        bass: "B",
                                        notes: ['B2', 'E3', 'G3', 'D4', 'F#4', 'A4', 'C5'],
                                        annotation: "Return to the Em7/B, creating a cyclical feel."
                                    },
                                    {
                                        name: "Am7/C",
                                        root: "A",
                                        type: "m7",
                                        bass: "C",
                                        notes: ['C3', 'E3', 'G3', 'B3', 'D4', 'F4', 'A4'],
                                        annotation: "Return to the Am7/C, reinforcing the modal quality."
                                    },
                                    {
                                        name: "D7(b9,#9,#11)",
                                        root: "D",
                                        type: "7",
                                        bass: "",
                                        notes: ['D3', 'F#3', 'A3', 'C4', 'E#4', 'G#4', 'B#4'],
                                        b9: true,
                                        s9: true,
                                        s11: true,
                                        annotation: "Another highly altered dominant, building towards the climax."
                                    },
                                    {
                                        name: "Gm7/B",
                                        root: "G",
                                        type: "m7",
                                        bass: "B",
                                        notes: ['B2', 'D3', 'F3', 'A3', 'C4', 'E4', 'G4'],
                                        annotation: "Gm7/B again, creating a sense of inevitability."
                                    },
                                    {
                                        name: "Cmaj9(#11)",
                                        root: "C",
                                        type: "maj9",
                                        bass: "",
                                        notes: ['C3', 'E3', 'G3', 'B3', 'D4', 'F#4'],
                                        s11: true,
                                        annotation: "Return to the opening chord, but now with a sense of resolution."
                                    },
                                    {
                                        name: "Cmaj7",
                                        root: "C",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['C3', 'E3', 'G3', 'B3'],
                                        annotation: "Simple Cmaj7 to ground the progression."
                                    }
                                ],
                                collapsed: false,
                                annotation: "This progression uses polychords, slash chords, altered dominants and modal interchange to create a sophisticated harmonic palette."
                            }
                        ]
                    },

                    // Preset 2: ChatGPT 4.5
                    'chatgpt45': {
                        name: "Intricate Jazz Progression (ChatGPT 4.5)",
                        description: "A 16-bar progression with modal interchange, bitonal chords, and altered dominants",
                        sections: [
                            {
                                name: "16-Bar Progression",
                                chords: [
                                    {
                                        name: "F#m9(maj7)/C#",
                                        root: "F#",
                                        type: "m9",
                                        bass: "C#",
                                        notes: ['C#2', 'F#3', 'A3', 'E4', 'G#4', 'C#5'],
                                        annotation: "Dark, modal minor color (melodic minor), inverted for tension."
                                    },
                                    {
                                        name: "C13(b9)/E",
                                        root: "C",
                                        type: "13",
                                        bass: "E",
                                        notes: ['E2', 'C3', 'E3', 'G3', 'Bb3', 'D4', 'A4', 'Db4'],
                                        b9: true,
                                        annotation: "Altered dominant (Phrygian dominant); first-inversion voicing."
                                    },
                                    {
                                        name: "Bbmaj13(#11)",
                                        root: "Bb",
                                        type: "maj13",
                                        bass: "",
                                        notes: ['Bb2', 'D3', 'F3', 'A3', 'D4', 'E4', 'G4'],
                                        s11: true,
                                        annotation: "Lydian color creating brightness and openness."
                                    },
                                    {
                                        name: "A7alt",
                                        root: "A",
                                        type: "alt",
                                        bass: "",
                                        notes: ['A2', 'C#3', 'Eb3', 'G3', 'Bb3', 'D#4'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: "Fully altered dominant (super Locrian) for tense resolution."
                                    },
                                    {
                                        name: "Dm11/C",
                                        root: "D",
                                        type: "m11",
                                        bass: "C",
                                        notes: ['C2', 'D3', 'F3', 'A3', 'C4', 'G4'],
                                        annotation: "Modal Dorian minor with pedal bass for suspense."
                                    },
                                    {
                                        name: "G13sus4(b9)",
                                        root: "G",
                                        type: "13sus4",
                                        bass: "",
                                        notes: ['G2', 'C3', 'D3', 'F3', 'Ab3', 'E4'],
                                        b9: true,
                                        annotation: "Suspended altered dominant, hybrid phrygian/modal sound."
                                    },
                                    {
                                        name: "Abmaj7(#5)",
                                        root: "Ab",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['Ab2', 'C3', 'E3', 'G3'],
                                        s5: true,
                                        annotation: "Lydian Augmented sound creating dreamy, floating quality."
                                    },
                                    {
                                        name: "Gb13(#11)/B",
                                        root: "Gb",
                                        type: "13",
                                        bass: "B",
                                        notes: ['B2', 'Gb3', 'Bb3', 'Db3', 'F3', 'Ab3', 'C4'],
                                        s11: true,
                                        annotation: "Tritone-related dominant, polytonal feel due to bass note."
                                    },
                                    {
                                        name: "Emaj9(#11)/F",
                                        root: "E",
                                        type: "maj9",
                                        bass: "F",
                                        notes: ['F2', 'E3', 'G#3', 'B3', 'D#4', 'F#4', 'A#4'],
                                        s11: true,
                                        annotation: "Bitonal chord voicing; an E Lydian sound over unrelated bass."
                                    },
                                    {
                                        name: "Ebm9/Gb",
                                        root: "Eb",
                                        type: "m9",
                                        bass: "Gb",
                                        notes: ['Gb2', 'Eb3', 'Gb3', 'Bb3', 'Db4', 'F4'],
                                        annotation: "Rich minor coloration (Aeolian), third inversion adds ambiguity."
                                    },
                                    {
                                        name: "Db13sus2/F",
                                        root: "Db",
                                        type: "13",
                                        bass: "F",
                                        notes: ['F2', 'Db3', 'Eb3', 'Ab3', 'B3', 'F4', 'Bb4'],
                                        annotation: "Modern suspended chord with subtle cluster voicing."
                                    },
                                    {
                                        name: "Cmaj9/E",
                                        root: "C",
                                        type: "maj9",
                                        bass: "E",
                                        notes: ['E2', 'C3', 'E3', 'G3', 'B3', 'D4'],
                                        annotation: "Smooth pivot, major chord in first inversion for clarity."
                                    },
                                    {
                                        name: "Bbm6/9",
                                        root: "Bb",
                                        type: "m6",
                                        bass: "",
                                        notes: ['Bb2', 'Db3', 'F3', 'G3', 'C4'],
                                        annotation: "Darker minor voicing (Dorian minor), sophisticated flavor."
                                    },
                                    {
                                        name: "Eb7(#9#5)",
                                        root: "Eb",
                                        type: "7",
                                        bass: "",
                                        notes: ['Eb3', 'G3', 'B3', 'Db4', 'F#4'],
                                        s9: true,
                                        s5: true,
                                        annotation: "Highly altered dominant chord, strongly dissonant tension."
                                    },
                                    {
                                        name: "Abmaj7sus2(#11)",
                                        root: "Ab",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['Ab2', 'Bb2', 'Eb3', 'G3', 'D4'],
                                        s11: true,
                                        annotation: "Dreamy modal voicing, expansive open harmony."
                                    },
                                    {
                                        name: "Gm11b5/C",
                                        root: "G",
                                        type: "m11",
                                        bass: "C",
                                        notes: ['C2', 'G3', 'Db3', 'F3', 'Bb3', 'D4'],
                                        b5: true,
                                        annotation: "Ambiguous minor dominant suspended hybrid; floating suspension."
                                    }
                                ],
                                collapsed: false,
                                annotation: "This progression uses strategic inversions, bitonality, modal borrowing, and altered tones for an unconventional yet highly musical narrative."
                            }
                        ]
                    },

                    // Preset 3: Claude 3.7 Sonnet
                    'claude37': {
                        name: "Sophisticated Jazz Progression (Claude 3.7 Sonnet)",
                        description: "A multi-section progression with polytonal concepts and upper structure triads",
                        sections: [
                            {
                                name: "Section A - Ethereal Opening",
                                chords: [
                                    {
                                        name: "Ebmaj7(#11)/G",
                                        root: "Eb",
                                        type: "maj7",
                                        bass: "G",
                                        notes: ['G2', 'Eb3', 'G3', 'Bb3', 'D4', 'A4'],
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "G7(b9,#11)",
                                        root: "G",
                                        type: "7",
                                        bass: "",
                                        notes: ['G2', 'F3', 'Ab3', 'B3', 'D4', 'Eb4'],
                                        b9: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Cmaj7(b5)/Bb",
                                        root: "C",
                                        type: "maj7",
                                        bass: "Bb",
                                        notes: ['Bb2', 'C3', 'E3', 'Gb3', 'B3', 'E4'],
                                        b5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Abmaj9(#11)",
                                        root: "Ab",
                                        type: "maj9",
                                        bass: "",
                                        notes: ['Ab2', 'C3', 'Eb3', 'G3', 'Bb3', 'D4'],
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "F13(b9)",
                                        root: "F",
                                        type: "13",
                                        bass: "",
                                        notes: ['F2', 'Eb3', 'A3', 'C4', 'D4', 'Gb4'],
                                        b9: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "E7alt/Bb",
                                        root: "E",
                                        type: "alt",
                                        bass: "Bb",
                                        notes: ['Bb2', 'E3', 'G#3', 'D4', 'F#4', 'Bb4'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Amaj7(#9)/D",
                                        root: "A",
                                        type: "maj7",
                                        bass: "D",
                                        notes: ['D2', 'A3', 'C#3', 'E3', 'G#3', 'B#3'],
                                        s9: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Dbmaj7(#5,#11)",
                                        root: "Db",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['Db3', 'F3', 'A3', 'C4', 'G4'],
                                        s5: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Gmaj7(b13)/C",
                                        root: "G",
                                        type: "maj7",
                                        bass: "C",
                                        notes: ['C2', 'G3', 'B3', 'D4', 'F#4', 'Eb4'],
                                        b13: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "C7(#9,b13)",
                                        root: "C",
                                        type: "7",
                                        bass: "",
                                        notes: ['C3', 'E3', 'Bb3', 'D#4', 'Ab4'],
                                        s9: true,
                                        b13: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "F#m11(b5)",
                                        root: "F#",
                                        type: "m11",
                                        bass: "",
                                        notes: ['F#2', 'A3', 'C#4', 'E4', 'B4'],
                                        b5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "B7alt(add maj7)",
                                        root: "B",
                                        type: "alt",
                                        bass: "",
                                        notes: ['B2', 'A#3', 'D#4', 'F4', 'Ab4', 'C5'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: ""
                                    }
                                ],
                                collapsed: false,
                                annotation: "Section A creates tension through upper-structure triads over unexpected bass notes and unresolved dissonance. The progression uses quartal harmony and borrowed chords that defy traditional resolution."
                            },
                            {
                                name: "Section B - Chromatic Metamorphosis",
                                chords: [
                                    {
                                        name: "Dmaj9(#11)",
                                        root: "D",
                                        type: "maj9",
                                        bass: "",
                                        notes: ['D2', 'F#3', 'A3', 'C#4', 'E4', 'G#4'],
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "D#dim7(add13)",
                                        root: "D#",
                                        type: "dim7",
                                        bass: "",
                                        notes: ['D#2', 'F#3', 'A3', 'C4', 'B4'],
                                        annotation: ""
                                    },
                                    {
                                        name: "Ebmaj13/F",
                                        root: "Eb",
                                        type: "maj13",
                                        bass: "F",
                                        notes: ['F2', 'Eb3', 'G3', 'Bb3', 'D4', 'C5'],
                                        annotation: ""
                                    },
                                    {
                                        name: "F#7sus4(b9)/A",
                                        root: "F#",
                                        type: "7sus4",
                                        bass: "A",
                                        notes: ['A2', 'F#3', 'B3', 'E4', 'G4'],
                                        b9: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Bbmaj7(#5)/D",
                                        root: "Bb",
                                        type: "maj7",
                                        bass: "D",
                                        notes: ['D2', 'Bb3', 'D3', 'F3', 'A3'],
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "D7(#9,#11,b13)",
                                        root: "D",
                                        type: "7",
                                        bass: "",
                                        notes: ['D2', 'F#3', 'C4', 'F4', 'Ab4', 'B4'],
                                        s9: true,
                                        s11: true,
                                        b13: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "G-6/9(#11)",
                                        root: "G",
                                        type: "6",
                                        bass: "",
                                        notes: ['G2', 'Bb3', 'D3', 'Eb3', 'A3', 'C#4'],
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "C#7alt(add maj7)",
                                        root: "C#",
                                        type: "alt",
                                        bass: "",
                                        notes: ['C#3', 'C3', 'E3', 'G3', 'Bb3', 'D#4'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Fmaj7(#9,#11)/A",
                                        root: "F",
                                        type: "maj7",
                                        bass: "A",
                                        notes: ['A2', 'F3', 'A3', 'C4', 'E4', 'G#4', 'B4'],
                                        s9: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Ab13(#11,b9)",
                                        root: "Ab",
                                        type: "13",
                                        bass: "",
                                        notes: ['Ab2', 'G3', 'C4', 'Eb4', 'Gb4', 'D4'],
                                        s11: true,
                                        b9: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Dbmaj9(add6)/F",
                                        root: "Db",
                                        type: "maj9",
                                        bass: "F",
                                        notes: ['F2', 'Db3', 'F3', 'Ab3', 'C4', 'Eb4', 'Bb4'],
                                        annotation: ""
                                    },
                                    {
                                        name: "Bm11(b5)/F#",
                                        root: "B",
                                        type: "m11",
                                        bass: "F#",
                                        notes: ['F#2', 'B3', 'D4', 'F4', 'A4', 'E5'],
                                        b5: true,
                                        annotation: ""
                                    }
                                ],
                                collapsed: false,
                                annotation: "Section B explores chromatic movement with unconventional voice leading. The progression uses polychords and applies the concept of constant structure through chromatic shifts."
                            },
                            {
                                name: "Section C - Polytonal Resolution",
                                chords: [
                                    {
                                        name: "E7sus4(b9,13)/A",
                                        root: "E",
                                        type: "7sus4",
                                        bass: "A",
                                        notes: ['A2', 'E3', 'A3', 'B3', 'D4', 'F4', 'C5'],
                                        b9: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "A7(#9,#5)/D",
                                        root: "A",
                                        type: "7",
                                        bass: "D",
                                        notes: ['D2', 'A3', 'C#4', 'E4', 'G4', 'B#4'],
                                        s9: true,
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Dmaj9(b5)/G",
                                        root: "D",
                                        type: "maj9",
                                        bass: "G",
                                        notes: ['G2', 'D3', 'F#3', 'Ab3', 'C#4', 'E4'],
                                        b5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Gb13(#11)",
                                        root: "Gb",
                                        type: "13",
                                        bass: "",
                                        notes: ['Gb2', 'Bb3', 'Db4', 'Fb4', 'B4', 'Eb5'],
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Cmaj7(#9,#11)/E",
                                        root: "C",
                                        type: "maj7",
                                        bass: "E",
                                        notes: ['E2', 'C3', 'E3', 'G3', 'B3', 'D#4', 'F#4'],
                                        s9: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "E7alt(add4)",
                                        root: "E",
                                        type: "alt",
                                        bass: "",
                                        notes: ['E2', 'G#3', 'D4', 'F4', 'Ab4', 'A4'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Am11(maj7)/D",
                                        root: "A",
                                        type: "m11",
                                        bass: "D",
                                        notes: ['D2', 'A3', 'C4', 'E4', 'G4', 'G#4'],
                                        annotation: ""
                                    },
                                    {
                                        name: "D13(b9,#11)",
                                        root: "D",
                                        type: "13",
                                        bass: "",
                                        notes: ['D2', 'F#3', 'C4', 'Eb4', 'G#4', 'B4'],
                                        b9: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Gmaj13(#11)/B",
                                        root: "G",
                                        type: "maj13",
                                        bass: "B",
                                        notes: ['B2', 'G3', 'B3', 'D4', 'F#4', 'A4', 'C#5'],
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "B7(b9,b5,add11)",
                                        root: "B",
                                        type: "7",
                                        bass: "",
                                        notes: ['B2', 'D#3', 'A3', 'C3', 'E4', 'F4'],
                                        b9: true,
                                        b5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Em9(maj7)",
                                        root: "E",
                                        type: "m9",
                                        bass: "",
                                        notes: ['E3', 'G3', 'B3', 'D#4', 'F#4'],
                                        annotation: ""
                                    },
                                    {
                                        name: "Abmaj7(#9,#5)",
                                        root: "Ab",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['Ab2', 'C3', 'Eb3', 'G3', 'B3', 'C5'],
                                        s9: true,
                                        s5: true,
                                        annotation: ""
                                    }
                                ],
                                collapsed: false,
                                annotation: "Section C employs polytonal concepts with upper structure triads against pedal points, creating harmonic ambiguity. The progression concludes with deceptive resolution."
                            },
                            {
                                name: "Extended Turnaround",
                                chords: [
                                    {
                                        name: "Fmaj9(#5)/A",
                                        root: "F",
                                        type: "maj9",
                                        bass: "A",
                                        notes: ['A2', 'F3', 'A3', 'C4', 'E4', 'G4', 'C#5'],
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "F#7(b9,#11)/A#",
                                        root: "F#",
                                        type: "7",
                                        bass: "A#",
                                        notes: ['A#2', 'F#3', 'A#3', 'C#4', 'E4', 'G4', 'C5'],
                                        b9: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Bmaj13(b5)",
                                        root: "B",
                                        type: "maj13",
                                        bass: "",
                                        notes: ['B2', 'D#3', 'F4', 'A#4', 'C#5', 'G#5'],
                                        b5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "E7alt(add maj7)",
                                        root: "E",
                                        type: "alt",
                                        bass: "",
                                        notes: ['E2', 'D#3', 'G#3', 'Bb3', 'D4', 'G4'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Amaj9(#11)/C#",
                                        root: "A",
                                        type: "maj9",
                                        bass: "C#",
                                        notes: ['C#2', 'A3', 'C#4', 'E4', 'G#4', 'B4', 'D#5'],
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "D13(b9,#11)/F#",
                                        root: "D",
                                        type: "13",
                                        bass: "F#",
                                        notes: ['F#2', 'D3', 'F#3', 'A3', 'C4', 'Eb4', 'G#4'],
                                        b9: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "G7sus4(b13,9)",
                                        root: "G",
                                        type: "7sus4",
                                        bass: "",
                                        notes: ['G2', 'D3', 'F3', 'A3', 'C4', 'Eb4'],
                                        b13: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "C#7alt",
                                        root: "C#",
                                        type: "alt",
                                        bass: "",
                                        notes: ['C#3', 'F3', 'G3', 'B3', 'E4'],
                                        b9: true,
                                        s9: true,
                                        b5: true,
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Fmaj7(#9,#11,13)",
                                        root: "F",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['F2', 'A3', 'C4', 'E4', 'G#4', 'B4', 'D5'],
                                        s9: true,
                                        s11: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Bb13(#9,b5)",
                                        root: "Bb",
                                        type: "13",
                                        bass: "",
                                        notes: ['Bb2', 'D3', 'Ab3', 'C#4', 'F4', 'A4'],
                                        s9: true,
                                        b5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Ebmaj7(#5,9)",
                                        root: "Eb",
                                        type: "maj7",
                                        bass: "",
                                        notes: ['Eb2', 'G3', 'Bb3', 'D4', 'F#4', 'F4'],
                                        s5: true,
                                        annotation: ""
                                    },
                                    {
                                        name: "Am11(b5)/E",
                                        root: "A",
                                        type: "m11",
                                        bass: "E",
                                        notes: ['E2', 'A3', 'C4', 'Eb4', 'G4', 'D5'],
                                        b5: true,
                                        annotation: ""
                                    }
                                ],
                                collapsed: false,
                                annotation: "The extended turnaround incorporates distant key relationships with chromatic median movements and upper structure triads to create a sophisticated harmonic conclusion."
                            }
                        ]
                    }
                }
            }));
        });
    </script>
</body>

</html>
